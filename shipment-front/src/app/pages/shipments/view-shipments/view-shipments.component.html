<div class="shipments-container">
  <h2>View Shipments</h2>

  <div class="tabs">
    <button type="button" (click)="activeTab='all'" [class.active]="activeTab==='all'">All Shipments</button>
    <button type="button" (click)="activeTab='received'" [class.active]="activeTab==='received'">Received Shipments</button>
  </div>

  <div *ngIf="activeTab==='all'">
    <!-- dY"? Search and Filters -->
    <div class="filters">
      <input
        type="text"
        placeholder="Search by consignment no. or consignor"
        [(ngModel)]="searchText"
        (input)="applyFilters()" />

      <input
        type="date"
        [(ngModel)]="filterDate"
        (change)="applyFilters()" />

      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Manifested">Manifested</option>
        <option value="Delivered">Delivered</option>
      </select>
      <button
        type="button"
        class="print-btn"
        (click)="printSelectedShipments()"
        [disabled]="!isPrintEnabled">
        Print LR
      </button>
      <select
        *ngIf="originLocId === 'all-hubs'"
        [(ngModel)]="selectedHubFilterId"
        (ngModelChange)="onHubFilterChange($event)">
        <option *ngFor="let h of getAllHubsFilterOptions()" [value]="h._id">{{ h.hubName }}</option>
      </select>
    </div>

    <!-- dY"Žř Shipments Table -->
    <div class="table-wrapper">
      <table class="shipments-table">
        <thead>
          <tr>
            <th class="select-column">
              <input
                type="checkbox"
                [checked]="isAllViewShipmentsSelected"
                (change)="toggleSelectAllShipments($event)" />
            </th>
            <th>Consignment No.</th>
            <th>Status</th>
            <th>Branch</th>
            <th>Current Branch</th>
            <th>Consignor</th>
            <th>Delivery Address</th>
            <th>No. of Products</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of filteredShipments" (click)="openShipmentDetails(s)">
            <td class="checkbox-cell">
              <input
                type="checkbox"
                [checked]="isViewShipmentSelected(s)"
                (change)="toggleShipmentSelection(s)"
                (click)="$event.stopPropagation()" />
            </td>
            <td>{{ s.consignmentNumber }}</td>
            <td>{{ s.shipmentStatus }}</td>
            <td>{{ s.branch }}</td>
            <td>{{ getCurrentBranchDisplay(s) }}</td>
            <td>{{ s.consignor }}</td>
            <td>{{ s.deliveryAddress }}</td>
            <td>{{ getInvoiceAmountTotal(s.invoices) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="activeTab==='received'">
    <div class="actions-bar">
      <button type="button" class="return-btn" *ngIf="hasSelectedReceived()" (click)="openReturnModal()">Return</button>
    </div>
    <div class="filters">
      <input
        type="text"
        placeholder="Search by consignment no. or consignor"
        [(ngModel)]="searchText"
        (input)="applyFilters()" />

      <input
        type="date"
        [(ngModel)]="filterDate"
        (change)="applyFilters()" />

      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Manifested">Manifested</option>
        <option value="Delivered">Delivered</option>
      </select>
      <select
        *ngIf="originLocId === 'all-hubs'"
        [(ngModel)]="selectedHubFilterId"
        (ngModelChange)="onHubFilterChange($event)">
        <option *ngFor="let h of getAllHubsFilterOptions()" [value]="h._id">{{ h.hubName }}</option>
      </select>
      <input
        type="text"
        placeholder="Filter by consignor"
        [(ngModel)]="filterConsignor"
        (input)="applyFilters()" />
    </div>

    <div class="table-wrapper">
      <table class="shipments-table">
        <thead>
          <tr>
            <th><input type="checkbox" (change)="toggleAllReceived($event)" /></th>
            <th>Consignment No.</th>
            <th>Branch</th>
            <th>Current Branch</th>
            <th>Consignor</th>
            <th>Status</th>
            <th>Delivery Address</th>
            <th>No. of Products</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of filteredReceived" (click)="openShipmentDetails(s)">
            <td>
              <input
                type="checkbox"
                [(ngModel)]="s._returnSelected"
                [disabled]="isCancelled(s)"
                (click)="$event.stopPropagation()"
              />
            </td>
            <td>{{ s.consignmentNumber }}</td>
            <td>{{ s.branch }}</td>
            <td>{{ getCurrentBranchDisplay(s) }}</td>
            <td>{{ s.consignor }}</td>
            <td>{{ s.shipmentStatus }}</td>
            <td>{{ s.deliveryAddress }}</td>
            <td>{{ getInvoiceAmountTotal(s.invoices) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
  <div class="modal return-modal" *ngIf="showReturnModal">
  <div class="modal-content return-content">
    <button class="details-close" type="button" (click)="closeReturnModal()">&times;</button>
    <h3>Confirm Return</h3>
    <p>Mark the selected consignments as returned?</p>
    <label class="return-toggle">
      <span>Customer side return and paid by the customer</span>
      <span class="toggle">
        <input type="checkbox" [(ngModel)]="showReturnFinalAmount" />
        <span class="toggle-track">
          <span class="toggle-thumb"></span>
        </span>
      </span>
    </label>
    <ul class="return-list">
      <li *ngFor="let s of getSelectedReceived()">
        <span class="return-line">
          <span>{{ s.consignmentNumber }} - {{ s.consignor }}</span>
          <input
            *ngIf="showReturnFinalAmount"
            type="number"
            min="0"
            placeholder="Final amount"
            [(ngModel)]="s.returnFinalAmount"
          />
        </span>
      </li>
    </ul>
    <div class="return-actions">
      <button type="button" class="ghost" (click)="closeReturnModal()">Cancel</button>
      <button type="button" class="return-btn" (click)="returnSelected()">Return</button>
    </div>
  </div>
</div>
<!-- dY"` Shipment Details Modal -->
<div class="modal details-modal" *ngIf="selectedShipment">
  <div class="modal-content details-content">
    <button class="details-close" type="button" (click)="closeShipmentDetails()">&times;</button>
    <div class="details-header accent">
      <div>
        <h2>Shipment Details</h2>
        <p class="details-sub">Consignment {{ isEditingConsignment ? editingShipment?.consignmentNumber : selectedShipment.consignmentNumber }}</p>
      </div>
      <span class="details-status pill">{{ isEditingConsignment ? editingShipment?.shipmentStatus : selectedShipment.shipmentStatus }}</span>
    </div>
    <div class="details-actions">
      <button
        *ngIf="!isEditingConsignment"
        type="button"
        class="edit-btn"
        (click)="editSelectedConsignment()">
        Edit Consignment
      </button>
      <button
        *ngIf="isEditingConsignment"
        type="button"
        class="edit-btn save-btn"
        [disabled]="isSavingConsignment"
        (click)="saveConsignmentEdits()">
        Save
      </button>
      <button
        *ngIf="isEditingConsignment"
        type="button"
        class="ghost-btn"
        [disabled]="isSavingConsignment"
        (click)="cancelConsignmentEdit()">
        Cancel
      </button>
    </div>

    <div class="shipment-details details-grid card">
      <p>
        <strong>Shipment ID:</strong>
        <span class="detail-value">{{ selectedShipment._id }}</span>
      </p>
      <p>
        <strong>Consignment No.:</strong>
        <span class="detail-value">{{ selectedShipment.consignmentNumber }}</span>
      </p>
      <p>
        <strong>Status:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.shipmentStatus }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.shipmentStatus" />
      </p>
      <p>
        <strong>Status Details:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.shipmentStatusDetails }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.shipmentStatusDetails" />
      </p>
        <p *ngIf="selectedShipmentManifestId">
          <strong>Manifest:</strong>
          <a
            [href]="getManifestUrl(selectedShipmentManifestId)"
            target="_blank"
            rel="noopener noreferrer">
            <span *ngIf="selectedShipmentManifestNumber">{{ selectedShipmentManifestNumber }} — </span>
            {{ selectedShipmentManifestId }}
          </a>
        </p>
      <p>
        <strong>Branch:</strong>
        <span class="detail-value">{{ getOriginBranchDisplay(selectedShipment) }}</span>
      </p>
      <p>
        <strong>Current Branch:</strong>
        <span class="detail-value">{{ getCurrentBranchDisplay(selectedShipment) }}</span>
      </p>
      <p>
        <strong>Current Vehicle No.:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.currentVehicleNo }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.currentVehicleNo" />
      </p>
      <p>
        <strong>Current Vehicle Owner Type:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.currentVehicleOwnerType }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.currentVehicleOwnerType" />
      </p>
      <p>
        <strong>Current Vehicle Owner ID:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.currentVehicleOwnerId }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.currentVehicleOwnerId" />
      </p>
      <p>
        <strong>Consignor:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consignor }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consignor" />
      </p>
      <p>
        <strong>Consignor GST:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consignorGST }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consignorGST" />
      </p>
      <p>
        <strong>Consignor Phone:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consignorPhone }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consignorPhone" />
      </p>
      <p>
        <strong>Consignor Address:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consignorAddress }}</span>
        <textarea *ngIf="isEditingConsignment" rows="2" [(ngModel)]="editingShipment.consignorAddress"></textarea>
      </p>
      <p>
        <strong>Consignee:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consignee }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consignee" />
      </p>
      <p>
        <strong>Consignee GST:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consigneeGST }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consigneeGST" />
      </p>
      <p>
        <strong>Consignee Phone:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consigneePhone }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.consigneePhone" />
      </p>
      <p>
        <strong>Consignee Address:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.consigneeAddress }}</span>
        <textarea *ngIf="isEditingConsignment" rows="2" [(ngModel)]="editingShipment.consigneeAddress"></textarea>
      </p>
      <p>
        <strong>Payment Mode:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.paymentMode }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.paymentMode" />
      </p>
      <p>
        <strong>External Ref ID:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.externalRefId }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.externalRefId" />
      </p>
      <p>
        <strong>Billing Type:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.billingType }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.billingType" />
      </p>
      <p>
        <strong>Billing Name:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.billingName }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.billingName" />
      </p>
      <p>
        <strong>Billing GSTIN:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.billingGSTIN }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.billingGSTIN" />
      </p>
      <p>
        <strong>Billing Phone:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.billingPhone }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.billingPhone" />
      </p>
      <p>
        <strong>Billing Address:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.billingAddress || selectedShipment.billingLocationId || '-' }}</span>
        <textarea *ngIf="isEditingConsignment" rows="2" [(ngModel)]="editingShipment.billingAddress"></textarea>
      </p>
      <p>
        <strong>Pickup Type:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.pickupType }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.pickupType" />
      </p>
      <p>
        <strong>Pickup Name:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.pickupName }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.pickupName" />
      </p>
      <p>
        <strong>Pickup Phone:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.pickupPhone }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.pickupPhone" />
      </p>
      <p>
        <strong>Pickup Address:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.pickupAddress }}</span>
        <textarea *ngIf="isEditingConsignment" rows="2" [(ngModel)]="editingShipment.pickupAddress"></textarea>
      </p>
      <p>
        <strong>Pickup Pincode:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.pickupPincode }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.pickupPincode" />
      </p>
      <p>
        <strong>Delivery Type:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.deliveryType }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.deliveryType" />
      </p>
      <p>
        <strong>Delivery To:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ getDeliveryDisplayName(selectedShipment) }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.deliveryName" />
      </p>
      <p>
        <strong>Delivery Phone:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.deliveryPhone }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.deliveryPhone" />
      </p>
      <p>
        <strong>Delivery Address:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.deliveryAddress }}</span>
        <textarea *ngIf="isEditingConsignment" rows="2" [(ngModel)]="editingShipment.deliveryAddress"></textarea>
      </p>
      <p>
        <strong>Delivery Pincode:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.deliveryPincode }}</span>
        <input *ngIf="isEditingConsignment" [(ngModel)]="editingShipment.deliveryPincode" />
      </p>
      <p>
        <strong>Date:</strong>
        <span class="detail-value">{{ selectedShipment.date | date:'short' }}</span>
      </p>
      <p>
        <strong>Final Amount:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment.finalAmount }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.finalAmount" />
      </p>
      <p>
        <strong>Charges - ODC:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.odc }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.odc" />
      </p>
      <p>
        <strong>Charges - Unloading:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.unloading }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.unloading" />
      </p>
      <p>
        <strong>Charges - Docket:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.docket }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.docket" />
      </p>
      <p>
        <strong>Charges - Other:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.other }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.other" />
      </p>
      <p>
        <strong>Charges - CCC:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.ccc }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.ccc" />
      </p>
      <p>
        <strong>Charges - Consignor Discount:</strong>
        <span class="detail-value" *ngIf="!isEditingConsignment">{{ selectedShipment?.charges?.consignorDiscount }}</span>
        <input *ngIf="isEditingConsignment" type="number" [(ngModel)]="editingShipment.charges.consignorDiscount" />
      </p>
      <p>
        <strong>Products in stock:</strong>
        <span class="detail-value">{{ getInStockAmountTotal(selectedShipment.invoices) }}</span>
      </p>
      <p>
        <strong>No. of Products:</strong>
        <span class="detail-value">{{ getInvoiceAmountTotal(selectedShipment.invoices) }}</span>
      </p>
    </div>

    <h3>Products</h3>
    <div class="details-products card">
      <div class="details-invoice" *ngFor="let invoice of selectedShipment.invoices">
        <div class="details-invoice-title">Invoice #{{ invoice.number }}</div>
        <ul class="details-product-list">
          <li *ngFor="let product of invoice.products">
            <span class="product-name">{{ product.type }}</span>
            <span class="product-meta">In Stock: {{ product.instock }}</span>
            <span class="product-meta">Total: {{ product.amount }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
