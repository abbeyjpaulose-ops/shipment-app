<div class="stocks-container">
  <h2>Manifest List</h2>

  <div class="manifest-table-section">
    <div class="manifest-filters">
      <button
        type="button"
        class="print-btn"
        (click)="printSelectedManifests()"
        [disabled]="!isManifestPrintEnabled">
        Print Selected
      </button>
      <input
        type="text"
        placeholder="Search manifest no."
        [(ngModel)]="manifestSearchText" />
      <input
        type="text"
        placeholder="Filter vehicle no."
        [(ngModel)]="manifestVehicleFilter" />
      <select [(ngModel)]="manifestStatusFilter">
        <option value="">All statuses</option>
        <option value="Scheduled">Scheduled</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </div>
    <table class="stocks-table">
      <thead>
        <tr>
          <th class="select-column">Select</th>
          <th>Manifest No.</th>
          <th>Date</th>
          <th>Status</th>
          <th>Vehicle</th>
          <th>Entity</th>
          <th>Consignments</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of filterManifests(manifests)" (click)="openManifestDetails(m)">
          <td class="checkbox-cell">
            <input
              type="checkbox"
              [checked]="isManifestSelected(m)"
              (change)="toggleManifestSelection(m)"
              (click)="$event.stopPropagation()" />
          </td>
          <td>{{ m.manifestNumber }}</td>
          <td>{{ m.createdAt | date:'short' }}</td>
          <td>{{ m.status || '-' }}</td>
          <td>{{ m.vehicleNo || '-' }}</td>
          <td>{{ getManifestEntityName(m) }}</td>
          <td>{{ getManifestItemCount(m) }}</td>
        </tr>
        <tr *ngIf="!filterManifests(manifests).length">
          <td colspan="7">No manifests found.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal" *ngIf="showManifestDetails">
    <div class="modal-content manifest-details-content">
      <button class="details-close" type="button" (click)="closeManifestDetails()">&times;</button>
      <h3>Manifest Details</h3>
      <div class="consignment-edit-actions" *ngIf="selectedManifestDetails?.manifest && canEditConsignments(selectedManifestDetails.manifest) && !showConsignmentEdit">
        <button (click)="startConsignmentEdit(selectedManifestDetails.manifest)">Edit Consignments</button>
      </div>
      <div class="manifest-details-grid" *ngIf="selectedManifestDetails?.manifest">
        <p><strong>Manifest No.:</strong> {{ selectedManifestDetails.manifest.manifestNumber }}</p>
        <p>
          <strong>Vehicle No.:</strong>
          <span *ngIf="!showConsignmentEdit">{{ selectedManifestDetails.manifest.vehicleNo || '-' }}</span>
          <ng-container *ngIf="showConsignmentEdit">
            <select [(ngModel)]="manifestEditVehicleNo" [disabled]="isManifestPickupStatus(manifestEditStatus)">
              <option value="">-</option>
              <option *ngFor="let v of getSelectedBranchVehicles()" [value]="v">{{ v }}</option>
            </select>
          </ng-container>
        </p>
        <p>
          <strong>Status:</strong>
          <span *ngIf="!showConsignmentEdit">{{ selectedManifestDetails.manifest.status || '-' }}</span>
          <select *ngIf="showConsignmentEdit" [(ngModel)]="manifestEditStatus">
            <option *ngFor="let status of manifestEditStatusOptions" [value]="status">{{ status }}</option>
          </select>
        </p>
        <p>
          <strong>Delivery Point:</strong>
          <span *ngIf="!showConsignmentEdit">{{ selectedManifestDetails.deliveryPoint || '-' }}</span>
          <select
            *ngIf="showConsignmentEdit"
            [(ngModel)]="manifestEditDeliverySelection"
            [disabled]="isManifestPickupStatus(manifestEditStatus) || isManifestOutForDeliveryStatus(manifestEditStatus)">
            <option value="">-</option>
            <option *ngFor="let opt of getDeliveryPointOptions()" [value]="opt.value">{{ opt.label }}</option>
          </select>
        </p>
        <p><strong>Pickup Point:</strong> {{ selectedManifestDetails.pickupPoint || '-' }}</p>
        <p>
          <strong>Entity ID:</strong>
          {{ selectedManifestDetails.manifest.entityId || '-' }}
        </p>
        <p *ngIf="selectedManifestDetails.manifest._id">
          <strong>Manifest ID:</strong>
          <a
            [href]="getManifestUrl(selectedManifestDetails.manifest)"
            target="_blank"
            rel="noopener noreferrer">
            {{ selectedManifestDetails.manifest._id }}
          </a>
        </p>
        <p><strong>Linked consignments:</strong> {{ getManifestConsignments()?.length || 0 }}</p>
      </div>
      <h4>Consignments</h4>
      <div class="manifest-consignments" *ngIf="getManifestConsignments()?.length; else noConsignments">
        <div class="consignment-split" *ngFor="let c of getManifestConsignments()">
          <div class="consignment-header">
            <span><strong>Consignment No.:</strong> {{ c.consignmentNumber }}</span>
            <span><strong>Status:</strong> {{ c.shipmentStatus }}</span>
            <span><strong>Current Location:</strong> {{ c.currentLocation || '-' }}</span>
          </div>
          <div class="consignment-pickup">
            <span><strong>Pickup:</strong> {{ c.pickupName || '-' }}</span>
            <span><strong>Phone:</strong> {{ c.pickupPhone || '-' }}</span>
            <span><strong>Pincode:</strong> {{ c.pickupPincode || '-' }}</span>
            <span class="pickup-address"><strong>Address:</strong> {{ c.pickupAddress || '-' }}</span>
          </div>
          <table class="stocks-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Total</th>
                <th>In Stock</th>
                <th>In Transit</th>
                <th>Delivered</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of c.productSummary">
                <td>{{ p.name }}</td>
                <td>{{ p.amount }}</td>
                <td>{{ p.instock }}</td>
                <td>{{ p.intransit }}</td>
                <td>{{ p.delivered }}</td>
              </tr>
              <tr *ngIf="!c.productSummary?.length">
                <td colspan="5">No products found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-template #noConsignments>
        <p>{{ getNoConsignmentsMessage(selectedManifestDetails?.manifest?.status) }}</p>
      </ng-template>

      <div class="consignment-edit-panel" *ngIf="showConsignmentEdit">
      <div class="consignment-edit-status" *ngIf="consignmentEditLoading">Loading eligible consignments...</div>
      <div class="consignment-edit-status error" *ngIf="consignmentEditError">{{ consignmentEditError }}</div>
      <div class="consignment-edit-grid">
          <div class="consignment-edit-list">
            <h5>Current Consignments (remove)</h5>
            <div class="consignment-edit-item" *ngFor="let c of getManifestConsignments()">
              <label>
                <input
                  type="checkbox"
                  [checked]="isConsignmentMarkedForRemove(c)"
                  (change)="toggleConsignmentRemove(c)" />
                <span>
                  {{ c.consignmentNumber }}
                  {{ getBranchNameById(c.originLocId || '') || c.originLocId || '-' }}
                  ({{ c.shipmentStatus }})
                </span>
              </label>
            </div>
            <div class="consignment-edit-empty" *ngIf="!getManifestConsignments().length">
              No consignments in this manifest.
            </div>
          </div>
          <div class="consignment-edit-list">
            <h5>Eligible Consignments (add)</h5>
            <div class="consignment-edit-item" *ngFor="let c of eligibleConsignments">
              <label>
                <input
                  type="checkbox"
                  [checked]="isConsignmentMarkedForAdd(c)"
                  (change)="toggleConsignmentAdd(c)" />
                <span>
                  {{ c.consignmentNumber }}
                  {{ getBranchNameById(c.originLocId || '') || c.originLocId || '-' }}
                  ({{ c.shipmentStatus }})
                </span>
              </label>
            </div>
            <div class="consignment-edit-empty" *ngIf="!eligibleConsignments.length && !consignmentEditLoading">
              No eligible consignments found.
            </div>
          </div>
        </div>
        <div class="consignment-edit-actions">
          <button (click)="applyConsignmentEdit(selectedManifestDetails.manifest)">OK</button>
          <button (click)="cancelConsignmentEdit()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>
