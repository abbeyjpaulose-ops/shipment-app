<div class="stocks-container">
  <h2>Stocks</h2>

  <div class="stocks-tabs">
    <button
      (click)="setActiveTab('stocks')"
      [class.active]="activeTab === 'stocks'">
      Stocks
    </button>
    <button
      (click)="setActiveTab('others-in-branch')"
      [class.active]="activeTab === 'others-in-branch'">
      Others stocks in our branch
    </button>
  </div>

  <!-- üîç Search and Filters (no status filter here) -->
  <div class="filters">
    <input
      type="text"
      placeholder="Search by consignment no. or consignor"
      [(ngModel)]="searchText"
      (input)="applyFilters()" />

    <select
      *ngIf="branchId === 'all-hubs'"
      [(ngModel)]="selectedHubFilterId"
      (ngModelChange)="onHubFilterChange($event)">
      <option *ngFor="let h of getAllHubsFilterOptions()" [value]="h._id">{{ h.hubName }}</option>
    </select>

    <input
      type="date"
      [(ngModel)]="filterDate"
      (change)="applyFilters()" />

    <input
      type="text"
      placeholder="Filter by consignor"
      [(ngModel)]="filterConsignor"
      (input)="applyFilters()" />

      
      <button (click)="openManifestationPopup()">Manifestation</button>
      <button class="cancel-btn" (click)="openCancelPopup()" [disabled]="!hasSelectedConsignment()">Delete</button>
      <button (click)="printReceipts()">üñ®Ô∏è Print Receipts</button>
       <!--<button (click)="downloadReceipts()">üìÑ Download Receipts</button> -->
  </div>

    <!-- Manifestation Button -->
  <div class="actions">
    
  </div>

  <!-- üì¶ Stocks Table -->
  <table class="stocks-table">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleAllSelection($event)" /></th>
        <th>Consignment No.</th>
        <th>Status</th>
        <th>Consignor</th>
        <th>Delivery Address</th>
        <th>No. of Products</th>
        <th>Branch</th>
        <th>Current Branch</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let s of filteredStocks" (click)="openStockDetails(s)">
        <td>
          <input type="checkbox" [(ngModel)]="s.selected" (click)="$event.stopPropagation()" />
        </td>
        <td>{{ s.consignmentNumber }}</td>
        <td>{{ s.shipmentStatus }}</td>
        <td>{{ s.consignor }}</td>
        <td>{{ s.deliveryAddress }}</td>
        <td>{{ getInvoiceAmountTotal(s.invoices) }}</td>
        <td>{{ getOriginBranchLabel(s) }}</td>
        <td>{{ getCurrentBranchLabel(s) }}</td>
        <td>
          <button (click)="editStock(s); $event.stopPropagation()">Edit</button>
        </td>
      </tr>
    </tbody>
  </table>


</div>

<!-- üìë Shipment Details Modal -->
<div class="modal details-modal" *ngIf="selectedStock">
  <div class="modal-content details-content">
    <button class="details-close" type="button" (click)="closeStockDetails()">&times;</button>
    <div class="details-header">
      <div>
        <h2>Shipment Details</h2>
        <p class="details-sub">Consignment {{ selectedStock.consignmentNumber }}</p>
      </div>
      <span class="details-status">{{ selectedStock.shipmentStatus }}</span>
    </div>

    <div class="stock-details details-grid">
      <p><strong>Consignment No.:</strong> {{ selectedStock.consignmentNumber }}</p>
      <p><strong>Status:</strong> {{ selectedStock.shipmentStatus }}</p>
      <p><strong>Branch:</strong> {{ getOriginBranchLabel(selectedStock) }}</p>
      <p><strong>Consignor:</strong> {{ selectedStock.consignor }}</p>
      <p><strong>Consignor GST:</strong> {{ selectedStock.consignorGST }}</p>
      <p><strong>Consignor Phone:</strong> {{ selectedStock.consignorPhone }}</p>
      <p><strong>Consignor Address:</strong> {{ selectedStock.consignorAddress }}</p>
      <p><strong>Consignee:</strong> {{ selectedStock.consignee }}</p>
      <p><strong>Consignee GST:</strong> {{ selectedStock.consigneeGST }}</p>
      <p><strong>Consignee Phone:</strong> {{ selectedStock.consigneePhone }}</p>
      <p><strong>Consignee Address:</strong> {{ selectedStock.consigneeAddress }}</p>
      <p><strong>Payment Mode:</strong> {{ selectedStock.paymentMode }}</p>
      <p><strong>External Ref ID:</strong> {{ selectedStock.externalRefId }}</p>
      <p><strong>Billing Type:</strong> {{ selectedStock.billingType }}</p>
      <p><strong>Billing Name:</strong> {{ selectedStock.billingName }}</p>
      <p><strong>Billing GSTIN:</strong> {{ selectedStock.billingGSTIN }}</p>
      <p><strong>Billing Phone:</strong> {{ selectedStock.billingPhone }}</p>
      <p><strong>Billing Address:</strong> {{ selectedStock.billingAddress }}</p>
      <p><strong>Pickup Type:</strong> {{ selectedStock.pickupType }}</p>
      <p><strong>Pickup Name:</strong> {{ selectedStock.pickupName }}</p>
      <p><strong>Pickup Phone:</strong> {{ selectedStock.pickupPhone }}</p>
      <p><strong>Pickup Address:</strong> {{ selectedStock.pickupAddress }}</p>
      <p><strong>Pickup Pincode:</strong> {{ selectedStock.pickupPincode }}</p>
      <p><strong>Delivery Type:</strong> {{ selectedStock.deliveryType }}</p>
      <p><strong>Delivery To:</strong> {{ getDeliveryDisplayName(selectedStock) }}</p>
      <p><strong>Delivery Phone:</strong> {{ selectedStock.deliveryPhone }}</p>
      <p><strong>Delivery Address:</strong> {{ selectedStock.deliveryAddress }}</p>
      <p><strong>Delivery Pincode:</strong> {{ selectedStock.deliveryPincode }}</p>
      <p><strong>Date:</strong> {{ selectedStock.date | date:'short' }}</p>
      <p><strong>Final Amount:</strong> {{ selectedStock.finalAmount }}</p>
      <p><strong>Charges - ODC:</strong> {{ selectedStock?.charges?.odc }}</p>
      <p><strong>Charges - Unloading:</strong> {{ selectedStock?.charges?.unloading }}</p>
      <p><strong>Charges - Docket:</strong> {{ selectedStock?.charges?.docket }}</p>
      <p><strong>Charges - Other:</strong> {{ selectedStock?.charges?.other }}</p>
      <p><strong>Charges - CCC:</strong> {{ selectedStock?.charges?.ccc }}</p>
      <p><strong>Charges - Consignor Discount:</strong> {{ selectedStock?.charges?.consignorDiscount }}</p>
      <p><strong>Products in stock:</strong> {{ getInStockAmountTotal(selectedStock.invoices) }}</p>
      <p><strong>No. of Products:</strong> {{ getInvoiceAmountTotal(selectedStock.invoices) }}</p>
    </div>


    <h3>Products</h3>
    <div class="details-products">
      <div class="details-invoice" *ngFor="let invoice of selectedStock.invoices">
        <div class="details-invoice-title">Invoice #{{ invoice.number }}</div>
        <ul class="details-product-list">
          <li *ngFor="let product of invoice.products">
            <span class="product-name">{{ product.type }}</span>
            <span class="product-meta">In Stock: {{ product.instock }}</span>
            <span class="product-meta">Total: {{ product.amount }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Edit Modal -->
<div class="modal edit-stock-modal" *ngIf="editingStock">
  <div class="modal-content edit-stock-content">
    <div class="edit-stock-header">
      <div>
        <h3>Edit Stock</h3>
        <p class="edit-stock-meta">Consignment No: {{editingStock.consignmentNumber}} | Status: {{editingStock.shipmentStatus}}</p>
      </div>
    </div>

    <div class="edit-stock-section">
      <div class="edit-stock-grid">
        <label>E-way Bill No:
          <input [(ngModel)]="editingStock.ewaybillNumber" />
        </label>
        <label>Date:
          <input type="date" [(ngModel)]="editingStock.date" />
        </label>
      </div>
    </div>

    <div class="edit-stock-section">
      <h4>Consignor</h4>
      <div class="tabs edit-stock-tabs">
        <button (click)="editingStock.consignorTab = 'consignor'" [class.active]="editingStock.consignorTab === 'consignor'">Consignor</button>
        <button (click)="editingStock.consignorTab = 'guest'" [class.active]="editingStock.consignorTab === 'guest'">Guest</button>
      </div>

      <div *ngIf="editingStock.consignorTab === 'consignor'" class="edit-stock-grid">
        <label>Consignor:
          <select [(ngModel)]="editingStock.consignor" (change)="onConsignorSelect(editingStock.consignor)">
            <option *ngFor="let client of clientList" [value]="client.clientName">{{ client.clientName }}, {{ client.address }}</option>
          </select>
        </label>
        <label>GSTIN:
          <input [(ngModel)]="editingStock.consignorGST" readonly />
        </label>
        <label>Address:
          <input [(ngModel)]="editingStock.consignorAddress" readonly />
        </label>
        <label>Phone:
          <input [(ngModel)]="editingStock.consignorPhone" readonly />
        </label>
      </div>

      <div *ngIf="editingStock.consignorTab === 'guest'" class="edit-stock-grid">
        <label>Guest Name:
          <select [(ngModel)]="editingStock.consignor" (change)="onConsignorGuestSelect(editingStock.consignor)">
            <option *ngFor="let guest of guestList" [value]="guest.guestName">{{ guest.guestName }}, {{ guest.address }}</option>
          </select>
        </label>
        <label>Address:
          <input [(ngModel)]="editingStock.consignorAddress" readonly />
        </label>
        <label>Phone:
          <input [(ngModel)]="editingStock.consignorPhone" readonly />
        </label>
      </div>
    </div>

    <div class="edit-stock-section">
      <h4>Consignee</h4>
      <div class="tabs edit-stock-tabs">
        <button (click)="editingStock.consigneeTab = 'consignee'" [class.active]="editingStock.consigneeTab === 'consignee'">Consignee</button>
        <button (click)="editingStock.consigneeTab = 'guest'" [class.active]="editingStock.consigneeTab === 'guest'">Guest</button>
      </div>

      <div *ngIf="editingStock.consigneeTab === 'consignee'" class="edit-stock-grid">
        <label>Consignee:
          <select [(ngModel)]="editingStock.consignee" (change)="onConsigneeSelect(editingStock.consignee)">
            <option *ngFor="let client of clientList" [value]="client.clientName">{{ client.clientName }}, {{ client.address }}</option>
          </select>
        </label>
        <label>GSTIN:
          <input [(ngModel)]="editingStock.consigneeGST" readonly />
        </label>
        <label>Address:
          <input [(ngModel)]="editingStock.consigneeAddress" readonly />
        </label>
        <label>Phone:
          <input [(ngModel)]="editingStock.consigneePhone" readonly />
        </label>
      </div>

      <div *ngIf="editingStock.consigneeTab === 'guest'" class="edit-stock-grid">
        <label>Guest Name:
          <select [(ngModel)]="editingStock.consignee" (change)="onConsigneeGuestSelect(editingStock.consignee)">
            <option *ngFor="let guest of guestList" [value]="guest.guestName">{{ guest.guestName }}, {{ guest.address }}</option>
          </select>
        </label>
        <label>Address:
          <input [(ngModel)]="editingStock.consigneeAddress" readonly />
        </label>
        <label>Phone:
          <input [(ngModel)]="editingStock.consigneePhone" readonly />
        </label>
      </div>
    </div>

    <div class="edit-stock-section">
      <div class="edit-stock-grid">
        <label>Payment Mode:
          <select [(ngModel)]="editingStock.paymentMode" (change)="onEditingPaymentModeChange()">
            <option>Account Credit</option>
            <option>Paid</option>
            <option>To Pay</option>
          </select>
        </label>
        <label>External Ref ID:
          <input [(ngModel)]="editingStock.externalRefId" />
        </label>
      </div>

      <h4>Billing Type</h4>
      <div class="edit-stock-radio">
        <label><input type="radio" name="billing" value="consignor" [(ngModel)]="editingStock.billingType" /> Consignor's GST Address</label>
        <label><input type="radio" name="billing" value="different" [(ngModel)]="editingStock.billingType" /> Different Address</label>
      </div>

      <div *ngIf="editingStock.billingType === 'different'" class="edit-stock-grid">
        <label>Name:
          <input [(ngModel)]="editingStock.billingName" />
        </label>
        <label>GSTIN:
          <input [(ngModel)]="editingStock.billingGSTIN" />
        </label>
        <label>Address:
          <textarea [(ngModel)]="editingStock.billingAddress"></textarea>
        </label>
      </div>
    </div>

   <!-- 4. Invoice -->
<section class="edit-stock-section">
  <h3>4. Invoice</h3>
  <div *ngFor="let invoice of editingStock.invoices; let i = index" class="invoice-block">
    <!-- Invoice Header -->
    <div class="grid-3">
      <input placeholder="Invoice Number" [(ngModel)]="invoice.number" />
      <input placeholder="Invoice Value" type="number" [(ngModel)]="invoice.value" />
      <button type="button" class="danger" (click)="deleteInvoice(i)">Delete Invoice</button>
    </div>

    <!-- Package Details for this Invoice -->
    <h4>Packages</h4>
    <div *ngFor="let pkg of invoice.packages; let j = index" class="grid-4">
      <select [(ngModel)]="pkg.type" (change)="onPackageList(pkg.pkgName)">
        <option *ngFor="let pkgItem of pkgList" [value]="pkgItem.pkgName">{{ pkgItem.pkgName }}</option>
      </select>
      <input placeholder="Amount*" type="number" [(ngModel)]="pkg.amount" />
      <button type="button" class="danger" (click)="deletePackage(i, j)">dY-`ÔøΩ,? Delete Package {{i}}/{{j}}</button>
    </div>
    <button type="button" class="ghost" (click)="addPackage(i)">+ Add Package</button>

    <!-- Product Details for this Invoice -->
    <h4>Products</h4>
    <div *ngFor="let product of invoice.products; let k = index" class="grid-4">
      <select [(ngModel)]="product.type" (change)="onPackageList(product.productName)">
        <option *ngFor="let productItem of productList" [value]="productItem.productName">
          {{ productItem.hsnNum }} - {{ productItem.productName }}
        </option>
      </select>
      <input
        placeholder="Amount*"
        type="number"
        [(ngModel)]="product.amount"
        (focus)="onProductAmountFocus(invoice, product, i)"
        (ngModelChange)="onProductAmountChange(invoice, product, $event, i)"
      />
      <button type="button" class="danger" (click)="deleteProduct(i, k)">dY-`ÔøΩ,? Delete Product {{i}}/{{k}}</button>
    </div>
    <button type="button" class="ghost" (click)="addProduct(i)">+ Add Product</button>
  </div>

  <!-- Add New Invoice -->
  <button type="button" class="ghost" (click)="addInvoice()">+ Add Invoice</button>
</section>

    <div class="edit-stock-section">
      <h4>Charges</h4>
      <div class="edit-stock-grid">
        <label>ODC:
          <input type="number" [(ngModel)]="editingStock.charges.odc" />
        </label>
        <label>Unloading:
          <input type="number" [(ngModel)]="editingStock.charges.unloading" />
        </label>
        <label>Docket:
          <input type="number" [(ngModel)]="editingStock.charges.docket" />
        </label>
        <label>Other:
          <input type="number" [(ngModel)]="editingStock.charges.other" />
        </label>
        <label>CCC:
          <input type="number" [(ngModel)]="editingStock.charges.ccc" />
        </label>
        <label>Final Amount:
          <input type="number" [(ngModel)]="editingStock.finalAmount" />
        </label>
      </div>
    </div>

    <div class="edit-stock-actions">
      <button class="ghost" (click)="calculateFinalAmount()">Calculate</button>
      <button class="primary" (click)="saveStockEdit()">Save</button>
      <button class="ghost" (click)="cancelEdit()">Cancel</button>
    </div>
  </div>
</div>
<!-- Adjust Manifest Quantities Popup -->
<div class="modal" *ngIf="showManifestAdjustmentPopup">
  <div class="modal-content">
    <h3>Adjust Manifest Quantities</h3>
    <div *ngIf="pendingManifestAdjustment">
      <p><strong>Consignment:</strong> {{ pendingManifestAdjustment.consignmentNumber }}</p>
      <p><strong>Product:</strong> {{ pendingManifestAdjustment.productType }}</p>
      <p>
        <strong>New Total Qty:</strong>
        {{ getPopupTargetTotal() }}
      </p>
      <p>
        <strong>In Stock Qty:</strong>
        <input
          type="number"
          min="0"
          [(ngModel)]="pendingManifestAdjustment.popupInstock"
          (ngModelChange)="onPopupInstockChange($event)"
        />
      </p>
      
    </div>

    <table class="stocks-table" *ngIf="manifestAdjustmentLines.length > 0">
      <thead>
        <tr>
          <th>Manifest No.</th>
          <th>Date</th>
          <th>Invoice</th>
          <th>Qty</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let line of manifestAdjustmentLines">
          <td>{{ line.manifestationNumber }}</td>
          <td>{{ line.date | date:'short' }}</td>
          <td>{{ line.invoiceNumber }}</td>
          <td>
            <input
              type="number"
              min="0"
              [(ngModel)]="line.newManifestQty"
              (ngModelChange)="onManifestQtyChange(line)"
            />
          </td>
        </tr>
      </tbody>
    </table>

    <p><strong>Manifest Total:</strong> {{ getManifestLineTotal() }} | <strong>Delivered Total:</strong> {{ getPopupDeliveredTotal() }}</p>

    <div class="terminal-buttons">
      <button (click)="applyManifestAdjustments()">Apply</button>
      <button (click)="cancelManifestAdjustments()">Cancel</button>
    </div>
  </div>
</div>
<!-- üßæ Manifestation Terminal Popup -->
<div class="modal" *ngIf="showManifestationPopup">
  <div class="modal-content terminal-style">
    <span class="close" (click)="closeManifestationPopup()">&times;</span>
    <div class="terminal-header">
      <h2>Manifestation Terminal</h2>
      <label class="terminal-status">
        <span>Status</span>
        <select [(ngModel)]="manifestationStatus">
          <option *ngFor="let status of manifestationStatusOptions" [value]="status">{{ status }}</option>
        </select>
      </label>
    </div>
    <p class="manifest-number" *ngIf="manifestationNumber">
      <strong>Manifest No:</strong> {{ manifestationNumber }}
    </p>

    <div *ngIf="selectedForManifestation.length > 0; else noSelection">
      <hr>

      <div *ngFor="let consignment of selectedForManifestation" class="consignment-block">
        <h4>Consignment: {{ consignment.consignmentNumber }}</h4>
        <div *ngIf="isSelectedNextDeliveryPointHub()" class="hub-charge-wrapper">
          <label class="hub-pickup-toggle">
            <input
              type="checkbox"
              [(ngModel)]="consignment.hubWillPickedUp"
              (change)="onHubPickedUpToggle(consignment)"
            />
            <span>Will picked-up from the location</span>
          </label>
          <div class="hub-charge-row">
            <label>
              Hub charge
              <input
                type="number"
                min="0"
                [(ngModel)]="consignment.hubPerRevAmount"
                [disabled]="consignment.hubWillPickedUp"
              />
            </label>
            <span class="hint">Suggested: {{ getHubChargeSuggestion(consignment) }}</span>
          </div>
        </div>

        <!-- Eway Bill Section -->
        <div class="ewaybill-section">
          <ng-container *ngIf="consignment.ewaybillNumber === ''; else showEwaybill">
            <label class="eway-toggle-label">
              <input
                type="checkbox"
                [(ngModel)]="consignment.ewayBillRequired"
                class="eway-toggle-input"
              />
              <span class="eway-toggle-slider"></span>
              <span class="eway-toggle-text">
                {{ consignment.ewayBillRequired ? 'Eway Bill will be created' : 'Eway Bill not required' }}
              </span>
            </label>
          </ng-container>
          <ng-template #showEwaybill>
            <p><strong>Customer created Eway Bill No:</strong> {{ consignment.ewaybillNumber }}</p>
          </ng-template>
        </div>

        <!-- Consignor and Invoices -->
        <p><strong>Consignor:</strong> {{ consignment.consignor }}</p>
        <ul>
          <li *ngFor="let invoice of consignment.invoices">
            <strong>Invoice:</strong> {{ invoice.number }}
            <ul>
              <li *ngFor="let product of invoice.products">
                <div class="product-line">
                  <span><strong>{{ product.type }}</strong></span>
                  <span>
                    Total: {{ product.amount }}
                  </span>
                  <span>
                    <input
                      type="number"
                      min="0"
                      [max]="product.instock"
                      [(ngModel)]="product.manifestQty"
                      class="manifest-input"
                      readonly
                      disabled
                    />
                  </span>
                </div>
              </li>
            </ul>
          </li>
        </ul>
        <hr>
      </div>


      <!-- Shipment Routing Section -->
      <div class="routing-section" *ngIf="manifestationStatus !== 'Will be Picked-Up'">
        <div class="routing-header">
          <h3>Transportation Vehicle</h3>
          <label class="eway-toggle-label external-toggle">
  <input
    type="checkbox"
    [(ngModel)]="isExternalTransport"
    class="eway-toggle-input"
    (change)="onExternalTransportToggle()"
  />
  <span class="eway-toggle-slider"></span>
  <span class="eway-toggle-text">External</span>
</label>
        </div>
        <div class="routing-controls">
  <ng-container *ngIf="!isExternalTransport; else externalTransport">
    <select disabled>
      <option value="">Select transport partner</option>
    </select>
    <select [(ngModel)]="selectedRouteVehicle" (change)="onRouteVehicleChange()">
      <option value="">Select Vehicle</option>
      <option *ngFor="let v of getBranchVehicles()" [value]="v">{{ v }}</option>
    </select>
  </ng-container>
  <ng-template #externalTransport>
    <select [(ngModel)]="selectedTransportPartnerId" (change)="onTransportPartnerChange()">
      <option value="">Select transport partner</option>
      <option *ngFor="let p of transportPartners" [value]="p._id">{{ p.partnerName }}</option>
    </select>
    <select [(ngModel)]="selectedRouteVehicle" (change)="onRouteVehicleChange()">
      <option value="">Select Vehicle</option>
      <option *ngFor="let v of getTransportPartnerVehicles()" [value]="v">{{ v }}</option>
    </select>
  </ng-template>
  <label *ngIf="manifestationStatus === 'Manifestation'">
    Next delivery point
    <select [(ngModel)]="selectedNextDeliveryPoint" (change)="onNextDeliveryPointChange()">
      <option value="">Select next point</option>
      <option *ngFor="let point of availableRoutePoints" [value]="point.name">
        {{ point.name }} ({{ point.type }})
      </option>
    </select>
  </label>
  <div *ngIf="manifestationStatus === 'Manifestation' && isSelectedNextDeliveryPointHub()" class="hub-charge-total">
    Hub charge total: {{ getHubChargeTotal() }}
  </div>
</div>

        <ul class="route-list">
          <li *ngFor="let point of shipmentRoute; let i = index">
            {{ i + 1 }}. {{ point.name }} ({{ point.type }}) <span *ngIf="point.vehicleNo">- {{ point.vehicleNo }}</span>
            <button class="remove-btn" (click)="removeRoutePoint(i)">x</button>
          </li>
        </ul>
      </div>
      <!-- Terminal Buttons -->
      <div class="terminal-buttons">
        <button (click)="finalizeManifestation()">Manifest</button>
        <button (click)="closeManifestationPopup()">Cancel</button>
      </div>
    </div>

    <!-- No Selection Template -->
    <ng-template #noSelection>
      <p>No consignments selected for manifestation.</p>
      <button (click)="closeManifestationPopup()">Close</button>
    </ng-template>
  </div>
</div>

<!-- Cancel Confirmation Popup -->
<div class="modal" *ngIf="showCancelPopup">
  <div class="modal-content">
    <h3>Are you sure you want to cancel the below list? This cannot be reverted! You can always edit it</h3>
    <ul class="cancel-list">
      <li *ngFor="let s of getSelectedConsignments()">
        <span>{{ s.consignmentNumber }}</span>
        <button type="button" class="remove-btn" (click)="removeSelection(s)">Remove</button>
      </li>
    </ul>
    <div class="terminal-buttons">
      <button (click)="confirmCancelSelection()">Ok</button>
      <button (click)="closeCancelPopup()">Cancel</button>
    </div>
  </div>
</div>







