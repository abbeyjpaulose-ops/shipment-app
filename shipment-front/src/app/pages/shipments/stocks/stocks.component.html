<div class="stocks-container">
  <h2>Stocks</h2>

  <!-- üîç Search and Filters (no status filter here) -->
  <div class="filters">
    <input
      type="text"
      placeholder="Search by consignment no. or consignor"
      [(ngModel)]="searchText"
      (input)="applyFilters()" />

    <input
      type="date"
      [(ngModel)]="filterDate"
      (change)="applyFilters()" />

    <input
      type="text"
      placeholder="Filter by consignor"
      [(ngModel)]="filterConsignor"
      (input)="applyFilters()" />
      
      <button (click)="openManifestationPopup()">Manifestation</button>
  </div>

    <!-- Manifestation Button -->
  <div class="actions">
    
  </div>

  <!-- üì¶ Stocks Table -->
  <table class="stocks-table">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleAllSelection($event)" /></th>
        <th>Consignment No.</th>
        <th>Consignor</th>
        <th>Delivery Address</th>
        <th>Products in stock</th>
        <th>No. of Products</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let s of filteredStocks" (click)="openStockDetails(s)">
        <td>
          <input type="checkbox" [(ngModel)]="s.selected" (click)="$event.stopPropagation()" />
        </td>
        <td>{{ s.consignmentNumber }}</td>
        <td>{{ s.consignor }}</td>
        <td>{{ s.deliveryAddress }}</td>
        <td>{{ getInStockAmountTotal(s.invoices) }}</td>
        <td>{{ getInvoiceAmountTotal(s.invoices) }}</td>
        <td>
          <button (click)="editStock(s); $event.stopPropagation()">Edit</button>
        </td>
      </tr>
    </tbody>
  </table>


</div>

<!-- üìë Shipment Details Modal -->
<div class="modal" *ngIf="selectedStock">
  <div class="modal-content">
    <span class="close" (click)="closeStockDetails()">&times;</span>
    <h2>Shipment Details</h2>

    <div class="stock-details">
      <p><strong>Consignment No.:</strong> {{ selectedStock.consignmentNumber }}</p>
      <p><strong>Status:</strong> {{ selectedStock.shipmentStatus }}</p>
      <p><strong>Consignor:</strong> {{ selectedStock.consignor }}</p>
      <p><strong>Consignee:</strong> {{ selectedStock.consignee }}</p>
      <p><strong>Delivery Address:</strong> {{ selectedStock.deliveryAddress }}</p>
      <p><strong>Date:</strong> {{ selectedStock.date | date:'short' }}</p>
      <p><strong>Products in stock:</strong> {{ getInStockAmountTotal(selectedStock.invoices) }}</p>
      <p><strong>No. of Products:</strong> {{ getInvoiceAmountTotal(selectedStock.invoices) }}</p>
    </div>


    <h3>Products</h3>
    <ul>
      <li *ngFor="let invoice of selectedStock.invoices">
        {{ invoice.number }}:
        <ul>
          <li *ngFor="let product of invoice.products">
            {{ product.type }} (In Stock Qty: {{ product.instock }}) (Total Qty: {{ product.amount }})
          </li>
        </ul>
      </li>
    </ul>
  </div>
</div>

<!-- ‚úÖ Edit Modal -->
<div class="modal" *ngIf="editingStock">
  <div class="modal-content">
    <h3>Edit Stock</h3>

    <!-- Section 1: Basic Info -->
    <label>Consignment No: {{editingStock.consignmentNumber}} | Status: {{editingStock.shipmentStatus}}</label><br>
    <label>E-way Bill No:</label>
    <input [(ngModel)]="editingStock.ewaybillNumber" />

    <label>Date:</label>
    <input type="date" [(ngModel)]="editingStock.date" />

    <label>Status Details:</label>
    <input [(ngModel)]="editingStock.shipmentStatusDetails" />

    <!-- Section 2: Consignor / Consignee Tabs -->
    <h4>Consignor</h4>
    <div class="tabs">
      <button (click)="editingStock.consignorTab = 'consignor'" [class.active]="editingStock.consignorTab === 'consignor'">Consignor</button>
      <button (click)="editingStock.consignorTab = 'guest'" [class.active]="editingStock.consignorTab === 'guest'">Guest</button>
    </div>

    <div *ngIf="editingStock.consignorTab === 'consignor'">
      <label>Consignor:
        <select [(ngModel)]="editingStock.consignor" (change)="onConsignorSelect(editingStock.consignor)">
          <option *ngFor="let client of clientList" [value]="client.clientName">{{ client.clientName }}, {{ client.address }}</option>
        </select>
      </label>
      <label>GSTIN: <input [(ngModel)]="editingStock.consignorGST" readonly /></label>
      <label>Address: <input [(ngModel)]="editingStock.consignorAddress" readonly /></label>
      <label>Phone: <input [(ngModel)]="editingStock.consignorPhone" readonly /></label>
    </div>

    <div *ngIf="editingStock.consignorTab === 'guest'">
      <label>Guest Name:
        <select [(ngModel)]="editingStock.consignor" (change)="onConsignorGuestSelect(editingStock.consignor)">
          <option *ngFor="let guest of guestList" [value]="guest.guestName">{{ guest.guestName }}, {{ guest.address }}</option>
        </select>
      </label>
      <label>Address: <input [(ngModel)]="editingStock.consignorAddress" readonly /></label>
      <label>Phone: <input [(ngModel)]="editingStock.consignorPhone" readonly /></label>
    </div>

    <h4>Consignee</h4>
    <div class="tabs">
      <button (click)="editingStock.consigneeTab = 'consignee'" [class.active]="editingStock.consigneeTab === 'consignee'">Consignee</button>
      <button (click)="editingStock.consigneeTab = 'guest'" [class.active]="editingStock.consigneeTab === 'guest'">Guest</button>
    </div>

    <div *ngIf="editingStock.consigneeTab === 'consignee'">
      <label>Consignee:
        <select [(ngModel)]="editingStock.consignee" (change)="onConsigneeSelect(editingStock.consignee)">
          <option *ngFor="let client of clientList" [value]="client.clientName">{{ client.clientName }}, {{ client.address }}</option>
        </select>
      </label>
      <label>GSTIN: <input [(ngModel)]="editingStock.consigneeGST" readonly /></label>
      <label>Address: <input [(ngModel)]="editingStock.consigneeAddress" readonly /></label>
      <label>Phone: <input [(ngModel)]="editingStock.consigneePhone" readonly /></label>
    </div>

    <div *ngIf="editingStock.consigneeTab === 'guest'">
      <label>Guest Name:
        <select [(ngModel)]="editingStock.consignee" (change)="onConsigneeGuestSelect(editingStock.consignee)">
          <option *ngFor="let guest of guestList" [value]="guest.guestName">{{ guest.guestName }}, {{ guest.address }}</option>
        </select>
      </label>
      <label>Address: <input [(ngModel)]="editingStock.consigneeAddress" readonly /></label>
      <label>Phone: <input [(ngModel)]="editingStock.consigneePhone" readonly /></label>
    </div>

    <!-- Payment Mode -->
    <label>Payment Mode:
      <select [(ngModel)]="editingStock.paymentMode">
        <option>Account Credit</option>
        <option>Paid</option>
        <option>To Pay</option>
      </select>
    </label>

    <label>External Ref ID:</label>
    <input [(ngModel)]="editingStock.externalRefId" />

    <!-- Billing, Pickup, Delivery Address Types -->
    <h4>Billing Type</h4>
    <label><input type="radio" name="billing" value="consignor" [(ngModel)]="editingStock.billingType" /> Consignor's GST Address</label>
    <label><input type="radio" name="billing" value="different" [(ngModel)]="editingStock.billingType" /> Different Address</label>

    <div *ngIf="editingStock.billingType === 'different'">
      <label>Name: <input [(ngModel)]="editingStock.billingName" /></label>
      <label>GSTIN: <input [(ngModel)]="editingStock.billingGSTIN" /></label>
      <label>Address: <textarea [(ngModel)]="editingStock.billingAddress"></textarea></label>
    </div>

    <!-- Similar structure for Pickup and Delivery -->
    <!-- You can replicate the same radio + conditional logic for pickupType and deliveryType -->

   <!-- 4. Invoice Details -->
<section>
  <h3>4. Invoice Details</h3>
  <div *ngFor="let invoice of editingStock.invoices; let i = index" class="invoice-block">
    <!-- Invoice Header -->
    <div class="grid-3">
      <input placeholder="Invoice Number" [(ngModel)]="invoice.number" />
      <input placeholder="Invoice Value" type="number" [(ngModel)]="invoice.value" />
      <button type="button" (click)="deleteInvoice(i)">üóëÔ∏è Delete Invoice</button>
    </div>

    <!-- Package Details for this Invoice -->
    <h4>Packages</h4>
    <div *ngFor="let pkg of invoice.packages; let j = index" class="grid-4">
      <select [(ngModel)]="pkg.type" (change)="onPackageList(pkg.pkgName)">
        <option *ngFor="let pkgItem of pkgList" [value]="pkgItem.pkgName">{{ pkgItem.pkgName }}</option>
      </select>
      <input placeholder="Amount*" type="number" [(ngModel)]="pkg.amount" />
      <button type="button" (click)="deletePackage(i, j)">üóëÔ∏è Delete Package {{i}}/{{j}}</button>
    </div>
    <button type="button" (click)="addPackage(i)">+ Add Package</button>

    <!-- Product Details for this Invoice -->
    <h4>Products</h4>
    <div *ngFor="let product of invoice.products; let k = index" class="grid-4">
      <select [(ngModel)]="product.type" (change)="onPackageList(product.productName)">
        <option *ngFor="let productItem of productList" [value]="productItem.productName">
          {{ productItem.hsnNum }} - {{ productItem.productName }}
        </option>
      </select>
      <input placeholder="Amount*" type="number" [(ngModel)]="product.amount" (ngModelChange)="product.instock = $event" />
      <button type="button" (click)="deleteProduct(i, k)">üóëÔ∏è Delete Product {{i}}/{{k}}</button>
    </div>
    <button type="button" (click)="addProduct(i)">+ Add Product</button>
  </div>

  <!-- Add New Invoice -->
  <button type="button" (click)="addInvoice()">+ Add Invoice</button>
</section>



    <!-- Charges -->
    <h4>Charges</h4>
    <label>ODC: <input type="number" [(ngModel)]="editingStock.charges.odc" /></label>
    <label>Unloading: <input type="number" [(ngModel)]="editingStock.charges.unloading" /></label>
    <label>Docket: <input type="number" [(ngModel)]="editingStock.charges.docket" /></label>
    <label>Other: <input type="number" [(ngModel)]="editingStock.charges.other" /></label>
    <label>CCC: <input type="number" [(ngModel)]="editingStock.charges.ccc" /></label>
    <label>Final Amount: <input type="number" [(ngModel)]="editingStock.finalAmount" /></label>

    <!-- Actions -->
    <button (click)="calculateFinalAmount()">Calculate</button>
    <button (click)="saveStockEdit()">Save</button>
    <button (click)="cancelEdit()">Cancel</button>
  </div>
</div>

<!-- üßæ Manifestation Terminal Popup -->
<div class="modal" *ngIf="showManifestationPopup">
  <div class="modal-content terminal-style">
    <span class="close" (click)="closeManifestationPopup()">&times;</span>
    <h2>Manifestation Terminal</h2>

    <div *ngIf="selectedForManifestation.length > 0; else noSelection">
      <p><strong>Manifestation No:</strong> {{ manifestationNumber }}</p>
      <hr>

      <div *ngFor="let consignment of selectedForManifestation" class="consignment-block">
        <h4>Consignment: {{ consignment.consignmentNumber }}</h4>
        <p><strong>Consignor:</strong> {{ consignment.consignor }}</p>
        <ul>
          <li *ngFor="let invoice of consignment.invoices">
            <strong>Invoice:</strong> {{ invoice.number }}   
            <ul>
              <li *ngFor="let product of invoice.products">
                <div class="product-line">
                  <span><strong>{{ product.type }}</strong></span>
                  <span>
                    In Stock: {{ product.instock }} /
                    Total: {{ product.amount }}
                  </span>
                  <span>
                    <input
                    type="number"
                    min="0"
                    [max]="product.instock"
                    [(ngModel)]="product.manifestQty"
                    (change)="validateManifestQty(product)"
                    class="manifest-input"
                    />
                  </span>
                </div>
              </li>
            </ul>
          </li>
        </ul>
        <hr>
      </div>

      <div class="terminal-buttons">
        <button (click)="finalizeManifestation()">Manifest</button>
        <button (click)="closeManifestationPopup()">Cancel</button>
      </div>
    </div>

    <ng-template #noSelection>
      <p>No consignments selected for manifestation.</p>
      <button (click)="closeManifestationPopup()">Close</button>
    </ng-template>
  </div>
</div>


