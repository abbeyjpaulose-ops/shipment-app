<div class="invoice-container">
  <h2>ðŸ“¦ Delivered/Pre-Invoice Management</h2>

  <!-- Filters -->
  <div class="filters">
    <input type="text" placeholder="Search by Consignment / Consignor" [(ngModel)]="searchText" (input)="applyFilters()" />
    <input type="date" [(ngModel)]="filterDate" (change)="applyFilters()" />
    <input type="text" placeholder="Filter by Consignor" [(ngModel)]="filterConsignor" (input)="applyFilters()" />
    <!-- Action Bar -->
  </div>

  <!-- Delivered Table -->
<div class="invoice-sections">
<div class="invoice-section">
  <h3>Delivered</h3>
  <div class="action-bar">
    <button (click)="invoiceSelected()">Generate Pre-Invoice</button>
    <button class="delete-btn" (click)="deleteDelivered()">Delete</button>
    <button class="print-btn" (click)="printDelivered()">Print Manifest</button>
  </div>
  <table class="invoice-table">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleAllDeliveredSelection($event)" /></th>
        <th>Consignment No.</th>
        <th>Status</th>
        <th>Consignor</th>
                        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let inv of filteredDelivered" [class.selected]="inv.selected">
        <td>
          <input
            type="checkbox"
            [(ngModel)]="inv.selected"
            (click)="$event.stopPropagation()"
          />
        </td>
        <td (click)="openInvoiceDetails(inv)">{{ inv.consignmentNumber }}</td>
        <td>{{ inv.shipmentStatus }}</td>
        <td>{{ inv.consignor }}</td>
                        <td>
          <button class="edit-btn" (click)="editInvoice(inv)">fo?<,? Edit</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Pre-Invoiced Table -->
<div class="invoice-section">
  <h3>Pre-Invoiced</h3>
  <div class="action-bar">
    <button (click)="openGenerateInvoicePopup()">Generate Invoice</button>
    <button class="delete-btn" (click)="deletePreInvoiced()">Delete</button>
    <button class="print-btn" (click)="printPreInvoiced()">Print Manifest</button>
  </div>
  <table class="invoice-table">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleAllPreInvoicedSelection($event)" /></th>
        <th>Consignment No.</th>
        <th>Status</th>
        <th>Consignor</th>
                        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let inv of filteredPreInvoiced" [class.selected]="inv.selected">
        <td>
          <input
            type="checkbox"
            [(ngModel)]="inv.selected"
            (click)="$event.stopPropagation()"
          />
        </td>
        <td (click)="openInvoiceDetails(inv)">{{ inv.consignmentNumber }}</td>
        <td>{{ inv.shipmentStatus }}</td>
        <td>{{ inv.consignor }}</td>
                        <td>
          <button class="edit-btn" (click)="editInvoice(inv)">fo?<,? Edit</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
</div>
<!-- Modal for invoice details -->
  <div class="modal details-modal" *ngIf="showInvoiceModal">
    <div class="modal-content details-content">
      <button class="details-close" type="button" (click)="closeInvoiceDetails()">&times;</button>
      <div class="details-header">
        <div>
          <h2>Consignment Details</h2>
          <p class="details-sub">Consignment #{{ selectedInvoice?.consignmentNumber }}</p>
        </div>
        <span class="details-status">{{ selectedInvoice?.shipmentStatus }}</span>
      </div>

      <div class="details-grid">
        <div class="details-item">
          <div class="details-label">Consignor</div>
          <div class="details-value">{{ selectedInvoice?.consignor }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor GST</div>
          <div class="details-value">{{ selectedInvoice?.consignorGST }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor Phone</div>
          <div class="details-value">{{ selectedInvoice?.consignorPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor Address</div>
          <div class="details-value">{{ selectedInvoice?.consignorAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee</div>
          <div class="details-value">{{ selectedInvoice?.consignee }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee GST</div>
          <div class="details-value">{{ selectedInvoice?.consigneeGST }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee Phone</div>
          <div class="details-value">{{ selectedInvoice?.consigneePhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee Address</div>
          <div class="details-value">{{ selectedInvoice?.consigneeAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Branch</div>
          <div class="details-value">{{ selectedInvoice?.branch }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Date</div>
          <div class="details-value">{{ selectedInvoice?.date | date:'short' }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Payment Mode</div>
          <div class="details-value">{{ selectedInvoice?.paymentMode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">External Ref ID</div>
          <div class="details-value">{{ selectedInvoice?.externalRefId }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Type</div>
          <div class="details-value">{{ selectedInvoice?.billingType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Name</div>
          <div class="details-value">{{ selectedInvoice?.billingName }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing GSTIN</div>
          <div class="details-value">{{ selectedInvoice?.billingGSTIN }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Phone</div>
          <div class="details-value">{{ selectedInvoice?.billingPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Address</div>
          <div class="details-value">{{ selectedInvoice?.billingAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Type</div>
          <div class="details-value">{{ selectedInvoice?.pickupType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Name</div>
          <div class="details-value">{{ selectedInvoice?.pickupName }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Phone</div>
          <div class="details-value">{{ selectedInvoice?.pickupPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Address</div>
          <div class="details-value">{{ selectedInvoice?.pickupAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Pincode</div>
          <div class="details-value">{{ selectedInvoice?.pickupPincode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Type</div>
          <div class="details-value">{{ selectedInvoice?.deliveryType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery To</div>
          <div class="details-value">{{ selectedInvoice?.deliveryName || selectedInvoice?.deliveryID }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Phone</div>
          <div class="details-value">{{ selectedInvoice?.deliveryPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Address</div>
          <div class="details-value">{{ selectedInvoice?.deliveryAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Pincode</div>
          <div class="details-value">{{ selectedInvoice?.deliveryPincode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Products</div>
          <div class="details-value">{{ selectedInvoice?.products?.length || 0 }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Status</div>
          <div class="details-value">{{ selectedInvoice?.shipmentStatus }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Final Amount</div>
          <div class="details-value">{{ selectedInvoice?.finalAmount }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - ODC</div>
          <div class="details-value">{{ selectedInvoice?.charges?.odc }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Unloading</div>
          <div class="details-value">{{ selectedInvoice?.charges?.unloading }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Docket</div>
          <div class="details-value">{{ selectedInvoice?.charges?.docket }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Other</div>
          <div class="details-value">{{ selectedInvoice?.charges?.other }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - CCC</div>
          <div class="details-value">{{ selectedInvoice?.charges?.ccc }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Consignor Discount</div>
          <div class="details-value">{{ selectedInvoice?.charges?.consignorDiscount }}</div>
        </div>
      </div>

      <div class="details-products">
        <div class="details-invoice">
          <h3>Products</h3>
          <ul class="details-product-list">
            <li *ngFor="let p of selectedInvoice?.products">
              <span class="product-name">{{ p.productName || p.type }}</span>
              <span class="product-meta">Qty: {{ p.quantity || p.amount }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal for Editing -->
  <div class="popup-overlay" *ngIf="showEditPopup">
    <div class="popup-content">
      <h2>Edit Details</h2>
      
      <form>
        <div class="form-row">
          <label for="consignor">Consignor:</label>
          <input type="text" id="consignor" [(ngModel)]="editingInvoice.consignor" name="consignor" />
        </div>

        <div class="form-row">
          <label for="deliveryAddress">Delivery Address:</label>
          <textarea id="deliveryAddress" [(ngModel)]="editingInvoice.deliveryAddress" name="deliveryAddress"></textarea>
        </div>

        <div class="form-row">
          <label for="status">Status:</label>
          <select id="status" [(ngModel)]="editingInvoice.shipmentStatus" name="status">
            <option value="Pending">Pending</option>
            <option value="Delivered">Delivered</option>
            <option value="Invoiced">Invoiced</option>
          </select>
        </div>

        <div class="form-row" *ngIf="editingInvoice?.invoices?.length">
          <h3>Delivered/Pre-Invoice & Products</h3>
          <div class="invoice-block" *ngFor="let inv of editingInvoice.invoices; let i = index">
            <div class="invoice-title">Pre-Invoice #{{ inv.number }}</div>
            <table class="product-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Total Qty</th>
                  <th>Delivered Qty</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of inv.products; let p = index">
                  <td>{{ product.type || product.productName }}</td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      [min]="product.deliveredstock || 0"
                      [(ngModel)]="product.amount"
                      name="total-{{ i }}-{{ p }}"
                      (ngModelChange)="onTotalQtyChange(inv, product, $event)"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      [(ngModel)]="product.deliveredstock"
                      name="delivered-{{ i }}-{{ p }}"
                      (ngModelChange)="onDeliveredQtyChange(inv, product, $event)"
                    />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Buttons -->
        <div class="button-section">
          <button type="button" (click)="saveInvoiceEdit()">Save</button>
          <button type="button" (click)="cancelEdit()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="popup-overlay" *ngIf="showGenerateInvoicePopup">
    <div class="popup-content confirm-popup">
      <h2>Generate Invoice</h2>
      <p>Generate invoice for the selected consignments?</p>
      <div class="button-section confirm-actions">
        <button type="button" (click)="confirmGenerateInvoice()">Okay</button>
        <button type="button" (click)="cancelGenerateInvoice()">Cancel</button>
      </div>
    </div>
  </div>
</div>
