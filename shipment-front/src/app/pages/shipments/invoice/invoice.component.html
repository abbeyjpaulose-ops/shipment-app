<div class="invoice-container">
  <h2>ðŸ“¦ Delivered/Pre-Invoice Management</h2>

  <!-- Delivered Table -->
<div class="invoice-sections">
<div class="invoice-section" *ngIf="hasSpecificBranchSelection()">
  <h3>Consignments</h3>
  <div class="action-bar">
    <button (click)="invoiceSelected()">Generate Pre-Invoice</button>
  </div>
  <div class="consignment-filters">
    <label>Search by billing entity</label>
    <input
      type="text"
      placeholder="Search by billing entity"
      [(ngModel)]="consignmentBillingSearch"
      (input)="applyFilters()" />
  </div>
  <table class="invoice-table">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleAllDeliveredSelection($event)" /></th>
        <th>Consignment No.</th>
        <th>Status</th>
        <th>Billing Entity</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let inv of filteredDelivered" [class.selected]="inv.selected">
        <td>
          <input
            type="checkbox"
            [(ngModel)]="inv.selected"
            (click)="$event.stopPropagation()"
            [disabled]="isInvoicePreInvoiced(inv)"
          />
        </td>
        <td (click)="openInvoiceDetails(inv)">{{ inv.consignmentNumber }}</td>
        <td>{{ inv.invoiceStatus }}</td>
        <td>{{ getBillingEntity(inv) }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="invoice-section">
  <div class="invoice-block" *ngIf="hasSpecificBranchSelection()">
    <div class="invoice-title">Pre-Invoice Records</div>
    <div class="action-bar">
      <button class="delete-btn" (click)="deletePreInvoices()">Delete</button>
      <button (click)="openGenerateInvoicePopup('preInvoices')">Generate Invoice</button>
      <button class="print-btn" (click)="printPreInvoices()">Print Pre-Invoice</button>
    </div>
    <div class="preinvoice-filters">
      <label>Category</label>
      <select [(ngModel)]="preInvoiceCategoryFilter" (change)="applyFilters()">
        <option value="all">All</option>
        <option value="B">B2B</option>
        <option value="C">B2C</option>
      </select>
    </div>
    <table class="invoice-table">
      <thead>
        <tr>
          <th><input type="checkbox" (change)="toggleAllPreInvoicesSelection($event)" /></th>
          <th>Pre-Invoice No.</th>
          <th>Billing Entity</th>
          <th>Consignment No: (Total Taxable)</th>
          <th>Final Amount</th>
          <th>Status</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let pre of filteredPreInvoices" (click)="openPreInvoicePreview(pre)">
          <td>
            <input
              type="checkbox"
              [(ngModel)]="pre.selected"
              (click)="$event.stopPropagation()"
              [disabled]="isPreInvoiceLocked(pre)"
            />
          </td>
          <td>{{ getPreInvoiceDisplayNumber(pre) }}</td>
          <td>{{ getPreInvoiceBillingEntity(pre) }}</td>
          <td>
            <div *ngFor="let c of pre.consignments">
              {{ c.consignmentNumber }} ({{ c.taxableValue || 0 }})
            </div>
          </td>
          <td>{{ getPreInvoiceFinalTotal(pre) | number:'1.0-2' }}</td>
          <td>{{ pre.status }}</td>
          <td>{{ pre.createdAt | date:'short' }}</td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="!filteredPreInvoices.length">No pre-invoices found.</p>
  </div>
</div>

<div class="invoice-section full-width">
  <div class="invoice-title">Generated Invoices</div>
  <div class="action-bar">
    <input
      type="text"
      placeholder="Search by invoice, client, GSTIN, or consignment"
      [(ngModel)]="generatedInvoiceSearch"
      (input)="applyGeneratedInvoiceFilters()" />
    <button type="button" (click)="loadGeneratedInvoices()">Refresh</button>
  </div>
  <p *ngIf="generatedInvoiceLoading">Loading generated invoices...</p>
  <table class="invoice-table" *ngIf="!generatedInvoiceLoading">
    <thead>
      <tr>
        <th>Invoice #</th>
        <th>Client</th>
        <th>GSTIN</th>
        <th>Billing Address</th>
        <th>Consignments</th>
        <th>Total</th>
        <th>Status</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let inv of filteredGeneratedInvoices">
        <td>{{ inv.invoiceDisplayNumber || inv.invoiceCode || inv.invoiceNumber }}</td>
        <td>{{ inv.clientName || '-' }}</td>
        <td>{{ inv.clientGSTIN || '-' }}</td>
        <td class="wrap-cell">{{ inv.billingAddress || '-' }}</td>
        <td>
          <div class="consignment-list">
            <span *ngFor="let c of inv.consignments">{{ c.consignmentNumber }}</span>
          </div>
        </td>
        <td>{{ getGeneratedInvoiceTotal(inv) | number:'1.0-2' }}</td>
        <td>{{ inv.status || 'active' }}</td>
        <td>{{ inv.createdAt | date:'short' }}</td>
      </tr>
      <tr *ngIf="!filteredGeneratedInvoices.length">
        <td colspan="8">No generated invoices found.</td>
      </tr>
    </tbody>
  </table>
</div>
</div>
<!-- Modal for invoice details -->
  <div class="modal details-modal" *ngIf="showInvoiceModal">
    <div class="modal-content details-content">
      <button class="details-close" type="button" (click)="closeInvoiceDetails()">&times;</button>
      <div class="details-header">
        <div>
          <h2>Consignment Details</h2>
          <p class="details-sub">Consignment #{{ selectedInvoice?.consignmentNumber }}</p>
        </div>
        <span class="details-status">{{ getDisplayStatus(selectedInvoice?.shipmentStatus) }}</span>
      </div>

      <div class="details-grid">
        <div class="details-item">
          <div class="details-label">Consignor</div>
          <div class="details-value">{{ selectedInvoice?.consignor }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor GST</div>
          <div class="details-value">{{ selectedInvoice?.consignorGST }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor Phone</div>
          <div class="details-value">{{ selectedInvoice?.consignorPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignor Address</div>
          <div class="details-value">{{ selectedInvoice?.consignorAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee</div>
          <div class="details-value">{{ selectedInvoice?.consignee }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee GST</div>
          <div class="details-value">{{ selectedInvoice?.consigneeGST }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee Phone</div>
          <div class="details-value">{{ selectedInvoice?.consigneePhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Consignee Address</div>
          <div class="details-value">{{ selectedInvoice?.consigneeAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Branch</div>
          <div class="details-value">{{ selectedInvoice?.branch }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Date</div>
          <div class="details-value">{{ selectedInvoice?.date | date:'short' }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Payment Mode</div>
          <div class="details-value">{{ selectedInvoice?.paymentMode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">External Ref ID</div>
          <div class="details-value">{{ selectedInvoice?.externalRefId }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Type</div>
          <div class="details-value">{{ selectedInvoice?.billingType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Name</div>
          <div class="details-value">{{ selectedInvoice?.billingName }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing GSTIN</div>
          <div class="details-value">{{ selectedInvoice?.billingGSTIN }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Phone</div>
          <div class="details-value">{{ selectedInvoice?.billingPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Billing Address</div>
          <div class="details-value">{{ selectedInvoice?.billingAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Type</div>
          <div class="details-value">{{ selectedInvoice?.pickupType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Name</div>
          <div class="details-value">{{ selectedInvoice?.pickupName }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Phone</div>
          <div class="details-value">{{ selectedInvoice?.pickupPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Address</div>
          <div class="details-value">{{ selectedInvoice?.pickupAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Pickup Pincode</div>
          <div class="details-value">{{ selectedInvoice?.pickupPincode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Type</div>
          <div class="details-value">{{ selectedInvoice?.deliveryType }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery To</div>
          <div class="details-value">{{ selectedInvoice?.deliveryName || selectedInvoice?.deliveryID }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Phone</div>
          <div class="details-value">{{ selectedInvoice?.deliveryPhone }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Address</div>
          <div class="details-value">{{ selectedInvoice?.deliveryAddress }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Delivery Pincode</div>
          <div class="details-value">{{ selectedInvoice?.deliveryPincode }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Products</div>
          <div class="details-value">{{ selectedInvoice?.products?.length || 0 }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Status</div>
          <div class="details-value">{{ getDisplayStatus(selectedInvoice?.shipmentStatus) }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Final Amount</div>
          <div class="details-value">{{ selectedInvoice?.finalAmount }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - ODC</div>
          <div class="details-value">{{ selectedInvoice?.charges?.odc }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Unloading</div>
          <div class="details-value">{{ selectedInvoice?.charges?.unloading }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Docket</div>
          <div class="details-value">{{ selectedInvoice?.charges?.docket }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Other</div>
          <div class="details-value">{{ selectedInvoice?.charges?.other }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - CCC</div>
          <div class="details-value">{{ selectedInvoice?.charges?.ccc }}</div>
        </div>
        <div class="details-item">
          <div class="details-label">Charges - Consignor Discount</div>
          <div class="details-value">{{ selectedInvoice?.charges?.consignorDiscount }}</div>
        </div>
      </div>

      <div class="details-products">
        <div class="details-invoice">
          <h3>Products</h3>
          <ul class="details-product-list">
            <li *ngFor="let p of selectedInvoice?.products">
              <span class="product-name">{{ p.productName || p.type }}</span>
              <span class="product-meta">Qty: {{ p.quantity || p.amount }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal for Editing -->
  <div class="popup-overlay" *ngIf="showEditPopup">
    <div class="popup-content">
      <h2>Edit Details</h2>
      
      <form>
        <div class="form-row">
          <label for="consignor">Consignor:</label>
          <input type="text" id="consignor" [(ngModel)]="editingInvoice.consignor" name="consignor" />
        </div>

        <div class="form-row">
          <label for="deliveryAddress">Delivery Address:</label>
          <textarea id="deliveryAddress" [(ngModel)]="editingInvoice.deliveryAddress" name="deliveryAddress"></textarea>
        </div>

        <div class="form-row">
          <label for="status">Status:</label>
          <select id="status" [(ngModel)]="editingInvoice.shipmentStatus" name="status">
            <option value="Pending">Pending</option>
            <option value="Delivered">Delivered</option>
            <option value="Invoiced">Invoiced</option>
          </select>
        </div>

        <div class="form-row" *ngIf="editingInvoice?.invoices?.length">
          <h3>Delivered/Pre-Invoice & Products</h3>
          <div class="invoice-block" *ngFor="let inv of editingInvoice.invoices; let i = index">
            <div class="invoice-title">Pre-Invoice #{{ inv.number }}</div>
            <table class="product-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Total Qty</th>
                  <th>Delivered Qty</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of inv.products; let p = index">
                  <td>{{ product.type || product.productName }}</td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      [min]="product.deliveredstock || 0"
                      [(ngModel)]="product.amount"
                      name="total-{{ i }}-{{ p }}"
                      (ngModelChange)="onTotalQtyChange(inv, product, $event)"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      [(ngModel)]="product.deliveredstock"
                      name="delivered-{{ i }}-{{ p }}"
                      (ngModelChange)="onDeliveredQtyChange(inv, product, $event)"
                    />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Buttons -->
        <div class="button-section">
          <button type="button" (click)="saveInvoiceEdit()">Save</button>
          <button type="button" (click)="cancelEdit()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="popup-overlay" *ngIf="showGenerateInvoicePopup">
    <div class="popup-content confirm-popup">
      <h2>Generate Invoice</h2>
      <p>Generate invoice for the selected consignments?</p>
      <div class="button-section confirm-actions">
        <button type="button" (click)="confirmGenerateInvoice()">Okay</button>
        <button type="button" (click)="cancelGenerateInvoice()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal details-modal" *ngIf="showPreInvoicePreview">
    <div class="modal-content preview-content">
      <button class="details-close" type="button" (click)="closePreInvoicePreview()">&times;</button>
      <div class="preview-body" [innerHTML]="preInvoicePreviewHtml"></div>
    </div>
  </div>
</div>
