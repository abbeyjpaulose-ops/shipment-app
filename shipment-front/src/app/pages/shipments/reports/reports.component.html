<div class="reports-page">
  <div class="header">
    <div>
      <h2>Generated Invoices</h2>
      <p class="subtitle">Fiscal Year: {{ fiscalYear || 'Current' }}</p>
      <p class="subtitle">GST Percent: {{ gstPercent || 0 }}%</p>
    </div>
    <div class="controls">
      <select [(ngModel)]="fiscalYearInput">
        <option value="">Current Fiscal Year</option>
        <option *ngFor="let fy of fiscalYears" [value]="fy">{{ fy }}</option>
      </select>
      <select [(ngModel)]="categoryFilter" (change)="applyFilters()">
        <option value="all">All Categories</option>
        <option value="B">B2B</option>
        <option value="C">B2C</option>
      </select>
      <input
        type="text"
        placeholder="Search by invoice, client, GSTIN, or consignment"
        [(ngModel)]="searchText"
        (input)="applyFilters()"
      />
      <button type="button" (click)="loadInvoices()">Apply FY</button>
      <button type="button" (click)="printSelectedInvoices()" [disabled]="!selectedCount">Print</button>
      <button
        type="button"
        class="delete-btn"
        (click)="openDeletePopupForSelected()"
        [disabled]="!hasDeletableSelection()"
      >
        Delete
      </button>
      <span class="selected-count" *ngIf="selectedCount">Selected: {{ selectedCount }}</span>
    </div>
  </div>

  <div class="status" *ngIf="loading">Loading invoices...</div>

  <div class="table-wrap" *ngIf="!loading">
    <table>
      <thead>
        <tr>
          <th class="check-col">
            <input type="checkbox" (change)="toggleAllSelection($event)" />
          </th>
          <th>Invoice #</th>
          <th>Client</th>
          <th>GSTIN</th>
          <th>Billing Address</th>
          <th>Consignments</th>
          <th>Status</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let inv of filteredInvoices">
          <td class="check-col">
            <input type="checkbox" [(ngModel)]="inv.selected" [disabled]="isDeleted(inv)" />
          </td>
          <td>{{ inv.invoiceDisplayNumber || inv.invoiceCode || inv.invoiceNumber }}</td>
          <td>{{ inv.clientName || '-' }}</td>
          <td>{{ inv.clientGSTIN || '-' }}</td>
          <td class="address-cell">{{ inv.billingAddress || '-' }}</td>
          <td>
            <div class="consignment-list">
              <span *ngFor="let c of inv.consignments">{{ c.consignmentNumber }}</span>
            </div>
          </td>
          <td>
            <span
              class="status-pill"
              [class.cancelled]="(inv.status || '') === 'cancelled' || (inv.status || '') === 'deleted'"
            >
              {{ inv.status || 'active' }}
            </span>
          </td>
          <td>
            <button
              type="button"
              class="payment-btn"
              [class.cancel]="(inv.status || '').toLowerCase() === 'paid'"
              (click)="togglePaymentStatus(inv)"
              [disabled]="paymentUpdatingId === inv._id || isDeleted(inv)"
              *ngIf="!isDeleted(inv)"
            >
              {{ (inv.status || '').toLowerCase() === 'paid' ? 'Payment got cancelled' : 'Paid' }}
            </button>
          </td>
        </tr>
        <tr *ngIf="!filteredInvoices.length">
          <td colspan="8" class="empty">No generated invoices found.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="popup-overlay" *ngIf="showDeletePopup">
  <div class="popup-card">
    <h3>Delete selected generated invoices?</h3>
    <p>
      This action cannot be reverted.
      {{ deleteTargets.length }} invoice{{ deleteTargets.length === 1 ? '' : 's' }} will be marked as deleted.
    </p>
    <div class="popup-actions">
      <button type="button" (click)="cancelDelete()">Keep</button>
      <button type="button" class="danger" (click)="confirmDelete()" [disabled]="deleting">
        {{ deleting ? 'Cancelling...' : 'Confirm delete' }}
      </button>
    </div>
  </div>
</div>
