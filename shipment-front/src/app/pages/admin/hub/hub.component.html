<div class="hubs-container">
  <h2>Manage Hubs</h2>

  <!-- Add Hub Form -->
  <div class="add-hub-form">
    <input [(ngModel)]="newHub.hubName" placeholder="Hub Name" required>
    <input [(ngModel)]="newHub.address" placeholder="Address" required>
    <input [(ngModel)]="newHub.city" placeholder="City">
    <input [(ngModel)]="newHub.state" placeholder="State">
    <input [(ngModel)]="newHub.pinCode" placeholder="Pin Code">
    <input [(ngModel)]="newHub.GSTIN" placeholder="GSTIN" required>
    <input [(ngModel)]="newHub.phoneNum" placeholder="Phone Number" required>
    <input [(ngModel)]="newHub.perRev" placeholder="% of Revenue" required>

    <!-- Delivery / Pickup Addresses (each address contains vehicles) -->
    <div class="delivery-wrapper">
      <label>Delivery / Pickup Addresses</label>

      <div *ngFor="let addr of newHub.deliveryAddresses; let a = index" class="addr-block">
        <div class="addr-row">
          <input [(ngModel)]="addr.location" placeholder="Address / Location" />

          <button *ngIf="newHub.deliveryAddresses.length > 1"
                  class="delete-btn"
                  (click)="removeAddress(a)">ğŸ—‘ï¸</button>
        </div>

        <!-- Vehicles for this delivery address -->
        <div class="vehicles-for-address">
          <label>Vehicles for this address</label>

          <div *ngFor="let v of addr.vehicles; let vIdx = index" class="vehicle-row">
            <input [(ngModel)]="addr.vehicles[vIdx].vehicleNo" placeholder="Vehicle No" />
            <input [(ngModel)]="addr.vehicles[vIdx].driverPhone" placeholder="Driver Phone" />
            <button *ngIf="addr.vehicles.length > 1"
                    class="delete-btn"
                    (click)="removeVehicle(a, vIdx)">ğŸ—‘ï¸</button>
          </div>

          <button class="add-vehicle-btn" (click)="addVehicle(a)">+ Add Vehicle</button>
        </div>
      </div>

      <button class="add-addr-btn" (click)="addAddress()">+ Add Address</button>
    </div>

    <button class="add-btn" (click)="addHub()">+ Add Hub</button>
  </div>


  <!-- Hubs List Table -->
  <div class="hubs-table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Hub Name</th>
          <th>Address</th>
          <th>City</th>
          <th>Phone</th>
          <th>GSTIN</th>
          <th>Delivery / Pickup (with Vehicles)</th>
          <th>% of Revenue</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let h of hubs">

          <!-- Hub Name -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.hubName }}</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.hubName" />
          </td>

          <!-- Hub Address -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.address }}</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.address" />
          </td>

          <!-- City -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.city }}</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.city" />
          </td>

          <!-- Phone -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.phoneNum }}</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.phoneNum" />
          </td>

          <!-- GSTIN -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.GSTIN }}</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.GSTIN" />
          </td>

          <!-- Delivery / Pickup Addresses column (each with nested vehicles) -->
          <td>

            <!-- VIEW MODE: show each address and its vehicles -->
            <div *ngIf="editingHub?._id !== h._id" class="addr-list-view">
              <div *ngFor="let addr of h.deliveryAddresses" class="addr-view-block">
                <div class="addr-title">ğŸ“ {{ addr.location }}</div>
                <div *ngIf="addr.vehicles?.length" class="vehicles-list-view">
                  <div *ngFor="let v of addr.vehicles" class="vehicle-view">
                    ğŸš› {{ v.vehicleNo }} â€” ğŸ“ {{ v.driverPhone }}
                  </div>
                </div>
                <div *ngIf="!addr.vehicles || addr.vehicles.length === 0" class="no-vehicles">
                  â€” No vehicles assigned â€”
                </div>
              </div>
            </div>

            <!-- EDIT MODE: edit addresses and vehicles inline -->
            <div *ngIf="editingHub?._id === h._id" class="addr-list-edit">
              <div *ngFor="let addr of editingHub.deliveryAddresses; let ai = index" class="addr-edit-block">
                <div class="addr-row">
                  <input [(ngModel)]="editingHub.deliveryAddresses[ai].location" placeholder="Address / Location" />
                  <button *ngIf="editingHub.deliveryAddresses.length > 1"
                          class="delete-btn"
                          (click)="removeAddressEdit(ai)">ğŸ—‘ï¸</button>
                </div>

                <div class="vehicles-for-address-edit">
                  <label>Vehicles</label>
                  <div *ngFor="let v of addr.vehicles; let vi = index" class="vehicle-row">
                    <input [(ngModel)]="editingHub.deliveryAddresses[ai].vehicles[vi].vehicleNo" placeholder="Vehicle No" />
                    <input [(ngModel)]="editingHub.deliveryAddresses[ai].vehicles[vi].driverPhone" placeholder="Driver Phone" />
                    <button *ngIf="editingHub.deliveryAddresses[ai].vehicles.length > 1"
                            class="delete-btn"
                            (click)="removeVehicleEdit(ai, vi)">ğŸ—‘ï¸</button>
                  </div>

                  <button class="add-vehicle-btn" (click)="addVehicleEdit(ai)">+ Add Vehicle</button>
                </div>
              </div>

              <button class="add-addr-btn" (click)="addAddressEdit()">+ Add Address</button>
            </div>
          </td>

          <!-- % of Revenue -->
          <td>
            <span *ngIf="editingHub?._id !== h._id">{{ h.perRev }}%</span>
            <input *ngIf="editingHub?._id === h._id" [(ngModel)]="editingHub.perRev" />
          </td>

          <!-- Status -->
          <td>
            <button (click)="toggleStatus(h)"
                    [ngClass]="{ 'active-btn': h.status === 'active', 'inactive-btn': h.status === 'inactive' }">
              {{ h.status === 'active' ? 'Active' : 'Inactive' }}
            </button>
          </td>

          <!-- Actions -->
          <td>
            <button *ngIf="editingHub?._id !== h._id" (click)="editHub(h)">Edit</button>
            <button *ngIf="editingHub?._id === h._id" (click)="saveEdit()">Save</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
