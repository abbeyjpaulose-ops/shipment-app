<div class="hubs-container">
  <h2>Manage Hubs</h2>

  <!-- Add Hub Button -->
  <button class="add-hub-btn" type="button" (click)="openAddHubPopup()">+ Add Hub</button>

  <!-- Add Hub Popup -->
  <div class="modal" *ngIf="showAddHubPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddHubPopup()">&times;</span>
      <h3>Add Hub</h3>
      <div class="add-hub-form">
        <input [(ngModel)]="newHub.hubName" (ngModelChange)="handleHubNameChange()" placeholder="Hub Name" required>
        <input [(ngModel)]="newHub.address" placeholder="Address" required>
        <input [(ngModel)]="newHub.city" placeholder="City">
        <input [(ngModel)]="newHub.state" placeholder="State">
        <input [(ngModel)]="newHub.pinCode" placeholder="Pin Code">
        <input [(ngModel)]="newHub.phoneNum" placeholder="Phone Number" required>
        <input [(ngModel)]="newHub.perRev" placeholder="% of Revenue" required>

        <!-- Delivery / Pickup Addresses (each address contains vehicles) -->
        <div class="delivery-wrapper">
          <label>Delivery / Pickup Addresses</label>

          <div *ngFor="let addr of newHub.deliveryAddresses; let a = index" class="addr-block">
            <div class="addr-row">
              <input [(ngModel)]="addr.location" placeholder="Address / Location" />

              <button *ngIf="newHub.deliveryAddresses.length > 1"
                      class="delete-btn"
                      (click)="removeAddress(a)">dY-`â€¹,?</button>
            </div>

            <!-- Vehicles for this delivery address -->
            <div class="vehicles-for-address">
              <label>Vehicles for this address</label>

              <div *ngFor="let v of addr.vehicles; let vIdx = index" class="vehicle-row">
                <input [(ngModel)]="addr.vehicles[vIdx].vehicleNo" placeholder="Vehicle No" />
                <input [(ngModel)]="addr.vehicles[vIdx].driverPhone" placeholder="Driver Phone" />
                <span>{{ addr.vehicles[vIdx].vehicleStatus || 'online' }}</span>
                <select [(ngModel)]="addr.vehicles[vIdx].currentBranch">
                  <option *ngIf="!newHub.hubName" [ngValue]="''" disabled>Select Current Branch</option>
                  <option *ngFor="let option of getHubBranchOptions()" [ngValue]="option">{{ option }}</option>
                </select>
                <button *ngIf="addr.vehicles.length > 1"
                        class="delete-btn"
                        (click)="removeVehicle(a, vIdx)">dY-`â€¹,?</button>
              </div>

              <button class="add-vehicle-btn" type="button" (click)="addVehicle(a)">+ Add Vehicle</button>
            </div>
          </div>

          <button class="add-addr-btn" type="button" (click)="addAddress()">+ Add Address</button>
        </div>

        <button class="add-btn" type="button" (click)="addHub()">+ Add Hub</button>
      </div>
    </div>
  </div>

  <!-- Edit Hub Popup -->
  <div class="modal" *ngIf="showEditHubPopup && editingHub">
    <div class="modal-content">
      <span class="close" (click)="closeEditHubPopup()">&times;</span>
      <h3>Edit Hub</h3>
      <div class="add-hub-form">
        <input [(ngModel)]="editingHub.hubName" placeholder="Hub Name" required>
        <input [(ngModel)]="editingHub.address" placeholder="Address" required>
        <input [(ngModel)]="editingHub.city" placeholder="City">
        <input [(ngModel)]="editingHub.state" placeholder="State">
        <input [(ngModel)]="editingHub.pinCode" placeholder="Pin Code">
        <input [(ngModel)]="editingHub.phoneNum" placeholder="Phone Number" required>
        <input [(ngModel)]="editingHub.perRev" placeholder="% of Revenue" required>

        <div class="delivery-wrapper">
          <label>Delivery / Pickup Addresses</label>

          <div *ngFor="let addr of editingHub.deliveryAddresses; let ai = index" class="addr-block">
            <div class="addr-row">
              <input [(ngModel)]="editingHub.deliveryAddresses[ai].location" placeholder="Address / Location" />
              <button *ngIf="editingHub.deliveryAddresses.length > 1"
                      class="delete-btn"
                      (click)="removeAddressEdit(ai)">dY-`ƒ?1,?</button>
            </div>

            <div class="vehicles-for-address">
              <label>Vehicles for this address</label>
              <div *ngFor="let v of addr.vehicles; let vi = index" class="vehicle-row">
                <input [(ngModel)]="editingHub.deliveryAddresses[ai].vehicles[vi].vehicleNo" placeholder="Vehicle No" />
                <input [(ngModel)]="editingHub.deliveryAddresses[ai].vehicles[vi].driverPhone" placeholder="Driver Phone" />
                <button type="button" (click)="toggleEditVehicleStatus(editingHub.deliveryAddresses[ai].vehicles[vi])">
                  {{ (editingHub.deliveryAddresses[ai].vehicles[vi].vehicleStatus || 'online') === 'offline' ? 'offline' : 'online' }}
                </button>
                <div class="current-branch-inline">
                  <label>Current Branch</label>
                  <select [(ngModel)]="editingHub.deliveryAddresses[ai].vehicles[vi].currentBranch">
                    <option *ngFor="let option of getEditHubBranchOptions(editingHub.deliveryAddresses[ai].vehicles[vi].currentBranch)" [ngValue]="option">{{ option }}</option>
                  </select>
                </div>
                <button *ngIf="editingHub.deliveryAddresses[ai].vehicles.length > 1"
                        class="delete-btn"
                        (click)="removeVehicleEdit(ai, vi)">dY-`ƒ?1,?</button>
              </div>

              <button class="add-vehicle-btn" type="button" (click)="addVehicleEdit(ai)">+ Add Vehicle</button>
            </div>
          </div>

          <button class="add-addr-btn" type="button" (click)="addAddressEdit()">+ Add Address</button>
        </div>

        <div class="terminal-buttons">
          <button class="add-btn" type="button" (click)="saveEdit()">Save</button>
          <button type="button" (click)="closeEditHubPopup()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hubs List Table -->
  <div class="hubs-table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Hub Name</th>
          <th>Address</th>
          <th>City</th>
          <th>Phone</th>
          <th>Delivery / Pickup (with Vehicles)</th>
          <th>% of Revenue</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let h of hubs">

          <!-- Hub Name -->
          <td>
            <span>{{ h.hubName }}</span>
          </td>

          <!-- Hub Address -->
          <td>
            <span>{{ h.address }}</span>
          </td>

          <!-- City -->
          <td>
            <span>{{ h.city }}</span>
          </td>

          <!-- Phone -->
          <td>
            <span>{{ h.phoneNum }}</span>
          </td>

          <!-- Delivery / Pickup Addresses column (each with nested vehicles) -->
          <td>
            <div class="addr-list-view">
              <div *ngFor="let addr of h.deliveryAddresses" class="addr-view-block">
                <div class="addr-title">dY"? {{ addr.location }}</div>
                <ng-container *ngIf="getFilteredVehicles(addr.vehicles) as filtered">
                  <div *ngIf="filtered.length" class="vehicles-list-view">
                    <div *ngFor="let v of filtered" class="vehicle-view">
                      dYs> {{ v.vehicleNo }} ’'?" dY"z {{ v.driverPhone }}
                    </div>
                  </div>
                  <div *ngIf="!filtered.length" class="no-vehicles">
                    ’'?" No vehicles assigned ’'?"
                  </div>
                </ng-container>
              </div>
            </div>
          </td>

          <!-- % of Revenue -->
          <td>
            <span>{{ h.perRev }}%</span>
          </td>

          <!-- Status -->
          <td>
            <button (click)="toggleStatus(h)"
                    [ngClass]="{ 'active-btn': h.status === 'active', 'inactive-btn': h.status === 'inactive' }">
              {{ h.status === 'active' ? 'Active' : 'Inactive' }}
            </button>
          </td>

          <!-- Actions -->
          <td>
            <button (click)="editHub(h)">Edit</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

