<div class="tpartner-container">
  <h2>Transport Partners</h2>

  <button class="add-partner-btn" type="button" (click)="openAddPartnerPopup()">+ Add Partner</button>

  <div class="modal" *ngIf="showAddPartnerPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddPartnerPopup()">&times;</span>
      <h3>Add Partner</h3>
      <div class="add-partner-form">
        <div class="form-row">
          <input [(ngModel)]="newPartner.partnerName" placeholder="Partner Name*" required>
          <input [(ngModel)]="newPartner.GSTIN" placeholder="GSTIN*" required>
        </div>

        <div class="form-row">
          <input [(ngModel)]="newPartner.address" placeholder="Address*" required>
          <input [(ngModel)]="newPartner.city" placeholder="City">
        </div>

        <div class="form-row">
          <input [(ngModel)]="newPartner.state" placeholder="State">
          <input [(ngModel)]="newPartner.pinCode" placeholder="Pin Code">
        </div>

        <div class="vehicle-tag" *ngFor="let v of newPartner.vehicleNumbers; let i=index">
          {{ v.number }} | {{ v.phone }} | {{ v.rateValue || 0 }} / {{ v.rateType === 'km' ? 'Km' : 'Day' }}
          <button type="button" (click)="startEditNewVehicle(i)">Edit</button>
          <button type="button" (click)="removeVehicle(i)">Delete</button>
        </div>

        <div class="vehicle-entry">
          <input [(ngModel)]="newVehicle.number" placeholder="Vehicle Number">
          <input [(ngModel)]="newVehicle.phone" placeholder="Driver Phone">
          <select [(ngModel)]="newVehicle.rateType" required>
            <option value="km">Rate / Km</option>
            <option value="day">Rate / Day</option>
          </select>
          <input type="number" [(ngModel)]="newVehicle.rateValue" placeholder="Rate Value*" required>
          <button type="button" (click)="addVehicle()">
            {{ editingNewVehicleIndex !== null ? 'Update Vehicle' : '+ Vehicle' }}
          </button>
        </div>

        <button class="btn-add" type="button" (click)="addPartner()">+ Add Partner</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="showEditPartnerPopup">
    <div class="modal-content">
      <span class="close" (click)="closeEditPartnerPopup()">&times;</span>
      <h3>Edit Partner</h3>
      <div class="add-partner-form" *ngIf="editing">
        <div class="form-row">
          <input [(ngModel)]="editing.partnerName" placeholder="Partner Name*" required>
          <input [(ngModel)]="editing.GSTIN" placeholder="GSTIN*" required>
        </div>

        <div class="form-row">
          <input [(ngModel)]="editing.address" placeholder="Address*" required>
          <input [(ngModel)]="editing.city" placeholder="City">
        </div>

        <div class="form-row">
          <input [(ngModel)]="editing.state" placeholder="State">
          <input [(ngModel)]="editing.pinCode" placeholder="Pin Code">
        </div>

        <div class="vehicle-tag" *ngFor="let v of editing.vehicleNumbers; let i=index">
          {{ v.number }} | {{ v.phone }} | {{ v.rateValue || 0 }} / {{ v.rateType === 'km' ? 'Km' : 'Day' }}
          <button type="button" (click)="startEditExistingVehicle(i)">Edit</button>
          <button type="button" (click)="removeEditingVehicle(i)">Delete</button>
        </div>

        <div class="vehicle-entry">
          <input [(ngModel)]="editVehicleField.number" placeholder="Vehicle Number">
          <input [(ngModel)]="editVehicleField.phone" placeholder="Driver Phone">
          <select [(ngModel)]="editVehicleField.rateType" required>
            <option value="km">Rate / Km</option>
            <option value="day">Rate / Day</option>
          </select>
          <input type="number" [(ngModel)]="editVehicleField.rateValue" placeholder="Rate Value*" required>
          <button type="button" (click)="addEditingVehicle()">
            {{ editingExistingVehicleIndex !== null ? 'Update Vehicle' : '+ Vehicle' }}
          </button>
        </div>

        <div class="terminal-buttons">
          <button class="btn-add" type="button" (click)="saveEdit()">Save Changes</button>
          <button type="button" (click)="closeEditPartnerPopup()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="tpartner-table-wrapper">
    <table>
      <tr>
        <th>Partner</th>
        <th>GSTIN</th>
        <th>Address</th>
        <th>Vehicles</th>
        <th>Vehicle Status</th>
        <th>Rate</th>
        <th>Status</th>
        <th>Vehicle daily cost</th>
        <th>Actions</th>
      </tr>

      <tr *ngFor="let p of partners">
        <td>
          <span>{{ p.partnerName }}</span>
        </td>

        <td>
          <span>{{ p.GSTIN }}</span>
        </td>

        <td>
          <span>{{ p.address }}</span>
        </td>

        <td>
          <div class="tag" *ngFor="let v of p.vehicleNumbers">
            {{ v.number }} <br> {{ v.phone }}
          </div>
        </td>

        <td>
          <div class="tag" *ngFor="let v of p.vehicleNumbers">
            <ng-container *ngIf="(v.vehicleStatus || 'online') === 'online'; else statusSelect">
              {{ v.vehicleStatus || 'online' }}
            </ng-container>
            <ng-template #statusSelect>
              <select [(ngModel)]="v.vehicleStatus" (change)="updateVehicleStatus(p, v)">
                <option value="scheduled">scheduled</option>
                <option value="delivering">delivering</option>
                <option value="completed">completed</option>
              </select>
            </ng-template>
          </div>
        </td>

        <td>
          <div class="tag" *ngFor="let v of p.vehicleNumbers">
            {{ v.rateValue || 0 }} / {{ v.rateType === 'km' ? 'Km' : 'Day' }}
          </div>
        </td>

        <td>
          <button
            [class.active]="p.status === 'active'"
            [class.inactive]="p.status !== 'active'"
            (click)="toggleStatus(p)">
            {{ p.status === 'active' ? 'Active' : 'Inactive' }}
          </button>
        </td>

        <td>
          <div class="tag" *ngFor="let v of p.vehicleNumbers">
            <input
              type="number"
              min="0"
              [(ngModel)]="v.vehicleDailyCost"
              [disabled]="true"
              placeholder="Daily cost">
          </div>
        </td>

        <td>
          <button (click)="editPartner(p)">Edit</button>
        </td>
      </tr>
    </table>
  </div>
</div>
