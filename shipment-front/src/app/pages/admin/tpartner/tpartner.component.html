<div class="tpartner-container">
  <h2>Transport Partners</h2>

  <button class="add-partner-btn" type="button" (click)="openAddPartnerPopup()">+ Add Partner</button>

  <div class="modal" *ngIf="showAddPartnerPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddPartnerPopup()">&times;</span>
      <h3>Add Partner</h3>
      <div class="add-partner-form">
        <div class="form-row">
          <input [(ngModel)]="newPartner.partnerName" placeholder="Partner Name*" required>
          <input [(ngModel)]="newPartner.GSTIN" placeholder="GSTIN*" required>
        </div>

        <div class="form-row">
          <input [(ngModel)]="newPartner.address" placeholder="Address*" required>
          <input [(ngModel)]="newPartner.city" placeholder="City">
        </div>

        <div class="form-row">
          <input [(ngModel)]="newPartner.state" placeholder="State">
          <input [(ngModel)]="newPartner.pinCode" placeholder="Pin Code">
        </div>

        <div class="form-row">
          <label>Rate Type
            <select [(ngModel)]="newPartner.rateType" required>
              <option value="km">Rate / Km</option>
              <option value="day">Rate / Day</option>
            </select>
          </label>
          <input type="number" [(ngModel)]="newPartner.rateValue" placeholder="Rate Value*" required>
        </div>

        <div class="vehicle-entry">
          <input [(ngModel)]="newVehicle.number" placeholder="Vehicle Number">
          <input [(ngModel)]="newVehicle.phone" placeholder="Driver Phone">
          <button type="button" (click)="addVehicle()">+ Vehicle</button>
        </div>

        <div class="vehicle-tag" *ngFor="let v of newPartner.vehicleNumbers; let i=index">
          {{ v.number }} | {{ v.phone }}
          <span class="delete-tag" (click)="removeVehicle(i)">A-</span>
        </div>

        <button class="btn-add" type="button" (click)="addPartner()">+ Add Partner</button>
      </div>
    </div>
  </div>

  <div class="tpartner-table-wrapper">
    <table>
      <tr>
        <th>Partner</th>
        <th>GSTIN</th>
        <th>Address</th>
        <th>Vehicles</th>
        <th>Rate</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>

      <tr *ngFor="let p of partners">
        <td>
          <span *ngIf="editing?._id !== p._id">{{ p.partnerName }}</span>
          <input *ngIf="editing?._id === p._id" [(ngModel)]="editing.partnerName">
        </td>

        <td>
          <span *ngIf="editing?._id !== p._id">{{ p.GSTIN }}</span>
          <input *ngIf="editing?._id === p._id" [(ngModel)]="editing.GSTIN">
        </td>

        <td>
          <span *ngIf="editing?._id !== p._id">{{ p.address }}</span>
          <div *ngIf="editing?._id === p._id" class="edit-field">
            <input [(ngModel)]="editing.address" placeholder="Address">
            <input [(ngModel)]="editing.city" placeholder="City">
            <input [(ngModel)]="editing.state" placeholder="State">
            <input [(ngModel)]="editing.pinCode" placeholder="Pin Code">
          </div>
        </td>

        <td>
          <div *ngIf="editing?._id !== p._id">
            <div class="tag" *ngFor="let v of p.vehicleNumbers">
              {{ v.number }} <br> {{ v.phone }}
            </div>
          </div>

          <div *ngIf="editing?._id === p._id">
            <div class="tag-edit" *ngFor="let v of editing.vehicleNumbers; let i=index">
              <input [(ngModel)]="editing.vehicleNumbers[i].number">
              <input [(ngModel)]="editing.vehicleNumbers[i].phone">
              <button (click)="removeEditingVehicle(i)">-</button>
            </div>

            <input [(ngModel)]="editVehicleField.number" placeholder="Vehicle">
            <input [(ngModel)]="editVehicleField.phone" placeholder="Phone">
            <button (click)="addEditingVehicle()">+ Veh</button>
          </div>
        </td>

        <td>
          <span *ngIf="editing?._id !== p._id">
            {{ p.rateValue }} / {{ p.rateType === 'km' ? 'Km' : 'Day' }}
          </span>
          <div *ngIf="editing?._id === p._id">
            <select [(ngModel)]="editing.rateType">
              <option value="km">Rate / Km</option>
              <option value="day">Rate / Day</option>
            </select>
            <input type="number" [(ngModel)]="editing.rateValue">
          </div>
        </td>

        <td>
          <button
            [class.active]="p.status === 'active'"
            [class.inactive]="p.status !== 'active'"
            (click)="toggleStatus(p)">
            {{ p.status === 'active' ? 'Active' : 'Inactive' }}
          </button>
        </td>

        <td>
          <button *ngIf="editing?._id !== p._id" (click)="editPartner(p)">Edit</button>
          <button *ngIf="editing?._id === p._id" (click)="saveEdit()">Save</button>
        </td>
      </tr>
    </table>
  </div>
</div>
