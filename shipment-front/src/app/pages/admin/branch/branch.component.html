<div class="branches-container">
  <div class="branches-header">
    <h2>Manage Branches</h2>

    <!-- Add Branch Button -->
    <button class="add-branch-btn" type="button" (click)="openAddBranchPopup()">+ Add Branch</button>
  </div>

  <!-- Add Branch Popup -->
  <div class="modal theme-modal" *ngIf="showAddBranchPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddBranchPopup()">&times;</span>
      <h3>Add Branch</h3>
      <div class="add-branch-form">
        <input [(ngModel)]="newBranch.branchName" (ngModelChange)="handleHeadingBranchChange()" placeholder="Branch Name" required>
        <input
          [(ngModel)]="newBranch.prefix"
          placeholder="Prefix (1-3 letters/numbers)"
          maxlength="3"
          pattern="[A-Za-z0-9]{0,3}"
          title="Up to 3 letters or numbers"
          style="text-transform: uppercase;"
        >
        <input [(ngModel)]="newBranch.address" placeholder="Address" required>
        <input [(ngModel)]="newBranch.city" placeholder="City">
        <input [(ngModel)]="newBranch.state" placeholder="State">
        <input [(ngModel)]="newBranch.pinCode" placeholder="Pin Code">
        <input [(ngModel)]="newBranch.phoneNum" placeholder="Branch Phone" required>

        <!-- Vehicles & Driver Contacts -->
        <div class="vehicle-wrapper">
          <label class="vehicle-label">Vehicles & Drivers</label>
          <table class="vehicle-table">
            <thead>
              <tr>
                <th>Vehicle No.</th>
                <th>Driver Phone</th>
                <th class="vehicle-col-status">Status</th>
                <th>Current Location</th>
                <th class="vehicle-col-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let v of newBranch.vehicles; let i=index">
                <td><input placeholder="Vehicle No." [(ngModel)]="v.vehicleNo"></td>
                <td><input placeholder="Driver Phone" [(ngModel)]="v.driverPhone"></td>
                <td class="vehicle-col-status">
                  <span class="vehicle-status">{{ v.vehicleStatus || 'online' }}</span>
                </td>
                <td>
                  <select [(ngModel)]="v.currentLocationId">
                    <option [ngValue]="''">Use this branch</option>
                    <option *ngFor="let option of getAddBranchOptions()" [ngValue]="option.id">{{ option.label }}</option>
                  </select>
                </td>
                <td class="vehicle-col-actions">
                  <button *ngIf="newBranch.vehicles.length > 1"
                          class="remove-btn"
                          (click)="removeVehicle(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>

          <button class="add-vehicle-btn" type="button" (click)="addVehicle()">+ Add Vehicle</button>
        </div>

        <button class="add-btn" type="button" (click)="addBranch()">+ Add Branch</button>
      </div>
    </div>
  </div>

  <!-- Edit Branch Popup -->
  <div class="modal theme-modal" *ngIf="showEditBranchPopup && editingBranch">
    <div class="modal-content">
      <span class="close" (click)="closeEditBranchPopup()">&times;</span>
      <h3>Edit Branch</h3>
      <div class="add-branch-form">
        <input [(ngModel)]="editingBranch.branchName" placeholder="Branch Name" required>
        <input
          [(ngModel)]="editingBranch.prefix"
          placeholder="Prefix (1-3 letters/numbers)"
          maxlength="3"
          pattern="[A-Za-z0-9]{0,3}"
          title="Up to 3 letters or numbers"
          style="text-transform: uppercase;"
        >
        <input [(ngModel)]="editingBranch.address" placeholder="Address" required>
        <input [(ngModel)]="editingBranch.city" placeholder="City">
        <input [(ngModel)]="editingBranch.state" placeholder="State">
        <input [(ngModel)]="editingBranch.pinCode" placeholder="Pin Code">
        <input [(ngModel)]="editingBranch.phoneNum" placeholder="Branch Phone" required>

        <div class="vehicle-wrapper">
          <label class="vehicle-label">Vehicles & Drivers</label>
          <div *ngFor="let v of editingBranch.vehicles; let i=index" class="vehicle-row">
            <input [(ngModel)]="v.vehicleNo" placeholder="Vehicle No.">
            <input [(ngModel)]="v.driverPhone" placeholder="Driver Phone">
            <button type="button" (click)="toggleEditVehicleStatus(v)">
              {{ (v.vehicleStatus || 'online') === 'offline' ? 'offline' : 'online' }}
            </button>
            <div class="current-branch-inline">
              <label>Current Branch</label>
              <select [(ngModel)]="v.currentLocationId">
                <option *ngFor="let option of getEditBranchOptions(v.currentLocationId)" [ngValue]="option.id">{{ option.label }}</option>
              </select>
            </div>
            <button *ngIf="editingBranch.vehicles.length > 1"
                    class="remove-btn"
                    (click)="removeVehicleEdit(i)">Remove</button>
          </div>
          <button class="add-vehicle-btn" type="button" (click)="addVehicleEdit()">+ Vehicle</button>
        </div>

        <button class="add-btn" type="button" (click)="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- Branches List Table -->
  <div class="branches-table-wrapper">
    <table>
      <tr>
        <th>Branch Name</th>
        <th>Address</th>
        <th>Phone</th>
        <th>Vehicles & Drivers</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>

      <tr *ngFor="let b of branches">

        <!-- Branch Name -->
        <td>{{ b.branchName }}</td>

        <!-- Address -->
        <td>{{ getBranchAddress(b) }}</td>

        <!-- Phone -->
        <td>{{ b.phoneNum }}</td>

        <!-- Vehicles -->
        <td>
          <div *ngFor="let v of b.vehicles">
            {{ v.vehicleNo }} - {{ v.driverPhone }}
          </div>
        </td>

        <!-- Status -->
        <td>
          <button (click)="toggleStatus(b)">
            {{ b.status === 'active' ? 'Deactivate' : 'Activate' }}
          </button>
        </td>

        <!-- Actions -->
        <td>
          <button (click)="editBranch(b)">Edit</button>
        </td>

      </tr>
    </table>
  </div>
</div>
