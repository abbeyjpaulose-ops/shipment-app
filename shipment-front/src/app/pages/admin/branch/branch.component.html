<div class="branches-container">
  <h2>Manage Branches</h2>

  <!-- Add Branch Button -->
  <button class="add-branch-btn" type="button" (click)="openAddBranchPopup()">+ Add Branch</button>

  <!-- Add Branch Popup -->
  <div class="modal" *ngIf="showAddBranchPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddBranchPopup()">&times;</span>
      <h3>Add Branch</h3>
      <div class="add-branch-form">
        <input [(ngModel)]="newBranch.branchName" placeholder="Branch Name" required>
        <input [(ngModel)]="newBranch.address" placeholder="Address" required>
        <input [(ngModel)]="newBranch.city" placeholder="City">
        <input [(ngModel)]="newBranch.state" placeholder="State">
        <input [(ngModel)]="newBranch.pinCode" placeholder="Pin Code">
        <input [(ngModel)]="newBranch.phoneNum" placeholder="Branch Phone" required>

        <!-- Vehicles & Driver Contacts -->
        <div class="vehicle-wrapper">
          <label class="vehicle-label">Vehicles & Drivers</label>

          <div *ngFor="let v of newBranch.vehicles; let i=index" class="vehicle-row">
            <input placeholder="Vehicle No." [(ngModel)]="v.vehicleNo">
            <input placeholder="Driver Phone" [(ngModel)]="v.driverPhone">
            <button *ngIf="newBranch.vehicles.length > 1"
                    class="remove-btn"
                    (click)="removeVehicle(i)">dY-`‹,?</button>
          </div>

          <button class="add-vehicle-btn" type="button" (click)="addVehicle()">+ Add Vehicle</button>
        </div>

        <button class="add-btn" type="button" (click)="addBranch()">+ Add Branch</button>
      </div>
    </div>
  </div>

  <!-- Branches List Table -->
  <div class="branches-table-wrapper">
    <table>
      <tr>
        <th>Branch Name</th>
        <th>Address</th>
        <th>City</th>
        <th>State</th>
        <th>Pin</th>
        <th>Phone</th>
        <th>Vehicles & Drivers</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>

      <tr *ngFor="let b of branches">

        <!-- Branch Name -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.branchName }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.branchName">
        </td>

        <!-- Address -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.address }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.address">
        </td>

        <!-- City -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.city }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.city">
        </td>

        <!-- State -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.state }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.state">
        </td>

        <!-- Pin Code -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.pinCode }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.pinCode">
        </td>

        <!-- Phone -->
        <td>
          <span *ngIf="editingBranch?._id !== b._id">{{ b.phoneNum }}</span>
          <input *ngIf="editingBranch?._id === b._id" [(ngModel)]="editingBranch.phoneNum">
        </td>

        <!-- Vehicles -->
        <td>
          <div *ngIf="editingBranch?._id !== b._id">
            <div *ngFor="let v of b.vehicles">
              dYss {{ v.vehicleNo }} ƒ?" dY"z {{ v.driverPhone }}
            </div>
          </div>

          <div class="vehicle-edit-wrapper" *ngIf="editingBranch?._id === b._id">
            <div *ngFor="let v of editingBranch.vehicles; let i=index" class="vehicle-row">
              <input [(ngModel)]="v.vehicleNo" placeholder="Vehicle No.">
              <input [(ngModel)]="v.driverPhone" placeholder="Driver Phone">
              <button *ngIf="editingBranch.vehicles.length > 1"
                      class="remove-btn"
                      (click)="removeVehicleEdit(i)">dY-`‹,?</button>
            </div>
            <button class="add-vehicle-btn" type="button" (click)="addVehicleEdit()">+ Vehicle</button>
          </div>
        </td>

        <!-- Status -->
        <td>
          <button (click)="toggleStatus(b)">
            {{ b.status === 'active' ? 'Deactivate' : 'Activate' }}
          </button>
        </td>

        <!-- Actions -->
        <td>
          <button *ngIf="editingBranch?._id !== b._id" (click)="editBranch(b)">Edit</button>
          <button *ngIf="editingBranch?._id === b._id" (click)="saveEdit()">Save</button>
        </td>

      </tr>
    </table>
  </div>
</div>
