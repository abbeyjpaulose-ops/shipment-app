<div class="branches-container">
  <div class="branches-header">
    <h2>Manage Branches</h2>

    <button class="add-branch-btn" type="button" (click)="openAddBranchPopup()">+ Add Branch</button>
  </div>

  <!-- Add Branch Popup -->
  <div class="modal theme-modal" *ngIf="showAddBranchPopup">
    <div class="modal-content branch-modal">
      <div class="modal-header">
        <div class="modal-title">
          <h3>Add Branch</h3>
          <p class="modal-subtitle">Create a new branch</p>
        </div>
        <button type="button" class="close" (click)="closeAddBranchPopup()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="branch-form-grid">
          <label class="field">
            <span>Branch Name</span>
            <input [(ngModel)]="newBranch.branchName" (ngModelChange)="handleHeadingBranchChange()" placeholder="Branch Name" required>
          </label>
          <label class="field">
            <span>Prefix</span>
            <input
              [(ngModel)]="newBranch.prefix"
              placeholder="Prefix (1-3 letters/numbers)"
              maxlength="3"
              pattern="[A-Za-z0-9]{0,3}"
              title="Up to 3 letters or numbers"
              style="text-transform: uppercase;"
            >
          </label>
          <label class="field">
            <span>Address</span>
            <input [(ngModel)]="newBranch.address" placeholder="Address" required>
          </label>
          <label class="field">
            <span>City</span>
            <input [(ngModel)]="newBranch.city" placeholder="City">
          </label>
          <label class="field">
            <span>State</span>
            <input [(ngModel)]="newBranch.state" placeholder="State">
          </label>
          <label class="field">
            <span>Pin Code</span>
            <input [(ngModel)]="newBranch.pinCode" placeholder="Pin Code">
          </label>
          <label class="field">
            <span>Branch Phone</span>
            <input [(ngModel)]="newBranch.phoneNum" placeholder="Branch Phone" required>
          </label>
        </div>

        <div class="vehicle-wrapper">
          <label class="vehicle-label">Vehicles & Drivers</label>
          <table class="vehicle-table">
            <thead>
              <tr>
                <th>Vehicle No.</th>
                <th>Driver Phone</th>
                <th class="vehicle-col-status">Status</th>
                <th>Current Location</th>
                <th class="vehicle-col-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let v of newBranch.vehicles; let i=index">
                <td><input placeholder="Vehicle No." [(ngModel)]="v.vehicleNo"></td>
                <td><input placeholder="Driver Phone" [(ngModel)]="v.driverPhone"></td>
                <td class="vehicle-col-status">
                  <span class="vehicle-status">{{ v.vehicleStatus || 'online' }}</span>
                </td>
                <td>
                  <select [(ngModel)]="v.currentLocationId">
                    <option [ngValue]="''">Use this branch</option>
                    <option *ngFor="let option of getAddBranchOptions()" [ngValue]="option.id">{{ option.label }}</option>
                  </select>
                </td>
                <td class="vehicle-col-actions">
                  <button *ngIf="newBranch.vehicles.length > 1"
                          class="remove-btn"
                          (click)="removeVehicle(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>

          <button class="add-vehicle-btn" type="button" (click)="addVehicle()">+ Add Vehicle</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="ghost-btn" (click)="closeAddBranchPopup()">Cancel</button>
          <button type="button" (click)="addBranch()">+ Add Branch</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Branch Popup -->
  <div class="modal theme-modal" *ngIf="showEditBranchPopup && editingBranch">
    <div class="modal-content edit-modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <h3>Edit Branch</h3>
          <p class="modal-subtitle">Branch: {{ editingBranch?.branchName || '-' }}</p>
        </div>
        <button type="button" class="close" (click)="closeEditBranchPopup()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="branch-form-grid">
          <label class="field">
            <span>Branch Name</span>
            <input [(ngModel)]="editingBranch.branchName" placeholder="Branch Name" required>
          </label>
          <label class="field">
            <span>Prefix</span>
            <input
              [(ngModel)]="editingBranch.prefix"
              placeholder="Prefix (1-3 letters/numbers)"
              maxlength="3"
              pattern="[A-Za-z0-9]{0,3}"
              title="Up to 3 letters or numbers"
              style="text-transform: uppercase;"
            >
          </label>
          <label class="field">
            <span>Address</span>
            <input [(ngModel)]="editingBranch.address" placeholder="Address" required>
          </label>
          <label class="field">
            <span>City</span>
            <input [(ngModel)]="editingBranch.city" placeholder="City">
          </label>
          <label class="field">
            <span>State</span>
            <input [(ngModel)]="editingBranch.state" placeholder="State">
          </label>
          <label class="field">
            <span>Pin Code</span>
            <input [(ngModel)]="editingBranch.pinCode" placeholder="Pin Code">
          </label>
          <label class="field">
            <span>Branch Phone</span>
            <input [(ngModel)]="editingBranch.phoneNum" placeholder="Branch Phone" required>
          </label>
        </div>

        <div class="vehicle-wrapper">
          <label class="vehicle-label">Vehicles & Drivers</label>
          <table class="vehicle-table">
            <thead>
              <tr>
                <th>Vehicle No.</th>
                <th>Driver Phone</th>
                <th class="vehicle-col-status">Status</th>
                <th>Current Location</th>
                <th class="vehicle-col-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let v of editingBranch.vehicles; let i=index">
                <td><input placeholder="Vehicle No." [(ngModel)]="v.vehicleNo"></td>
                <td><input placeholder="Driver Phone" [(ngModel)]="v.driverPhone"></td>
                <td class="vehicle-col-status">
                  <button type="button" class="vehicle-status-btn" (click)="toggleEditVehicleStatus(v)">
                    {{ (v.vehicleStatus || 'online') === 'offline' ? 'offline' : 'online' }}
                  </button>
                </td>
                <td>
                  <select [(ngModel)]="v.currentLocationId">
                    <option *ngFor="let option of getEditBranchOptions(v.currentLocationId)" [ngValue]="option.id">{{ option.label }}</option>
                  </select>
                </td>
                <td class="vehicle-col-actions">
                  <button *ngIf="editingBranch.vehicles.length > 1"
                          class="remove-btn"
                          (click)="removeVehicleEdit(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button class="add-vehicle-btn" type="button" (click)="addVehicleEdit()">+ Add Vehicle</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="ghost-btn" (click)="closeEditBranchPopup()">Cancel</button>
          <button type="button" (click)="saveEdit()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Branches List Table -->
  <div class="branches-table-wrapper">
    <table class="branches-table">
      <thead>
        <tr>
          <th>Branch Name</th>
          <th>Address</th>
          <th>Phone</th>
          <th>Vehicles & Drivers</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let b of branches" (click)="openBranchDetailsPopup(b)">
          <td>{{ b.branchName }}</td>
          <td>{{ getBranchAddress(b) }}</td>
          <td>{{ b.phoneNum }}</td>
          <td>
            <div *ngFor="let v of b.vehicles">
              {{ v.vehicleNo || '-' }} - {{ v.driverPhone || '-' }}
            </div>
          </td>
          <td class="status-cell">
            <button (click)="toggleStatus(b); $event.stopPropagation()"
              [ngClass]="b.status === 'active' ? 'status-active' : 'status-inactive'">
              {{ b.status === 'active' ? 'Active' : 'Deactivated' }}
            </button>
          </td>
        </tr>
        <tr *ngIf="branches.length === 0">
          <td colspan="5">No branches found.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Branch Details Popup -->
<div class="modal theme-modal" *ngIf="showBranchDetailsPopup">
  <div class="modal-content branch-details-modal">
    <div class="modal-header">
      <div class="modal-title">
        <h3>Branch Details</h3>
        <p class="modal-subtitle">Branch: {{ selectedBranch?.branchName || '-' }}</p>
      </div>
      <div class="modal-header-actions">
        <button type="button" class="link-button" (click)="editBranchFromDetails()">Edit</button>
        <button type="button" class="close" (click)="closeBranchDetailsPopup()">&times;</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="details-section">
        <div class="details-row">
          <span class="details-label">Branch Name</span>
          <span class="details-value">{{ selectedBranch?.branchName || '-' }}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Prefix</span>
          <span class="details-value">{{ selectedBranch?.prefix || '-' }}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Phone</span>
          <span class="details-value">{{ selectedBranch?.phoneNum || '-' }}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Status</span>
          <span class="details-value">{{ selectedBranch?.status === 'active' ? 'Active' : 'Deactivated' }}</span>
        </div>
      </div>

      <div class="details-section">
        <h4>Address</h4>
        <div class="details-grid">
          <div>
            <div class="details-label">Address</div>
            <div class="details-value">{{ selectedBranch?.address || selectedBranch?.addresses?.[0]?.address || '-' }}</div>
          </div>
          <div>
            <div class="details-label">City</div>
            <div class="details-value">{{ selectedBranch?.city || selectedBranch?.addresses?.[0]?.city || '-' }}</div>
          </div>
          <div>
            <div class="details-label">State</div>
            <div class="details-value">{{ selectedBranch?.state || selectedBranch?.addresses?.[0]?.state || '-' }}</div>
          </div>
          <div>
            <div class="details-label">Pin</div>
            <div class="details-value">{{ selectedBranch?.pinCode || selectedBranch?.addresses?.[0]?.pinCode || '-' }}</div>
          </div>
        </div>
      </div>

      <div class="details-section">
        <h4>Vehicles & Drivers</h4>
        <div class="details-list" *ngIf="selectedBranch?.vehicles?.length; else noBranchVehicles">
          <div class="details-list-item" *ngFor="let v of selectedBranch.vehicles; let i = index">
            <div class="details-label">Vehicle {{ v?.vehicleNo || (i + 1) }}</div>
            <div class="details-value">Driver: {{ v?.driverPhone || '-' }}</div>
            <div class="details-value">Status: {{ v?.vehicleStatus || 'online' }}</div>
            <div class="details-value">Location: {{ getVehicleLocationLabel(v) }}</div>
          </div>
        </div>
        <ng-template #noBranchVehicles>
          <div class="details-empty">No vehicles assigned.</div>
        </ng-template>
      </div>
    </div>
  </div>
</div>
