<div class="clients-container">
  <h2>Manage Clients</h2>

  <!-- Add Client Button -->
  <button class="add-client-btn" (click)="openAddClientPopup()">+ Add Client</button>

  <!-- Popup Modal -->
  <div class="modal" *ngIf="showAddClientPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddClientPopup()">&times;</span>
      <h3>Add New Client</h3>

      <div class="add-client-form">
        <!-- Client Fields -->
        <input [(ngModel)]="newClient.clientName" placeholder="Client Name" required>
        <input [(ngModel)]="newClient.deliveryLocations[0].address" placeholder="Address" required>
        <input [(ngModel)]="newClient.deliveryLocations[0].city" placeholder="City">
        <input [(ngModel)]="newClient.deliveryLocations[0].state" placeholder="State">
        <input [(ngModel)]="newClient.deliveryLocations[0].pinCode" placeholder="Pin Code" required>
        <input [(ngModel)]="newClient.GSTIN" placeholder="GSTIN" required>
        <input [(ngModel)]="newClient.phoneNum" placeholder="Contact Number" required>
        <input [(ngModel)]="newClient.perDis" placeholder="% of Discount" required>

        <!-- Credit Type -->
        <select [(ngModel)]="newClient.creditType" class="small-select">
          <option value="no-credit">No Credit</option>
          <option value="credit">Credit Allowed</option>
        </select>

        <!-- Delivery Locations Section -->
        <h4>Delivery Locations</h4>
        <div class="delivery-form" *ngFor="let d of newClient.deliveryLocations; let i=index">
          <input [(ngModel)]="d.address" placeholder="Delivery Address" required>
          <input [(ngModel)]="d.city" placeholder="City">
          <input [(ngModel)]="d.state" placeholder="State">
          <input [(ngModel)]="d.pinCode" placeholder="Pin Code" required>

          <!-- Remove -->
          <button type="button" (click)="removeDeliveryLocation(i)">Remove</button>
        </div>
        <button type="button" (click)="addDeliveryLocation()">+ Add Delivery Location</button>
        <br><br>

        <!-- Product Pricing Section -->
        <h4>Product Pricing</h4>
        <div class="product-form" *ngFor="let p of newClient.products; let i = index">
          <select [(ngModel)]="p.productName" (change)="onProductSelect(p)" required>
            <option value="">Select Product</option>
            <option *ngFor="let prod of productOptions" [value]="prod.productName">
              {{ prod.hsnNum }} - {{ prod.productName }}
            </option>
          </select><br>
          <div class="rate-rows">
            <div class="rate-row" *ngFor="let rateEntry of p.rates; let r = index">
              <input [(ngModel)]="rateEntry.pickupLocationId" placeholder="Pickup Address Id" list="rate-addresses">
              <input [(ngModel)]="rateEntry.deliveryLocationId" placeholder="Delivery Address Id" list="rate-addresses">
              <input [(ngModel)]="rateEntry.rate.ratePerNum" type="number" placeholder="Rate per Box">
              <input [(ngModel)]="rateEntry.rate.ratePerVolume" type="number" placeholder="Rate per Volume">
              <input [(ngModel)]="rateEntry.rate.ratePerKg" type="number" placeholder="Rate per Kg">
              <button type="button" (click)="removeRateRow(p, r)">Remove</button>
            </div>
            <button type="button" (click)="addRateRow(p)">+ Add Rate</button>
            <datalist id="rate-addresses">
              <option *ngFor="let opt of rateAddressOptions" [value]="opt.id" [label]="opt.label"></option>
            </datalist>
          </div>
          <button type="button" (click)="removeProduct(i)">Remove Product</button>
        </div>
        <button type="button" (click)="addProduct()">+ Add Product</button>
        <br><br>

        <button (click)="addClient()">+ Add Client</button>
      </div>
    </div>
  </div>

  <!-- Clients List -->
  <div class="clients-table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Client Name</th>
          <th>Address</th>
          <th>City</th>
          <th>State</th>
          <th>Pin</th>
          <th>GSTIN</th>
          <th>Contact Number</th>
          <th>% Discount</th>
          <th>Credit Type</th>
          <th>Delivery Locations</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let b of clients">

          <td>{{ b.clientName }}</td>

          <td>{{ b.address }}</td>

          <td>{{ b.city }}</td>

          <td>{{ b.state }}</td>

          <td>{{ b.pinCode }}</td>

          <td>{{ b.GSTIN }}</td>

          <td>{{ b.phoneNum }}</td>

          <td>{{ b.perDis }}</td>

          <!-- Credit Toggle -->
          <td>
            <button 
              (click)="toggleCreditType(b)"
              [ngClass]="b.creditType === 'credit' ? 'credit-active' : 'credit-inactive'">
              {{ b.creditType === 'credit' ? 'Credit âœ”' : 'No Credit' }}
            </button>
          </td>

          <!-- Delivery Locations -->
          <td>
            <div *ngFor="let d of b.deliveryLocations">
              ðŸ“¦ {{ d.address }} {{ d.city }} {{ d.state }} {{ d.pinCode }}
            </div>
          </td>

          <!-- Status -->
          <td>
            <button (click)="toggleStatus(b)"
              [ngClass]="b.status === 'active' ? 'status-active' : 'status-inactive'">
              {{ b.status === 'active' ? 'Active' : 'Deactivated' }}
            </button>
          </td>

          <td>
            <button (click)="openEditClientPopup(b)">Edit</button>
          </td>

        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Client Popup -->
<div class="modal" *ngIf="showEditClientPopup">
  <div class="modal-content edit-modal-content">
    <span class="close" (click)="closeEditClientPopup()">&times;</span>
    <h3>Edit Client</h3>

    <div class="add-client-form">
      <input [(ngModel)]="editingClient.clientName" placeholder="Client Name" required>
      <input [(ngModel)]="editingClient.address" placeholder="Address" required>
      <input [(ngModel)]="editingClient.city" placeholder="City">
      <input [(ngModel)]="editingClient.state" placeholder="State">
      <input [(ngModel)]="editingClient.pinCode" placeholder="Pin Code" required>
      <input [(ngModel)]="editingClient.GSTIN" placeholder="GSTIN" required>
      <input [(ngModel)]="editingClient.phoneNum" placeholder="Contact Number" required>
      <input [(ngModel)]="editingClient.perDis" placeholder="% of Discount" required>

      <select [(ngModel)]="editingClient.creditType" class="small-select">
        <option value="no-credit">No Credit</option>
        <option value="credit">Credit Allowed</option>
      </select>

      <h4>Delivery Locations</h4>
      <div class="delivery-form" *ngFor="let d of editingClient.deliveryLocations; let i=index">
        <input [(ngModel)]="d.address" placeholder="Delivery Address" required>
          <input [(ngModel)]="d.city" placeholder="City">
          <input [(ngModel)]="d.state" placeholder="State">
          <input [(ngModel)]="d.pinCode" placeholder="Pin Code" required>
        <button type="button" (click)="removeDeliveryLocationEdit(i)">Remove</button>
      </div>
      <button type="button" (click)="addDeliveryLocationEdit()">+ Add Delivery Location</button>
      <br><br>

      <h4>Product Pricing</h4>
      <div class="product-form" *ngFor="let p of editingClient.products; let i = index">
        <select [(ngModel)]="p.productName" (change)="onProductSelect(p)" required>
          <option value="">Select Product</option>
          <option *ngFor="let prod of productOptions" [value]="prod.productName">
            {{ prod.hsnNum }} - {{ prod.productName }}
          </option>
        </select><br>
        <div class="rate-rows">
          <div class="rate-row" *ngFor="let rateEntry of p.rates; let r = index">
            <input [(ngModel)]="rateEntry.pickupLocationId" placeholder="Pickup Address Id" list="rate-addresses">
            <input [(ngModel)]="rateEntry.deliveryLocationId" placeholder="Delivery Address Id" list="rate-addresses">
            <input [(ngModel)]="rateEntry.rate.ratePerNum" type="number" placeholder="Rate per Box">
            <input [(ngModel)]="rateEntry.rate.ratePerVolume" type="number" placeholder="Rate per Volume">
            <input [(ngModel)]="rateEntry.rate.ratePerKg" type="number" placeholder="Rate per Kg">
            <button type="button" (click)="removeRateRow(p, r)">Remove</button>
          </div>
          <button type="button" (click)="addRateRow(p)">+ Add Rate</button>
          <datalist id="rate-addresses">
            <option *ngFor="let opt of rateAddressOptions" [value]="opt.id" [label]="opt.label"></option>
          </datalist>
        </div>
        <button type="button" (click)="removeProductEdit(i)">Remove Product</button>
      </div>
      <button type="button" (click)="addProductEdit()">+ Add Product</button>
      <br><br>

      <button (click)="saveEdit()">Save</button>
    </div>
  </div>
</div>






