<div class="products-container">
  <h2>Manage Standard Products Pricing</h2>

  <!-- Add Product Button -->
  <button class="add-product-btn" type="button" (click)="openAddProductPopup()">+ Add Product</button>

  <!-- Add Product Popup -->
  <div class="modal" *ngIf="showAddProductPopup">
    <div class="modal-content">
      <span class="close" (click)="closeAddProductPopup()">&times;</span>
      <h3>Add Product</h3>
      <div class="add-product-form">
        <input [(ngModel)]="newProduct.hsnNum" placeholder="HSN number" required>
        <input [(ngModel)]="newProduct.productName" placeholder="Product Type" required>

        <div class="rate-rows">
          <div class="rate-row" *ngFor="let rateEntry of newProduct.rates; let i = index">
            <input [(ngModel)]="rateEntry.pickupPincode" placeholder="Pickup Pincode">
            <input [(ngModel)]="rateEntry.deliveryPincode" placeholder="Delivery Pincode">
            <input type="number" [(ngModel)]="rateEntry.rate.ratePerNum" placeholder="Rate / Box" required>
            <input type="number" [(ngModel)]="rateEntry.rate.ratePerVolume" placeholder="Rate / cmA3" required>
            <input type="number" [(ngModel)]="rateEntry.rate.ratePerKg" placeholder="Rate / Kg" required>
            <button type="button" (click)="removeRateRow(newProduct, i)">Remove</button>
          </div>
          <button type="button" (click)="addRateRow(newProduct)">+ Add Rate</button>
        </div>

        <button type="button" (click)="addProduct()">+ Add Product</button>
      </div>
    </div>
  </div>

  <!-- Products List -->
  <div class="products-table-wrapper">
    <table>
      <tr>
        <th>HSN number</th>
        <th>Product Type</th>
        <th>Rates by Route</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>

      <tr *ngFor="let b of filteredProducts">

        <!-- HSN number -->
        <td>
          <span *ngIf="editingProduct?._id !== b._id">{{ b.hsnNum }}</span>
          <div *ngIf="editingProduct?._id === b._id" class="edit-field">
            <input [(ngModel)]="editingProduct.hsnNum">
          </div>
        </td>

        <!-- Product Name -->
        <td>
          <span *ngIf="editingProduct?._id !== b._id">{{ b.productName }}</span>
          <div *ngIf="editingProduct?._id === b._id" class="edit-field">
            <input [(ngModel)]="editingProduct.productName">
          </div>
        </td>

        <!-- Rates -->
        <td>
          <div *ngIf="editingProduct?._id !== b._id" class="rate-list">
            <div class="rate-item" *ngFor="let rateEntry of b.rates">
              <span>Pickup: {{ rateEntry.pickupPincode || '-' }}</span>
              <span>Delivery: {{ rateEntry.deliveryPincode || '-' }}</span>
              <span>Box: {{ rateEntry.rate?.ratePerNum }}</span>
              <span>cmA3: {{ rateEntry.rate?.ratePerVolume }}</span>
              <span>Kg: {{ rateEntry.rate?.ratePerKg }}</span>
            </div>
          </div>
          <div *ngIf="editingProduct?._id === b._id" class="edit-field">
            <div class="rate-row" *ngFor="let rateEntry of editingProduct.rates; let i = index">
              <input [(ngModel)]="rateEntry.pickupPincode" placeholder="Pickup Pincode">
              <input [(ngModel)]="rateEntry.deliveryPincode" placeholder="Delivery Pincode">
              <input type="number" [(ngModel)]="rateEntry.rate.ratePerNum" placeholder="Rate / Box" required>
              <input type="number" [(ngModel)]="rateEntry.rate.ratePerVolume" placeholder="Rate / cmA3" required>
              <input type="number" [(ngModel)]="rateEntry.rate.ratePerKg" placeholder="Rate / Kg" required>
              <button type="button" (click)="removeRateRow(editingProduct, i)">Remove</button>
            </div>
            <button type="button" (click)="addRateRow(editingProduct)">+ Add Rate</button>
          </div>
        </td>

        <!-- Status Toggle -->
        <td>
          <button (click)="toggleStatus(b)">
            {{ b.status === 'active' ? 'Deactivate' : 'Activate' }}
          </button>
        </td>

        <!-- Actions -->
        <td>
          <button *ngIf="editingProduct?._id !== b._id" (click)="editProduct(b)">Edit</button>
          <button *ngIf="editingProduct?._id === b._id" (click)="saveEdit()">Save</button>
        </td>

      </tr>
    </table>
  </div>
</div>
