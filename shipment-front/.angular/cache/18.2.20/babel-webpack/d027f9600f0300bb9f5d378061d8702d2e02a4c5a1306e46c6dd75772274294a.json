{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet InvoiceComponent = class InvoiceComponent {\n  constructor(http, branchService) {\n    this.http = http;\n    this.branchService = branchService;\n    this.invoices = [];\n    this.deliveredInvoices = [];\n    this.preInvoicedInvoices = [];\n    this.filteredDelivered = [];\n    this.filteredPreInvoiced = [];\n    this.searchText = '';\n    this.filterDate = '';\n    this.filterConsignor = '';\n    this.selectedInvoice = null;\n    this.showInvoiceModal = false;\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.editingInvoice = null; // �o. Track the invoice being edited\n    this.showEditPopup = false;\n    this.showGenerateInvoicePopup = false;\n    this.onStorageChange = e => {\n      if (e.key === 'branch' && e.newValue && e.newValue !== this.branch) {\n        this.branch = e.newValue;\n        this.loadInvoices();\n      }\n    };\n  }\n  ngOnInit() {\n    this.branch = this.branchService.currentBranch || this.branch;\n    this.branchSub = this.branchService.branch$.subscribe(branch => {\n      if (branch !== this.branch) {\n        this.branch = branch;\n        this.loadInvoices();\n      }\n    });\n    window.addEventListener('storage', this.onStorageChange);\n    this.loadInvoices();\n  }\n  ngOnDestroy() {\n    this.branchSub?.unsubscribe();\n    window.removeEventListener('storage', this.onStorageChange);\n  }\n  loadInvoices() {\n    this.http.get('http://localhost:3000/api/newshipments', {\n      params: {\n        username: localStorage.getItem('username') || '',\n        branch: this.branch || localStorage.getItem('branch') || ''\n      }\n    }).subscribe({\n      next: res => {\n        const raw = Array.isArray(res) ? res : res?.value || [];\n        // �o. Only show shipments with status 'Delivered'\n        //onsole.log('�Y\"� IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIInvoices loaded:', res);\n        const normalized = (raw || []).map(s => ({\n          ...s,\n          _normalizedStatus: this.normalizeStatus(s?.shipmentStatus)\n        }));\n        this.invoices = normalized.filter(s => s._normalizedStatus === 'delivered' || s._normalizedStatus === 'pre-invoiced');\n        this.deliveredInvoices = this.invoices.filter(s => s._normalizedStatus === 'delivered');\n        this.preInvoicedInvoices = this.invoices.filter(s => s._normalizedStatus === 'pre-invoiced');\n        this.applyFilters();\n        console.log('A??,f??A? Filtered Delivered consignments:', this.filteredDelivered);\n        console.log('A??,f??A? Filtered Pre-Invoiced consignments:', this.filteredPreInvoiced);\n      },\n      error: err => console.error('�O Error loading invoices:', err)\n    });\n  }\n  normalizeStatus(status) {\n    const value = String(status || '').trim().toLowerCase();\n    if (!value) return '';\n    if (value.includes('delivered')) return 'delivered';\n    if (value === 'pre invoiced' || value === 'preinvoiced' || value.includes('pre-invoiced')) {\n      return 'pre-invoiced';\n    }\n    return value;\n  }\n  applyFilters() {\n    const matches = s => (this.searchText ? s.consignmentNumber?.includes(this.searchText) || s.consignor?.includes(this.searchText) : true) && (this.filterDate ? new Date(s.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? s.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase()) : true);\n    this.filteredDelivered = this.deliveredInvoices.filter(matches);\n    this.filteredPreInvoiced = this.preInvoicedInvoices.filter(matches);\n  }\n  toggleAllDeliveredSelection(event) {\n    const checked = event.target.checked;\n    this.filteredDelivered.forEach(i => i.selected = checked);\n  }\n  toggleAllPreInvoicedSelection(event) {\n    const checked = event.target.checked;\n    this.filteredPreInvoiced.forEach(i => i.selected = checked);\n  }\n  openInvoiceDetails(invoice) {\n    this.selectedInvoice = invoice;\n    this.showInvoiceModal = true;\n  }\n  closeInvoiceDetails() {\n    this.showInvoiceModal = false;\n    this.selectedInvoice = null;\n  }\n  // �o. Function to mark selected Delivered consignments as Invoiced\n  invoiceSelected() {\n    const selectedConsignments = this.filteredDelivered.filter(i => i.selected);\n    if (selectedConsignments.length === 0) {\n      console.warn('No consignments selected for invoicing.');\n      return;\n    }\n    selectedConsignments.forEach(consignment => {\n      const updatedConsignment = {\n        ...consignment,\n        shipmentStatus: 'Pre-Invoiced'\n      };\n      this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, updatedConsignment).subscribe({\n        next: () => {\n          console.log(`Consignment ${consignment.consignmentNumber} updated to Pre-Invoiced`);\n          this.loadInvoices();\n        },\n        error: err => {\n          console.error(`Error updating consignment ${consignment.consignmentNumber}:`, err);\n        }\n      });\n    });\n    this.filteredDelivered.forEach(i => i.selected = false);\n  }\n  editInvoice(invoice) {\n    console.log('Edit invoice:', invoice);\n    const cloned = JSON.parse(JSON.stringify(invoice || {}));\n    if (Array.isArray(cloned.ewaybills) && cloned.ewaybills.length) {\n      cloned.invoices = this.flattenInvoices(cloned.ewaybills);\n    } else {\n      cloned.invoices = cloned.invoices || [];\n    }\n    this.editingInvoice = cloned;\n    this.captureOriginalDelivered(this.editingInvoice);\n    this.showEditPopup = true;\n  }\n  flattenInvoices(ewaybills) {\n    return (ewaybills || []).flatMap(ewb => ewb.invoices || []);\n  }\n  captureOriginalDelivered(invoice) {\n    (invoice?.invoices || []).forEach(inv => {\n      (inv.products || []).forEach(prod => {\n        prod._originalDelivered = Number(prod.deliveredstock) || 0;\n      });\n    });\n  }\n  deleteDelivered() {\n    this.deleteConsignments(this.filteredDelivered);\n  }\n  deletePreInvoiced() {\n    this.deleteConsignments(this.filteredPreInvoiced);\n  }\n  deleteInvoice() {\n    this.deleteConsignments([...this.filteredDelivered, ...this.filteredPreInvoiced]);\n  }\n  finalizePreInvoiced() {\n    const selectedConsignments = (this.filteredPreInvoiced || []).filter(i => i.selected);\n    if (selectedConsignments.length === 0) {\n      console.warn('No consignments selected for invoicing.');\n      return;\n    }\n    selectedConsignments.forEach(consignment => {\n      const updatedConsignment = {\n        ...consignment,\n        shipmentStatus: 'Invoiced'\n      };\n      this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, updatedConsignment).subscribe({\n        next: () => {\n          console.log(`Consignment ${consignment.consignmentNumber} updated to Invoiced`);\n          this.loadInvoices();\n        },\n        error: err => {\n          console.error(`Error updating consignment ${consignment.consignmentNumber}:`, err);\n        }\n      });\n    });\n    this.filteredPreInvoiced.forEach(i => i.selected = false);\n  }\n  openGenerateInvoicePopup() {\n    const selectedConsignments = (this.filteredPreInvoiced || []).filter(i => i.selected);\n    if (selectedConsignments.length === 0) {\n      console.warn('No consignments selected for invoicing.');\n      return;\n    }\n    this.showGenerateInvoicePopup = true;\n  }\n  confirmGenerateInvoice() {\n    this.showGenerateInvoicePopup = false;\n    this.finalizePreInvoiced();\n  }\n  cancelGenerateInvoice() {\n    this.showGenerateInvoicePopup = false;\n  }\n  deleteConsignments(list) {\n    const selectedConsignments = (list || []).filter(i => i.selected);\n    if (selectedConsignments.length === 0) {\n      console.warn('No consignments selected for invoicing.');\n      return;\n    }\n    selectedConsignments.forEach(consignment => {\n      const updatedConsignment = {\n        ...consignment,\n        shipmentStatus: ' Cancelled-' + consignment.shipmentStatus\n      };\n      this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, updatedConsignment).subscribe({\n        next: () => {\n          console.log(`Consignment ${consignment.consignmentNumber} updated to Invoiced`);\n          this.loadInvoices();\n        },\n        error: err => {\n          console.error(`Error updating consignment ${consignment.consignmentNumber}:`, err);\n        }\n      });\n    });\n    (list || []).forEach(i => i.selected = false);\n  }\n  printDelivered() {\n    this.printConsignments(this.filteredDelivered);\n  }\n  printPreInvoiced() {\n    this.printConsignments(this.filteredPreInvoiced);\n  }\n  printInvoice() {\n    this.printConsignments([...this.filteredDelivered, ...this.filteredPreInvoiced]);\n  }\n  printConsignments(list) {\n    const selected = (list || []).filter(inv => inv.selected);\n    if (selected.length === 0) {\n      alert('No invoices selected.');\n      return;\n    }\n    fetch('assets/invoice-template.html').then(res => res.text()).then(template => {\n      let fullHtml = `\n      <html>\n        <head>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h2 { margin-bottom: 0; }\n            table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n            th { background-color: #f2f2f2; }\n            .page-break { page-break-after: always; }\n            .totals { margin-top: 15px; font-weight: bold; }\n          </style>\n        </head>\n        <body>\n    `;\n      selected.forEach((inv, index) => {\n        let subtotal = 0;\n        const rows = (inv.invoices || []).map(i => (i.products || []).map(p => {\n          const lineTotal = (p.price || 0) * (p.deliveredstock || 0);\n          subtotal += lineTotal;\n          return `\n          <tr>\n          <td>${inv.consignmentNumber}</td>\n          <td>${inv.shipmentStatus}</td>\n          <td>${inv.consignor}</td>\n          <td>${inv.deliveryAddress}</td>\n          <td>${p.type}</td>\n          <td>${p.deliveredstock}</td>\n          <td>${p.price || 0}</td>\n          <td>${lineTotal.toFixed(2)}</td>\n          </tr>\n          `;\n        }).join('')).join('');\n        const ctype = localStorage.getItem('companyType') || 'default';\n        const gst = inv.finalAmount * (parseInt(ctype, 10) / 100);\n        const grandTotal = inv.finalAmount + gst;\n        const htmlContent = template.replace('{{consignmentNumber}}', inv.consignmentNumber).replace('{{consignor}}', inv.consignor).replace('{{deliveryAddress}}', inv.deliveryAddress).replace('{{status}}', inv.shipmentStatus).replace('{{rows}}', rows).replace('{{subtotal}}', subtotal.toFixed(2)).replace('{{gst}}', gst.toFixed(2)).replace('{{grandTotal}}', grandTotal.toFixed(2));\n        fullHtml += htmlContent;\n        if (index < selected.length - 1) {\n          fullHtml += `<div class=\"page-break\"></div>`;\n        }\n      });\n      fullHtml += `</body></html>`;\n      const printWindow = window.open('', '_blank');\n      if (printWindow) {\n        printWindow.document.open();\n        printWindow.document.write(fullHtml);\n        printWindow.document.close();\n        printWindow.print();\n      }\n    }).catch(err => console.error('Error loading invoice template:', err));\n  }\n};\nInvoiceComponent = __decorate([Component({\n  selector: 'app-invoice',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './invoice.component.html',\n  styleUrls: ['./invoice.component.css']\n})], InvoiceComponent);\nexport { InvoiceComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}