{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, HostListener } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet NewShipmentComponent = class NewShipmentComponent {\n  constructor(http) {\n    this.http = http;\n    this.DRAFT_PREFIX = 'newShipmentDraft';\n    this.showClientModal = false;\n    this.showGuestModal = false;\n    this.clientError = '';\n    this.guestError = '';\n    this.newClient = {\n      clientName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      GSTIN: '',\n      phoneNum: '',\n      perDis: 0,\n      creditType: 'no-credit',\n      products: [],\n      deliveryLocations: [{\n        location: ''\n      }],\n      status: 'active',\n      branch: ''\n    };\n    this.newGuest = {\n      guestName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perDis: 0\n    };\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    // Delivery\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.email = '';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.selectedConsignorId = null;\n    this.consignmentNumber = '-999';\n    this.date = new Date().toISOString().split('T')[0];\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'To Pay';\n    this.externalRefId = '';\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n    this.onStorageChange = e => {\n      if (e.key === 'branch' && e.newValue) {\n        this.handleBranchChange(e.newValue, e.oldValue || this.branch);\n      }\n    };\n  }\n  ngOnInit() {\n    if (typeof window === 'undefined') return;\n    this.email = localStorage.getItem('email') || '';\n    this.username = localStorage.getItem('username') || '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.newClient.branch = this.branch;\n    this.loadDraft(this.branch);\n    this.getCurrentConsignmentNumber();\n    this.loadLists();\n    // React to branch change (same tab)\n    this.branchCheckInterval = setInterval(() => {\n      const current = localStorage.getItem('branch') || 'All Branches';\n      if (current !== this.branch) {\n        const oldBranch = this.branch;\n        this.handleBranchChange(current, oldBranch);\n      }\n    }, 1000);\n    // React to branch change (other tab)\n    window.addEventListener('storage', this.onStorageChange);\n  }\n  ngOnDestroy() {\n    if (this.branchCheckInterval) {\n      clearInterval(this.branchCheckInterval);\n    }\n    window.removeEventListener('storage', this.onStorageChange);\n  }\n  onBeforeUnload() {\n    this.saveDraft(this.branch);\n  }\n  handleBranchChange(newBranch, oldBranch) {\n    // Save draft for the previous branch\n    if (oldBranch) {\n      this.saveDraft(oldBranch);\n    }\n    this.branch = newBranch || 'All Branches';\n    this.newClient.branch = this.branch;\n    this.loadDraft(this.branch);\n    this.getCurrentConsignmentNumber();\n    this.loadLists();\n  }\n  draftKey(branch) {\n    return `${this.DRAFT_PREFIX}:${branch || 'All Branches'}`;\n  }\n  saveDraft(branch) {\n    if (typeof window === 'undefined') return;\n    const key = this.draftKey(branch);\n    const draft = {\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingAddress: this.billingAddress,\n      billingGSTIN: this.billingGSTIN,\n      billingPhone: this.billingPhone,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      deliveryType: this.deliveryType,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      consignorTab: this.consignorTab,\n      consigneeTab: this.consigneeTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      paymentMode: this.paymentMode,\n      externalRefId: this.externalRefId,\n      ewaybills: this.ewaybills,\n      charges: this.charges,\n      finalAmount: this.finalAmount,\n      selectedConsignorId: this.selectedConsignorId,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date\n    };\n    localStorage.setItem(key, JSON.stringify(draft));\n  }\n  loadDraft(branch) {\n    if (typeof window === 'undefined') return;\n    const raw = localStorage.getItem(this.draftKey(branch));\n    if (!raw) return;\n    try {\n      const draft = JSON.parse(raw);\n      Object.assign(this, {\n        billingType: draft.billingType ?? this.billingType,\n        billingName: draft.billingName ?? this.billingName,\n        billingAddress: draft.billingAddress ?? this.billingAddress,\n        billingGSTIN: draft.billingGSTIN ?? this.billingGSTIN,\n        billingPhone: draft.billingPhone ?? this.billingPhone,\n        pickupType: draft.pickupType ?? this.pickupType,\n        pickupName: draft.pickupName ?? this.pickupName,\n        pickupAddress: draft.pickupAddress ?? this.pickupAddress,\n        pickupPhone: draft.pickupPhone ?? this.pickupPhone,\n        deliveryType: draft.deliveryType ?? this.deliveryType,\n        deliveryName: draft.deliveryName ?? this.deliveryName,\n        deliveryAddress: draft.deliveryAddress ?? this.deliveryAddress,\n        deliveryPhone: draft.deliveryPhone ?? this.deliveryPhone,\n        consignorTab: draft.consignorTab ?? this.consignorTab,\n        consigneeTab: draft.consigneeTab ?? this.consigneeTab,\n        consignor: draft.consignor ?? this.consignor,\n        consignorGST: draft.consignorGST ?? this.consignorGST,\n        consignorAddress: draft.consignorAddress ?? this.consignorAddress,\n        consignorPhone: draft.consignorPhone ?? this.consignorPhone,\n        consignee: draft.consignee ?? this.consignee,\n        consigneeGST: draft.consigneeGST ?? this.consigneeGST,\n        consigneeAddress: draft.consigneeAddress ?? this.consigneeAddress,\n        consigneePhone: draft.consigneePhone ?? this.consigneePhone,\n        paymentMode: draft.paymentMode ?? this.paymentMode,\n        externalRefId: draft.externalRefId ?? this.externalRefId,\n        ewaybills: draft.ewaybills ?? this.ewaybills,\n        charges: draft.charges ?? this.charges,\n        finalAmount: draft.finalAmount ?? this.finalAmount,\n        selectedConsignorId: draft.selectedConsignorId ?? null,\n        consignmentNumber: draft.consignmentNumber ?? this.consignmentNumber,\n        date: draft.date ?? this.date\n      });\n    } catch {\n      /* ignore bad draft */\n    }\n  }\n  clearDraft(branch) {\n    localStorage.removeItem(this.draftKey(branch));\n  }\n  loadLists() {\n    // Client list\n    this.http.get(`http://localhost:3000/api/clients/clientslist`).subscribe(res => this.clientList = res);\n    // Guest list\n    this.http.get(`http://localhost:3000/api/guests/guestslist`).subscribe(res => this.guestList = res);\n    // Package list\n    this.http.get(`http://localhost:3000/api/pkgs/pkglist`).subscribe(res => this.pkgList = res);\n    // Product list (defaults)\n    this.http.get(`http://localhost:3000/api/products/productlist`).subscribe(res => this.productList = res);\n  }\n  // E-WAYBILL HELPERS\n  addEwaybill() {\n    this.ewaybills.push({\n      number: '',\n      date: this.date,\n      invoices: []\n    });\n  }\n  deleteEwaybill(index) {\n    this.ewaybills.splice(index, 1);\n  }\n  addInvoice(ewaybillIndex) {\n    this.ewaybills[ewaybillIndex].invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices.splice(invoiceIndex, 1);\n  }\n  addPackage(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.push({\n      type: '',\n      amount: 0\n    });\n  }\n  deletePackage(ewaybillIndex, invoiceIndex, packageIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.splice(packageIndex, 1);\n  }\n  addProduct(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.push({\n      type: '',\n      amount: 1,\n      instock: 1,\n      intransitstock: 0,\n      deliveredstock: 0\n    });\n  }\n  deleteProduct(ewaybillIndex, invoiceIndex, productIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.splice(productIndex, 1);\n  }\n  // CALCULATIONS\n  calculateFinalAmount() {\n    let invoiceTotal = 0;\n    let packageTotal = 0;\n    this.ewaybills.forEach(ewb => {\n      invoiceTotal += ewb.invoices.reduce((sum, inv) => sum + (inv.value || 0), 0);\n      packageTotal += ewb.invoices.reduce((sum, inv) => sum + inv.packages.reduce((pSum, p) => pSum + (p.amount || 0), 0), 0);\n    });\n    const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n    this.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n  }\n  resetForm() {\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.selectedConsignorId = null;\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'To Pay';\n    this.externalRefId = '';\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.finalAmount = 0;\n    this.saveDraft(this.branch);\n  }\n  // CONSIGNMENT NUMBER\n  getCurrentConsignmentNumber() {\n    if (!this.branch || this.branch === 'All Branches') {\n      this.consignmentNumber = '-999';\n      return;\n    }\n    this.http.get(`http://localhost:3000/api/newshipments/nextConsignment?emailId=${this.email}&branch=${encodeURIComponent(this.branch)}`).subscribe({\n      next: res => {\n        this.consignmentNumber = res.nextNumber.toString();\n        localStorage.setItem('consignmentNumber', this.consignmentNumber);\n      },\n      error: err => console.error('Error fetching consignment number', err)\n    });\n  }\n  // SAVE SHIPMENT\n  saveShipment() {\n    if (!this.ensureProductAmounts()) return;\n    const shipmentData = {\n      email: localStorage.getItem('email'),\n      username: localStorage.getItem('username'),\n      branch: localStorage.getItem('branch'),\n      shipmentStatus: this.shipmentStatus,\n      shipmentStatusDetails: `${localStorage.getItem('email')}$$${this.date}$$${this.shipmentStatus}`,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date,\n      paymentMode: this.paymentMode,\n      externalRefId: this.externalRefId,\n      consignorTab: this.consignorTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consigneeTab: this.consigneeTab,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingGSTIN: this.billingGSTIN,\n      billingAddress: this.billingAddress,\n      billingPhone: this.billingPhone,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      deliveryType: this.deliveryType,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      ewaybills: this.ewaybills,\n      charges: this.charges,\n      finalAmount: this.finalAmount\n    };\n    if (this.consignorTab === 'guest') shipmentData.consignorGST = 'GUEST';\n    if (this.consigneeTab === 'guest') shipmentData.consigneeGST = 'GUEST';\n    if (this.billingType === 'consignor') {\n      shipmentData.billingName = this.consignor;\n      shipmentData.billingAddress = this.consignorAddress;\n      shipmentData.billingGSTIN = this.consignorGST;\n      shipmentData.billingPhone = this.consignorPhone;\n    }\n    if (this.pickupType === 'consignor') {\n      shipmentData.pickupName = this.consignor;\n      shipmentData.pickupAddress = this.consignorAddress;\n      shipmentData.pickupPhone = this.consignorPhone;\n    }\n    if (this.deliveryType === 'consignee') {\n      shipmentData.deliveryName = this.consignee;\n      shipmentData.deliveryAddress = this.consigneeAddress;\n      shipmentData.deliveryPhone = this.consigneePhone;\n    }\n    if (shipmentData.branch !== 'All Branches') {\n      this.http.post('http://localhost:3000/api/newshipments/add', shipmentData, {\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }).subscribe({\n        next: () => {\n          alert(`Shipment ${this.consignmentNumber} saved successfully!`);\n          this.getCurrentConsignmentNumber();\n          this.resetForm();\n          this.clearDraft(this.branch);\n        },\n        error: err => alert('Error: ' + err.message)\n      });\n    } else {\n      alert('Please select a branch before saving.');\n    }\n  }\n  ensureProductAmounts() {\n    for (const ewb of this.ewaybills) {\n      for (const inv of ewb.invoices || []) {\n        for (const prod of inv.products || []) {\n          if (!prod.amount || prod.amount <= 0) {\n            alert('Please enter a quantity greater than 0 for all products.');\n            return false;\n          }\n          if (!prod.instock || prod.instock <= 0) {\n            prod.instock = prod.amount;\n          }\n        }\n      }\n    }\n    return true;\n  }\n  // SELECT HANDLERS\n  onConsignorSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consignorGST = c.GSTIN;\n      this.consignorAddress = c.address;\n      this.consignorPhone = c.phoneNum;\n      this.charges.consignorDiscount = c.perDis;\n      this.selectedConsignorId = c._id;\n      this.loadPricingSuggestions(c._id);\n    }\n  }\n  onConsigneeSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consigneeGST = c.GSTIN;\n      this.consigneeAddress = c.address;\n      this.consigneePhone = c.phoneNum;\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consignorGST = 'GUEST';\n      this.consignorAddress = g.address;\n      this.consignorPhone = g.phoneNum;\n      this.selectedConsignorId = null;\n      this.loadPricingSuggestions(null);\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consigneeGST = 'GUEST';\n      this.consigneeAddress = g.address;\n      this.consigneePhone = g.phoneNum;\n    }\n  }\n  onPackageList(name) {\n    this.pkgList.find(x => x.pkgName === name);\n  }\n  onProductList(name) {\n    this.productList.find(x => x.productName === name);\n  }\n  loadPricingSuggestions(clientId) {\n    if (!this.branch || this.branch === 'All Branches') return;\n    const params = clientId ? `branch=${encodeURIComponent(this.branch)}&clientId=${clientId}` : `branch=${encodeURIComponent(this.branch)}`;\n    this.http.get(`http://localhost:3000/api/pricing/suggestions?${params}`).subscribe({\n      next: res => {\n        if (res?.pricing) {\n          // Map to product dropdown structure\n          this.productList = res.pricing.map(p => ({\n            productName: p.productName,\n            hsnNum: p.hsnNum,\n            ratePerNum: p.ratePerNum,\n            ratePerVolume: p.ratePerVolume,\n            ratePerKg: p.ratePerKg,\n            source: p.source\n          }));\n        }\n      },\n      error: () => {}\n    });\n  }\n  // QUICK ADD CLIENT/GUEST\n  openClientModal() {\n    if (!this.branch || this.branch === 'All Branches') {\n      alert('Select a branch before adding a client.');\n      return;\n    }\n    this.newClient = {\n      clientName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      GSTIN: '',\n      phoneNum: '',\n      perDis: 0,\n      creditType: 'no-credit',\n      products: [],\n      deliveryLocations: [{\n        location: ''\n      }],\n      status: 'active',\n      branch: this.branch\n    };\n    this.clientError = '';\n    this.showClientModal = true;\n  }\n  openGuestModal() {\n    this.newGuest = {\n      guestName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perDis: 0\n    };\n    this.guestError = '';\n    this.showGuestModal = true;\n  }\n  saveNewClient() {\n    this.clientError = '';\n    if (!this.newClient.clientName || !this.newClient.address || !this.newClient.GSTIN || !this.newClient.phoneNum || !this.newClient.branch) {\n      this.clientError = 'Please fill required fields (name, address, GSTIN, phone, branch).';\n      return;\n    }\n    if (this.newClient.branch === 'All Branches') {\n      this.clientError = 'Select a specific branch before adding a client.';\n      return;\n    }\n    this.http.post('http://localhost:3000/api/clients/add', this.newClient).subscribe({\n      next: client => {\n        this.clientList = [client, ...this.clientList];\n        this.consignor = client.clientName;\n        this.onConsignorSelect(this.consignor);\n        this.showClientModal = false;\n      },\n      error: err => {\n        this.clientError = err?.error?.message || 'Failed to save client.';\n      }\n    });\n  }\n  saveNewGuest() {\n    this.guestError = '';\n    if (!this.newGuest.guestName || !this.newGuest.address || !this.newGuest.phoneNum) {\n      this.guestError = 'Please fill required fields (name, address, phone).';\n      return;\n    }\n    this.http.post('http://localhost:3000/api/guests/add', this.newGuest).subscribe({\n      next: guest => {\n        this.guestList = [guest, ...this.guestList];\n        if (this.consignorTab === 'guest') {\n          this.consignor = guest.guestName;\n          this.onConsignorGuestSelect(this.consignor);\n        }\n        this.showGuestModal = false;\n      },\n      error: err => {\n        this.guestError = err?.error?.message || 'Failed to save guest.';\n      }\n    });\n  }\n  closeModals() {\n    this.showClientModal = false;\n    this.showGuestModal = false;\n  }\n  addClientProduct() {\n    this.newClient.products.push({\n      hsnNum: '',\n      productName: '',\n      ratePerNum: 0,\n      ratePerVolume: 0,\n      ratePerKg: 0\n    });\n  }\n  removeClientProduct(index) {\n    this.newClient.products.splice(index, 1);\n  }\n  addDeliveryLocation() {\n    this.newClient.deliveryLocations.push({\n      location: ''\n    });\n  }\n  removeDeliveryLocation(index) {\n    this.newClient.deliveryLocations.splice(index, 1);\n  }\n};\n__decorate([HostListener('window:beforeunload')], NewShipmentComponent.prototype, \"onBeforeUnload\", null);\nNewShipmentComponent = __decorate([Component({\n  selector: 'app-new-shipment',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './new-shipment.component.html',\n  styleUrls: ['./new-shipment.component.css']\n})], NewShipmentComponent);\nexport { NewShipmentComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}