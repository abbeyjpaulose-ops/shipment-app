{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { forkJoin, of } from 'rxjs';\nlet StocksComponent = class StocksComponent {\n  constructor(http, branchService) {\n    this.http = http;\n    this.branchService = branchService;\n    this.stocks = [];\n    this.filteredStocks = [];\n    this.searchText = '';\n    this.filterDate = '';\n    this.filterConsignor = '';\n    this.selectedStock = null;\n    this.editingStock = null; // ✅ track which stock is being edited\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    // Delivery\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.email = '';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.consignmentNumber = localStorage.getItem('consignmentNumber') || '-999'; // will be loaded asynchronously\n    this.date = new Date().toISOString().split('T')[0];\n    this.ewaybillNumber = '';\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'Account Credit';\n    this.externalRefId = '';\n    this.invoices = [{\n      number: '',\n      value: 0\n    }];\n    this.packages = [{\n      type: '',\n      amount: 1\n    }];\n    this.products = [{\n      type: '',\n      amount: 1\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n    this.branches = [];\n    this.hubs = [];\n    this.availableRoutePoints = [];\n    this.shipmentRoute = [];\n    this.selectedRoutePoint = null;\n    this.selectedRouteVehicle = '';\n    this.routeBaskets = [];\n    this.onStorageChange = e => {\n      if (e.key === 'branch' && e.newValue && e.newValue !== this.branch) {\n        this.branch = e.newValue;\n        this.loadStocks();\n      }\n    };\n    this.showManifestAdjustmentPopup = false;\n    this.pendingManifestAdjustment = null;\n    this.manifestAdjustments = [];\n    this.manifestAdjustmentLines = [];\n    this.manifestEditsById = {};\n    this.showManifestationPopup = false;\n    this.selectedForManifestation = [];\n    this.manifestationNumber = '';\n  }\n  // --- Methods ---\n  addInvoice() {\n    this.editingStock.invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(index) {\n    this.editingStock.invoices.splice(index, 1);\n  }\n  addPackage(invoiceIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (!invoice.packages) {\n      invoice.packages = [];\n    }\n    invoice.packages.push({\n      type: '',\n      amount: 1\n    });\n  }\n  deletePackage(invoiceIndex, packageIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (invoice.packages && invoice.packages.length > packageIndex) {\n      invoice.packages.splice(packageIndex, 1);\n    }\n  }\n  addProduct(invoiceIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (!invoice.products) {\n      invoice.products = [];\n    }\n    invoice.products.push({\n      type: '',\n      amount: 1,\n      instock: 0,\n      intransitstock: 0,\n      deliveredstock: 0\n    });\n  }\n  deleteProduct(invoiceIndex, productIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (invoice.products && invoice.products.length > productIndex) {\n      const product = invoice.products[productIndex];\n      if (this.isProductManifested(product)) {\n        alert('This product has been manifested and cannot be deleted.');\n        return;\n      }\n      invoice.products.splice(productIndex, 1);\n    }\n  }\n  calculateFinalAmount() {\n    const invoiceTotal = this.editingStock.invoices.reduce((sum, i) => sum + (i.value || 0), 0);\n    const packageTotal = this.editingStock.packages.reduce((sum, p) => sum + (p.amount || 0), 0);\n    const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n    this.editingStock.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n  }\n  loadStocks() {\n    const username = this.username || localStorage.getItem('username') || '';\n    const branch = this.branch || localStorage.getItem('branch') || 'All Branches';\n    if (!username) {\n      console.error('Missing username for loading stocks');\n      return;\n    }\n    this.http.get('http://localhost:3000/api/newshipments', {\n      params: {\n        username,\n        branch\n      }\n    }).subscribe({\n      next: res => {\n        const normalized = (res || []).map(stock => ({\n          ...stock,\n          invoices: this.flattenInvoices(stock.ewaybills || stock.invoices || [])\n        }));\n        this.stocks = normalized.filter(stock => stock.shipmentStatus === 'Pending' || stock.shipmentStatus === 'In Transit/Pending' || stock.shipmentStatus === 'To Pay').sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n        this.applyFilters();\n      },\n      error: err => console.error('Error loading shipments:', err)\n    });\n  }\n  flattenInvoices(ewaybills) {\n    return (ewaybills || []).flatMap(ewb => ewb.invoices || []);\n  }\n  getInStockAmountTotal(invoices) {\n    let total = 0;\n    (invoices || []).forEach(inv => {\n      (inv.products || []).forEach(prod => {\n        total += Number(prod.instock || 0);\n      });\n    });\n    return total;\n  }\n  getInvoiceAmountTotal(invoices) {\n    let total = 0;\n    (invoices || []).forEach(inv => {\n      (inv.products || []).forEach(prod => {\n        total += Number(prod.amount || 0);\n      });\n    });\n    return total;\n  }\n  getProductTotal(ewaybills, field) {\n    let total = 0;\n    ewaybills.forEach(ewaybill => {\n      ewaybill.invoices.forEach(invoice => {\n        invoice.products.forEach(product => {\n          total += product[field] || 0;\n        });\n      });\n    });\n    return total;\n  }\n  applyFilters() {\n    this.filteredStocks = this.stocks.filter(s => (this.searchText ? s.consignmentNumber?.includes(this.searchText) || s.consignor?.includes(this.searchText) : true) && (this.filterDate ? new Date(s.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? s.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase()) : true));\n  }\n  toggleAllSelection(event) {\n    const checked = event.target.checked;\n    this.filteredStocks.forEach(s => {\n      if (this.isManifestSelectable(s)) {\n        s.selected = checked;\n      }\n    });\n  }\n  isManifestSelectable(stock) {\n    return String(stock?.shipmentStatus || '').toLowerCase() !== 'to pay';\n  }\n  openStockDetails(stock) {\n    this.selectedStock = stock;\n  }\n  closeStockDetails() {\n    this.selectedStock = null;\n  }\n  editStock(stock) {\n    console.log('�o?�,? Edit stock:', stock);\n    const cloned = JSON.parse(JSON.stringify(stock));\n    cloned.invoices = this.flattenInvoices(cloned.ewaybills || cloned.invoices || []);\n    this.editingStock = cloned;\n    this.manifestEditsById = {};\n    this.pendingManifestAdjustment = null;\n    this.manifestAdjustmentLines = [];\n    this.showManifestAdjustmentPopup = false;\n    this.captureOriginalProductValues(this.editingStock);\n  }\n  saveStockEdit() {\n    if (!this.editingStock) return;\n    if (this.pendingManifestAdjustment || this.showManifestAdjustmentPopup) {\n      this.applyManifestAdjustments();\n      if (this.pendingManifestAdjustment || this.showManifestAdjustmentPopup) {\n        return;\n      }\n    }\n    this.syncEwaybillsFromInvoices();\n    console.log(\"kkkkkkkkkkklllllllllllllllll\" + this.editingStock.consignmentNumber);\n    const payload = this.buildShipmentPayload();\n    const manifestUpdates = Object.values(this.manifestEditsById || {});\n    const updateManifests$ = manifestUpdates.length ? forkJoin(manifestUpdates.map(m => this.http.put(`http://localhost:3000/api/manifest/${m._id}`, m))) : of([]);\n    updateManifests$.subscribe({\n      next: () => {\n        this.http.put(`http://localhost:3000/api/newshipments/${payload.consignmentNumber}`, payload).subscribe({\n          next: () => {\n            console.log('�o. Stock updated');\n            this.loadStocks(); // reload updated data\n            this.editingStock = null; // close modal\n          },\n          error: err => console.error('�?O Error updating stock:', err)\n        });\n      },\n      error: err => {\n        console.error('�?O Error updating manifests:', err);\n        alert('Failed to update manifests. Please try again.');\n      }\n    });\n  }\n  cancelEdit() {\n    this.editingStock = null;\n    this.pendingManifestAdjustment = null;\n    this.manifestAdjustmentLines = [];\n    this.showManifestAdjustmentPopup = false;\n  }\n  captureOriginalProductValues(stock) {\n    (stock?.invoices || []).forEach(inv => {\n      (inv.products || []).forEach(prod => {\n        prod._originalAmount = Number(prod.amount) || 0;\n        prod._originalInstock = Number(prod.instock) || 0;\n        prod._originalIntransit = Number(prod.intransitstock) || 0;\n        prod._originalDelivered = Number(prod.deliveredstock) || 0;\n      });\n    });\n  }\n  resetProductToOriginal(product) {\n    product.amount = Number(product._originalAmount) || 0;\n    product.instock = Number(product._originalInstock) || 0;\n    product.intransitstock = Number(product._originalIntransit) || 0;\n    product.deliveredstock = Number(product._originalDelivered) || 0;\n  }\n  normalizeInvoiceNumber(invoice) {\n    return String(invoice?.number || invoice?.invoicenum || '').trim();\n  }\n  normalizeProductType(product) {\n    return String(product?.type || '').trim();\n  }\n  getManifestTotals() {\n    const lines = this.manifestAdjustmentLines || [];\n    const deliveredTotal = lines.filter(line => line?.isDelivered).reduce((sum, line) => sum + (Number(line.newManifestQty) || 0), 0);\n    const manifestTotal = lines.reduce((sum, line) => sum + (Number(line.newManifestQty) || 0), 0);\n    const intransitTotal = Math.max(0, manifestTotal - deliveredTotal);\n    return {\n      manifestTotal,\n      deliveredTotal,\n      intransitTotal\n    };\n  }\n  syncEwaybillsFromInvoices() {\n    if (!this.editingStock?.ewaybills?.length || !this.editingStock?.invoices?.length) return;\n    for (const flatInv of this.editingStock.invoices || []) {\n      const flatInvNumber = this.normalizeInvoiceNumber(flatInv);\n      for (const ewb of this.editingStock.ewaybills || []) {\n        for (const inv of ewb.invoices || []) {\n          if (this.normalizeInvoiceNumber(inv) !== flatInvNumber) continue;\n          for (const prod of inv.products || []) {\n            const flatProd = (flatInv.products || []).find(p => this.normalizeProductType(p) === this.normalizeProductType(prod));\n            if (!flatProd) continue;\n            prod.amount = flatProd.amount;\n            prod.instock = flatProd.instock;\n            prod.intransitstock = flatProd.intransitstock;\n            prod.deliveredstock = flatProd.deliveredstock;\n            if (flatProd.manifestQty !== undefined) {\n              prod.manifestQty = flatProd.manifestQty;\n            }\n          }\n        }\n      }\n    }\n  }\n  applyProductUpdate(invoices, invoiceNumber, productType, update) {\n    const normalizedInvoice = String(invoiceNumber || '').trim();\n    const normalizedProduct = String(productType || '').trim();\n    (invoices || []).forEach(inv => {\n      const invNumber = this.normalizeInvoiceNumber(inv);\n      if (normalizedInvoice && invNumber !== normalizedInvoice) return;\n      (inv.products || []).forEach(prod => {\n        if (this.normalizeProductType(prod) !== normalizedProduct) return;\n        update(prod);\n      });\n    });\n  }\n  isProductManifested(product) {\n    return Number(product?._originalIntransit ?? product?.intransitstock ?? 0) > 0;\n  }\n  onProductAmountFocus(invoice, product, invoiceIndex) {\n    if (!this.isProductManifested(product)) return;\n    this.openManifestAdjustmentPopup(invoice, product, product.amount, invoiceIndex);\n  }\n  onProductAmountChange(invoice, product, rawValue, invoiceIndex) {\n    if (!this.editingStock) return;\n    let newAmount = Number(rawValue);\n    if (!Number.isFinite(newAmount)) newAmount = 0;\n    if (newAmount < 0) newAmount = 0;\n    const originalAmount = Number(product._originalAmount) || 0;\n    const originalInstock = Number(product._originalInstock) || 0;\n    const originalIntransit = Number(product._originalIntransit) || 0;\n    const originalDelivered = Number(product._originalDelivered) || 0;\n    if (!this.isProductManifested(product)) {\n      if (newAmount >= originalAmount) {\n        const delta = newAmount - originalAmount;\n        product.amount = newAmount;\n        product.instock = originalInstock + delta;\n        product.intransitstock = originalIntransit;\n        product.deliveredstock = originalDelivered;\n        return;\n      }\n      const reduction = originalAmount - newAmount;\n      if (reduction <= originalInstock) {\n        product.amount = newAmount;\n        product.instock = originalInstock - reduction;\n        product.intransitstock = originalIntransit;\n        product.deliveredstock = originalDelivered;\n        return;\n      }\n      alert('Reduction exceeds available in-stock quantity.');\n      this.resetProductToOriginal(product);\n      return;\n    }\n    const reduction = originalAmount - newAmount;\n    if (reduction > originalInstock + originalIntransit) {\n      alert('Reduction exceeds available in-stock and manifested quantity.');\n      this.resetProductToOriginal(product);\n      return;\n    }\n    if (!this.pendingManifestAdjustment || this.pendingManifestAdjustment.productRef !== product) {\n      this.openManifestAdjustmentPopup(invoice, product, newAmount, invoiceIndex);\n      return;\n    }\n    this.pendingManifestAdjustment.targetAmount = newAmount;\n    product.amount = newAmount;\n  }\n  openManifestAdjustmentPopup(invoice, product, targetAmount, invoiceIndex) {\n    const consignmentNumber = this.editingStock?.consignmentNumber;\n    if (!consignmentNumber) return;\n    let invoiceNumber = this.normalizeInvoiceNumber(invoice);\n    if (!invoiceNumber && Number.isFinite(invoiceIndex)) {\n      invoiceNumber = `MAN-${String(consignmentNumber || '').trim()}-${Number(invoiceIndex) + 1}`;\n    }\n    this.pendingManifestAdjustment = {\n      consignmentNumber,\n      invoiceNumber,\n      productType: this.normalizeProductType(product),\n      targetAmount: Number(targetAmount) || 0,\n      popupInstock: Number(product._originalInstock) || 0,\n      originalAmount: Number(product._originalAmount) || 0,\n      originalInstock: Number(product._originalInstock) || 0,\n      originalIntransit: Number(product._originalIntransit) || 0,\n      originalDelivered: Number(product._originalDelivered) || 0,\n      productRef: product\n    };\n    this.http.get(`http://localhost:3000/api/manifest/by-consignment/${encodeURIComponent(consignmentNumber)}`).subscribe({\n      next: res => {\n        this.manifestAdjustments = res || [];\n        this.buildManifestAdjustmentLines();\n      },\n      error: err => {\n        console.error('Error loading manifests:', err);\n        alert('Failed to load manifests for adjustment.');\n        this.cancelManifestAdjustments();\n      }\n    });\n  }\n  buildManifestAdjustmentLines() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    const productType = pending.productType;\n    const consignmentNumber = pending.consignmentNumber;\n    const lines = [];\n    for (const manifest of this.manifestAdjustments || []) {\n      for (const cons of manifest.consignments || []) {\n        if (String(cons.consignmentNumber || '').trim() !== consignmentNumber) continue;\n        for (const inv of cons.invoices || []) {\n          const invNumber = this.normalizeInvoiceNumber(inv);\n          if (pending.invoiceNumber && invNumber !== pending.invoiceNumber) continue;\n          for (const prod of inv.products || []) {\n            if (this.normalizeProductType(prod) !== productType) continue;\n            const originalManifestQty = Number(prod.manifestQty) || 0;\n            lines.push({\n              manifestId: manifest._id,\n              manifestationNumber: manifest.manifestationNumber,\n              date: manifest.date,\n              manifestStatus: manifest.mshipmentStatus,\n              consignmentNumber,\n              invoiceNumber: invNumber,\n              productType,\n              originalManifestQty,\n              newManifestQty: originalManifestQty,\n              isDelivered: String(manifest.mshipmentStatus || '').toLowerCase() === 'delivered'\n            });\n          }\n        }\n      }\n    }\n    if (!lines.length) {\n      alert('No manifest lines found for this product.');\n      this.cancelManifestAdjustments();\n      return;\n    }\n    this.manifestAdjustmentLines = lines;\n    this.syncPopupInstockWithTarget();\n    this.showManifestAdjustmentPopup = true;\n  }\n  onManifestQtyChange(line) {\n    let value = Number(line.newManifestQty);\n    if (!Number.isFinite(value)) value = 0;\n    if (value < 0) value = 0;\n    line.newManifestQty = value;\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    const totals = this.getManifestTotals();\n    pending.targetAmount = (Number(pending.popupInstock) || 0) + totals.manifestTotal;\n    if (pending.productRef) {\n      pending.productRef.amount = Number(pending.targetAmount) || 0;\n    }\n  }\n  getManifestLineTotal() {\n    return this.getManifestTotals().manifestTotal;\n  }\n  getPopupTargetTotal() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return 0;\n    return Number(pending.targetAmount) || 0;\n  }\n  getPopupDeliveredTotal() {\n    return this.getManifestTotals().deliveredTotal;\n  }\n  getPopupInstockTotal() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return 0;\n    const totals = this.getManifestTotals();\n    return (Number(pending.targetAmount) || 0) - totals.manifestTotal;\n  }\n  syncPopupInstockWithTarget() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    const totals = this.getManifestTotals();\n    const targetAmount = Number(pending.targetAmount) || 0;\n    const computedInstock = targetAmount - totals.manifestTotal;\n    pending.popupInstock = Math.max(0, computedInstock);\n    pending.targetAmount = pending.popupInstock + totals.manifestTotal;\n  }\n  syncTargetFromInstock() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    const popupInstock = Math.max(0, Number(pending.popupInstock) || 0);\n    pending.popupInstock = popupInstock;\n    const totals = this.getManifestTotals();\n    pending.targetAmount = popupInstock + totals.manifestTotal;\n  }\n  onPopupTargetAmountChange(rawValue) {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    let newAmount = Number(rawValue);\n    if (!Number.isFinite(newAmount)) newAmount = 0;\n    if (newAmount < 0) newAmount = 0;\n    pending.targetAmount = newAmount;\n    this.syncPopupInstockWithTarget();\n    if (pending.productRef) {\n      pending.productRef.amount = newAmount;\n    }\n  }\n  onPopupInstockChange(rawValue) {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    let newInstock = Number(rawValue);\n    if (!Number.isFinite(newInstock)) newInstock = 0;\n    if (newInstock < 0) newInstock = 0;\n    pending.popupInstock = newInstock;\n    this.syncTargetFromInstock();\n    if (pending.productRef) {\n      pending.productRef.amount = Number(pending.targetAmount) || 0;\n    }\n  }\n  applyManifestAdjustments() {\n    const pending = this.pendingManifestAdjustment;\n    if (!pending) return;\n    const totals = this.getManifestTotals();\n    const instockTotal = Math.max(0, Number(pending.popupInstock) || 0);\n    const targetAmount = instockTotal + totals.manifestTotal;\n    if (instockTotal < 0) {\n      alert('New Total Qty must be at least manifest + delivered quantities.');\n      return;\n    }\n    for (const line of this.manifestAdjustmentLines || []) {\n      line.updatedAmount = targetAmount;\n      line.updatedInstock = instockTotal;\n      line.updatedIntransit = totals.intransitTotal;\n      line.updatedDelivered = totals.deliveredTotal;\n    }\n    for (const line of this.manifestAdjustmentLines || []) {\n      this.queueManifestUpdate(line);\n    }\n    const updateTotals = prod => {\n      prod.amount = targetAmount;\n      prod.instock = instockTotal;\n      prod.intransitstock = totals.intransitTotal;\n      prod.deliveredstock = totals.deliveredTotal;\n      prod.manifestQty = totals.manifestTotal;\n    };\n    if (pending.productRef) {\n      updateTotals(pending.productRef);\n    }\n    this.applyProductUpdate(this.editingStock?.invoices || [], pending.invoiceNumber, pending.productType, updateTotals);\n    (this.editingStock?.ewaybills || []).forEach(ewb => {\n      this.applyProductUpdate(ewb.invoices || [], pending.invoiceNumber, pending.productType, updateTotals);\n    });\n    this.pendingManifestAdjustment = null;\n    this.manifestAdjustmentLines = [];\n    this.showManifestAdjustmentPopup = false;\n  }\n  cancelManifestAdjustments() {\n    const pending = this.pendingManifestAdjustment;\n    if (pending?.productRef) this.resetProductToOriginal(pending.productRef);\n    this.pendingManifestAdjustment = null;\n    this.manifestAdjustmentLines = [];\n    this.showManifestAdjustmentPopup = false;\n  }\n  queueManifestUpdate(line) {\n    const manifest = (this.manifestAdjustments || []).find(m => m._id === line.manifestId);\n    if (!manifest) return;\n    for (const cons of manifest.consignments || []) {\n      if (String(cons.consignmentNumber || '').trim() !== line.consignmentNumber) continue;\n      for (const inv of cons.invoices || []) {\n        const invNumber = this.normalizeInvoiceNumber(inv);\n        if (invNumber !== line.invoiceNumber) continue;\n        for (const prod of inv.products || []) {\n          if (this.normalizeProductType(prod) !== line.productType) continue;\n          prod.manifestQty = Number(line.newManifestQty) || 0;\n          if (line.updatedAmount !== undefined) {\n            prod.amount = Number(line.updatedAmount) || 0;\n            prod.instock = Number(line.updatedInstock) || 0;\n            prod.intransitstock = Number(line.updatedIntransit) || 0;\n            prod.deliveredstock = Number(line.updatedDelivered) || 0;\n          }\n        }\n      }\n    }\n    this.manifestEditsById[manifest._id] = manifest;\n  }\n  buildShipmentPayload() {\n    const payload = JSON.parse(JSON.stringify(this.editingStock));\n    const cleanProduct = prod => {\n      delete prod._originalAmount;\n      delete prod._originalInstock;\n      delete prod._originalIntransit;\n      delete prod._originalDelivered;\n    };\n    (payload.ewaybills || []).forEach(ewb => {\n      (ewb.invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => cleanProduct(prod));\n      });\n    });\n    (payload.invoices || []).forEach(inv => {\n      (inv.products || []).forEach(prod => cleanProduct(prod));\n    });\n    return payload;\n  }\n  onConsignorSelect(name) {\n    const selectedconignor = this.clientList.find(c => c.clientName === name);\n    if (selectedconignor) {\n      this.editingStock.consignorGST = selectedconignor.GSTIN;\n      this.editingStock.consignorAddress = selectedconignor.address;\n      this.editingStock.consignorPhone = selectedconignor.phoneNum;\n    }\n  }\n  onConsigneeSelect(name) {\n    const selectedconignee = this.clientList.find(c => c.clientName === name);\n    if (selectedconignee) {\n      this.editingStock.consigneeGST = selectedconignee.GSTIN;\n      this.editingStock.consigneeAddress = selectedconignee.address;\n      this.editingStock.consigneePhone = selectedconignee.phoneNum;\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const selectedguestconignor = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignor) {\n      this.editingStock.consignorGST = 'GUEST';\n      this.editingStock.consignorAddress = selectedguestconignor.address;\n      this.editingStock.consignorPhone = selectedguestconignor.phoneNum;\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const selectedguestconignee = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignee) {\n      this.editingStock.consigneeGST = 'GUEST';\n      this.editingStock.editingStock.consigneeAddress = selectedguestconignee.address;\n      this.editingStock.editingStock.consigneePhone = selectedguestconignee.phoneNum;\n    }\n  }\n  onPackageList(name) {\n    const selectedpackage = this.pkgList.find(c => c.pkgName === name);\n  }\n  onProductList(name) {\n    const selectedproduct = this.productList.find(c => c.productName === name);\n  }\n  addRoutePoint() {\n    if (!this.selectedRoutePoint) return;\n    const vehicleNo = this.selectedRouteVehicle || '';\n    this.shipmentRoute.push({\n      name: this.selectedRoutePoint.name,\n      type: this.selectedRoutePoint.type,\n      vehicleNo\n    });\n    this.selectedRoutePoint = null;\n    this.selectedRouteVehicle = '';\n  }\n  removeRoutePoint(index) {\n    this.shipmentRoute.splice(index, 1);\n  }\n  loadBranches() {\n    const email = localStorage.getItem('email');\n    this.http.get(`http://localhost:3000/api/branches?email=${email}`).subscribe({\n      next: data => {\n        console.log(\"Branches loaded:\", data);\n        this.branches = data;\n        this.updateAvailableRoutePoints(); // ⬅️ Refresh route options\n      },\n      error: err => console.error(\"Error loading branches:\", err)\n    });\n  }\n  loadHubs() {\n    const email = localStorage.getItem('email');\n    this.http.get(`http://localhost:3000/api/hubs?email=${email}`).subscribe({\n      next: data => {\n        console.log(\"Hubs loaded:\", data);\n        this.hubs = data;\n        this.updateAvailableRoutePoints(); // ⬅️ Refresh route options\n      },\n      error: err => console.error(\"Error loading hubs:\", err)\n    });\n  }\n  updateAvailableRoutePoints() {\n    this.availableRoutePoints = [...this.branches.map(b => ({\n      name: b.branchName,\n      type: \"Branch\",\n      vehicles: (b.vehicles || []).map(v => v.vehicleNo).filter(Boolean)\n    })), ...this.hubs.map(h => ({\n      name: h.hubName,\n      type: \"Hub\",\n      vehicles: (h.deliveryAddresses || []).flatMap(addr => (addr.vehicles || []).map(v => v.vehicleNo)).filter(Boolean)\n    }))];\n  }\n  onRoutePointChange() {\n    this.selectedRouteVehicle = this.selectedRoutePoint?.vehicles?.[0] || '';\n  }\n  buildRouteString() {\n    if (!this.shipmentRoute.length) return '';\n    const hasBaskets = (this.routeBaskets || []).length > 0;\n    const prefix = hasBaskets ? `$$${this.buildBasketDescriptor()}$$ ` : '$$All$$ ';\n    return prefix + this.shipmentRoute.map(p => {\n      const vehicle = String(p.vehicleNo || '').trim();\n      return vehicle ? `${p.name} (${p.type})|${vehicle}` : `${p.name} (${p.type})`;\n    }).join(' -> ');\n  }\n  buildBasketDescriptor() {\n    return (this.routeBaskets || []).filter(b => b && String(b.labelKey || '').trim() && Number(b.qty) > 0).map(b => {\n      const key = String(b.labelKey || '').trim();\n      const parts = key.split('|');\n      const labelType = parts.shift() || '';\n      const labelValue = parts.join('|');\n      const label = labelValue ? `${labelType}:${labelValue}` : labelType;\n      return `${label}-${Number(b.qty)}`;\n    }).join('|');\n  }\n  addRouteBasket() {\n    const options = this.getBasketOptions();\n    const firstKey = options.length ? options[0].key : '';\n    this.routeBaskets.push({\n      labelKey: firstKey,\n      qty: 0\n    });\n  }\n  removeRouteBasket(index) {\n    if (index < 0 || index >= this.routeBaskets.length) return;\n    this.routeBaskets.splice(index, 1);\n  }\n  getBasketOptions() {\n    const consignment = (this.selectedForManifestation || [])[0];\n    if (!consignment) return [];\n    const options = [];\n    const consNum = consignment.consignmentNumber || '';\n    if (consNum) {\n      options.push({\n        key: `Consignment|${consNum}`,\n        text: `Consignment: ${consNum}`\n      });\n    }\n    const ewaybills = consignment.ewaybills || [];\n    if (ewaybills.length) {\n      ewaybills.forEach((ewb, eIdx) => {\n        const eNum = ewb.number || ewb.ewaybillNumber || `EWB-${eIdx + 1}`;\n        options.push({\n          key: `Ewaybill|${eNum}`,\n          text: `Ewaybill: ${eNum}`\n        });\n        (ewb.invoices || []).forEach((inv, iIdx) => {\n          const invNum = inv.number || inv.invoicenum || `INV-${iIdx + 1}`;\n          options.push({\n            key: `Invoice|${invNum}`,\n            text: `Invoice: ${invNum}`\n          });\n          (inv.products || []).forEach((prod, pIdx) => {\n            const pType = prod.type || prod.productName || `Product-${pIdx + 1}`;\n            options.push({\n              key: `Product|${invNum}:${pType}`,\n              text: `Product: ${invNum} - ${pType}`\n            });\n          });\n        });\n      });\n      return options;\n    }\n    (consignment.invoices || []).forEach((inv, iIdx) => {\n      const invNum = inv.number || inv.invoicenum || `INV-${iIdx + 1}`;\n      options.push({\n        key: `Invoice|${invNum}`,\n        text: `Invoice: ${invNum}`\n      });\n      (inv.products || []).forEach((prod, pIdx) => {\n        const pType = prod.type || prod.productName || `Product-${pIdx + 1}`;\n        options.push({\n          key: `Product|${invNum}:${pType}`,\n          text: `Product: ${invNum} - ${pType}`\n        });\n      });\n    });\n    return options;\n  }\n  ngOnInit() {\n    this.email = localStorage.getItem('email') || '';\n    this.username = localStorage.getItem('username') || '';\n    this.branch = this.branchService.currentBranch || localStorage.getItem('branch') || 'All Branches';\n    this.branchSub = this.branchService.branch$.subscribe(branch => {\n      this.branch = branch;\n      this.loadStocks();\n    });\n    // react to branch changes (same tab)\n    this.branchCheck = setInterval(() => {\n      const current = localStorage.getItem('branch') || 'All Branches';\n      if (current !== this.branch) {\n        this.branch = current;\n        this.loadStocks();\n      }\n    }, 1000);\n    // react to branch changes (other tabs)\n    window.addEventListener('storage', this.onStorageChange);\n    // Clients list\n    this.http.get(`http://localhost:3000/api/clients/clientslist?emailId=${this.email}`).subscribe({\n      next: data => this.clientList = data,\n      error: err => console.error('Error fetching client list', err),\n      complete: () => console.log('Client list fetch complete')\n    });\n    // Guests list\n    this.http.get(`http://localhost:3000/api/guests/guestslist?emailId=${this.email}`).subscribe({\n      next: data => this.guestList = data,\n      error: err => console.error('Error fetching guest list', err),\n      complete: () => console.log('Guest list fetch complete')\n    });\n    // Packages list\n    this.http.get(`http://localhost:3000/api/pkgs/pkglist?emailId=${this.email}`).subscribe({\n      next: data => this.pkgList = data,\n      error: err => console.error('Error fetching package list', err),\n      complete: () => console.log('Package list fetch complete')\n    });\n    // Products list\n    this.http.get(`http://localhost:3000/api/products/productlist?emailId=${this.email}`).subscribe({\n      next: data => this.productList = data,\n      error: err => console.error('Error fetching product list', err),\n      complete: () => console.log('Product list fetch complete')\n    });\n    this.loadBranches();\n    this.loadHubs();\n  }\n  ngOnDestroy() {\n    this.branchSub?.unsubscribe();\n    if (this.branchCheck) clearInterval(this.branchCheck);\n    window.removeEventListener('storage', this.onStorageChange);\n  }\n  getEwaybillNumberFromDB(consignmentNumber) {\n    const record = this.stocks.find(shipment => shipment.consignmentNumber === consignmentNumber);\n    return record?.ewaybillNumber || '';\n  }\n  openManifestationPopup() {\n    if (this.branch === 'All Branches') {\n      alert('Please select a specific branch before manifesting consignments.');\n      return;\n    }\n    // Filter selected consignments\n    this.selectedForManifestation = this.filteredStocks.filter(s => s.selected);\n    // Guard clause: ensure at least one consignment is selected\n    if (this.selectedForManifestation.length === 0) {\n      alert('⚠️ Please select at least one consignment to manifest.');\n      return;\n    }\n    this.routeBaskets = [];\n    // Initialize manifestQty and eway bill fields\n    this.selectedForManifestation = this.selectedForManifestation.map(consignment => {\n      // Set eway bill fields\n      const updatedConsignment = {\n        ...consignment,\n        ewayBillRequired: false,\n        ewaybillNumber: this.getEwaybillNumberFromDB(consignment.consignmentNumber)\n      };\n      // Set manifestQty = instock for each product\n      updatedConsignment.invoices?.forEach(invoice => {\n        invoice.products?.forEach(product => {\n          const amount = Number(product.amount) || 0;\n          const inTransit = Number(product.intransitstock) || 0;\n          const delivered = Number(product.deliveredstock) || 0;\n          const available = Math.max(0, amount - inTransit - delivered);\n          const currentInstock = Number(product.instock) || 0;\n          if (!currentInstock && available > 0) {\n            product.instock = available;\n          }\n          product.manifestQty = Number(product.instock) || available;\n          product.manifestQtyTouched = false;\n        });\n      });\n      return updatedConsignment;\n    });\n    // Show the popup\n    this.showManifestationPopup = true;\n  }\n  closeManifestationPopup() {\n    this.showManifestationPopup = false;\n  }\n  finalizeManifestation() {\n    if (this.selectedForManifestation.length === 0) {\n      alert('No consignments selected.');\n      return;\n    }\n    if (this.shipmentRoute.some(p => !String(p.vehicleNo || '').trim())) {\n      alert('Please select a vehicle for each route point.');\n      return;\n    }\n    if (this.routeBaskets.length && !this.buildBasketDescriptor()) {\n      alert('Please add at least one basket with a quantity.');\n      return;\n    }\n    const routeString = this.buildRouteString();\n    if (!routeString) {\n      alert('Please add at least one route point.');\n      return;\n    }\n    const updates = (this.selectedForManifestation || []).map(consignment => {\n      const updatedEwaybills = (consignment.ewaybills || []).map(ewb => ({\n        ...ewb,\n        routes: routeString\n      }));\n      const payload = {\n        ...consignment,\n        shipmentStatus: 'In Transit',\n        ewaybills: updatedEwaybills\n      };\n      return this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, payload);\n    });\n    if (!updates.length) return;\n    forkJoin(updates).subscribe({\n      next: () => {\n        this.showManifestationPopup = false;\n        this.selectedForManifestation = [];\n        this.filteredStocks.forEach(s => s.selected = false);\n        this.loadStocks();\n      },\n      error: err => {\n        console.error('Error updating consignment status:', err);\n        alert('Failed to update consignment status.');\n      }\n    });\n  }\n  validateManifestQty(product) {\n    product.manifestQtyTouched = true;\n    if (product.manifestQty > product.instock) {\n      alert(`⚠️ Manifest quantity cannot exceed available stock (${product.instock}).`);\n      product.manifestQty = product.instock;\n    }\n    if (product.manifestQty < 0) {\n      alert('⚠️ Manifest quantity cannot be negative.');\n      product.manifestQty = 0;\n    }\n  }\n  printReceipts() {\n    const selected = this.filteredStocks?.filter(s => s.selected) || [];\n    if (selected.length === 0) {\n      alert('No consignments selected.');\n      return;\n    }\n    fetch('assets/receipt-template.html').then(res => res.text()).then(template => {\n      let fullHtml = `\n        <html>\n          <head>\n            <style>\n              body { font-family: Arial, sans-serif; padding: 20px; }\n              h2 { margin-bottom: 0; }\n              table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .page-break { page-break-after: always; }\n            </style>\n          </head>\n          <body>\n      `;\n      selected.forEach((consignment, index) => {\n        const rows = consignment.invoices.flatMap(inv => inv.products.map(p => `\n            <tr>\n              <td>${inv.number}</td>\n              <td>${p.type}</td>\n              <td>${p.instock}</td>\n              <td>${p.manifestQty}</td>\n              <td>${p.amount}</td>\n            </tr>\n          `)).join('');\n        const htmlContent = template.replace('{{consignmentNumber}}', consignment.consignmentNumber).replace('{{consignor}}', consignment.consignor).replace('{{rows}}', rows);\n        fullHtml += htmlContent;\n        // Add page break after each consignment except the last one\n        if (index < selected.length - 1) {\n          fullHtml += `<div class=\"page-break\"></div>`;\n        }\n      });\n      fullHtml += `</body></html>`;\n      const printWindow = window.open('', '_blank');\n      if (printWindow) {\n        printWindow.document.open();\n        printWindow.document.write(fullHtml); // use write instead of body.innerHTML\n        printWindow.document.close();\n        printWindow.print();\n      }\n    });\n  }\n};\nStocksComponent = __decorate([Component({\n  selector: 'app-stocks',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './stocks.component.html',\n  styleUrls: ['./stocks.component.css']\n})], StocksComponent);\nexport { StocksComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}