{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"../../../services/branch.service\";\nexport let CategoriesComponent = /*#__PURE__*/(() => {\n  class CategoriesComponent {\n    constructor(http, branchService) {\n      this.http = http;\n      this.branchService = branchService;\n      this.activeTab = 'summary';\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.originLocId = localStorage.getItem('originLocId') || 'all';\n      this.selectedDate = new Date().toISOString().slice(0, 10);\n      this.isLoading = false;\n      this.savingFuel = false;\n      this.savingWorkers = false;\n      this.savingMaintenance = false;\n      this.infoMessage = '';\n      this.errorMessage = '';\n      this.vehicleOptions = [];\n      this.fuelEntries = [];\n      this.workerEntries = [];\n      this.maintenanceEntries = [];\n      this.summary = this.getDefaultSummary();\n      this.fuelForm = {\n        vehicleNo: '',\n        fuelType: 'diesel',\n        amount: '',\n        notes: ''\n      };\n      this.workerForm = {\n        workType: 'loading',\n        workersCount: '',\n        wagePerWorker: '',\n        notes: ''\n      };\n      this.maintenanceForm = {\n        vehicleNo: '',\n        maintenanceType: 'service',\n        amount: '',\n        notes: ''\n      };\n      this.onStorageChange = e => {\n        if (e.key === 'branch' || e.key === 'originLocId') {\n          const current = localStorage.getItem('branch') || 'All Branches';\n          const currentId = localStorage.getItem('originLocId') || 'all';\n          if (current !== this.branch || currentId !== this.originLocId) {\n            this.branch = current;\n            this.originLocId = currentId;\n            this.loadDayData();\n          }\n        }\n      };\n    }\n    ngOnInit() {\n      this.branch = this.branchService.currentBranch || this.branch;\n      this.originLocId = localStorage.getItem('originLocId') || this.originLocId;\n      this.branchSub = this.branchService.branch$.subscribe(branch => {\n        const currentoriginLocId = localStorage.getItem('originLocId') || 'all';\n        if (branch !== this.branch || currentoriginLocId !== this.originLocId) {\n          this.branch = branch;\n          this.originLocId = currentoriginLocId;\n          this.loadDayData();\n        }\n      });\n      window.addEventListener('storage', this.onStorageChange);\n      this.loadDayData();\n    }\n    ngOnDestroy() {\n      this.branchSub?.unsubscribe();\n      window.removeEventListener('storage', this.onStorageChange);\n    }\n    setTab(tab) {\n      this.activeTab = tab;\n    }\n    onDateChange() {\n      this.loadDayData();\n    }\n    get hasScopedBranch() {\n      const id = this.getNormalizedoriginLocId();\n      return Boolean(id && id !== 'all');\n    }\n    get workerPreviewTotal() {\n      const workersCount = Number(this.workerForm.workersCount);\n      const wagePerWorker = Number(this.workerForm.wagePerWorker);\n      if (!Number.isFinite(workersCount) || workersCount < 0) return 0;\n      if (!Number.isFinite(wagePerWorker) || wagePerWorker < 0) return 0;\n      return Number((workersCount * wagePerWorker).toFixed(2));\n    }\n    formatMoney(value) {\n      const amount = Number(value || 0);\n      return new Intl.NumberFormat('en-IN', {\n        style: 'currency',\n        currency: 'INR',\n        maximumFractionDigits: 2\n      }).format(Number.isFinite(amount) ? amount : 0);\n    }\n    formatDateTime(value) {\n      if (!value) return '-';\n      const parsed = new Date(value);\n      if (Number.isNaN(parsed.getTime())) return '-';\n      return parsed.toLocaleString();\n    }\n    submitFuel() {\n      if (!this.hasScopedBranch) {\n        alert('Please select a specific branch first.');\n        return;\n      }\n      const vehicleNo = String(this.fuelForm.vehicleNo || '').trim();\n      const amount = Number(this.fuelForm.amount);\n      if (!vehicleNo) {\n        alert('Vehicle is required.');\n        return;\n      }\n      if (!Number.isFinite(amount) || amount < 0) {\n        alert('Please enter a valid fuel amount.');\n        return;\n      }\n      this.savingFuel = true;\n      this.http.post('http://localhost:3000/api/categories/running-costs/fuel', {\n        date: this.selectedDate,\n        originLocId: this.getNormalizedoriginLocId(),\n        vehicleNo,\n        fuelType: this.fuelForm.fuelType,\n        amount,\n        notes: this.fuelForm.notes\n      }).subscribe({\n        next: res => {\n          this.fuelForm.amount = '';\n          this.fuelForm.notes = '';\n          alert(res?.message || 'Fuel charge added.');\n          this.loadDayData();\n        },\n        error: err => {\n          alert(err?.error?.message || 'Failed to add fuel charge.');\n        },\n        complete: () => {\n          this.savingFuel = false;\n        }\n      });\n    }\n    submitWorkers() {\n      if (!this.hasScopedBranch) {\n        alert('Please select a specific branch first.');\n        return;\n      }\n      const workersCount = Number(this.workerForm.workersCount);\n      const wagePerWorker = Number(this.workerForm.wagePerWorker);\n      if (!Number.isFinite(workersCount) || workersCount < 0) {\n        alert('Please enter valid worker count.');\n        return;\n      }\n      if (!Number.isFinite(wagePerWorker) || wagePerWorker < 0) {\n        alert('Please enter valid wage per worker.');\n        return;\n      }\n      this.savingWorkers = true;\n      this.http.post('http://localhost:3000/api/categories/running-costs/workers', {\n        date: this.selectedDate,\n        originLocId: this.getNormalizedoriginLocId(),\n        workType: this.workerForm.workType,\n        workersCount,\n        wagePerWorker,\n        notes: this.workerForm.notes\n      }).subscribe({\n        next: res => {\n          this.workerForm.workersCount = '';\n          this.workerForm.wagePerWorker = '';\n          this.workerForm.notes = '';\n          alert(res?.message || 'Worker wage entry added.');\n          this.loadDayData();\n        },\n        error: err => {\n          alert(err?.error?.message || 'Failed to add worker wages.');\n        },\n        complete: () => {\n          this.savingWorkers = false;\n        }\n      });\n    }\n    submitMaintenance() {\n      if (!this.hasScopedBranch) {\n        alert('Please select a specific branch first.');\n        return;\n      }\n      const vehicleNo = String(this.maintenanceForm.vehicleNo || '').trim();\n      const amount = Number(this.maintenanceForm.amount);\n      if (!vehicleNo) {\n        alert('Vehicle is required.');\n        return;\n      }\n      if (!Number.isFinite(amount) || amount < 0) {\n        alert('Please enter a valid maintenance amount.');\n        return;\n      }\n      this.savingMaintenance = true;\n      this.http.post('http://localhost:3000/api/categories/running-costs/maintenance', {\n        date: this.selectedDate,\n        originLocId: this.getNormalizedoriginLocId(),\n        vehicleNo,\n        maintenanceType: this.maintenanceForm.maintenanceType,\n        amount,\n        notes: this.maintenanceForm.notes\n      }).subscribe({\n        next: res => {\n          this.maintenanceForm.amount = '';\n          this.maintenanceForm.notes = '';\n          alert(res?.message || 'Maintenance cost added.');\n          this.loadDayData();\n        },\n        error: err => {\n          alert(err?.error?.message || 'Failed to add maintenance cost.');\n        },\n        complete: () => {\n          this.savingMaintenance = false;\n        }\n      });\n    }\n    getNormalizedoriginLocId() {\n      const raw = String(this.originLocId || localStorage.getItem('originLocId') || 'all').trim();\n      return raw === 'all-hubs' ? 'all' : raw || 'all';\n    }\n    loadDayData() {\n      const date = String(this.selectedDate || '').trim();\n      if (!date) return;\n      this.isLoading = true;\n      this.errorMessage = '';\n      this.infoMessage = '';\n      this.http.get('http://localhost:3000/api/categories/running-costs', {\n        params: {\n          date,\n          originLocId: this.getNormalizedoriginLocId()\n        }\n      }).subscribe({\n        next: res => {\n          this.vehicleOptions = Array.isArray(res?.vehicleOptions) ? res.vehicleOptions.map(value => String(value || '').trim()).filter(value => Boolean(value)) : [];\n          this.fuelEntries = Array.isArray(res?.fuelEntries) ? res.fuelEntries : [];\n          this.workerEntries = Array.isArray(res?.workerEntries) ? res.workerEntries : [];\n          this.maintenanceEntries = Array.isArray(res?.maintenanceEntries) ? res.maintenanceEntries : [];\n          this.summary = {\n            ...this.getDefaultSummary(),\n            ...(res?.summary || {})\n          };\n          this.syncDefaultVehicleSelection();\n        },\n        error: err => {\n          this.vehicleOptions = [];\n          this.fuelEntries = [];\n          this.workerEntries = [];\n          this.maintenanceEntries = [];\n          this.summary = this.getDefaultSummary();\n          const serverMessage = String(err?.error?.message || '').trim();\n          if (serverMessage && serverMessage.toLowerCase().includes('select a specific branch')) {\n            this.infoMessage = serverMessage;\n            this.errorMessage = '';\n          } else {\n            this.errorMessage = serverMessage || 'Failed to load running cost data.';\n          }\n        },\n        complete: () => {\n          this.isLoading = false;\n        }\n      });\n    }\n    syncDefaultVehicleSelection() {\n      if (!this.vehicleOptions.length) {\n        this.fuelForm.vehicleNo = '';\n        this.maintenanceForm.vehicleNo = '';\n        return;\n      }\n      if (!this.fuelForm.vehicleNo || !this.vehicleOptions.includes(this.fuelForm.vehicleNo)) {\n        this.fuelForm.vehicleNo = this.vehicleOptions[0];\n      }\n      if (!this.maintenanceForm.vehicleNo || !this.vehicleOptions.includes(this.maintenanceForm.vehicleNo)) {\n        this.maintenanceForm.vehicleNo = this.vehicleOptions[0];\n      }\n    }\n    getDefaultSummary() {\n      return {\n        fuelTotal: 0,\n        workersTotal: 0,\n        maintenanceTotal: 0,\n        grandTotal: 0,\n        fuelCount: 0,\n        workersCount: 0,\n        maintenanceCount: 0\n      };\n    }\n    static {\n      this.ɵfac = function CategoriesComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || CategoriesComponent)(i0.ɵɵdirectiveInject(i1.HttpClient), i0.ɵɵdirectiveInject(i2.BranchService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: CategoriesComponent,\n        selectors: [[\"app-categories\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 2,\n        vars: 0,\n        template: function CategoriesComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"h2\");\n            i0.ɵɵtext(1, \"Running cost\");\n            i0.ɵɵelementEnd();\n          }\n        },\n        dependencies: [CommonModule, FormsModule],\n        styles: [\"h2[_ngcontent-%COMP%]{color:#1976d2}\"]\n      });\n    }\n  }\n  return CategoriesComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}