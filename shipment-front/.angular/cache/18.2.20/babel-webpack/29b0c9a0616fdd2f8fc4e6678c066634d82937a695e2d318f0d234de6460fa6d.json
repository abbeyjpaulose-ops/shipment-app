{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/common\";\nimport * as i3 from \"@angular/forms\";\nfunction ManifestComponent_tr_31_div_12_li_12_li_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ÉµÉµelementStart(0, \"li\");\n    i0.ÉµÉµtext(1);\n    i0.ÉµÉµelementEnd();\n  }\n  if (rf & 2) {\n    const p_r3 = ctx.$implicit;\n    i0.ÉµÉµadvance();\n    i0.ÉµÉµtextInterpolate3(\" \", p_r3.type, \" \\u2014 Manifested: \", p_r3.manifestQty, \" / Stock: \", p_r3.instock, \" \");\n  }\n}\nfunction ManifestComponent_tr_31_div_12_li_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ÉµÉµelementStart(0, \"li\")(1, \"b\");\n    i0.ÉµÉµtext(2);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµtext(3);\n    i0.ÉµÉµelementStart(4, \"ul\");\n    i0.ÉµÉµtemplate(5, ManifestComponent_tr_31_div_12_li_12_li_5_Template, 2, 3, \"li\", 13);\n    i0.ÉµÉµelementEnd()();\n  }\n  if (rf & 2) {\n    const inv_r4 = ctx.$implicit;\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtextInterpolate1(\"#\", inv_r4.number, \"\");\n    i0.ÉµÉµadvance();\n    i0.ÉµÉµtextInterpolate1(\" (\\u20B9\", inv_r4.value, \") \");\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµproperty(\"ngForOf\", inv_r4.products);\n  }\n}\nfunction ManifestComponent_tr_31_div_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ÉµÉµelementStart(0, \"div\", 19)(1, \"strong\");\n    i0.ÉµÉµtext(2, \"Consignment:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµtext(3);\n    i0.ÉµÉµelement(4, \"br\");\n    i0.ÉµÉµelementStart(5, \"strong\");\n    i0.ÉµÉµtext(6, \"Consignor:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµtext(7);\n    i0.ÉµÉµelement(8, \"br\");\n    i0.ÉµÉµelementStart(9, \"strong\");\n    i0.ÉµÉµtext(10, \"Invoices:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(11, \"ul\");\n    i0.ÉµÉµtemplate(12, ManifestComponent_tr_31_div_12_li_12_Template, 6, 3, \"li\", 13);\n    i0.ÉµÉµelementEnd()();\n  }\n  if (rf & 2) {\n    const c_r5 = ctx.$implicit;\n    i0.ÉµÉµadvance(3);\n    i0.ÉµÉµtextInterpolate1(\" \", c_r5.consignmentNumber, \"\");\n    i0.ÉµÉµadvance(4);\n    i0.ÉµÉµtextInterpolate1(\" \", c_r5.consignor, \"\");\n    i0.ÉµÉµadvance(5);\n    i0.ÉµÉµproperty(\"ngForOf\", c_r5.invoices);\n  }\n}\nfunction ManifestComponent_tr_31_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ÉµÉµgetCurrentView();\n    i0.ÉµÉµelementStart(0, \"tr\")(1, \"td\")(2, \"input\", 15);\n    i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_tr_31_Template_input_ngModelChange_2_listener($event) {\n      const manifest_r2 = i0.ÉµÉµrestoreView(_r1).$implicit;\n      i0.ÉµÉµtwoWayBindingSet(manifest_r2.selected, $event) || (manifest_r2.selected = $event);\n      return i0.ÉµÉµresetView($event);\n    });\n    i0.ÉµÉµelementEnd()();\n    i0.ÉµÉµelementStart(3, \"td\");\n    i0.ÉµÉµtext(4);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(5, \"td\");\n    i0.ÉµÉµtext(6);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(7, \"td\");\n    i0.ÉµÉµtext(8);\n    i0.ÉµÉµpipe(9, \"date\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(10, \"td\")(11, \"div\", 16);\n    i0.ÉµÉµtemplate(12, ManifestComponent_tr_31_div_12_Template, 13, 3, \"div\", 17);\n    i0.ÉµÉµelementEnd()();\n    i0.ÉµÉµelementStart(13, \"td\");\n    i0.ÉµÉµtext(14);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(15, \"td\")(16, \"button\", 18);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_tr_31_Template_button_click_16_listener() {\n      const manifest_r2 = i0.ÉµÉµrestoreView(_r1).$implicit;\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.openEditPopup(manifest_r2));\n    });\n    i0.ÉµÉµtext(17, \"\\u270F\\uFE0F Edit\");\n    i0.ÉµÉµelementEnd()()();\n  }\n  if (rf & 2) {\n    const manifest_r2 = ctx.$implicit;\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtwoWayProperty(\"ngModel\", manifest_r2.selected);\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtextInterpolate(manifest_r2.manifestationNumber);\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtextInterpolate(manifest_r2.mshipmentStatus);\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtextInterpolate(i0.ÉµÉµpipeBind2(9, 6, manifest_r2.date, \"mediumDate\"));\n    i0.ÉµÉµadvance(4);\n    i0.ÉµÉµproperty(\"ngForOf\", manifest_r2.consignments);\n    i0.ÉµÉµadvance(2);\n    i0.ÉµÉµtextInterpolate(manifest_r2.branch);\n  }\n}\nfunction ManifestComponent_div_32_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ÉµÉµgetCurrentView();\n    i0.ÉµÉµelementStart(0, \"div\", 20)(1, \"div\", 21)(2, \"h3\");\n    i0.ÉµÉµtext(3, \"Edit Manifest\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(4, \"label\");\n    i0.ÉµÉµtext(5, \"Manifest #:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(6, \"input\", 22);\n    i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_div_32_Template_input_ngModelChange_6_listener($event) {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      i0.ÉµÉµtwoWayBindingSet(ctx_r5.selectedManifest.manifestationNumber, $event) || (ctx_r5.selectedManifest.manifestationNumber = $event);\n      return i0.ÉµÉµresetView($event);\n    });\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(7, \"label\");\n    i0.ÉµÉµtext(8, \"Status:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(9, \"input\", 22);\n    i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_div_32_Template_input_ngModelChange_9_listener($event) {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      i0.ÉµÉµtwoWayBindingSet(ctx_r5.selectedManifest.mshipmentStatus, $event) || (ctx_r5.selectedManifest.mshipmentStatus = $event);\n      return i0.ÉµÉµresetView($event);\n    });\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(10, \"label\");\n    i0.ÉµÉµtext(11, \"Date:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(12, \"input\", 23);\n    i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_div_32_Template_input_ngModelChange_12_listener($event) {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      i0.ÉµÉµtwoWayBindingSet(ctx_r5.selectedManifest.date, $event) || (ctx_r5.selectedManifest.date = $event);\n      return i0.ÉµÉµresetView($event);\n    });\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(13, \"label\");\n    i0.ÉµÉµtext(14, \"Branch:\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(15, \"input\", 22);\n    i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_div_32_Template_input_ngModelChange_15_listener($event) {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      i0.ÉµÉµtwoWayBindingSet(ctx_r5.selectedManifest.branch, $event) || (ctx_r5.selectedManifest.branch = $event);\n      return i0.ÉµÉµresetView($event);\n    });\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(16, \"div\", 24)(17, \"button\", 25);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_32_Template_button_click_17_listener() {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.finalizeEdit());\n    });\n    i0.ÉµÉµtext(18, \"\\u2705 Save\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(19, \"button\", 26);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_32_Template_button_click_19_listener() {\n      i0.ÉµÉµrestoreView(_r7);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.closeEditPopup());\n    });\n    i0.ÉµÉµtext(20, \"\\u274C Cancel\");\n    i0.ÉµÉµelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r5 = i0.ÉµÉµnextContext();\n    i0.ÉµÉµadvance(6);\n    i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx_r5.selectedManifest.manifestationNumber);\n    i0.ÉµÉµadvance(3);\n    i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx_r5.selectedManifest.mshipmentStatus);\n    i0.ÉµÉµadvance(3);\n    i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx_r5.selectedManifest.date);\n    i0.ÉµÉµadvance(3);\n    i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx_r5.selectedManifest.branch);\n  }\n}\nfunction ManifestComponent_div_33_li_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ÉµÉµelementStart(0, \"li\");\n    i0.ÉµÉµtext(1);\n    i0.ÉµÉµelementEnd();\n  }\n  if (rf & 2) {\n    const m_r9 = ctx.$implicit;\n    i0.ÉµÉµadvance();\n    i0.ÉµÉµtextInterpolate(m_r9.manifestationNumber);\n  }\n}\nfunction ManifestComponent_div_33_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ÉµÉµgetCurrentView();\n    i0.ÉµÉµelementStart(0, \"div\", 20)(1, \"div\", 21)(2, \"h3\");\n    i0.ÉµÉµtext(3, \"Confirm Delivery\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(4, \"p\")(5, \"b\");\n    i0.ÉµÉµtext(6, \"Selected Manifests:\");\n    i0.ÉµÉµelementEnd()();\n    i0.ÉµÉµelementStart(7, \"ul\");\n    i0.ÉµÉµtemplate(8, ManifestComponent_div_33_li_8_Template, 2, 1, \"li\", 13);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(9, \"div\", 24)(10, \"button\", 25);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_33_Template_button_click_10_listener() {\n      i0.ÉµÉµrestoreView(_r8);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.finalizeDelivery());\n    });\n    i0.ÉµÉµtext(11, \"\\u2705 Deliver\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(12, \"button\", 26);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_33_Template_button_click_12_listener() {\n      i0.ÉµÉµrestoreView(_r8);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.closeDeliveryPopup());\n    });\n    i0.ÉµÉµtext(13, \"\\u274C Cancel\");\n    i0.ÉµÉµelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r5 = i0.ÉµÉµnextContext();\n    i0.ÉµÉµadvance(8);\n    i0.ÉµÉµproperty(\"ngForOf\", ctx_r5.selectedForDelivery);\n  }\n}\nfunction ManifestComponent_div_34_li_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ÉµÉµelementStart(0, \"li\");\n    i0.ÉµÉµtext(1);\n    i0.ÉµÉµelementEnd();\n  }\n  if (rf & 2) {\n    const m_r11 = ctx.$implicit;\n    i0.ÉµÉµadvance();\n    i0.ÉµÉµtextInterpolate(m_r11.manifestationNumber);\n  }\n}\nfunction ManifestComponent_div_34_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ÉµÉµgetCurrentView();\n    i0.ÉµÉµelementStart(0, \"div\", 20)(1, \"div\", 21)(2, \"h3\");\n    i0.ÉµÉµtext(3, \"Confirm Cancellation\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(4, \"p\")(5, \"b\");\n    i0.ÉµÉµtext(6, \"Selected Manifests:\");\n    i0.ÉµÉµelementEnd()();\n    i0.ÉµÉµelementStart(7, \"ul\");\n    i0.ÉµÉµtemplate(8, ManifestComponent_div_34_li_8_Template, 2, 1, \"li\", 13);\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(9, \"div\", 24)(10, \"button\", 25);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_34_Template_button_click_10_listener() {\n      i0.ÉµÉµrestoreView(_r10);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.finalizeCancel());\n    });\n    i0.ÉµÉµtext(11, \"\\u2705 Confirm Cancel\");\n    i0.ÉµÉµelementEnd();\n    i0.ÉµÉµelementStart(12, \"button\", 26);\n    i0.ÉµÉµlistener(\"click\", function ManifestComponent_div_34_Template_button_click_12_listener() {\n      i0.ÉµÉµrestoreView(_r10);\n      const ctx_r5 = i0.ÉµÉµnextContext();\n      return i0.ÉµÉµresetView(ctx_r5.closeCancelPopup());\n    });\n    i0.ÉµÉµtext(13, \"\\u274C Close\");\n    i0.ÉµÉµelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r5 = i0.ÉµÉµnextContext();\n    i0.ÉµÉµadvance(8);\n    i0.ÉµÉµproperty(\"ngForOf\", ctx_r5.selectedForCancel);\n  }\n}\nexport let ManifestComponent = /*#__PURE__*/(() => {\n  class ManifestComponent {\n    // Open edit popup\n    openEditPopup(manifest) {\n      this.selectedManifest = {\n        ...manifest\n      }; // clone to avoid direct mutation\n      this.showEditPopup = true;\n    }\n    // Close edit popup\n    closeEditPopup() {\n      this.showEditPopup = false;\n      this.selectedManifest = null;\n    }\n    // Save edits\n    finalizeEdit() {\n      if (!this.selectedManifest) return;\n      const email = localStorage.getItem('email') || '';\n      // Update manifest in DB\n      this.http.post(`http://localhost:3000/api/manifest/manifestationNumber`, this.selectedManifest).subscribe({\n        next: () => {\n          console.log('âœ… Manifest updated in DDDDDDDDDB', this.selectedManifest.consignments);\n          this.selectedManifest.consignments.forEach(cons => {\n            this.updateConsignment(this.username, cons);\n          });\n          console.log('âœ… Manifest updated successfully');\n          alert('Manifest updated!');\n          this.loadManifests(); // reload list\n          this.closeEditPopup();\n        },\n        error: err => console.error('âŒ Error updating manifest:', err)\n      });\n    }\n    constructor(http) {\n      this.http = http;\n      this.manifests = [];\n      this.filteredManifests = [];\n      this.searchText = '';\n      this.filterDate = '';\n      this.filterConsignor = '';\n      this.selectedManifest = null;\n      this.showDeliveryPopup = false;\n      this.selectedForDelivery = [];\n      this.email = '';\n      this.username = '';\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.showCancelPopup = false;\n      this.selectedForCancel = [];\n      this.showEditPopup = false;\n    }\n    ngOnInit() {\n      this.email = localStorage.getItem('email') || '';\n      this.username = localStorage.getItem('username') || '';\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.loadManifests();\n      this.branchCheck = setInterval(() => {\n        const current = localStorage.getItem('branch') || 'All Branches';\n        if (current !== this.branch) {\n          this.branch = current;\n          this.loadManifests();\n        }\n      }, 1000);\n    }\n    // âœ… Load all manifests from backend\n    loadManifests() {\n      this.http.get('http://localhost:3000/api/manifest', {\n        params: {\n          email: localStorage.getItem('email') || '',\n          branch: localStorage.getItem('branch') || ''\n        }\n      }).subscribe({\n        next: res => {\n          this.manifests = res.filter(item => item.mshipmentStatus != 'Delivered' && item.mshipmentStatus != 'Cancelled').sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n          this.filteredManifests = [...this.manifests];\n        },\n        error: err => console.error('âŒ Error loading shipments:', err)\n      });\n    }\n    applyFilters() {\n      this.filteredManifests = this.manifests.filter(m => (this.searchText ? m.manifestationNumber?.includes(this.searchText) || m.consignments?.some(c => c.consignor?.includes(this.searchText)) : true) && (this.filterDate ? new Date(m.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? m.consignments?.some(c => c.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase())) : true));\n    }\n    toggleAllSelection(event) {\n      const checked = event.target.checked;\n      this.filteredManifests.forEach(m => m.selected = checked);\n    }\n    // âœ… Open delivery popup\n    openDeliveryPopup() {\n      if (this.branch === 'All Branches') {\n        alert('Please select a specific branch before confirming delivery.');\n        return;\n      }\n      this.selectedForDelivery = this.filteredManifests.filter(m => m.selected);\n      if (this.selectedForDelivery.length === 0) {\n        alert('âš ï¸ Please select at least one manifest to deliver.');\n        return;\n      }\n      this.showDeliveryPopup = true;\n    }\n    closeDeliveryPopup() {\n      this.showDeliveryPopup = false;\n    }\n    // âœ… Finalize delivery and update statuses in both DBs\n    finalizeDelivery() {\n      if (this.branch === 'All Branches') {\n        alert('Please select a specific branch before confirming delivery.');\n        return;\n      }\n      if (this.selectedForDelivery.length === 0) {\n        alert('No manifests selected for delivery.');\n        return;\n      }\n      const userEmail = localStorage.getItem('email') || '';\n      this.selectedForDelivery.forEach(manifest => {\n        manifest.consignments.forEach(cons => {\n          // Update product delivery status\n          cons.invoices.forEach(inv => {\n            inv.products.forEach(p => {\n              const deliveredQty = Number(p.intransitstock) || 0;\n              if (deliveredQty > 0) {\n                p.deliveredstock = (p.deliveredstock || 0) + deliveredQty;\n                p.manifestQty = deliveredQty;\n              }\n              p.intransitstock = 0;\n            });\n          });\n          // Check if all products are fully delivered\n          const allDelivered = cons.invoices.every(inv => inv.products.every(p => (Number(p.deliveredstock) || 0) >= (Number(p.amount) || 0) || (Number(p.instock) || 0) === 0 && (Number(p.intransitstock) || 0) === 0));\n          // Prepare updated consignment\n          console.log(`ðŸšš Updating consignment1  to status:`, allDelivered);\n          const updatedConsignment = {\n            ...cons,\n            mshipmentStatus: 'Delivered'\n          };\n          console.log(`ðŸšš Updating consignment1  to status:`, updatedConsignment.mshipmentStatus);\n          // Send updated consignment using helper method\n          this.updateConsignment(this.username, updatedConsignment);\n        });\n        manifest = {\n          ...manifest,\n          mshipmentStatus: 'Delivered'\n        };\n        console.log(`ðŸšš Updating consignment ${manifest.manifestationNumber} to status:`, manifest);\n        this.http.post(`http://localhost:3000/api/manifest/manifestationNumber`, manifest).subscribe({\n          next: () => {\n            console.log('âœ… Manifest Stock updated');\n          },\n          error: err => console.error('âŒ Error updating stock:', err)\n        });\n      });\n      // Final UI updates\n      this.showDeliveryPopup = false;\n      alert('âœ… Delivery completed successfully!');\n      this.filteredManifests.forEach(m => m.selected = false);\n      this.loadManifests();\n    }\n    updatedstkConsignmentfn(updatedConsignment) {\n      this.http.put(`http://localhost:3000/api/newshipments/${updatedConsignment.consignmentNumber}`, updatedConsignment).subscribe({\n        next: () => {\n          console.log('âœ… Stock updated');\n        },\n        error: err => console.error('âŒ Error updating stock:', err)\n      });\n    }\n    updateConsignment(username, updatedConsignment) {\n      this.http.get('http://localhost:3000/api/newshipments/getConsignment', {\n        params: {\n          username: username,\n          consignmentNumber: updatedConsignment.consignmentNumber\n        }\n      }).subscribe({\n        next: res => {\n          const stkupdatedConsignment = res[0];\n          if (!stkupdatedConsignment) return;\n          const manifestQtyByType = new Map();\n          (updatedConsignment.invoices || []).forEach(inv => {\n            (inv.products || []).forEach(p => {\n              const key = String(p.type || '').trim();\n              if (!key) return;\n              const qty = Number(p.manifestQty) || 0;\n              if (qty <= 0) return;\n              manifestQtyByType.set(key, (manifestQtyByType.get(key) || 0) + qty);\n            });\n          });\n          stkupdatedConsignment.invoices?.forEach(invoice => {\n            invoice.products?.forEach(product => {\n              const key = String(product.type || '').trim();\n              const qty = manifestQtyByType.get(key) || 0;\n              if (!qty) return;\n              product.deliveredstock = (Number(product.deliveredstock) || 0) + qty;\n              product.intransitstock = Math.max(0, (Number(product.intransitstock) || 0) - qty);\n            });\n          });\n          // Check if all products are fully delivered\n          const allDelivered = stkupdatedConsignment.invoices.every(inv => inv.products.every(p => (Number(p.deliveredstock) || 0) >= (Number(p.amount) || 0)));\n          // Prepare updated consignment\n          stkupdatedConsignment.shipmentStatus = allDelivered ? 'Delivered' : 'In Transit/Pending';\n          this.updatedstkConsignmentfn(stkupdatedConsignment);\n        },\n        error: err => console.error('? Error loading shipments:', err)\n      });\n    }\n    openCancelPopup() {\n      this.selectedForCancel = this.filteredManifests.filter(m => m.selected);\n      if (this.selectedForCancel.length === 0) {\n        alert('âš ï¸ Please select at least one manifest to cancel.');\n        return;\n      }\n      this.showCancelPopup = true;\n    }\n    closeCancelPopup() {\n      this.showCancelPopup = false;\n    }\n    // âœ… Finalize cancellation\n    finalizeCancel() {\n      if (this.selectedForCancel.length === 0) {\n        alert('No manifests selected for cancellation.');\n        return;\n      }\n      const userEmail = this.email;\n      this.selectedForCancel.forEach(manifest => {\n        // Update consignments in newshipments DB\n        manifest.consignments.forEach(cons => {\n          const updatedConsignment = {\n            ...cons,\n            shipmentStatus: 'Pending'\n          };\n          this.updateConsignment(this.username, updatedConsignment);\n        });\n        // Update manifest in manifest DB\n        const cancelledManifest = {\n          ...manifest,\n          mshipmentStatus: 'Cancelled'\n        };\n        this.http.post(`http://localhost:3000/api/manifest/manifestationNumber`, cancelledManifest).subscribe({\n          next: () => {\n            manifest.consignments.forEach(cons => {\n              console.log(`ðŸ—‘ï¸ Manifest ${manifest.manifestationNumber} cancelled`, cons);\n              this.http.get('http://localhost:3000/api/newshipments/getConsignment', {\n                params: {\n                  email: localStorage.getItem('email') || '',\n                  consignmentNumber: cons.consignmentNumber\n                }\n              }).subscribe({\n                next: res => {\n                  let stkupdatedConsignment = res[0];\n                  console.log('Manifest cancelled', stkupdatedConsignment);\n                  const cancelQtyByType = new Map();\n                  (cons.invoices || []).forEach(inv => {\n                    (inv.products || []).forEach(p => {\n                      const key = String(p.type || '').trim();\n                      if (!key) return;\n                      const qty = Number(p.manifestQty) || 0;\n                      if (qty <= 0) return;\n                      cancelQtyByType.set(key, (cancelQtyByType.get(key) || 0) + qty);\n                    });\n                  });\n                  stkupdatedConsignment.invoices?.forEach(invoice => {\n                    invoice.products?.forEach(product => {\n                      const key = String(product.type || '').trim();\n                      const qty = cancelQtyByType.get(key) || 0;\n                      if (!qty) return;\n                      product.intransitstock = Math.max(0, (Number(product.intransitstock) || 0) - qty);\n                      product.instock = (Number(product.instock) || 0) + qty;\n                    });\n                  });\n                  // Check if all products are fully delivered\n                  const allDelivered = stkupdatedConsignment.invoices.every(inv => inv.products.every(p => p.deliveredstock != 0));\n                  // Prepare updated consignment\n                  console.log(`ðŸ—‘ï¸ Manifest2 cancelled`, allDelivered);\n                  stkupdatedConsignment.shipmentStatus = allDelivered ? 'Pending' : 'In Transit/Pending';\n                  this.updatedstkConsignmentfn(stkupdatedConsignment);\n                },\n                error: err => console.error('âŒ Error loading shipments:', err)\n              });\n            });\n            // Additional logic for finding the consignments and updating the newshipment respectively\n          },\n          error: err => console.error('âŒ Error cancelling manifest:', err)\n        });\n      });\n      this.showCancelPopup = false;\n      alert('ðŸ—‘ï¸ Cancellation completed successfully!');\n      this.filteredManifests.forEach(m => m.selected = false);\n      this.loadManifests();\n    }\n    //Printing the manifest\n    printManifest() {\n      const selected = this.filteredManifests?.filter(m => m.selected) || [];\n      if (selected.length === 0) {\n        alert('No manifests selected.');\n        return;\n      }\n      fetch('assets/manifest-template.html').then(res => res.text()).then(template => {\n        let fullHtml = `\n        <html>\n          <head>\n            <style>\n              body { font-family: Arial, sans-serif; padding: 20px; }\n              h2 { margin-bottom: 0; }\n              table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .page-break { page-break-after: always; }\n            </style>\n          </head>\n          <body>\n      `;\n        selected.forEach((manifest, index) => {\n          // Build rows for consignments/invoices/products\n          const rows = manifest.consignments.flatMap(c => c.invoices.flatMap(inv => inv.products.map(p => `\n              <tr>\n                <td>${manifest.manifestationNumber}</td>\n                <td>${manifest.mshipmentStatus}</td>\n                <td>${manifest.date}</td>\n                <td>${c.consignmentNumber}</td>\n                <td>${c.consignor}</td>\n                <td>${inv.number}</td>\n                <td>${p.type}</td>\n                <td>${p.manifestQty}</td>\n                <td>${p.instock}</td>\n                <td>${inv.value}</td>\n                <td>${manifest.branch}</td>\n              </tr>\n            `))).join('');\n          // Replace placeholders in template\n          const htmlContent = template.replace('{{manifestNumber}}', manifest.manifestationNumber).replace('{{status}}', manifest.mshipmentStatus).replace('{{date}}', manifest.date).replace('{{branch}}', manifest.branch).replace('{{rows}}', rows);\n          fullHtml += htmlContent;\n          // Add page break after each manifest except the last\n          if (index < selected.length - 1) {\n            fullHtml += `<div class=\"page-break\"></div>`;\n          }\n        });\n        fullHtml += `</body></html>`;\n        const printWindow = window.open('', '_blank');\n        if (printWindow) {\n          printWindow.document.open();\n          printWindow.document.write(fullHtml); // âœ… safer than body.innerHTML\n          printWindow.document.close();\n          printWindow.print();\n        }\n      }).catch(err => console.error('Error loading manifest template:', err));\n    }\n    static {\n      this.Éµfac = function ManifestComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || ManifestComponent)(i0.ÉµÉµdirectiveInject(i1.HttpClient));\n      };\n    }\n    static {\n      this.Éµcmp = /*@__PURE__*/i0.ÉµÉµdefineComponent({\n        type: ManifestComponent,\n        selectors: [[\"app-manifest\"]],\n        standalone: true,\n        features: [i0.ÉµÉµStandaloneFeature],\n        decls: 35,\n        vars: 7,\n        consts: [[1, \"manifest-container\"], [1, \"filters\"], [\"type\", \"text\", \"placeholder\", \"\\uD83D\\uDD0D Search Consignor / Manifest #\", 3, \"ngModelChange\", \"input\", \"ngModel\"], [\"type\", \"date\", 3, \"ngModelChange\", \"change\", \"ngModel\"], [\"type\", \"text\", \"placeholder\", \"\\uD83C\\uDFF7\\uFE0F Filter by Consignor\", 3, \"ngModelChange\", \"input\", \"ngModel\"], [1, \"actions\"], [1, \"delivery-btn\", 3, \"click\"], [1, \"delete-btn\", 3, \"click\"], [1, \"print-btn\", 3, \"click\"], [1, \"table-wrapper\"], [1, \"manifest-table\"], [2, \"width\", \"50px\"], [\"type\", \"checkbox\", 3, \"change\"], [4, \"ngFor\", \"ngForOf\"], [\"class\", \"popup\", 4, \"ngIf\"], [\"type\", \"checkbox\", 3, \"ngModelChange\", \"ngModel\"], [1, \"manifest-consignments\"], [\"class\", \"consignment-card\", 4, \"ngFor\", \"ngForOf\"], [1, \"edit-btn\", 3, \"click\"], [1, \"consignment-card\"], [1, \"popup\"], [1, \"popup-content\"], [\"type\", \"text\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"date\", 3, \"ngModelChange\", \"ngModel\"], [1, \"popup-actions\"], [1, \"confirm-btn\", 3, \"click\"], [1, \"cancel-btn\", 3, \"click\"]],\n        template: function ManifestComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ÉµÉµelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ÉµÉµtext(2, \"\\uD83D\\uDCE6 Manifest Records\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(3, \"div\", 1)(4, \"input\", 2);\n            i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_input_ngModelChange_4_listener($event) {\n              i0.ÉµÉµtwoWayBindingSet(ctx.searchText, $event) || (ctx.searchText = $event);\n              return $event;\n            });\n            i0.ÉµÉµlistener(\"input\", function ManifestComponent_Template_input_input_4_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(5, \"input\", 3);\n            i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_input_ngModelChange_5_listener($event) {\n              i0.ÉµÉµtwoWayBindingSet(ctx.filterDate, $event) || (ctx.filterDate = $event);\n              return $event;\n            });\n            i0.ÉµÉµlistener(\"change\", function ManifestComponent_Template_input_change_5_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(6, \"input\", 4);\n            i0.ÉµÉµtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_input_ngModelChange_6_listener($event) {\n              i0.ÉµÉµtwoWayBindingSet(ctx.filterConsignor, $event) || (ctx.filterConsignor = $event);\n              return $event;\n            });\n            i0.ÉµÉµlistener(\"input\", function ManifestComponent_Template_input_input_6_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ÉµÉµelementEnd()();\n            i0.ÉµÉµelementStart(7, \"div\", 5)(8, \"button\", 6);\n            i0.ÉµÉµlistener(\"click\", function ManifestComponent_Template_button_click_8_listener() {\n              return ctx.openDeliveryPopup();\n            });\n            i0.ÉµÉµtext(9, \"\\uD83D\\uDE9A Deliver\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(10, \"button\", 7);\n            i0.ÉµÉµlistener(\"click\", function ManifestComponent_Template_button_click_10_listener() {\n              return ctx.openCancelPopup();\n            });\n            i0.ÉµÉµtext(11, \"\\uD83D\\uDDD1\\uFE0F Delete\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(12, \"button\", 8);\n            i0.ÉµÉµlistener(\"click\", function ManifestComponent_Template_button_click_12_listener() {\n              return ctx.printManifest();\n            });\n            i0.ÉµÉµtext(13, \"\\uD83D\\uDDA8\\uFE0F Print Manifest\");\n            i0.ÉµÉµelementEnd()();\n            i0.ÉµÉµelementStart(14, \"div\", 9)(15, \"table\", 10)(16, \"thead\")(17, \"tr\")(18, \"th\", 11)(19, \"input\", 12);\n            i0.ÉµÉµlistener(\"change\", function ManifestComponent_Template_input_change_19_listener($event) {\n              return ctx.toggleAllSelection($event);\n            });\n            i0.ÉµÉµelementEnd()();\n            i0.ÉµÉµelementStart(20, \"th\");\n            i0.ÉµÉµtext(21, \"Manifest #\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(22, \"th\");\n            i0.ÉµÉµtext(23, \"Status #\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(24, \"th\");\n            i0.ÉµÉµtext(25, \"Date\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(26, \"th\");\n            i0.ÉµÉµtext(27, \"Consignor / Consignment Details\");\n            i0.ÉµÉµelementEnd();\n            i0.ÉµÉµelementStart(28, \"th\");\n            i0.ÉµÉµtext(29, \"Branch\");\n            i0.ÉµÉµelementEnd()()();\n            i0.ÉµÉµelementStart(30, \"tbody\");\n            i0.ÉµÉµtemplate(31, ManifestComponent_tr_31_Template, 18, 9, \"tr\", 13);\n            i0.ÉµÉµelementEnd()()();\n            i0.ÉµÉµtemplate(32, ManifestComponent_div_32_Template, 21, 4, \"div\", 14)(33, ManifestComponent_div_33_Template, 14, 1, \"div\", 14)(34, ManifestComponent_div_34_Template, 14, 1, \"div\", 14);\n            i0.ÉµÉµelementEnd();\n          }\n          if (rf & 2) {\n            i0.ÉµÉµadvance(4);\n            i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx.searchText);\n            i0.ÉµÉµadvance();\n            i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx.filterDate);\n            i0.ÉµÉµadvance();\n            i0.ÉµÉµtwoWayProperty(\"ngModel\", ctx.filterConsignor);\n            i0.ÉµÉµadvance(25);\n            i0.ÉµÉµproperty(\"ngForOf\", ctx.filteredManifests);\n            i0.ÉµÉµadvance();\n            i0.ÉµÉµproperty(\"ngIf\", ctx.showEditPopup);\n            i0.ÉµÉµadvance();\n            i0.ÉµÉµproperty(\"ngIf\", ctx.showDeliveryPopup);\n            i0.ÉµÉµadvance();\n            i0.ÉµÉµproperty(\"ngIf\", ctx.showCancelPopup);\n          }\n        },\n        dependencies: [CommonModule, i2.NgForOf, i2.NgIf, i2.DatePipe, FormsModule, i3.DefaultValueAccessor, i3.CheckboxControlValueAccessor, i3.NgControlStatus, i3.NgModel],\n        styles: [\".manifest-container[_ngcontent-%COMP%]{padding:1.5rem;max-width:100%;box-sizing:border-box}h2[_ngcontent-%COMP%]{margin-bottom:1rem;color:#333}.filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1 1 200px;padding:8px 10px;border:1px solid #ccc;border-radius:8px}.table-wrapper[_ngcontent-%COMP%]{width:100%;overflow-x:auto;background:#fff;border-radius:10px;box-shadow:0 0 5px #0000001a}.manifest-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;min-width:900px}.manifest-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .manifest-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #ddd;padding:10px;text-align:left;vertical-align:top}.manifest-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#f5f5f5;font-weight:600}.manifest-consignments[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.consignment-card[_ngcontent-%COMP%]{background:#fafafa;padding:6px 10px;border-radius:8px;border-left:4px solid #4caf50}.actions[_ngcontent-%COMP%]{margin-top:20px;text-align:right}.delivery-btn[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff;font-weight:600;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;transition:background .3s}.delivery-btn[_ngcontent-%COMP%]:hover{background-color:#43a047}.popup[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;justify-content:center;align-items:center;z-index:2000}.popup-content[_ngcontent-%COMP%]{background:#fff;padding:25px;border-radius:12px;width:90%;max-width:450px;text-align:center;box-shadow:0 4px 10px #0003}.popup-actions[_ngcontent-%COMP%]{margin-top:20px;display:flex;justify-content:space-around}.confirm-btn[_ngcontent-%COMP%]{background:#4caf50;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer}.cancel-btn[_ngcontent-%COMP%]{background:#f44336;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer}@media (max-width: 768px){.manifest-table[_ngcontent-%COMP%]{min-width:100%}.filters[_ngcontent-%COMP%]{flex-direction:column}.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%}.consignment-card[_ngcontent-%COMP%]{font-size:.9em}}.edit-btn[_ngcontent-%COMP%]{background-color:#ffc107;border:none;padding:5px 10px;cursor:pointer;border-radius:4px}.edit-btn[_ngcontent-%COMP%]:hover{background-color:#e0a800}.print-btn[_ngcontent-%COMP%]{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:500}.print-btn[_ngcontent-%COMP%]:hover{background:#3e8e41}\"]\n      });\n    }\n  }\n  return ManifestComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}