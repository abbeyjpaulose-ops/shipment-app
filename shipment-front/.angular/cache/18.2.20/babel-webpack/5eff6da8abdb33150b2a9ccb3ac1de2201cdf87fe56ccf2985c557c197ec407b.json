{"ast":null,"code":"var NewShipmentComponent_1;\nimport { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet NewShipmentComponent = NewShipmentComponent_1 = class NewShipmentComponent {\n  // --- Methods ---\n  addInvoice() {\n    this.invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(index) {\n    this.invoices.splice(index, 1);\n  }\n  addPackage(invoiceIndex) {\n    this.invoices[invoiceIndex].packages.push({\n      type: '',\n      // This now serves as the package name\n      amount: 0\n    });\n  }\n  deletePackage(invoiceIndex, packageIndex) {\n    this.invoices[invoiceIndex].packages.splice(packageIndex, 1);\n  }\n  addProduct(invoiceIndex) {\n    this.invoices[invoiceIndex].products.push({\n      type: '',\n      // This now serves as the product name\n      amount: 0,\n      instock: 0\n    });\n  }\n  deleteProduct(invoiceIndex, productIndex) {\n    this.invoices[invoiceIndex].products.splice(productIndex, 1);\n  }\n  calculateFinalAmount() {\n    const invoiceTotal = this.invoices.reduce((sum, i) => sum + (i.value || 0), 0);\n    const packageTotal = this.invoices.reduce((sum, i) => {\n      return sum + i.packages.reduce((pkgSum, p) => pkgSum + (p.amount || 0), 0);\n    }, 0);\n    const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n    this.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n  }\n  resetForm() {\n    Object.assign(this, new NewShipmentComponent_1(this.http));\n  }\n  // --- Serial Number logic ---\n  getFiscalYear() {\n    const today = new Date();\n    return today.getMonth() >= 3 ? today.getFullYear() : today.getFullYear() - 1;\n  }\n  getCurrentConsignmentNumber() {\n    this.http.get(`http://localhost:3000/api/newshipments/nextConsignment?emailId=${this.email}`).subscribe({\n      next: res => {\n        console.log('FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFetched consignment number:', res);\n        console.log(localStorage.getItem('consignmentNumber'));\n        this.consignmentNumber = res.nextNumber.toString();\n        localStorage.setItem('consignmentNumber', this.consignmentNumber);\n        console.log(localStorage.getItem('consignmentNumber'));\n      },\n      error: err => console.error('Error fetching consignment number', err)\n    });\n  }\n  saveShipment() {\n    const shipmentData = {\n      email: localStorage.getItem('email'),\n      username: localStorage.getItem('username'),\n      branch: localStorage.getItem('branch'),\n      shipmentStatus: this.shipmentStatus,\n      shipmentStatusDetails: localStorage.getItem('email') + '$$' + this.date + '$$' + this.shipmentStatus,\n      ewaybillNumber: this.ewaybillNumber,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date,\n      consignorTab: this.consignorTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consigneeTab: this.consigneeTab,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      paymentMode: this.paymentMode,\n      externalRefId: this.externalRefId,\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingGSTIN: this.billingGSTIN,\n      billingAddress: this.billingAddress,\n      billingPhone: this.billingPhone,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      deliveryType: this.deliveryType,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      invoices: this.invoices,\n      charges: this.charges,\n      finalAmount: this.finalAmount\n    };\n    if (this.consignorTab === 'guest') {\n      shipmentData.consignorGST = 'GUEST';\n    }\n    if (this.consigneeTab === 'guest') {\n      shipmentData.consigneeGST = 'GUEST';\n    }\n    if (this.billingType === 'consignor') {\n      shipmentData.billingName = this.consignor;\n      shipmentData.billingAddress = this.consignorAddress;\n      shipmentData.billingGSTIN = this.consignorGST;\n      shipmentData.billingPhone = this.consignorPhone;\n    }\n    if (this.pickupType === 'consignor') {\n      shipmentData.pickupName = this.consignor;\n      shipmentData.pickupAddress = this.consignorAddress;\n      shipmentData.pickupPhone = this.consignorPhone;\n    }\n    if (this.deliveryType === 'consignee') {\n      shipmentData.deliveryName = this.consignee;\n      shipmentData.deliveryAddress = this.consigneeAddress;\n      shipmentData.deliveryPhone = this.consigneePhone;\n    }\n    if (shipmentData.branch !== 'All Branches') {\n      this.http.post('http://localhost:3000/api/newshipments/add', shipmentData, {\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }).subscribe({\n        next: res => {\n          // Save shipment (later we can push to localStorage / backend)\n          console.log('Shipment Data:', shipmentData);\n          alert(`Shipment ${this.consignmentNumber} saved successfully!`);\n          this.getCurrentConsignmentNumber(); // get next consignment number\n          // reset form for next entry\n          this.resetForm();\n          window.location.reload();\n          console.log('âœ… Shipment saved', res);\n          console.log('Next Consignment Number:', this.consignmentNumber);\n          console.log(localStorage.getItem('consignmentNumber'));\n          alert(`Shipment ${this.consignmentNumber} next successfully!`);\n        },\n        error: err => {\n          console.error(\"Error saving shipment:\", err.message);\n          alert('Error: ' + err.message);\n        }\n      });\n    } else {\n      alert(`Please select a branch before saving or create one if you haven't.`);\n    }\n  }\n  onConsignorSelect(name) {\n    const selectedconignor = this.clientList.find(c => c.clientName === name);\n    if (selectedconignor) {\n      this.consignorGST = selectedconignor.GSTIN;\n      this.consignorAddress = selectedconignor.address;\n      this.consignorPhone = selectedconignor.phoneNum;\n    }\n  }\n  onConsigneeSelect(name) {\n    const selectedconignee = this.clientList.find(c => c.clientName === name);\n    if (selectedconignee) {\n      this.consigneeGST = selectedconignee.GSTIN;\n      this.consigneeAddress = selectedconignee.address;\n      this.consigneePhone = selectedconignee.phoneNum;\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const selectedguestconignor = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignor) {\n      this.consignorGST = 'GUEST';\n      this.consignorAddress = selectedguestconignor.address;\n      this.consignorPhone = selectedguestconignor.phoneNum;\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const selectedguestconignee = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignee) {\n      this.consigneeGST = 'GUEST';\n      this.consigneeAddress = selectedguestconignee.address;\n      this.consigneePhone = selectedguestconignee.phoneNum;\n    }\n  }\n  onPackageList(name) {\n    const selectedpackage = this.pkgList.find(c => c.pkgName === name);\n  }\n  onProductList(name) {\n    const selectedproduct = this.productList.find(c => c.productName === name);\n  }\n  ngOnInit() {\n    if (typeof window !== 'undefined') {\n      console.log('Window is aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaavailable');\n      this.email = localStorage.getItem('email') || '';\n      this.username = localStorage.getItem('username') || '';\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.getCurrentConsignmentNumber();\n      //clients list  \n      this.http.get(`http://localhost:3000/api/clients/clientslist?emailId=${this.email}`).subscribe(data => {\n        this.clientList = data;\n      });\n      //guest list\n      this.http.get(`http://localhost:3000/api/guests/guestslist?emailId=${this.email}`).subscribe(data => {\n        this.guestList = data;\n      }, error => {\n        console.error('Error fetching guest list', error);\n      });\n      //package list\n      this.http.get(`http://localhost:3000/api/pkgs/pkglist?emailId=${this.email}`).subscribe(data => {\n        this.pkgList = data;\n      }, error => {\n        console.error('Error fetching package list', error);\n      });\n      //product list\n      this.http.get(`http://localhost:3000/api/products/productlist?emailId=${this.email}`).subscribe(data => {\n        this.productList = data;\n      }, error => {\n        console.error('Error fetching product list', error);\n      });\n    }\n  }\n  constructor(http) {\n    this.http = http;\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    // Delivery\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.email = '';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.consignmentNumber = '-999'; // will be loaded asynchronously\n    this.date = new Date().toISOString().split('T')[0];\n    this.ewaybillNumber = '';\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'Account Credit';\n    this.externalRefId = '';\n    this.invoices = [{\n      number: '',\n      value: 0,\n      packages: [{\n        type: '',\n        amount: 1\n      }],\n      products: [{\n        type: '',\n        amount: 1,\n        instock: 1\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n  }\n};\nNewShipmentComponent = NewShipmentComponent_1 = __decorate([Component({\n  selector: 'app-new-shipment',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './new-shipment.component.html',\n  styleUrls: ['./new-shipment.component.css']\n})], NewShipmentComponent);\nexport { NewShipmentComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}