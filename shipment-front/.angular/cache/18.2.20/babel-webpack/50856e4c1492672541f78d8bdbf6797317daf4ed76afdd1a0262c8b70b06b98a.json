{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet UsersComponent = class UsersComponent {\n  constructor(http) {\n    this.http = http;\n    this.tabs = [{\n      key: 'clients',\n      label: 'Clients'\n    }, {\n      key: 'branches',\n      label: 'Branches'\n    }, {\n      key: 'hubs',\n      label: 'Hubs'\n    }, {\n      key: 'transportPartners',\n      label: 'Transport Partners'\n    }];\n    this.activeTab = 'clients';\n    this.dataView = 'summary';\n    this.paymentData = {\n      clients: [],\n      branches: [],\n      hubs: [],\n      transportPartners: []\n    };\n    this.allTransactions = [];\n    this.loading = false;\n    this.transactionListLoading = false;\n    this.error = '';\n    this.transactionListError = '';\n    this.searchText = '';\n    this.transactionSearchText = '';\n    this.statusFilter = 'all';\n    this.transactionStatusFilter = 'all';\n    this.totals = {\n      due: 0,\n      paid: 0,\n      balance: 0,\n      entities: 0\n    };\n    this.showDrawer = false;\n    this.activeEntity = null;\n    this.activeRow = null;\n    this.transactions = [];\n    this.transactionsLoading = false;\n    this.transactionsError = '';\n    this.recordForm = {\n      amount: '',\n      transactionDate: '',\n      method: '',\n      referenceNo: '',\n      notes: ''\n    };\n    this.recordError = '';\n    this.dueAmount = '';\n    this.dueError = '';\n    this.syncLoading = false;\n    this.syncError = '';\n    this.backfillLoading = false;\n    this.backfillError = '';\n  }\n  ngOnInit() {\n    this.loadPayments();\n  }\n  setActiveTab(key) {\n    this.activeTab = key;\n  }\n  setDataView(view) {\n    this.dataView = view;\n    this.syncError = '';\n    this.backfillError = '';\n    if (view === 'transactions') {\n      this.loadAllTransactions();\n    }\n  }\n  refreshView() {\n    if (this.dataView === 'transactions') {\n      this.loadAllTransactions();\n      return;\n    }\n    this.loadPayments();\n  }\n  loadPayments() {\n    this.loading = true;\n    this.error = '';\n    this.syncError = '';\n    this.backfillError = '';\n    this.http.get('http://localhost:3000/api/payments/summary').subscribe({\n      next: res => {\n        const data = res?.data || {};\n        this.paymentData = {\n          clients: Array.isArray(data.clients) ? data.clients : [],\n          branches: Array.isArray(data.branches) ? data.branches : [],\n          hubs: Array.isArray(data.hubs) ? data.hubs : [],\n          transportPartners: Array.isArray(data.transportPartners) ? data.transportPartners : []\n        };\n        this.computeTotals();\n        this.loading = false;\n      },\n      error: err => {\n        console.error('Error loading payments summary:', err);\n        this.error = 'Failed to load payments. Please try again.';\n        this.loading = false;\n      }\n    });\n  }\n  loadAllTransactions() {\n    this.transactionListLoading = true;\n    this.transactionListError = '';\n    const params = {};\n    if (this.transactionStatusFilter !== 'all') {\n      params.status = this.transactionStatusFilter;\n    }\n    this.http.get('http://localhost:3000/api/payments/transactions', {\n      params\n    }).subscribe({\n      next: res => {\n        this.allTransactions = Array.isArray(res?.data) ? res.data : [];\n        this.transactionListLoading = false;\n      },\n      error: err => {\n        console.error('Error loading payment transactions:', err);\n        this.transactionListError = err?.error?.message || 'Failed to load payment transactions.';\n        this.transactionListLoading = false;\n      }\n    });\n  }\n  computeTotals() {\n    const allRows = Object.values(this.paymentData).flat();\n    this.totals = allRows.reduce((acc, row) => {\n      acc.due += Number(row.totalDue || 0);\n      acc.paid += Number(row.totalPaid || 0);\n      acc.balance += Number(row.totalBalance || 0);\n      acc.entities += 1;\n      return acc;\n    }, {\n      due: 0,\n      paid: 0,\n      balance: 0,\n      entities: 0\n    });\n  }\n  getRowsForTab(tabKey) {\n    const rows = this.paymentData[tabKey] || [];\n    const q = this.searchText.trim().toLowerCase();\n    const status = this.statusFilter;\n    return rows.filter(row => {\n      const matchesQuery = q ? String(row.name || '').toLowerCase().includes(q) || String(row.entityId || '').toLowerCase().includes(q) : true;\n      const matchesStatus = status === 'all' ? true : String(row.status || '').toLowerCase() === status;\n      return matchesQuery && matchesStatus;\n    });\n  }\n  getFilteredTransactions() {\n    const rows = this.allTransactions || [];\n    const q = this.transactionSearchText.trim().toLowerCase();\n    const status = String(this.transactionStatusFilter || 'all').toLowerCase();\n    return rows.filter(row => {\n      const textFields = [row?.entityName, row?.entityId, row?.entityType, row?.referenceNo, row?.method];\n      const matchesQuery = q ? textFields.some(value => String(value || '').toLowerCase().includes(q)) : true;\n      const rowStatus = String(row?.status || 'posted').toLowerCase();\n      const matchesStatus = status === 'all' ? true : rowStatus === status;\n      return matchesQuery && matchesStatus;\n    });\n  }\n  formatEntityType(value) {\n    const raw = String(value || '').trim().toLowerCase();\n    if (!raw) return '-';\n    if (raw === 'transport_partner') return 'Transport Partner';\n    return raw.charAt(0).toUpperCase() + raw.slice(1);\n  }\n  formatAmount(value) {\n    const amount = Number(value || 0);\n    return new Intl.NumberFormat('en-IN', {\n      style: 'currency',\n      currency: 'INR',\n      maximumFractionDigits: 2\n    }).format(amount);\n  }\n  formatDate(value) {\n    if (!value) return '-';\n    const date = new Date(value);\n    if (Number.isNaN(date.getTime())) return '-';\n    return date.toLocaleDateString('en-IN', {\n      day: '2-digit',\n      month: 'short',\n      year: 'numeric'\n    });\n  }\n  openDrawer(tabKey, row) {\n    const entityTypeMap = {\n      clients: 'client',\n      branches: 'branch',\n      hubs: 'hub',\n      transportPartners: 'transport_partner'\n    };\n    const entityType = entityTypeMap[tabKey];\n    if (!entityType) return;\n    this.activeEntity = {\n      tabKey,\n      entityType,\n      entityId: String(row?.entityId || ''),\n      name: String(row?.name || '')\n    };\n    this.activeRow = row;\n    this.showDrawer = true;\n    this.dueAmount = String(row?.totalDue ?? '');\n    this.dueError = '';\n    this.recordError = '';\n    if (!this.recordForm.transactionDate) {\n      this.recordForm.transactionDate = this.formatDateInput(new Date());\n    }\n    this.loadTransactions();\n  }\n  closeDrawer() {\n    this.showDrawer = false;\n    this.activeEntity = null;\n    this.activeRow = null;\n    this.transactions = [];\n    this.transactionsError = '';\n    this.recordError = '';\n    this.dueError = '';\n  }\n  loadTransactions() {\n    if (!this.activeEntity) return;\n    this.transactionsLoading = true;\n    this.transactionsError = '';\n    const {\n      entityType,\n      entityId\n    } = this.activeEntity;\n    this.http.get(`http://localhost:3000/api/payments/${entityType}/${entityId}/transactions`).subscribe({\n      next: res => {\n        this.transactions = Array.isArray(res?.transactions) ? res.transactions : [];\n        if (res?.summary) {\n          this.activeRow = {\n            ...this.activeRow,\n            ...res.summary\n          };\n          this.dueAmount = String(res.summary.totalDue ?? '');\n        }\n        this.transactionsLoading = false;\n      },\n      error: err => {\n        console.error('Error loading transactions:', err);\n        this.transactionsError = 'Failed to load transactions.';\n        this.transactionsLoading = false;\n      }\n    });\n  }\n  submitPayment() {\n    if (!this.activeEntity || this.transactionsLoading) return;\n    const amount = Number(this.recordForm.amount || 0);\n    this.recordError = '';\n    if (!Number.isFinite(amount) || amount <= 0) {\n      this.recordError = 'Enter a valid amount.';\n      return;\n    }\n    if (!this.recordForm.transactionDate) {\n      this.recordError = 'Select a payment date.';\n      return;\n    }\n    if (!this.recordForm.method) {\n      this.recordError = 'Select a payment method.';\n      return;\n    }\n    this.transactionsLoading = true;\n    const payload = {\n      amount,\n      transactionDate: this.recordForm.transactionDate,\n      method: this.recordForm.method,\n      referenceNo: this.recordForm.referenceNo,\n      notes: this.recordForm.notes\n    };\n    const {\n      entityType,\n      entityId\n    } = this.activeEntity;\n    this.http.post(`http://localhost:3000/api/payments/${entityType}/${entityId}/transactions`, payload).subscribe({\n      next: res => {\n        if (res?.transaction) {\n          this.transactions = [res.transaction, ...this.transactions];\n        }\n        if (res?.summary) {\n          this.activeRow = {\n            ...this.activeRow,\n            ...res.summary\n          };\n        }\n        this.recordForm.amount = '';\n        this.recordForm.referenceNo = '';\n        this.recordForm.notes = '';\n        this.recordError = '';\n        this.transactionsLoading = false;\n        this.loadPayments();\n      },\n      error: err => {\n        console.error('Error recording payment:', err);\n        this.transactionsError = 'Failed to record payment.';\n        this.recordError = err?.error?.message || 'Failed to record payment.';\n        this.transactionsLoading = false;\n      }\n    });\n  }\n  syncFromInvoices() {\n    if (this.syncLoading) return;\n    this.syncError = '';\n    this.backfillError = '';\n    this.syncLoading = true;\n    this.http.post('http://localhost:3000/api/payments/sync/generated-invoices', {}).subscribe({\n      next: () => {\n        this.syncLoading = false;\n        this.loadPayments();\n        if (this.dataView === 'transactions') {\n          this.loadAllTransactions();\n        }\n      },\n      error: err => {\n        console.error('Error syncing payments:', err);\n        this.syncError = err?.error?.message || 'Failed to sync payments.';\n        this.syncLoading = false;\n      }\n    });\n  }\n  backfillInvoiceTransactions() {\n    if (this.backfillLoading) return;\n    this.backfillError = '';\n    this.backfillLoading = true;\n    this.http.post('http://localhost:3000/api/payments/transactions/backfill-invoice-ids', {}).subscribe({\n      next: res => {\n        this.backfillLoading = false;\n        const updated = Number(res?.updated) || 0;\n        if (updated) {\n          this.loadPayments();\n          if (this.dataView === 'transactions') {\n            this.loadAllTransactions();\n          }\n        }\n      },\n      error: err => {\n        console.error('Error backfilling invoice transactions:', err);\n        this.backfillError = err?.error?.message || 'Failed to backfill invoice transactions.';\n        this.backfillLoading = false;\n      }\n    });\n  }\n  updateDueAmount() {\n    if (!this.activeEntity || this.transactionsLoading) return;\n    const totalDue = Number(this.dueAmount);\n    this.dueError = '';\n    if (!Number.isFinite(totalDue) || totalDue < 0) {\n      this.dueError = 'Enter a valid due amount.';\n      return;\n    }\n    const {\n      entityType,\n      entityId\n    } = this.activeEntity;\n    this.transactionsLoading = true;\n    this.http.post(`http://localhost:3000/api/payments/${entityType}/${entityId}/summary/due`, {\n      totalDue\n    }).subscribe({\n      next: res => {\n        if (res?.summary) {\n          this.activeRow = {\n            ...this.activeRow,\n            ...res.summary\n          };\n          this.dueAmount = String(res.summary.totalDue ?? '');\n        }\n        this.dueError = '';\n        this.transactionsLoading = false;\n        this.loadPayments();\n      },\n      error: err => {\n        console.error('Error updating due amount:', err);\n        this.dueError = err?.error?.message || 'Failed to update due amount.';\n        this.transactionsLoading = false;\n      }\n    });\n  }\n  voidTransaction(tx) {\n    if (!this.activeEntity || this.transactionsLoading) return;\n    if (!tx?._id) return;\n    const confirmVoid = window.confirm('Void this transaction? This cannot be undone.');\n    if (!confirmVoid) return;\n    const voidReason = String(tx?.voidReason || '').trim();\n    const {\n      entityType,\n      entityId\n    } = this.activeEntity;\n    this.transactionsLoading = true;\n    this.http.post(`http://localhost:3000/api/payments/${entityType}/${entityId}/transactions/${tx._id}/void`, {\n      voidReason\n    }).subscribe({\n      next: res => {\n        if (res?.transaction) {\n          this.transactions = this.transactions.map(t => String(t._id) === String(res.transaction._id) ? res.transaction : t);\n        }\n        if (res?.summary) {\n          this.activeRow = {\n            ...this.activeRow,\n            ...res.summary\n          };\n        }\n        this.transactionsLoading = false;\n        this.loadPayments();\n      },\n      error: err => {\n        console.error('Error voiding transaction:', err);\n        this.transactionsError = err?.error?.message || 'Failed to void transaction.';\n        this.transactionsLoading = false;\n      }\n    });\n  }\n  formatDateInput(date) {\n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const day = String(date.getDate()).padStart(2, '0');\n    return `${year}-${month}-${day}`;\n  }\n};\nUsersComponent = __decorate([Component({\n  selector: 'app-users',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './users.component.html',\n  styleUrls: ['./users.component.css']\n})], UsersComponent);\nexport { UsersComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}