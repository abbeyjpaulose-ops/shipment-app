{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { RouterModule } from '@angular/router';\nimport { forkJoin, of } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/common\";\nimport * as i3 from \"@angular/forms\";\nimport * as i4 from \"@angular/router\";\nconst _c0 = () => [\"/home/Branches\"];\nfunction BranchVehiclesComponent_tr_20_ng_container_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"select\", 11);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function BranchVehiclesComponent_tr_20_ng_container_8_Template_select_ngModelChange_1_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const v_r2 = i0.ɵɵnextContext().$implicit;\n      i0.ɵɵtwoWayBindingSet(v_r2.vehicleStatus, $event) || (v_r2.vehicleStatus = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"change\", function BranchVehiclesComponent_tr_20_ng_container_8_Template_select_change_1_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const v_r2 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.onVehicleStatusChange(v_r2));\n    });\n    i0.ɵɵelementStart(2, \"option\", 12);\n    i0.ɵɵtext(3, \"Scheduled\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"option\", 13);\n    i0.ɵɵtext(5, \"Delivering\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"option\", 14);\n    i0.ɵɵtext(7, \"Completed\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const v_r2 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtwoWayProperty(\"ngModel\", v_r2.vehicleStatus);\n  }\n}\nfunction BranchVehiclesComponent_tr_20_ng_template_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtext(0);\n  }\n  if (rf & 2) {\n    const v_r2 = i0.ɵɵnextContext().$implicit;\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.formatVehicleStatus(v_r2.vehicleStatus), \" \");\n  }\n}\nfunction BranchVehiclesComponent_tr_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"td\");\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"td\");\n    i0.ɵɵtemplate(8, BranchVehiclesComponent_tr_20_ng_container_8_Template, 8, 1, \"ng-container\", 9)(9, BranchVehiclesComponent_tr_20_ng_template_9_Template, 1, 1, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"td\");\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"td\")(14, \"a\", 10);\n    i0.ɵɵtext(15, \"Edit\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const v_r2 = ctx.$implicit;\n    const statusLabel_r4 = i0.ɵɵreference(10);\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.branchName);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.vehicleNo);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.driverPhone);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", v_r2.vehicleStatus !== \"online\" && v_r2.vehicleStatus !== \"offline\")(\"ngIfElse\", statusLabel_r4);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r2.getCurrentBranchLabel(v_r2.currentBranch));\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"routerLink\", i0.ɵɵpureFunction0(7, _c0));\n  }\n}\nfunction BranchVehiclesComponent_tr_21_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 15);\n    i0.ɵɵtext(2, \"No vehicles found.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction BranchVehiclesComponent_div_22_ul_6_li_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"li\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementStart(2, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_ul_6_li_1_Template_button_click_2_listener() {\n      const i_r7 = i0.ɵɵrestoreView(_r6).index;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.removeDeliveringConsignment(i_r7));\n    });\n    i0.ɵɵtext(3, \"-\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const item_r8 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" \", item_r8.consignmentNumber, \" (\", item_r8.shipmentStatus, \") \");\n  }\n}\nfunction BranchVehiclesComponent_div_22_ul_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ul\");\n    i0.ɵɵtemplate(1, BranchVehiclesComponent_div_22_ul_6_li_1_Template, 4, 2, \"li\", 6);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.deliveringConsignments);\n  }\n}\nfunction BranchVehiclesComponent_div_22_ng_template_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"No consignments found.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_22_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r5 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 16)(1, \"div\", 17)(2, \"span\", 18);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_span_click_2_listener() {\n      i0.ɵɵrestoreView(_r5);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.cancelDelivering());\n    });\n    i0.ɵɵtext(3, \"\\u00D7\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"h3\");\n    i0.ɵɵtext(5, \"Are you sure all the consignments are in the vehicle?\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, BranchVehiclesComponent_div_22_ul_6_Template, 2, 1, \"ul\", 9)(7, BranchVehiclesComponent_div_22_ng_template_7_Template, 2, 0, \"ng-template\", null, 1, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementStart(9, \"div\", 19)(10, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_button_click_10_listener() {\n      i0.ɵɵrestoreView(_r5);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.confirmDelivering());\n    });\n    i0.ɵɵtext(11, \"OK\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_button_click_12_listener() {\n      i0.ɵɵrestoreView(_r5);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.cancelDelivering());\n    });\n    i0.ɵɵtext(13, \"Cancel\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const noDeliveringConsignments_r9 = i0.ɵɵreference(8);\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(6);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.deliveringConsignments.length)(\"ngIfElse\", noDeliveringConsignments_r9);\n  }\n}\nfunction BranchVehiclesComponent_div_23_ul_6_li_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"li\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementStart(2, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_23_ul_6_li_1_Template_button_click_2_listener() {\n      const i_r12 = i0.ɵɵrestoreView(_r11).index;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.removeCompletionConsignment(i_r12));\n    });\n    i0.ɵɵtext(3, \"-\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const item_r13 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" \", item_r13.consignmentNumber, \" (\", item_r13.shipmentStatus, \") \");\n  }\n}\nfunction BranchVehiclesComponent_div_23_ul_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ul\");\n    i0.ɵɵtemplate(1, BranchVehiclesComponent_div_23_ul_6_li_1_Template, 4, 2, \"li\", 6);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.completionConsignments);\n  }\n}\nfunction BranchVehiclesComponent_div_23_ng_template_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"No consignments found.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_23_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 16)(1, \"div\", 17)(2, \"span\", 18);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_23_Template_span_click_2_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.cancelCompletion());\n    });\n    i0.ɵɵtext(3, \"\\u00D7\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"h3\");\n    i0.ɵɵtext(5, \"Are you sure the below consignments are delivered?\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, BranchVehiclesComponent_div_23_ul_6_Template, 2, 1, \"ul\", 9)(7, BranchVehiclesComponent_div_23_ng_template_7_Template, 2, 0, \"ng-template\", null, 2, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementStart(9, \"div\", 19)(10, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_23_Template_button_click_10_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.confirmCompletion());\n    });\n    i0.ɵɵtext(11, \"OK\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_23_Template_button_click_12_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.cancelCompletion());\n    });\n    i0.ɵɵtext(13, \"Cancel\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const noConsignments_r14 = i0.ɵɵreference(8);\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(6);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.completionConsignments.length)(\"ngIfElse\", noConsignments_r14);\n  }\n}\nexport let BranchVehiclesComponent = /*#__PURE__*/(() => {\n  class BranchVehiclesComponent {\n    constructor(http) {\n      this.http = http;\n      this.branches = [];\n      this.hubs = [];\n      this.vehicles = [];\n      this.branchId = localStorage.getItem('branchId') || 'all';\n      this.branchName = localStorage.getItem('branch') || 'All Branches';\n      this.vehicleStatusByKey = new Map();\n      this.showDeliveringConfirm = false;\n      this.showCompletionConfirm = false;\n      this.pendingStatusVehicle = null;\n      this.deliveringConsignments = [];\n      this.completionConsignments = [];\n      this.deliveringConsignmentsOriginal = [];\n      this.completionConsignmentsOriginal = [];\n      this.onStorage = e => {\n        if (e.key === 'branch' || e.key === 'branchId') {\n          this.branchName = localStorage.getItem('branch') || 'All Branches';\n          this.branchId = localStorage.getItem('branchId') || 'all';\n          this.loadBranches();\n          this.loadHubs();\n        }\n      };\n    }\n    ngOnInit() {\n      this.loadBranches();\n      this.loadHubs();\n      this.branchCheck = setInterval(() => {\n        const current = localStorage.getItem('branch') || 'All Branches';\n        const currentId = localStorage.getItem('branchId') || 'all';\n        if (current !== this.branchName || currentId !== this.branchId) {\n          this.branchName = current;\n          this.branchId = currentId;\n          this.buildVehicles();\n        }\n      }, 1000);\n      this.refreshTimer = setInterval(() => {\n        this.loadBranches();\n        this.loadHubs();\n      }, 5000);\n      window.addEventListener('storage', this.onStorage);\n    }\n    ngOnDestroy() {\n      if (this.branchCheck) clearInterval(this.branchCheck);\n      if (this.refreshTimer) clearInterval(this.refreshTimer);\n      window.removeEventListener('storage', this.onStorage);\n    }\n    loadHubs() {\n      const ts = Date.now();\n      this.http.get(`http://localhost:3000/api/hubs?ts=${ts}`).subscribe({\n        next: data => {\n          this.hubs = data || [];\n          this.buildVehicles();\n        },\n        error: err => console.error('Error loading hubs:', err)\n      });\n    }\n    loadBranches() {\n      const ts = Date.now();\n      this.http.get(`http://localhost:3000/api/branches?ts=${ts}`).subscribe({\n        next: data => {\n          this.branches = data || [];\n          this.buildVehicles();\n        },\n        error: err => console.error('Error loading branches:', err)\n      });\n    }\n    buildVehicles() {\n      const branchId = this.branchId || 'all';\n      const branchName = String(this.branchName || '').trim().toLowerCase();\n      const filtered = this.branches;\n      const rows = [];\n      (filtered || []).forEach(b => {\n        const list = Array.isArray(b?.vehicles) ? b.vehicles : [];\n        list.forEach(v => {\n          const vehicleNo = String(v?.vehicleNo || '').trim();\n          const driverPhone = String(v?.driverPhone || '').trim();\n          const currentBranch = String(v?.currentBranch || '').trim();\n          if (!vehicleNo && !driverPhone) return;\n          if (branchId !== 'all' && !this.matchesBranchFilter(currentBranch, branchId, branchName)) return;\n          rows.push({\n            branchId: String(b?._id || ''),\n            branchName: b?.branchName || '',\n            branchStatus: b?.status || '',\n            vehicleNo,\n            vehicleStatus: String(v?.vehicleStatus || 'online'),\n            driverPhone,\n            currentBranch,\n            sourceType: 'branch',\n            sourceId: String(b?._id || '')\n          });\n        });\n      });\n      const hubs = this.hubs;\n      (hubs || []).forEach(h => {\n        const deliveryAddresses = Array.isArray(h?.deliveryAddresses) ? h.deliveryAddresses : [];\n        deliveryAddresses.forEach(addr => {\n          const list = Array.isArray(addr?.vehicles) ? addr.vehicles : [];\n          list.forEach(v => {\n            const vehicleNo = String(v?.vehicleNo || '').trim();\n            const driverPhone = String(v?.driverPhone || '').trim();\n            const currentBranch = String(v?.currentBranch || '').trim();\n            if (!vehicleNo && !driverPhone) return;\n            if (branchId !== 'all' && !this.matchesBranchFilter(currentBranch, branchId, branchName)) return;\n            rows.push({\n              branchId: String(h?._id || ''),\n              branchName: h?.hubName || '',\n              branchStatus: h?.status || '',\n              vehicleNo,\n              vehicleStatus: String(v?.vehicleStatus || 'online'),\n              driverPhone,\n              currentBranch,\n              sourceType: 'hub',\n              sourceId: String(h?._id || '')\n            });\n          });\n        });\n      });\n      this.vehicles = rows;\n      this.vehicleStatusByKey = new Map(rows.map(v => [`${v.sourceType}:${v.sourceId}:${v.vehicleNo}`, v.vehicleStatus || 'online']));\n    }\n    matchesBranchFilter(currentBranch, branchId, branchName) {\n      const raw = String(currentBranch || '').trim();\n      if (!raw) return false;\n      const targetName = String(branchName || '').trim().toLowerCase();\n      const rawLower = raw.toLowerCase();\n      if (rawLower === targetName) return true;\n      if (String(raw) === String(branchId)) return true;\n      const branch = (this.branches || []).find(b => String(b?._id || '') === raw);\n      if (branch?.branchName && String(branch.branchName).trim().toLowerCase() === targetName) return true;\n      const hub = (this.hubs || []).find(h => String(h?._id || '') === raw);\n      if (hub?.hubName && String(hub.hubName).trim().toLowerCase() === targetName) return true;\n      return false;\n    }\n    normalizeId(value) {\n      if (!value) return '';\n      if (typeof value === 'string') return value;\n      if (value?._id) return String(value._id);\n      if (value?.$oid) return String(value.$oid);\n      return String(value);\n    }\n    toggleBranchStatus(branchId) {\n      if (!branchId) return;\n      this.http.patch(`http://localhost:3000/api/branches/${branchId}/status`, {}).subscribe({\n        next: () => this.loadBranches(),\n        error: err => console.error('Error updating branch status:', err)\n      });\n    }\n    onVehicleStatusChange(vehicle) {\n      if (!vehicle) return;\n      const key = `${vehicle.sourceType}:${vehicle.sourceId}:${vehicle.vehicleNo}`;\n      const previousStatus = this.vehicleStatusByKey.get(key) || vehicle.vehicleStatus || 'online';\n      const nextStatus = String(vehicle.vehicleStatus || '').trim().toLowerCase();\n      if (nextStatus === 'delivering') {\n        this.pendingStatusVehicle = {\n          ...vehicle,\n          previousStatus\n        };\n        vehicle.vehicleStatus = previousStatus;\n        this.fetchDeliveringConsignments();\n        return;\n      }\n      if (nextStatus === 'completed') {\n        this.pendingStatusVehicle = {\n          ...vehicle,\n          previousStatus\n        };\n        vehicle.vehicleStatus = previousStatus;\n        this.fetchCompletionConsignments();\n        return;\n      }\n      this.updateVehicleStatus(vehicle, nextStatus);\n    }\n    confirmDelivering() {\n      if (!this.pendingStatusVehicle) return;\n      const removed = this.getRemovedConsignments(this.deliveringConsignmentsOriginal, this.deliveringConsignments);\n      this.updateConsignmentStatuses([], removed, {\n        applyCurrentBranchFromDetails: false,\n        vehicleNo: this.pendingStatusVehicle?.vehicleNo\n      }).subscribe({\n        next: () => {\n          this.updateVehicleStatus(this.pendingStatusVehicle, 'delivering');\n          this.showDeliveringConfirm = false;\n          this.deliveringConsignments = [];\n          this.deliveringConsignmentsOriginal = [];\n          this.pendingStatusVehicle = null;\n        },\n        error: err => console.error('Error updating consignments:', err)\n      });\n    }\n    cancelDelivering() {\n      this.showDeliveringConfirm = false;\n      this.deliveringConsignments = [];\n      this.deliveringConsignmentsOriginal = [];\n      this.pendingStatusVehicle = null;\n    }\n    confirmCompletion() {\n      if (!this.pendingStatusVehicle) return;\n      const nextDeliveryPoint = this.getNextDeliveryPointFromConsignments(this.completionConsignments);\n      const removed = this.getRemovedConsignments(this.completionConsignmentsOriginal, this.completionConsignments);\n      this.updateConsignmentStatuses(this.completionConsignments, removed, {\n        applyCurrentBranchFromDetails: true,\n        vehicleNo: this.pendingStatusVehicle?.vehicleNo\n      }).subscribe({\n        next: () => {\n          this.updateVehicleStatus(this.pendingStatusVehicle, 'online', nextDeliveryPoint);\n          this.showCompletionConfirm = false;\n          this.completionConsignments = [];\n          this.completionConsignmentsOriginal = [];\n          this.pendingStatusVehicle = null;\n        },\n        error: err => console.error('Error updating consignments:', err)\n      });\n    }\n    cancelCompletion() {\n      this.showCompletionConfirm = false;\n      this.completionConsignments = [];\n      this.completionConsignmentsOriginal = [];\n      this.pendingStatusVehicle = null;\n    }\n    removeDeliveringConsignment(index) {\n      this.deliveringConsignments.splice(index, 1);\n    }\n    removeCompletionConsignment(index) {\n      this.completionConsignments.splice(index, 1);\n    }\n    getCurrentBranchLabel(value) {\n      const raw = String(value || '').trim();\n      if (!raw) return '-';\n      const branch = (this.branches || []).find(b => String(b?._id || '') === raw);\n      if (branch?.branchName) return branch.branchName;\n      const hub = (this.hubs || []).find(h => String(h?._id || '') === raw);\n      if (hub?.hubName) return hub.hubName;\n      return raw;\n    }\n    fetchDeliveringConsignments() {\n      const vehicleNo = String(this.pendingStatusVehicle?.vehicleNo || '').trim();\n      if (!vehicleNo) return;\n      this.http.get('http://localhost:3000/api/newshipments/vehicle-consignments', {\n        params: {\n          vehicleNumber: vehicleNo,\n          statusFilter: 'assigned'\n        }\n      }).subscribe({\n        next: resp => {\n          const list = Array.isArray(resp?.consignments) ? resp.consignments : [];\n          this.deliveringConsignments = list;\n          this.deliveringConsignmentsOriginal = list.map(c => ({\n            ...c\n          }));\n          this.showDeliveringConfirm = true;\n        },\n        error: err => console.error('Error loading delivering consignments:', err)\n      });\n    }\n    fetchCompletionConsignments() {\n      const vehicleNo = String(this.pendingStatusVehicle?.vehicleNo || '').trim();\n      if (!vehicleNo) return;\n      this.http.get('http://localhost:3000/api/newshipments/vehicle-consignments', {\n        params: {\n          vehicleNumber: vehicleNo,\n          statusFilter: 'assigned'\n        }\n      }).subscribe({\n        next: resp => {\n          const list = Array.isArray(resp?.consignments) ? resp.consignments : [];\n          this.completionConsignments = list;\n          this.completionConsignmentsOriginal = list.map(c => ({\n            ...c\n          }));\n          this.showCompletionConfirm = true;\n        },\n        error: err => console.error('Error loading completion consignments:', err)\n      });\n    }\n    getRemovedConsignments(original, current) {\n      const currentIds = new Set(current.map(c => String(c?.id || '')));\n      return original.filter(c => !currentIds.has(String(c?.id || '')));\n    }\n    updateConsignmentStatuses(kept, removed, options) {\n      const updates = [...kept.map(item => this.buildShipmentUpdate(item, true, options)), ...removed.map(item => this.buildShipmentUpdate(item, false, options))].filter(Boolean);\n      if (!updates.length) {\n        return of([]);\n      }\n      return forkJoin(updates);\n    }\n    buildShipmentUpdate(item, keep, options) {\n      const shipmentId = String(item?.id || '').trim();\n      const consignmentNumber = String(item?.consignmentNumber || '').trim();\n      if (!shipmentId || !consignmentNumber) return null;\n      const status = String(item?.shipmentStatus || '').trim();\n      const isManifestation = status === 'Manifestation' || status === 'DManifestation';\n      const isDStatus = status.startsWith('D');\n      const nextStatus = keep ? isManifestation ? 'DPending' : 'Delivered' : isDStatus ? 'DPending' : 'Pending';\n      const currentBranchId = options.applyCurrentBranchFromDetails && keep ? this.parseCurrentBranchId(item?.shipmentStatusDetails) : '';\n      const shipmentParam = `?shipmentId=${encodeURIComponent(shipmentId)}`;\n      return this.http.put(`http://localhost:3000/api/newshipments/${consignmentNumber}${shipmentParam}`, {\n        shipmentId,\n        shipmentStatus: nextStatus,\n        ...(options.vehicleNo ? {\n          clearVehicleNo: options.vehicleNo\n        } : {}),\n        ...(currentBranchId ? {\n          currentBranchId\n        } : {})\n      });\n    }\n    updateVehicleStatus(vehicle, status, currentBranch) {\n      if (!vehicle?.vehicleNo || !vehicle?.sourceId) return;\n      const nextStatus = status === 'completed' ? 'online' : status;\n      const endpoint = vehicle.sourceType === 'hub' ? `http://localhost:3000/api/hubs/${vehicle.sourceId}/vehicle-status` : `http://localhost:3000/api/branches/${vehicle.sourceId}/vehicle-status`;\n      this.http.patch(endpoint, {\n        vehicleNo: vehicle.vehicleNo,\n        vehicleStatus: nextStatus,\n        ...(currentBranch ? {\n          currentBranch\n        } : {})\n      }).subscribe({\n        next: () => {\n          this.loadBranches();\n          this.loadHubs();\n        },\n        error: err => console.error('Error updating vehicle status:', err)\n      });\n    }\n    getNextDeliveryPointFromConsignments(consignments) {\n      const details = (consignments || []).map(c => String(c?.shipmentStatusDetails || '').trim()).find(text => text);\n      if (!details) return null;\n      return this.parseCurrentBranchId(details);\n    }\n    parseCurrentBranchId(details) {\n      if (!details) return '';\n      const parts = String(details).split('$$').map(part => String(part || '').trim()).filter(Boolean);\n      if (!parts.length) return '';\n      const last = parts[parts.length - 1];\n      if (!last) return '';\n      const cleaned = last.includes('/') ? last.split('/').pop() || '' : last;\n      return String(cleaned || '').trim();\n    }\n    formatVehicleStatus(status) {\n      const value = String(status || '').trim().toLowerCase();\n      if (!value) return '';\n      return value.charAt(0).toUpperCase() + value.slice(1);\n    }\n    static {\n      this.ɵfac = function BranchVehiclesComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || BranchVehiclesComponent)(i0.ɵɵdirectiveInject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: BranchVehiclesComponent,\n        selectors: [[\"app-branch-vehicles\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 24,\n        vars: 5,\n        consts: [[\"statusLabel\", \"\"], [\"noDeliveringConsignments\", \"\"], [\"noConsignments\", \"\"], [1, \"branch-vehicles-container\"], [1, \"branch-subtitle\"], [1, \"vehicles-table-wrapper\"], [4, \"ngFor\", \"ngForOf\"], [4, \"ngIf\"], [\"class\", \"modal\", 4, \"ngIf\"], [4, \"ngIf\", \"ngIfElse\"], [3, \"routerLink\"], [3, \"ngModelChange\", \"change\", \"ngModel\"], [\"value\", \"scheduled\"], [\"value\", \"delivering\"], [\"value\", \"completed\"], [\"colspan\", \"6\"], [1, \"modal\"], [1, \"modal-content\"], [1, \"close\", 3, \"click\"], [1, \"terminal-buttons\"], [\"type\", \"button\", 3, \"click\"]],\n        template: function BranchVehiclesComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 3)(1, \"h2\");\n            i0.ɵɵtext(2, \"Branch Vehicles\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"p\", 4);\n            i0.ɵɵtext(4);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"div\", 5)(6, \"table\")(7, \"tr\")(8, \"th\");\n            i0.ɵɵtext(9, \"Branch\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(10, \"th\");\n            i0.ɵɵtext(11, \"Vehicles num\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(12, \"th\");\n            i0.ɵɵtext(13, \"Phone\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(14, \"th\");\n            i0.ɵɵtext(15, \"Vehicle Status\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(16, \"th\");\n            i0.ɵɵtext(17, \"Current Branch\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(18, \"th\");\n            i0.ɵɵtext(19, \"Actions\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(20, BranchVehiclesComponent_tr_20_Template, 16, 8, \"tr\", 6)(21, BranchVehiclesComponent_tr_21_Template, 3, 0, \"tr\", 7);\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵtemplate(22, BranchVehiclesComponent_div_22_Template, 14, 2, \"div\", 8)(23, BranchVehiclesComponent_div_23_Template, 14, 2, \"div\", 8);\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(4);\n            i0.ɵɵtextInterpolate(ctx.branchId === \"all\" ? \"All Branches\" : ctx.branchName);\n            i0.ɵɵadvance(16);\n            i0.ɵɵproperty(\"ngForOf\", ctx.vehicles);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.vehicles.length === 0);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showDeliveringConfirm);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showCompletionConfirm);\n          }\n        },\n        dependencies: [CommonModule, i2.NgForOf, i2.NgIf, FormsModule, i3.NgSelectOption, i3.ɵNgSelectMultipleOption, i3.SelectControlValueAccessor, i3.NgControlStatus, i3.NgModel, RouterModule, i4.RouterLink],\n        styles: [\".branch-vehicles-container[_ngcontent-%COMP%]{padding:20px}.branch-subtitle[_ngcontent-%COMP%]{color:#6b7280;margin-top:4px}.vehicles-table-wrapper[_ngcontent-%COMP%]   table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin-top:12px}.vehicles-table-wrapper[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .vehicles-table-wrapper[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #e5e7eb;padding:8px;text-align:left}.vehicles-table-wrapper[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc}.modal[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:#fff;padding:20px;width:480px;max-width:90%;max-height:80vh;overflow-y:auto;border-radius:8px;position:relative}.close[_ngcontent-%COMP%]{position:absolute;right:15px;top:10px;font-size:24px;cursor:pointer}.terminal-buttons[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:12px;margin-top:12px}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 16px;border:none;border-radius:6px;cursor:pointer}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{background-color:#007acc;color:#fff}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{background-color:#555;color:#fff}\"]\n      });\n    }\n  }\n  return BranchVehiclesComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}