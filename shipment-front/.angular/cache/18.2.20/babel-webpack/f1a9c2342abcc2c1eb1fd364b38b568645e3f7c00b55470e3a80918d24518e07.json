{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { forkJoin, of } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"../../../services/branch.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction ManifestComponent_tr_38_button_17_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_tr_38_button_17_Template_button_click_0_listener($event) {\n      i0.ɵɵrestoreView(_r4);\n      const m_r2 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      ctx_r2.deliverManifest(m_r2);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵtext(1, \"Deliver\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ManifestComponent_tr_38_button_18_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r5 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_tr_38_button_18_Template_button_click_0_listener($event) {\n      i0.ɵɵrestoreView(_r5);\n      const m_r2 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      ctx_r2.cancelManifest(m_r2);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵtext(1, \"Cancel\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ManifestComponent_tr_38_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_tr_38_Template_tr_click_0_listener() {\n      const m_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.openManifestDetails(m_r2));\n    });\n    i0.ɵɵelementStart(1, \"td\", 18)(2, \"input\", 19);\n    i0.ɵɵlistener(\"change\", function ManifestComponent_tr_38_Template_input_change_2_listener() {\n      const m_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.toggleManifestSelection(m_r2));\n    })(\"click\", function ManifestComponent_tr_38_Template_input_click_2_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(3, \"td\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"td\");\n    i0.ɵɵtext(6);\n    i0.ɵɵpipe(7, \"date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"td\");\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"td\");\n    i0.ɵɵtext(11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"td\");\n    i0.ɵɵtext(13);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(14, \"td\");\n    i0.ɵɵtext(15);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"td\", 20);\n    i0.ɵɵtemplate(17, ManifestComponent_tr_38_button_17_Template, 2, 0, \"button\", 21)(18, ManifestComponent_tr_38_button_18_Template, 2, 0, \"button\", 21);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const m_r2 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"checked\", ctx_r2.isManifestSelected(m_r2));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r2.manifestNumber);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind2(7, 9, m_r2.createdAt, \"short\"));\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(m_r2.status || \"-\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r2.vehicleNo || \"-\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.getManifestEntityName(m_r2));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.getManifestItemCount(m_r2));\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.canDeliverManifest(m_r2));\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.canCancelManifest(m_r2));\n  }\n}\nfunction ManifestComponent_tr_39_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 22);\n    i0.ɵɵtext(2, \"No manifests found.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction ManifestComponent_div_40_div_6_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 30)(1, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_div_40_div_6_Template_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r7);\n      const ctx_r2 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r2.startConsignmentEdit(ctx_r2.selectedManifestDetails.manifest));\n    });\n    i0.ɵɵtext(2, \"Edit Manifest\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction ManifestComponent_div_40_div_7_span_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r2.selectedManifestDetails.manifest.vehicleNo || \"-\");\n  }\n}\nfunction ManifestComponent_div_40_div_7_ng_container_9_option_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 36);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const v_r9 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", v_r9);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(v_r9);\n  }\n}\nfunction ManifestComponent_div_40_div_7_ng_container_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"select\", 34);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_div_40_div_7_ng_container_9_Template_select_ngModelChange_1_listener($event) {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      i0.ɵɵtwoWayBindingSet(ctx_r2.manifestEditVehicleNo, $event) || (ctx_r2.manifestEditVehicleNo = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementStart(2, \"option\", 8);\n    i0.ɵɵtext(3, \"-\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(4, ManifestComponent_div_40_div_7_ng_container_9_option_4_Template, 2, 2, \"option\", 35);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.manifestEditVehicleNo);\n    i0.ɵɵproperty(\"disabled\", ctx_r2.isManifestPickupStatus(ctx_r2.manifestEditStatus));\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.getSelectedBranchVehicles());\n  }\n}\nfunction ManifestComponent_div_40_div_7_span_13_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r2.selectedManifestDetails.manifest.status || \"-\");\n  }\n}\nfunction ManifestComponent_div_40_div_7_select_14_option_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 36);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const status_r11 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", status_r11);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(status_r11);\n  }\n}\nfunction ManifestComponent_div_40_div_7_select_14_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"select\", 7);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_div_40_div_7_select_14_Template_select_ngModelChange_0_listener($event) {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      i0.ɵɵtwoWayBindingSet(ctx_r2.manifestEditStatus, $event) || (ctx_r2.manifestEditStatus = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"ngModelChange\", function ManifestComponent_div_40_div_7_select_14_Template_select_ngModelChange_0_listener($event) {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.onManifestEditStatusChange($event));\n    });\n    i0.ɵɵtemplate(1, ManifestComponent_div_40_div_7_select_14_option_1_Template, 2, 2, \"option\", 35);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.manifestEditStatus);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.manifestEditStatusOptions);\n  }\n}\nfunction ManifestComponent_div_40_div_7_span_18_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r2.selectedManifestDetails.deliveryPoint || \"-\");\n  }\n}\nfunction ManifestComponent_div_40_div_7_select_19_option_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 36);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const opt_r13 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", opt_r13.value);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(opt_r13.label);\n  }\n}\nfunction ManifestComponent_div_40_div_7_select_19_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r12 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"select\", 34);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_div_40_div_7_select_19_Template_select_ngModelChange_0_listener($event) {\n      i0.ɵɵrestoreView(_r12);\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      i0.ɵɵtwoWayBindingSet(ctx_r2.manifestEditDeliverySelection, $event) || (ctx_r2.manifestEditDeliverySelection = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementStart(1, \"option\", 8);\n    i0.ɵɵtext(2, \"-\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, ManifestComponent_div_40_div_7_select_19_option_3_Template, 2, 2, \"option\", 35);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.manifestEditDeliverySelection);\n    i0.ɵɵproperty(\"disabled\", ctx_r2.isManifestPickupStatus(ctx_r2.manifestEditStatus) || ctx_r2.isManifestOutForDeliveryStatus(ctx_r2.manifestEditStatus));\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.getDeliveryPointOptions());\n  }\n}\nfunction ManifestComponent_div_40_div_7_p_28_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\")(1, \"strong\");\n    i0.ɵɵtext(2, \"Manifest ID:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"a\", 37);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"href\", ctx_r2.getManifestUrl(ctx_r2.selectedManifestDetails.manifest), i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedManifestDetails.manifest._id, \" \");\n  }\n}\nfunction ManifestComponent_div_40_div_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 31)(1, \"p\")(2, \"strong\");\n    i0.ɵɵtext(3, \"Manifest No.:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"p\")(6, \"strong\");\n    i0.ɵɵtext(7, \"Vehicle No.:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(8, ManifestComponent_div_40_div_7_span_8_Template, 2, 1, \"span\", 15)(9, ManifestComponent_div_40_div_7_ng_container_9_Template, 5, 3, \"ng-container\", 15);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"p\")(11, \"strong\");\n    i0.ɵɵtext(12, \"Status:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(13, ManifestComponent_div_40_div_7_span_13_Template, 2, 1, \"span\", 15)(14, ManifestComponent_div_40_div_7_select_14_Template, 2, 2, \"select\", 32);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"p\")(16, \"strong\");\n    i0.ɵɵtext(17, \"Delivery Point:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(18, ManifestComponent_div_40_div_7_span_18_Template, 2, 1, \"span\", 15)(19, ManifestComponent_div_40_div_7_select_19_Template, 4, 3, \"select\", 33);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(20, \"p\")(21, \"strong\");\n    i0.ɵɵtext(22, \"Pickup Point:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(23);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(24, \"p\")(25, \"strong\");\n    i0.ɵɵtext(26, \"Entity ID:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(27);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(28, ManifestComponent_div_40_div_7_p_28_Template, 5, 2, \"p\", 15);\n    i0.ɵɵelementStart(29, \"p\")(30, \"strong\");\n    i0.ɵɵtext(31, \"Linked consignments:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(32);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    let tmp_13_0;\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedManifestDetails.manifest.manifestNumber, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedManifestDetails.pickupPoint || \"-\", \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedManifestDetails.manifest.entityId || \"-\", \" \");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.selectedManifestDetails.manifest._id);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ((tmp_13_0 = ctx_r2.getManifestConsignments()) == null ? null : tmp_13_0.length) || 0, \"\");\n  }\n}\nfunction ManifestComponent_div_40_div_10_div_1_tr_45_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"td\");\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"td\");\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"td\");\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const p_r14 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(p_r14.name);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(p_r14.amount);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(p_r14.instock);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(p_r14.intransit);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(p_r14.delivered);\n  }\n}\nfunction ManifestComponent_div_40_div_10_div_1_tr_46_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 45);\n    i0.ɵɵtext(2, \"No products found.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction ManifestComponent_div_40_div_10_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 40)(1, \"div\", 41)(2, \"span\")(3, \"strong\");\n    i0.ɵɵtext(4, \"Consignment No.:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"span\")(7, \"strong\");\n    i0.ɵɵtext(8, \"Status:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"span\")(11, \"strong\");\n    i0.ɵɵtext(12, \"Current Location:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(13);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(14, \"div\", 42)(15, \"span\")(16, \"strong\");\n    i0.ɵɵtext(17, \"Pickup:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(18);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"span\")(20, \"strong\");\n    i0.ɵɵtext(21, \"Phone:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(22);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(23, \"span\")(24, \"strong\");\n    i0.ɵɵtext(25, \"Pincode:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(26);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(27, \"span\", 43)(28, \"strong\");\n    i0.ɵɵtext(29, \"Address:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(30);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(31, \"table\", 12)(32, \"thead\")(33, \"tr\")(34, \"th\");\n    i0.ɵɵtext(35, \"Product\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(36, \"th\");\n    i0.ɵɵtext(37, \"Total\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(38, \"th\");\n    i0.ɵɵtext(39, \"In Stock\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(40, \"th\");\n    i0.ɵɵtext(41, \"In Transit\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(42, \"th\");\n    i0.ɵɵtext(43, \"Delivered\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(44, \"tbody\");\n    i0.ɵɵtemplate(45, ManifestComponent_div_40_div_10_div_1_tr_45_Template, 11, 5, \"tr\", 44)(46, ManifestComponent_div_40_div_10_div_1_tr_46_Template, 3, 0, \"tr\", 15);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const c_r15 = ctx.$implicit;\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.consignmentNumber, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.shipmentStatus, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.currentLocation || \"-\", \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.pickupName || \"-\", \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.pickupPhone || \"-\", \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.pickupPincode || \"-\", \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", c_r15.pickupAddress || \"-\", \"\");\n    i0.ɵɵadvance(15);\n    i0.ɵɵproperty(\"ngForOf\", c_r15.productSummary);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !(c_r15.productSummary == null ? null : c_r15.productSummary.length));\n  }\n}\nfunction ManifestComponent_div_40_div_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 38);\n    i0.ɵɵtemplate(1, ManifestComponent_div_40_div_10_div_1_Template, 47, 9, \"div\", 39);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.getManifestConsignments());\n  }\n}\nfunction ManifestComponent_div_40_ng_template_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r2.getNoConsignmentsMessage(ctx_r2.selectedManifestDetails == null ? null : ctx_r2.selectedManifestDetails.manifest == null ? null : ctx_r2.selectedManifestDetails.manifest.status));\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 53);\n    i0.ɵɵtext(1, \"Loading eligible consignments...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 54);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r2.consignmentEditError);\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_7_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r17 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 55)(1, \"label\")(2, \"input\", 56);\n    i0.ɵɵlistener(\"change\", function ManifestComponent_div_40_div_13_div_7_Template_input_change_2_listener() {\n      const c_r18 = i0.ɵɵrestoreView(_r17).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.toggleConsignmentRemove(c_r18));\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"span\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const c_r18 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"checked\", ctx_r2.isConsignmentMarkedForRemove(c_r18));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate3(\" \", c_r18.consignmentNumber, \" \", ctx_r2.getBranchNameById(c_r18.originLocId || \"\") || c_r18.originLocId || \"-\", \" (\", c_r18.shipmentStatus, \") \");\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 57);\n    i0.ɵɵtext(1, \" No consignments in this manifest. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_12_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r19 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 55)(1, \"label\")(2, \"input\", 56);\n    i0.ɵɵlistener(\"change\", function ManifestComponent_div_40_div_13_div_12_Template_input_change_2_listener() {\n      const c_r20 = i0.ɵɵrestoreView(_r19).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.toggleConsignmentAdd(c_r20));\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"span\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const c_r20 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"checked\", ctx_r2.isConsignmentMarkedForAdd(c_r20));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate3(\" \", c_r20.consignmentNumber, \" \", ctx_r2.getBranchNameById(c_r20.originLocId || \"\") || c_r20.originLocId || \"-\", \" (\", c_r20.shipmentStatus, \") \");\n  }\n}\nfunction ManifestComponent_div_40_div_13_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 57);\n    i0.ɵɵtext(1, \" No eligible consignments found. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction ManifestComponent_div_40_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r16 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 46);\n    i0.ɵɵtemplate(1, ManifestComponent_div_40_div_13_div_1_Template, 2, 0, \"div\", 47)(2, ManifestComponent_div_40_div_13_div_2_Template, 2, 1, \"div\", 48);\n    i0.ɵɵelementStart(3, \"div\", 49)(4, \"div\", 50)(5, \"h5\");\n    i0.ɵɵtext(6, \"Current Consignments (remove)\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(7, ManifestComponent_div_40_div_13_div_7_Template, 5, 4, \"div\", 51)(8, ManifestComponent_div_40_div_13_div_8_Template, 2, 0, \"div\", 52);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"div\", 50)(10, \"h5\");\n    i0.ɵɵtext(11, \"Eligible Consignments (add)\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(12, ManifestComponent_div_40_div_13_div_12_Template, 5, 4, \"div\", 51)(13, ManifestComponent_div_40_div_13_div_13_Template, 2, 0, \"div\", 52);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(14, \"div\", 30)(15, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_div_40_div_13_Template_button_click_15_listener() {\n      i0.ɵɵrestoreView(_r16);\n      const ctx_r2 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r2.applyConsignmentEdit(ctx_r2.selectedManifestDetails.manifest));\n    });\n    i0.ɵɵtext(16, \"OK\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(17, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_div_40_div_13_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r16);\n      const ctx_r2 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r2.cancelConsignmentEdit());\n    });\n    i0.ɵɵtext(18, \"Cancel\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.consignmentEditLoading);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.consignmentEditError);\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.getManifestConsignments());\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.getManifestConsignments().length);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.eligibleConsignments);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.eligibleConsignments.length && !ctx_r2.consignmentEditLoading);\n  }\n}\nfunction ManifestComponent_div_40_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 23)(1, \"div\", 24)(2, \"button\", 25);\n    i0.ɵɵlistener(\"click\", function ManifestComponent_div_40_Template_button_click_2_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeManifestDetails());\n    });\n    i0.ɵɵtext(3, \"\\u00D7\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"h3\");\n    i0.ɵɵtext(5, \"Manifest Details\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, ManifestComponent_div_40_div_6_Template, 3, 0, \"div\", 26)(7, ManifestComponent_div_40_div_7_Template, 33, 11, \"div\", 27);\n    i0.ɵɵelementStart(8, \"h4\");\n    i0.ɵɵtext(9, \"Consignments\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(10, ManifestComponent_div_40_div_10_Template, 2, 1, \"div\", 28)(11, ManifestComponent_div_40_ng_template_11_Template, 2, 1, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor)(13, ManifestComponent_div_40_div_13_Template, 19, 6, \"div\", 29);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    let tmp_4_0;\n    const noConsignments_r21 = i0.ɵɵreference(12);\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(6);\n    i0.ɵɵproperty(\"ngIf\", (ctx_r2.selectedManifestDetails == null ? null : ctx_r2.selectedManifestDetails.manifest) && ctx_r2.canEditConsignments(ctx_r2.selectedManifestDetails.manifest) && !ctx_r2.showConsignmentEdit);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.selectedManifestDetails == null ? null : ctx_r2.selectedManifestDetails.manifest);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngIf\", (tmp_4_0 = ctx_r2.getManifestConsignments()) == null ? null : tmp_4_0.length)(\"ngIfElse\", noConsignments_r21);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.showConsignmentEdit);\n  }\n}\nexport let ManifestComponent = /*#__PURE__*/(() => {\n  class ManifestComponent {\n    get isManifestPrintEnabled() {\n      return this.selectedManifestIds.size > 0;\n    }\n    constructor(http, branchService) {\n      this.http = http;\n      this.branchService = branchService;\n      this.stocks = [];\n      this.filteredStocks = [];\n      this.activeTab = 'stocks';\n      this.searchText = '';\n      this.filterDate = '';\n      this.filterConsignor = '';\n      this.filterStatus = 'Manifestation';\n      this.selectedHubFilterId = null;\n      this.selectedHubFilterName = '';\n      this.selectedStock = null;\n      this.editingStock = null; // G?? track which stock is being edited\n      this.manifests = [];\n      this.selectedManifestIds = new Set();\n      this.manifestSearchText = '';\n      this.manifestStatusFilter = '';\n      this.manifestVehicleFilter = '';\n      this.showManifestDetails = false;\n      this.selectedManifestDetails = null;\n      this.showConsignmentEdit = false;\n      this.eligibleConsignments = [];\n      this.consignmentEditLoading = false;\n      this.consignmentEditError = '';\n      this.consignmentsToAdd = new Set();\n      this.consignmentsToRemove = new Set();\n      this.manifestEditVehicleNo = '';\n      this.manifestEditStatus = '';\n      this.manifestEditDeliverySelection = '';\n      this.manifestEditOriginal = {\n        vehicleNo: '',\n        status: '',\n        deliverySelection: ''\n      };\n      this.manifestEditStatusOptions = ['Scheduled', 'Out for Delivery', 'Will be Picked-Up'];\n      // Billing\n      this.billingType = 'consignor';\n      this.billingName = '';\n      this.billingAddress = '';\n      this.billingGSTIN = '';\n      this.billingPhone = '';\n      this.clientList = [];\n      this.guestList = [];\n      this.pkgList = [];\n      this.productList = [];\n      // Pickup\n      this.pickupType = 'consignor';\n      this.pickupName = '';\n      this.pickupAddress = '';\n      this.pickupPhone = '';\n      // Delivery\n      this.deliveryType = 'consignee';\n      this.deliveryName = '';\n      this.deliveryAddress = '';\n      this.deliveryPhone = '';\n      this.consignorTab = 'consignor';\n      this.consigneeTab = 'consignee';\n      this.email = '';\n      this.username = '';\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.originLocId = localStorage.getItem('originLocId') || 'all';\n      this.consignmentNumber = localStorage.getItem('consignmentNumber') || '-999'; // will be loaded asynchronously\n      this.date = new Date().toISOString().split('T')[0];\n      this.ewaybillNumber = '';\n      this.consignor = '';\n      this.consignorGST = '';\n      this.consignorAddress = '';\n      this.consignorPhone = '';\n      this.consignee = '';\n      this.consigneeGST = '';\n      this.consigneeAddress = '';\n      this.consigneePhone = '';\n      this.paymentMode = 'Account Credit';\n      this.externalRefId = '';\n      this.invoices = [{\n        number: '',\n        value: 0\n      }];\n      this.packages = [{\n        type: '',\n        amount: 1\n      }];\n      this.products = [{\n        type: '',\n        amount: 1\n      }];\n      this.charges = {\n        odc: 0,\n        unloading: 0,\n        docket: 0,\n        other: 0,\n        ccc: 0\n      };\n      this.finalAmount = 0;\n      this.shipmentStatus = 'Pending';\n      this.shipmentStatusDetails = '';\n      this.branches = [];\n      this.hubs = [];\n      this.availableRoutePoints = [];\n      this.shipmentRoute = [];\n      this.selectedRoutePoint = null;\n      this.selectedRouteVehicle = '';\n      this.showCancelPopup = false;\n      this.showDeleteErrorPopup = false;\n      this.deleteErrorMessage = '';\n      this.onStorageChange = e => {\n        if (e.key === 'branch' || e.key === 'originLocId') {\n          const current = localStorage.getItem('branch') || 'All Branches';\n          const currentId = localStorage.getItem('originLocId') || 'all';\n          if (current !== this.branch || currentId !== this.originLocId) {\n            this.branch = current;\n            this.originLocId = currentId;\n            this.loadStocks();\n            this.loadManifests();\n          }\n        }\n      };\n      this.showManifestAdjustmentPopup = false;\n      this.pendingManifestAdjustment = null;\n      this.manifestAdjustments = [];\n      this.manifestAdjustmentLines = [];\n      this.manifestEditsById = {};\n      this.showManifestationPopup = false;\n      this.selectedForManifestation = [];\n      this.manifestationNumber = '';\n    }\n    // --- Methods ---\n    addInvoice() {\n      this.editingStock.invoices.push({\n        number: '',\n        value: 0,\n        packages: [],\n        products: []\n      });\n    }\n    deleteInvoice(index) {\n      this.editingStock.invoices.splice(index, 1);\n    }\n    addPackage(invoiceIndex) {\n      const invoice = this.editingStock.invoices[invoiceIndex];\n      if (!invoice.packages) {\n        invoice.packages = [];\n      }\n      invoice.packages.push({\n        type: '',\n        amount: 1\n      });\n    }\n    deletePackage(invoiceIndex, packageIndex) {\n      const invoice = this.editingStock.invoices[invoiceIndex];\n      if (invoice.packages && invoice.packages.length > packageIndex) {\n        invoice.packages.splice(packageIndex, 1);\n      }\n    }\n    addProduct(invoiceIndex) {\n      const invoice = this.editingStock.invoices[invoiceIndex];\n      if (!invoice.products) {\n        invoice.products = [];\n      }\n      invoice.products.push({\n        type: '',\n        amount: 1,\n        instock: 0,\n        intransitstock: 0,\n        deliveredstock: 0\n      });\n    }\n    deleteProduct(invoiceIndex, productIndex) {\n      const invoice = this.editingStock.invoices[invoiceIndex];\n      if (invoice.products && invoice.products.length > productIndex) {\n        const product = invoice.products[productIndex];\n        if (this.isProductManifested(product)) {\n          alert('This product has been manifested and cannot be deleted.');\n          return;\n        }\n        invoice.products.splice(productIndex, 1);\n      }\n    }\n    calculateFinalAmount() {\n      const invoiceTotal = this.editingStock.invoices.reduce((sum, i) => sum + (i.value || 0), 0);\n      const packageTotal = this.editingStock.packages.reduce((sum, p) => sum + (p.amount || 0), 0);\n      const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n      this.editingStock.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n    }\n    loadStocks() {\n      const username = this.username || localStorage.getItem('username') || '';\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      if (!username) {\n        console.error('Missing username for loading stocks');\n        return;\n      }\n      const branchParamRaw = this.activeTab === 'stocks' ? originLocId : 'all';\n      const branchParam = branchParamRaw === 'all-hubs' ? 'all' : branchParamRaw;\n      this.http.get('http://localhost:3000/api/newshipments', {\n        params: {\n          username,\n          originLocId: branchParam\n        }\n      }).subscribe({\n        next: res => {\n          const normalized = (res || []).map(stock => ({\n            ...stock,\n            invoices: this.flattenInvoices(stock.ewaybills || stock.invoices || [])\n          }));\n          this.stocks = this.getBaseStocks(normalized).sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n          this.applyFilters();\n        },\n        error: err => console.error('Error loading shipments:', err)\n      });\n    }\n    flattenInvoices(ewaybills) {\n      return (ewaybills || []).flatMap(ewb => ewb.invoices || []);\n    }\n    getInStockAmountTotal(invoices) {\n      let total = 0;\n      (invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          total += Number(prod.instock || 0);\n        });\n      });\n      return total;\n    }\n    getInvoiceAmountTotal(invoices) {\n      let total = 0;\n      (invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          total += Number(prod.amount || 0);\n        });\n      });\n      return total;\n    }\n    normalizeId(value) {\n      if (!value) return '';\n      if (typeof value === 'string') return value;\n      if (value?._id) return String(value._id);\n      if (value?.$oid) return String(value.$oid);\n      return String(value);\n    }\n    formatLocationDisplay(idValue, labelValue) {\n      const rawId = this.normalizeId(idValue);\n      const rawLabel = String(labelValue || '').trim();\n      let resolvedId = rawId;\n      let resolvedName = '';\n      const branchById = rawId ? (this.branches || []).find(b => this.normalizeId(b?._id) === rawId) : null;\n      if (branchById?._id) {\n        resolvedId = this.normalizeId(branchById._id);\n        resolvedName = String(branchById.branchName || '').trim();\n      } else {\n        const hubById = rawId ? (this.hubs || []).find(h => this.normalizeId(h?._id) === rawId) : null;\n        if (hubById?._id) {\n          resolvedId = this.normalizeId(hubById._id);\n          resolvedName = String(hubById.hubName || '').trim();\n        }\n      }\n      if (!resolvedName && rawLabel) {\n        const labelLower = rawLabel.toLowerCase();\n        const branchByName = (this.branches || []).find(b => String(b?.branchName || '').trim().toLowerCase() === labelLower);\n        if (branchByName?._id) {\n          resolvedId = this.normalizeId(branchByName._id);\n          resolvedName = String(branchByName.branchName || '').trim();\n        } else {\n          const hubByName = (this.hubs || []).find(h => String(h?.hubName || '').trim().toLowerCase() === labelLower);\n          if (hubByName?._id) {\n            resolvedId = this.normalizeId(hubByName._id);\n            resolvedName = String(hubByName.hubName || '').trim();\n          }\n        }\n      }\n      const name = resolvedName || rawLabel || resolvedId || '-';\n      if (!resolvedId) return name;\n      if (name.toLowerCase() === String(resolvedId).toLowerCase()) return name;\n      return `${name}$$${resolvedId}`;\n    }\n    getOriginBranchDisplay(stock) {\n      return this.formatLocationDisplay(this.getOriginId(stock), stock?.branch);\n    }\n    getCurrentBranchDisplay(stock) {\n      return this.formatLocationDisplay(stock?.currentLocationId || stock?.currentBranch, stock?.currentBranch);\n    }\n    getoriginLocIdByName(name) {\n      const target = String(name || '').trim().toLowerCase();\n      if (!target) return '';\n      const branch = (this.branches || []).find(b => String(b?.branchName || '').trim().toLowerCase() === target);\n      return branch?._id ? String(branch._id) : '';\n    }\n    getOriginId(stock) {\n      if (!stock) return '';\n      const raw = stock?.originLocId || stock?.originLocId || stock?.originLocId || stock?.branch;\n      return this.normalizeId(raw);\n    }\n    getBranchNameById(id) {\n      const target = this.normalizeId(id);\n      if (!target) return '';\n      const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === target);\n      return branch?.branchName ? String(branch.branchName) : '';\n    }\n    getHubById(id) {\n      const target = this.normalizeId(id);\n      if (!target) return null;\n      return (this.hubs || []).find(h => this.normalizeId(h?._id) === target) || null;\n    }\n    matchesSelectedBranch(originLocIdValue, branchLabel, selectedoriginLocId) {\n      if (!selectedoriginLocId) return false;\n      const normalizedSelected = this.normalizeId(selectedoriginLocId);\n      if (originLocIdValue && this.normalizeId(originLocIdValue) === normalizedSelected) return true;\n      const hubByCurrentId = (this.hubs || []).find(h => this.normalizeId(h?._id) === this.normalizeId(originLocIdValue));\n      if (hubByCurrentId) {\n        const huboriginLocId = this.normalizeId(hubByCurrentId?.originLocId || hubByCurrentId?.branch);\n        if (huboriginLocId && huboriginLocId === normalizedSelected) return true;\n      }\n      const hub = this.getHubById(normalizedSelected);\n      if (hub) {\n        const huboriginLocId = this.normalizeId(hub?.originLocId || hub?.branch);\n        if (huboriginLocId && this.normalizeId(originLocIdValue) === huboriginLocId) return true;\n        const hubName = String(hub?.hubName || '').trim();\n        if (hubName && branchLabel) {\n          if (String(branchLabel).trim().toLowerCase() === hubName.toLowerCase()) return true;\n        }\n        const hubBranchName = this.getBranchNameById(huboriginLocId);\n        if (hubBranchName && branchLabel) {\n          if (String(branchLabel).trim().toLowerCase() === hubBranchName.toLowerCase()) return true;\n        }\n      }\n      const selectedName = this.getBranchNameById(normalizedSelected);\n      if (selectedName && branchLabel) {\n        return String(branchLabel).trim().toLowerCase() === String(selectedName).trim().toLowerCase();\n      }\n      return false;\n    }\n    isCurrentBranchMatch(currentoriginLocId, uioriginLocId) {\n      if (!currentoriginLocId || !uioriginLocId) return false;\n      if (this.normalizeId(currentoriginLocId) === this.normalizeId(uioriginLocId)) return true;\n      const uiBranchName = this.getBranchNameById(uioriginLocId);\n      if (uiBranchName && String(currentoriginLocId || '').trim().toLowerCase() === String(uiBranchName).trim().toLowerCase()) {\n        return true;\n      }\n      const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === this.normalizeId(currentoriginLocId));\n      if (!hub?.branch) return false;\n      const originLocId = this.getoriginLocIdByName(hub.branch);\n      return originLocId ? this.normalizeId(originLocId) === this.normalizeId(uioriginLocId) : false;\n    }\n    matchesBranchLabel(currentBranch, branchLabel) {\n      const current = String(currentBranch || '').trim().toLowerCase();\n      const label = String(branchLabel || '').trim().toLowerCase();\n      if (!current || !label) return false;\n      if (label === current) return true;\n      if (label.startsWith(`${current}-`)) return true;\n      const labelPrefix = label.split('-')[0].trim();\n      return Boolean(labelPrefix) && labelPrefix === current;\n    }\n    isAllowedManifestStatus(status) {\n      return status === 'Manifestation' || status === 'Out for Delivery' || status === 'Will be Picked-Up';\n    }\n    isAllowedDeliveryStatus(status) {\n      return status === 'DManifestation' || status === 'D-Out for Delivery' || status === 'D-Will be Picked-Up';\n    }\n    isCompanyMatch(stock) {\n      const gstinId = String(localStorage.getItem('GSTIN_ID') || '').trim();\n      if (!gstinId) return true;\n      const stockGstin = String(stock?.GSTIN_ID ?? stock?.gstinId ?? '').trim();\n      if (!stockGstin) return false;\n      return stockGstin === gstinId;\n    }\n    getLastStatusDetailoriginLocId(statusDetails) {\n      if (!statusDetails) return '';\n      const parts = String(statusDetails).split('$$').map(part => String(part || '').trim()).filter(Boolean);\n      return parts.length ? parts[parts.length - 1] : '';\n    }\n    getManifestEntityName(manifest) {\n      const entityType = String(manifest?.entityType || '').toLowerCase();\n      const entityId = this.normalizeId(manifest?.entityId);\n      if (!entityType || !entityId) return '-';\n      if (entityType === 'hub') {\n        const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === entityId);\n        return hub?.hubName ? String(hub.hubName).trim() : entityId;\n      }\n      const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === entityId);\n      return branch?.branchName ? String(branch.branchName).trim() : entityId;\n    }\n    getManifestDeliveryPointName(manifest) {\n      const deliveryType = String(manifest?.deliveryType || '').toLowerCase();\n      const deliveryId = this.normalizeId(manifest?.deliveryId);\n      if (!deliveryType || !deliveryId) return '-';\n      if (deliveryType === 'hub') {\n        const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === deliveryId);\n        return hub?.hubName ? String(hub.hubName).trim() : deliveryId;\n      }\n      const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === deliveryId);\n      return branch?.branchName ? String(branch.branchName).trim() : deliveryId;\n    }\n    buildDeliverySelection(manifest) {\n      const deliveryType = String(manifest?.deliveryType || '').trim().toLowerCase();\n      const deliveryId = this.normalizeId(manifest?.deliveryId);\n      if (!deliveryType || !deliveryId) return '';\n      return `${deliveryType}:${deliveryId}`;\n    }\n    parseDeliverySelection(value) {\n      const raw = String(value || '').trim();\n      if (!raw || !raw.includes(':')) return {\n        type: '',\n        id: ''\n      };\n      const [type, id] = raw.split(':');\n      return {\n        type: String(type || '').trim().toLowerCase(),\n        id: String(id || '').trim()\n      };\n    }\n    getDeliveryPointOptions() {\n      const options = [];\n      (this.branches || []).forEach(b => {\n        const id = this.normalizeId(b?._id);\n        if (!id) return;\n        const prefix = String(b?.prefix || '').trim();\n        const name = String(b?.branchName || '').trim() || id;\n        const label = prefix ? `${prefix} - ${name}` : name;\n        options.push({\n          value: `branch:${id}`,\n          label: `Branch: ${label}`\n        });\n      });\n      (this.hubs || []).forEach(h => {\n        const id = this.normalizeId(h?._id);\n        if (!id) return;\n        const name = String(h?.hubName || '').trim() || id;\n        options.push({\n          value: `hub:${id}`,\n          label: `Hub: ${name}`\n        });\n      });\n      return options;\n    }\n    resolveLocationNameByIdOrName(value) {\n      const raw = String(value || '').trim();\n      if (!raw) return '';\n      const branch = this.resolveBranchByIdOrName(raw, raw);\n      if (branch?.branchName) return String(branch.branchName).trim();\n      const hub = this.resolveHubByIdOrName(raw, raw);\n      if (hub?.hubName) return String(hub.hubName).trim();\n      return raw;\n    }\n    getManifestItemCount(manifest) {\n      const items = Array.isArray(manifest?.items) ? manifest.items : [];\n      return items.length;\n    }\n    getManifestUrl(manifest) {\n      const id = String(manifest?._id || '').trim();\n      return id ? `/manifests/${id}` : '#';\n    }\n    openManifestDetails(manifest) {\n      if (!manifest?._id) return;\n      const items = Array.isArray(manifest?.items) ? manifest.items : [];\n      if (!items.length) {\n        this.selectedManifestDetails = {\n          manifest,\n          deliveryPoint: this.getManifestDeliveryPointName(manifest) || this.getManifestEntityName(manifest) || '-',\n          pickupPoint: '-',\n          consignments: []\n        };\n        this.showManifestDetails = true;\n        return;\n      }\n      const manifestId = String(manifest._id || '');\n      if (!manifestId) return;\n      this.http.get(`http://localhost:3000/api/manifests/${manifestId}/consignments`).subscribe({\n        next: consignments => {\n          const manifestId = String(manifest._id || '');\n          const linkedConsignments = (consignments || []).filter(c => String(c?.manifestId || '').trim() === manifestId);\n          const formatted = linkedConsignments.map(c => {\n            const enriched = this.enrichShipmentDetails(c);\n            const invoices = Array.isArray(enriched?.ewaybills) ? enriched.ewaybills.flatMap(ewb => ewb?.invoices || []) : enriched?.invoices || [];\n            const products = invoices.flatMap(inv => inv?.products || []);\n            const productSummaryMap = new Map();\n            products.forEach(p => {\n              const name = String(p?.type || p?.productName || '').trim();\n              if (!name) return;\n              const entry = productSummaryMap.get(name) || {\n                name,\n                amount: 0,\n                instock: 0,\n                intransit: 0,\n                delivered: 0\n              };\n              entry.amount += Number(p?.amount) || 0;\n              entry.instock += Number(p?.instock) || 0;\n              entry.intransit += Number(p?.intransitstock) || 0;\n              entry.delivered += Number(p?.deliveredstock) || 0;\n              productSummaryMap.set(name, entry);\n            });\n            const productSummary = Array.from(productSummaryMap.values());\n            const itemManifestId = String(c?.manifestId || manifestId);\n            return {\n              shipmentId: enriched?._id ? String(enriched._id) : '',\n              consignmentNumber: enriched?.consignmentNumber || '',\n              shipmentStatus: enriched?.shipmentStatus || '',\n              shipmentStatusDetails: enriched?.shipmentStatusDetails || '',\n              currentLocation: this.resolveLocationNameByIdOrName(this.normalizeId(enriched?.currentLocationId || enriched?.currentBranch) || String(enriched?.currentBranch || '')) || '-',\n              originLocId: this.normalizeId(enriched?.originLocId || enriched?.branch),\n              originType: enriched?.originType || (enriched?.originLocId ? 'hub' : ''),\n              pickupName: enriched?.pickupName || '',\n              pickupAddress: enriched?.pickupAddress || '',\n              pickupPhone: enriched?.pickupPhone || '',\n              pickupPincode: enriched?.pickupPincode || '',\n              productSummary,\n              manifestId: itemManifestId\n            };\n          });\n          const manifestDeliveryPoint = this.getManifestDeliveryPointName(manifest);\n          let deliveryPoint = manifestDeliveryPoint;\n          let pickupPoint = '-';\n          if (!deliveryPoint || deliveryPoint === '-') {\n            const statusDetails = String(formatted?.[0]?.shipmentStatusDetails || '').trim();\n            const lastId = this.getLastStatusDetailoriginLocId(statusDetails);\n            const resolved = this.resolveLocationNameByIdOrName(lastId);\n            deliveryPoint = resolved || this.getManifestEntityName(manifest) || '-';\n          }\n          if (formatted?.length) {\n            pickupPoint = this.resolveLocationNameByIdOrName(formatted[0]?.pickupName || '') || '-';\n          }\n          this.selectedManifestDetails = {\n            manifest,\n            deliveryPoint,\n            pickupPoint,\n            consignments: formatted\n          };\n          this.showManifestDetails = true;\n          this.resetConsignmentEditState();\n        },\n        error: err => {\n          console.error('Failed to load manifest consignments', err);\n          this.selectedManifestDetails = {\n            manifest,\n            deliveryPoint: this.getManifestDeliveryPointName(manifest) || this.getManifestEntityName(manifest) || '-',\n            pickupPoint: '-',\n            consignments: []\n          };\n          this.showManifestDetails = true;\n          this.resetConsignmentEditState();\n        }\n      });\n    }\n    refreshSelectedManifestDetails(manifestId) {\n      if (!this.showManifestDetails) return;\n      const selectedId = this.normalizeId(this.selectedManifestDetails?.manifest?._id);\n      const targetId = this.normalizeId(manifestId);\n      if (!selectedId || !targetId || selectedId !== targetId) return;\n      const manifest = this.selectedManifestDetails?.manifest;\n      if (manifest) {\n        this.openManifestDetails(manifest);\n      }\n    }\n    closeManifestDetails() {\n      this.showManifestDetails = false;\n      this.selectedManifestDetails = null;\n      this.resetConsignmentEditState();\n    }\n    getNoConsignmentsMessage(status) {\n      const value = String(status || '').trim().toLowerCase();\n      if (value.includes('will be picked-up') || value.includes('out for delivery')) {\n        return 'No consignments found or linked.';\n      }\n      return 'No consignments found for this manifest.';\n    }\n    canDeliverManifest(manifest) {\n      const status = String(manifest?.status || '').trim().toLowerCase();\n      return status !== 'completed' && status !== 'cancelled';\n    }\n    canCancelManifest(manifest) {\n      const status = String(manifest?.status || '').trim().toLowerCase();\n      return status !== 'completed' && status !== 'cancelled';\n    }\n    canUncancelManifest(manifest) {\n      const status = String(manifest?.status || '').trim().toLowerCase();\n      if (status !== 'cancelled') return false;\n      let allowed = true;\n      if (typeof manifest?.canUncancel === 'boolean') {\n        allowed = manifest.canUncancel;\n      }\n      const selectedId = this.normalizeId(this.selectedManifestDetails?.manifest?._id);\n      const targetId = this.normalizeId(manifest?._id);\n      if (selectedId && targetId && selectedId === targetId) {\n        const consignments = Array.isArray(this.selectedManifestDetails?.consignments) ? this.selectedManifestDetails.consignments : [];\n        const hasDelivered = consignments.some(c => String(c?.shipmentStatus || '').trim().toLowerCase() === 'delivered');\n        if (hasDelivered) {\n          allowed = false;\n        }\n      }\n      return allowed;\n    }\n    isCancelledManifest(manifest) {\n      return String(manifest?.status || '').trim().toLowerCase() === 'cancelled';\n    }\n    canEditConsignments(manifest) {\n      const status = String(manifest?.status || '').trim().toLowerCase();\n      return status !== 'completed' && status !== 'cancelled';\n    }\n    isManifestPickupStatus(status) {\n      return String(status || '').trim().toLowerCase() === 'will be picked-up';\n    }\n    isManifestOutForDeliveryStatus(status) {\n      return String(status || '').trim().toLowerCase() === 'out for delivery';\n    }\n    onManifestEditStatusChange(status) {\n      if (this.isManifestPickupStatus(status)) {\n        this.manifestEditVehicleNo = '';\n        this.manifestEditDeliverySelection = this.manifestEditOriginal.deliverySelection;\n        return;\n      }\n      if (this.isManifestOutForDeliveryStatus(status)) {\n        this.manifestEditDeliverySelection = this.manifestEditOriginal.deliverySelection;\n      }\n    }\n    resetConsignmentEditState() {\n      this.showConsignmentEdit = false;\n      this.eligibleConsignments = [];\n      this.consignmentEditLoading = false;\n      this.consignmentEditError = '';\n      this.consignmentsToAdd.clear();\n      this.consignmentsToRemove.clear();\n      this.manifestEditVehicleNo = '';\n      this.manifestEditStatus = '';\n      this.manifestEditDeliverySelection = '';\n      this.manifestEditOriginal = {\n        vehicleNo: '',\n        status: '',\n        deliverySelection: ''\n      };\n    }\n    startConsignmentEdit(manifest) {\n      if (!manifest?._id) return;\n      this.resetConsignmentEditState();\n      this.showConsignmentEdit = true;\n      const vehicleNo = String(manifest?.vehicleNo || '').trim();\n      const status = String(manifest?.status || '').trim() || 'Scheduled';\n      if (status && !this.manifestEditStatusOptions.some(s => s.toLowerCase() === status.toLowerCase())) {\n        this.manifestEditStatusOptions = [status, ...this.manifestEditStatusOptions];\n      }\n      const deliverySelection = this.buildDeliverySelection(manifest);\n      this.manifestEditVehicleNo = vehicleNo;\n      this.manifestEditStatus = status;\n      this.manifestEditDeliverySelection = deliverySelection;\n      this.manifestEditOriginal = {\n        vehicleNo,\n        status,\n        deliverySelection\n      };\n      this.loadEligibleConsignments(manifest);\n    }\n    cancelConsignmentEdit() {\n      this.resetConsignmentEditState();\n    }\n    loadEligibleConsignments(manifest) {\n      this.consignmentEditLoading = true;\n      this.http.get(`http://localhost:3000/api/manifests/${manifest._id}/eligible-consignments`, {}).subscribe({\n        next: res => {\n          this.eligibleConsignments = Array.isArray(res?.consignments) ? res.consignments : [];\n          this.consignmentEditLoading = false;\n        },\n        error: err => {\n          console.error('Failed to load eligible consignments', err);\n          this.consignmentEditError = 'Failed to load eligible consignments.';\n          this.consignmentEditLoading = false;\n        }\n      });\n    }\n    getConsignmentKey(consignment) {\n      return String(consignment?._id || consignment?.shipmentId || '').trim();\n    }\n    toggleConsignmentAdd(consignment) {\n      const key = this.getConsignmentKey(consignment);\n      if (!key) return;\n      if (this.consignmentsToAdd.has(key)) {\n        this.consignmentsToAdd.delete(key);\n      } else {\n        this.consignmentsToAdd.add(key);\n      }\n    }\n    toggleConsignmentRemove(consignment) {\n      const key = this.getConsignmentKey(consignment);\n      if (!key) return;\n      if (this.consignmentsToRemove.has(key)) {\n        this.consignmentsToRemove.delete(key);\n      } else {\n        this.consignmentsToRemove.add(key);\n      }\n    }\n    isConsignmentMarkedForAdd(consignment) {\n      const key = this.getConsignmentKey(consignment);\n      return key ? this.consignmentsToAdd.has(key) : false;\n    }\n    isConsignmentMarkedForRemove(consignment) {\n      const key = this.getConsignmentKey(consignment);\n      return key ? this.consignmentsToRemove.has(key) : false;\n    }\n    applyConsignmentEdit(manifest) {\n      if (!manifest?._id) return;\n      const addShipmentIds = Array.from(this.consignmentsToAdd.values());\n      const removeShipmentIds = Array.from(this.consignmentsToRemove.values());\n      const updates = [];\n      const nextStatus = String(this.manifestEditStatus || '').trim();\n      const currentStatus = String(manifest?.status || '').trim();\n      const statusChanged = nextStatus && nextStatus.toLowerCase() !== currentStatus.toLowerCase();\n      const isPickup = this.isManifestPickupStatus(nextStatus);\n      const isOutForDelivery = this.isManifestOutForDeliveryStatus(nextStatus);\n      if (statusChanged) {\n        const allowed = this.manifestEditStatusOptions.map(s => s.toLowerCase());\n        if (!allowed.includes(nextStatus.toLowerCase())) {\n          alert('Invalid manifest status.');\n          return;\n        }\n        updates.push(this.http.put(`http://localhost:3000/api/manifests/${manifest._id}/status`, {\n          status: nextStatus\n        }));\n      }\n      const nextVehicleNo = String(this.manifestEditVehicleNo || '').trim();\n      const currentVehicleNo = String(manifest?.vehicleNo || '').trim();\n      if (!isPickup && nextVehicleNo && nextVehicleNo !== currentVehicleNo) {\n        updates.push(this.http.patch(`http://localhost:3000/api/manifests/${manifest._id}/vehicle`, {\n          vehicleNo: nextVehicleNo\n        }));\n      }\n      const {\n        type: deliveryType,\n        id: deliveryId\n      } = this.parseDeliverySelection(this.manifestEditDeliverySelection);\n      const currentDeliveryType = String(manifest?.deliveryType || '').trim().toLowerCase();\n      const currentDeliveryId = this.normalizeId(manifest?.deliveryId);\n      const deliveryChanged = currentDeliveryType !== deliveryType || currentDeliveryId !== deliveryId;\n      if (!isPickup && !isOutForDelivery && deliveryChanged) {\n        updates.push(this.http.patch(`http://localhost:3000/api/manifests/${manifest._id}/delivery`, {\n          deliveryType,\n          deliveryId\n        }));\n      }\n      if (addShipmentIds.length || removeShipmentIds.length) {\n        updates.push(this.http.patch(`http://localhost:3000/api/manifests/${manifest._id}/consignments`, {\n          addShipmentIds,\n          removeShipmentIds\n        }));\n      }\n      if (!updates.length) {\n        this.resetConsignmentEditState();\n        return;\n      }\n      forkJoin(updates).subscribe({\n        next: results => {\n          this.resetConsignmentEditState();\n          this.loadManifests();\n          this.loadStocks();\n          let updatedManifest = null;\n          let updatedItems = null;\n          (results || []).forEach(res => {\n            if (res?.manifest) updatedManifest = res.manifest;\n            if (Array.isArray(res?.items)) updatedItems = res.items;\n          });\n          const manifestDetails = {\n            ...(manifest || {})\n          };\n          if (updatedManifest && typeof updatedManifest === 'object') {\n            Object.assign(manifestDetails, updatedManifest);\n          }\n          if (updatedItems) {\n            manifestDetails.items = updatedItems;\n          }\n          this.openManifestDetails(manifestDetails);\n        },\n        error: err => {\n          console.error('Failed to update manifest details', err);\n          alert('Failed to update manifest details.');\n        }\n      });\n    }\n    isObjectId(value) {\n      return /^[a-f0-9]{24}$/i.test(String(value || '').trim());\n    }\n    getManifestConsignments() {\n      const manifestId = String(this.selectedManifestDetails?.manifest?._id || '');\n      if (!manifestId) return [];\n      return (this.selectedManifestDetails?.consignments || []).filter(c => {\n        return String(c?.manifestId || '').trim() === manifestId;\n      });\n    }\n    deliverManifest(manifest) {\n      if (!manifest?._id) return;\n      const items = Array.isArray(manifest?.items) ? manifest.items : [];\n      const consignmentNumbers = Array.from(new Set(items.map(i => String(i?.consignmentNumber || '').trim()).filter(Boolean)));\n      if (!consignmentNumbers.length) {\n        alert('No consignments found for this manifest.');\n        return;\n      }\n      const confirmMsg = `Deliver manifest ${manifest.manifestNumber || ''} for ${consignmentNumbers.length} consignments?`;\n      if (!confirm(confirmMsg)) return;\n      this.http.put(`http://localhost:3000/api/manifests/${manifest._id}/status`, {\n        status: 'Completed'\n      }).subscribe({\n        next: () => {\n          this.loadManifests();\n          this.loadStocks();\n        },\n        error: err => {\n          console.error('Failed to update manifest status', err);\n          alert('Failed to update manifest status.');\n        }\n      });\n    }\n    cancelManifest(manifest) {\n      if (!manifest?._id) return;\n      const items = Array.isArray(manifest?.items) ? manifest.items : [];\n      const consignmentNumbers = Array.from(new Set(items.map(i => String(i?.consignmentNumber || '').trim()).filter(Boolean)));\n      if (!consignmentNumbers.length) {\n        alert('No consignments found for this manifest.');\n        return;\n      }\n      const confirmMsg = `Cancel manifest ${manifest.manifestNumber || ''} for ${consignmentNumbers.length} consignments?`;\n      if (!confirm(confirmMsg)) return;\n      this.http.put(`http://localhost:3000/api/manifests/${manifest._id}/status`, {\n        status: 'Cancelled'\n      }).subscribe({\n        next: () => {\n          this.loadManifests();\n          this.loadStocks();\n          this.refreshSelectedManifestDetails(manifest._id);\n        },\n        error: err => {\n          console.error('Failed to cancel manifest', err);\n          alert('Failed to cancel manifest.');\n        }\n      });\n    }\n    uncancelManifest(manifest) {\n      if (!manifest?._id) return;\n      const items = Array.isArray(manifest?.items) ? manifest.items : [];\n      const consignmentNumbers = Array.from(new Set(items.map(i => String(i?.consignmentNumber || '').trim()).filter(Boolean)));\n      if (!consignmentNumbers.length) {\n        alert('No consignments found for this manifest.');\n        return;\n      }\n      const confirmMsg = `Uncancel manifest ${manifest.manifestNumber || ''} for ${consignmentNumbers.length} consignments?`;\n      if (!confirm(confirmMsg)) return;\n      this.http.put(`http://localhost:3000/api/manifests/${manifest._id}/status`, {\n        status: 'Scheduled'\n      }).subscribe({\n        next: () => {\n          this.loadManifests();\n          this.loadStocks();\n          this.refreshSelectedManifestDetails(manifest._id);\n        },\n        error: err => {\n          console.error('Failed to uncancel manifest', err);\n          alert('Failed to uncancel manifest.');\n        }\n      });\n    }\n    getBaseStocks(allStocks) {\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      if (originLocId === 'all') {\n        if (this.activeTab === 'other-branch' || this.activeTab === 'others-in-branch') {\n          return (allStocks || []).filter(stock => {\n            const status = String(stock.shipmentStatus || '').trim();\n            if (!this.isAllowedDeliveryStatus(status)) return false;\n            const originoriginLocId = this.getOriginId(stock);\n            const currentoriginLocId = this.normalizeId(stock.currentLocationId || stock.currentBranch);\n            return originoriginLocId && currentoriginLocId && originoriginLocId !== currentoriginLocId;\n          });\n        }\n        return (allStocks || []).filter(stock => {\n          const status = String(stock.shipmentStatus || '').trim();\n          return this.isAllowedManifestStatus(status);\n        });\n      }\n      if (this.activeTab === 'other-branch') {\n        const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n        const selectedLocationId = originLocId === 'all-hubs' ? this.normalizeId(this.selectedHubFilterId || localStorage.getItem('hubId')) : this.normalizeId(originLocId);\n        if (!selectedLocationId || selectedLocationId === 'all') return [];\n        const selectedBranch = (this.branches || []).find(b => this.normalizeId(b?._id) === selectedLocationId);\n        const selectedHub = selectedBranch ? null : (this.hubs || []).find(h => this.normalizeId(h?._id) === selectedLocationId);\n        const selectedName = String(selectedBranch?.branchName || selectedHub?.hubName || '').trim();\n        const selectedNameLower = selectedName.toLowerCase();\n        return (allStocks || []).filter(stock => {\n          const status = String(stock.shipmentStatus || '').trim();\n          if (!this.isAllowedDeliveryStatus(status)) return false;\n          const originoriginLocId = this.getOriginId(stock);\n          const originBranchLabel = String(stock.branch || '').trim();\n          const currentoriginLocId = this.normalizeId(stock.currentLocationId || stock.currentBranch);\n          const isIdMatch = Boolean(originoriginLocId) && originoriginLocId === selectedLocationId;\n          const isNameMatch = Boolean(selectedName) && Boolean(originBranchLabel) && (originBranchLabel.toLowerCase() === selectedNameLower || this.matchesBranchLabel(originBranchLabel, selectedName));\n          return originoriginLocId && currentoriginLocId && (isIdMatch || isNameMatch) && originoriginLocId !== currentoriginLocId;\n        });\n      }\n      if (this.activeTab === 'others-in-branch') {\n        const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n        const selectedLocationId = originLocId === 'all-hubs' ? this.normalizeId(this.selectedHubFilterId || localStorage.getItem('hubId')) : this.normalizeId(originLocId);\n        if (!selectedLocationId || selectedLocationId === 'all') return [];\n        const selectedBranch = (this.branches || []).find(b => this.normalizeId(b?._id) === selectedLocationId);\n        const selectedHub = selectedBranch ? null : (this.hubs || []).find(h => this.normalizeId(h?._id) === selectedLocationId);\n        const selectedName = String(selectedBranch?.branchName || selectedHub?.hubName || '').trim();\n        const selectedNameLower = selectedName.toLowerCase();\n        return (allStocks || []).filter(stock => {\n          const status = String(stock.shipmentStatus || '').trim();\n          if (!this.isAllowedDeliveryStatus(status)) return false;\n          const originoriginLocId = this.getOriginId(stock);\n          const currentoriginLocId = this.normalizeId(stock.currentLocationId || stock.currentBranch);\n          const currentBranchLabel = String(stock.currentBranch || '').trim();\n          const isIdMatch = Boolean(currentoriginLocId) && currentoriginLocId === selectedLocationId;\n          const isNameMatch = Boolean(selectedName) && Boolean(currentBranchLabel) && (currentBranchLabel.toLowerCase() === selectedNameLower || this.matchesBranchLabel(currentBranchLabel, selectedName));\n          return originoriginLocId && currentoriginLocId && (isIdMatch || isNameMatch) && originoriginLocId !== currentoriginLocId;\n        });\n      }\n      const selectedoriginLocId = this.getSelectedManifestoriginLocId();\n      if (!selectedoriginLocId) return [];\n      return (allStocks || []).filter(stock => {\n        const status = String(stock.shipmentStatus || '').trim();\n        if (!this.isAllowedManifestStatus(status)) return false;\n        const currentoriginLocId = this.normalizeId(stock.currentLocationId || stock.currentBranch || stock.currentBranch);\n        const currentBranchLabel = String(stock.currentBranch || '').trim();\n        return currentoriginLocId && this.matchesSelectedBranch(currentoriginLocId, currentBranchLabel, selectedoriginLocId);\n      });\n    }\n    getSelectedManifestoriginLocId() {\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      if (originLocId === 'all-hubs') {\n        return this.normalizeId(this.selectedHubFilterId || localStorage.getItem('hubId'));\n      }\n      if (!originLocId || originLocId === 'all') return '';\n      return this.normalizeId(originLocId);\n    }\n    getManifestEntityFilter() {\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      if (originLocId === 'all-hubs') {\n        const hubId = this.normalizeId(this.selectedHubFilterId || localStorage.getItem('hubId'));\n        return hubId ? {\n          entityType: 'hub',\n          entityId: hubId\n        } : null;\n      }\n      if (originLocId && originLocId !== 'all') {\n        return {\n          entityType: 'branch',\n          entityId: this.normalizeId(originLocId)\n        };\n      }\n      return null;\n    }\n    getManifestOriginFilter() {\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      if (originLocId === 'all-hubs') {\n        const hubId = this.normalizeId(this.selectedHubFilterId || localStorage.getItem('hubId'));\n        return hubId ? {\n          originType: 'hub',\n          originLocId: hubId\n        } : null;\n      }\n      if (originLocId && originLocId !== 'all') {\n        return {\n          originType: 'branch',\n          originLocId: this.normalizeId(originLocId)\n        };\n      }\n      return null;\n    }\n    loadManifests() {\n      const params = {};\n      const entity = this.getManifestEntityFilter();\n      if (entity?.entityType && entity?.entityId) {\n        params.entityType = entity.entityType;\n        params.entityId = entity.entityId;\n      }\n      const origin = this.getManifestOriginFilter();\n      if (origin?.originType && origin?.originLocId) {\n        params.originType = origin.originType;\n        params.originLocId = origin.originLocId;\n      }\n      this.http.get('http://localhost:3000/api/manifests', {\n        params\n      }).subscribe({\n        next: res => {\n          this.manifests = Array.isArray(res) ? res : [];\n          this.selectedManifestIds = new Set();\n        },\n        error: err => console.error('Error loading manifests:', err)\n      });\n    }\n    filterManifests(list) {\n      const raw = Array.isArray(list) ? list : [];\n      const q = String(this.manifestSearchText || '').trim().toLowerCase();\n      const status = String(this.manifestStatusFilter || '').trim().toLowerCase();\n      const vehicle = String(this.manifestVehicleFilter || '').trim().toLowerCase();\n      return raw.filter(m => {\n        const number = String(m?.manifestNumber || '').toLowerCase();\n        const matchesSearch = !q || number.includes(q);\n        const mStatus = String(m?.status || '').trim().toLowerCase();\n        const matchesStatus = !status || mStatus === status;\n        const mVehicle = String(m?.vehicleNo || '').trim().toLowerCase();\n        const matchesVehicle = !vehicle || mVehicle.includes(vehicle);\n        return matchesSearch && matchesStatus && matchesVehicle;\n      });\n    }\n    getDeliveryDisplayName(stock) {\n      const name = String(stock?.deliveryName || '').trim();\n      if (name) return name;\n      const deliveryId = this.normalizeId(stock?.deliveryID);\n      if (!deliveryId) return '-';\n      const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === deliveryId);\n      if (branch?.branchName) return branch.branchName;\n      const client = (this.clientList || []).find(c => this.normalizeId(c?._id) === deliveryId);\n      if (client?.clientName) return client.clientName;\n      const guest = (this.guestList || []).find(g => this.normalizeId(g?._id) === deliveryId);\n      if (guest?.guestName) return guest.guestName;\n      return deliveryId;\n    }\n    firstNonEmpty(...values) {\n      for (const value of values) {\n        if (value === undefined || value === null) continue;\n        const text = String(value).trim();\n        if (text) return text;\n      }\n      return '-';\n    }\n    resolveClientByIdOrName(id, name) {\n      const normId = this.normalizeId(id);\n      const normName = String(name || '').trim().toLowerCase();\n      return (this.clientList || []).find(c => normId && this.normalizeId(c?._id) === normId || normName && String(c?.clientName || '').trim().toLowerCase() === normName) || null;\n    }\n    resolveGuestByIdOrName(id, name) {\n      const normId = this.normalizeId(id);\n      const normName = String(name || '').trim().toLowerCase();\n      return (this.guestList || []).find(g => normId && this.normalizeId(g?._id) === normId || normName && String(g?.guestName || '').trim().toLowerCase() === normName) || null;\n    }\n    resolveBranchByIdOrName(id, name) {\n      const normId = this.normalizeId(id);\n      const normName = String(name || '').trim().toLowerCase();\n      return (this.branches || []).find(b => normId && this.normalizeId(b?._id) === normId || normName && String(b?.branchName || '').trim().toLowerCase() === normName) || null;\n    }\n    resolveHubByIdOrName(id, name) {\n      const normId = this.normalizeId(id);\n      const normName = String(name || '').trim().toLowerCase();\n      return (this.hubs || []).find(h => normId && this.normalizeId(h?._id) === normId || normName && String(h?.hubName || '').trim().toLowerCase() === normName) || null;\n    }\n    resolveBranchByVehicle(vehicleNo) {\n      const target = String(vehicleNo || '').trim().toLowerCase();\n      if (!target) return null;\n      return (this.branches || []).find(b => (b?.vehicles || []).some(v => String(v?.vehicleNo || '').trim().toLowerCase() === target)) || null;\n    }\n    resolveHubByVehicle(vehicleNo) {\n      const target = String(vehicleNo || '').trim().toLowerCase();\n      if (!target) return null;\n      return (this.hubs || []).find(h => (h?.deliveryAddresses || []).some(addr => (addr?.vehicles || []).some(v => String(v?.vehicleNo || '').trim().toLowerCase() === target))) || null;\n    }\n    findVehicleStatus(vehicleNo) {\n      const target = String(vehicleNo || '').trim().toLowerCase();\n      if (!target) return '';\n      for (const branch of this.branches || []) {\n        const match = (branch?.vehicles || []).find(v => String(v?.vehicleNo || '').trim().toLowerCase() === target);\n        if (match) return String(match?.vehicleStatus || '').trim().toLowerCase();\n      }\n      for (const hub of this.hubs || []) {\n        for (const addr of hub?.deliveryAddresses || []) {\n          const match = (addr?.vehicles || []).find(v => String(v?.vehicleNo || '').trim().toLowerCase() === target);\n          if (match) return String(match?.vehicleStatus || '').trim().toLowerCase();\n        }\n      }\n      return '';\n    }\n    resolveVehicleOwner(vehicleNo, fallbackType, fallbackId) {\n      const ownerTypeRaw = String(fallbackType || '').trim().toLowerCase();\n      const ownerIdRaw = String(fallbackId || '').trim();\n      if (ownerIdRaw && (ownerTypeRaw === 'branch' || ownerTypeRaw === 'hub')) {\n        return {\n          ownerType: ownerTypeRaw === 'branch' ? 'Branch' : 'Hub',\n          ownerId: ownerIdRaw\n        };\n      }\n      const ownerBranch = this.resolveBranchByVehicle(vehicleNo);\n      if (ownerBranch?._id) return {\n        ownerType: 'Branch',\n        ownerId: String(ownerBranch._id)\n      };\n      const ownerHub = this.resolveHubByVehicle(vehicleNo);\n      if (ownerHub?._id) return {\n        ownerType: 'Hub',\n        ownerId: String(ownerHub._id)\n      };\n      return {\n        ownerType: '',\n        ownerId: ''\n      };\n    }\n    getSelectedBranchVehicles() {\n      const currentoriginLocId = this.normalizeId(this.originLocId || localStorage.getItem('originLocId'));\n      const currentBranchName = String(this.branch || localStorage.getItem('branch') || '').trim();\n      const currentBranchNameLower = currentBranchName.toLowerCase();\n      const isAllHubsSelection = currentoriginLocId === 'all-hubs' || currentBranchNameLower === 'all hubs';\n      const selectedHubId = isAllHubsSelection ? this.normalizeId(this.selectedHubFilterId) || this.normalizeId(localStorage.getItem('hubId')) : '';\n      const locationFilterId = isAllHubsSelection ? selectedHubId : currentoriginLocId;\n      const locationFilterName = locationFilterId ? String((this.branches || []).find(b => this.normalizeId(b?._id) === locationFilterId)?.branchName || (this.hubs || []).find(h => this.normalizeId(h?._id) === locationFilterId)?.hubName || '').trim() : '';\n      if (!locationFilterId || locationFilterId === 'all' || locationFilterId === 'all-hubs') return [];\n      const branchVehicles = (this.branches || []).flatMap(b => (b?.vehicles || []).map(v => ({\n        ...v,\n        _ownerType: 'branch',\n        _ownerId: this.normalizeId(b?._id)\n      })));\n      const hubVehicles = (this.hubs || []).flatMap(h => (h?.deliveryAddresses || []).flatMap(addr => (addr?.vehicles || []).map(v => ({\n        ...v,\n        _ownerType: 'hub',\n        _ownerId: this.normalizeId(h?._id)\n      }))));\n      const vehicles = [...branchVehicles, ...hubVehicles];\n      const seen = new Set();\n      return vehicles.filter(v => {\n        const currentLocationRaw = v?.currentLocationId || v?.currentBranch || v?.currentBranch || '';\n        const currentLocation = this.normalizeId(currentLocationRaw);\n        if (currentLocation) {\n          if (this.isCurrentBranchMatch(currentLocation, locationFilterId)) return true;\n          if (locationFilterName && this.matchesBranchLabel(String(currentLocationRaw || ''), locationFilterName)) return true;\n          if (locationFilterName && this.matchesBranchLabel(String(currentLocation || ''), locationFilterName)) return true;\n          return false;\n        }\n        if (String(v?._ownerType || '').toLowerCase() === 'branch') {\n          const ownerId = this.normalizeId(v?._ownerId);\n          return ownerId && ownerId === this.normalizeId(locationFilterId);\n        }\n        return false;\n      }).map(v => {\n        if (typeof v === 'string') return v;\n        return v?.vehicleNo || v?.number || v?.vehicleNumber || '';\n      }).filter(vehicle => {\n        if (!vehicle) return false;\n        if (seen.has(vehicle)) return false;\n        seen.add(vehicle);\n        return true;\n      });\n    }\n    resolveClientLocation(client, locationId) {\n      if (!client) return null;\n      const normId = this.normalizeId(locationId);\n      const locations = client?.deliveryLocations || [];\n      if (!normId) return locations[0] || null;\n      return locations.find(loc => this.normalizeId(loc?.delivery_id) === normId) || null;\n    }\n    enrichShipmentDetails(stock) {\n      const enriched = {\n        ...stock\n      };\n      const consignor = stock?.consignorTab === 'guest' ? this.resolveGuestByIdOrName(stock?.consignorId, stock?.consignor) : this.resolveClientByIdOrName(stock?.consignorId, stock?.consignor);\n      const consignee = stock?.consigneeTab === 'guest' ? this.resolveGuestByIdOrName(stock?.consigneeId, stock?.consignee) : this.resolveClientByIdOrName(stock?.consigneeId, stock?.consignee);\n      enriched.consignor = this.firstNonEmpty(enriched.consignor, consignor?.clientName, consignor?.guestName);\n      enriched.consignorGST = this.firstNonEmpty(enriched.consignorGST, consignor?.GSTIN, stock?.consignorTab === 'guest' ? 'GUEST' : '');\n      enriched.consignorPhone = this.firstNonEmpty(enriched.consignorPhone, consignor?.phoneNum);\n      enriched.consignorAddress = this.firstNonEmpty(enriched.consignorAddress, consignor?.address);\n      enriched.consignee = this.firstNonEmpty(enriched.consignee, consignee?.clientName, consignee?.guestName);\n      enriched.consigneeGST = this.firstNonEmpty(enriched.consigneeGST, consignee?.GSTIN, stock?.consigneeTab === 'guest' ? 'GUEST' : '');\n      enriched.consigneePhone = this.firstNonEmpty(enriched.consigneePhone, consignee?.phoneNum);\n      enriched.consigneeAddress = this.firstNonEmpty(enriched.consigneeAddress, consignee?.address);\n      if (stock?.billingType === 'consignor') {\n        enriched.billingName = this.firstNonEmpty(enriched.billingName, enriched.consignor);\n        enriched.billingGSTIN = this.firstNonEmpty(enriched.billingGSTIN, enriched.consignorGST);\n        enriched.billingPhone = this.firstNonEmpty(enriched.billingPhone, enriched.consignorPhone);\n        enriched.billingAddress = this.firstNonEmpty(enriched.billingAddress, enriched.consignorAddress);\n      } else {\n        const billingClient = this.resolveClientByIdOrName(stock?.billingClientId, stock?.billingName);\n        enriched.billingName = this.firstNonEmpty(enriched.billingName, billingClient?.clientName);\n        enriched.billingGSTIN = this.firstNonEmpty(enriched.billingGSTIN, billingClient?.GSTIN);\n        enriched.billingPhone = this.firstNonEmpty(enriched.billingPhone, billingClient?.phoneNum);\n        enriched.billingAddress = this.firstNonEmpty(enriched.billingAddress, billingClient?.address);\n      }\n      if (stock?.pickupType === 'branch') {\n        const pickupBranch = this.resolveBranchByIdOrName(stock?.pickupLocationId, stock?.pickupName) || this.resolveBranchByIdOrName(null, stock?.branch);\n        enriched.pickupName = this.firstNonEmpty(enriched.pickupName, pickupBranch?.branchName);\n        enriched.pickupAddress = this.firstNonEmpty(enriched.pickupAddress, pickupBranch?.address);\n        enriched.pickupPhone = this.firstNonEmpty(enriched.pickupPhone, pickupBranch?.phoneNum);\n        enriched.pickupPincode = this.firstNonEmpty(enriched.pickupPincode, pickupBranch?.pinCode);\n      } else if (stock?.pickupType === 'consignor') {\n        enriched.pickupName = this.firstNonEmpty(enriched.pickupName, enriched.consignor);\n        enriched.pickupAddress = this.firstNonEmpty(enriched.pickupAddress, enriched.consignorAddress);\n        enriched.pickupPhone = this.firstNonEmpty(enriched.pickupPhone, enriched.consignorPhone);\n        enriched.pickupPincode = this.firstNonEmpty(enriched.pickupPincode, consignor?.pinCode);\n      }\n      const isSelfPickup = stock?.deliveryType === 'Customer self pick up' || stock?.deliveryType === 'branch' || stock?.deliveryType === 'hub';\n      if (isSelfPickup) {\n        const deliveryBranch = this.resolveBranchByIdOrName(stock?.deliveryID, stock?.deliveryName);\n        const deliveryHub = deliveryBranch ? null : this.resolveHubByIdOrName(stock?.deliveryID, stock?.deliveryName);\n        enriched.deliveryName = this.firstNonEmpty(enriched.deliveryName, deliveryBranch?.branchName, deliveryHub?.hubName);\n        enriched.deliveryAddress = this.firstNonEmpty(enriched.deliveryAddress, deliveryBranch?.address, deliveryHub?.address);\n        enriched.deliveryPhone = this.firstNonEmpty(enriched.deliveryPhone, deliveryBranch?.phoneNum, deliveryHub?.phoneNum);\n        enriched.deliveryPincode = this.firstNonEmpty(enriched.deliveryPincode, deliveryBranch?.pinCode, deliveryHub?.pinCode);\n      } else {\n        const deliveryClient = this.resolveClientByIdOrName(stock?.deliveryID, stock?.deliveryName);\n        const deliveryGuest = this.resolveGuestByIdOrName(stock?.deliveryID, stock?.deliveryName);\n        const deliveryLocation = this.resolveClientLocation(deliveryClient, stock?.deliveryLocationId);\n        enriched.deliveryName = this.firstNonEmpty(enriched.deliveryName, deliveryClient?.clientName, deliveryGuest?.guestName, enriched.consignee);\n        enriched.deliveryAddress = this.firstNonEmpty(enriched.deliveryAddress, deliveryLocation?.address, deliveryClient?.address, deliveryGuest?.address, enriched.consigneeAddress);\n        enriched.deliveryPhone = this.firstNonEmpty(enriched.deliveryPhone, deliveryClient?.phoneNum, deliveryGuest?.phoneNum, enriched.consigneePhone);\n        enriched.deliveryPincode = this.firstNonEmpty(enriched.deliveryPincode, deliveryLocation?.pinCode, deliveryClient?.pinCode, deliveryGuest?.pinCode);\n      }\n      return enriched;\n    }\n    getProductTotal(ewaybills, field) {\n      let total = 0;\n      ewaybills.forEach(ewaybill => {\n        ewaybill.invoices.forEach(invoice => {\n          invoice.products.forEach(product => {\n            total += product[field] || 0;\n          });\n        });\n      });\n      return total;\n    }\n    applyFilters() {\n      const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n      const hubFilterId = this.normalizeId(this.selectedHubFilterId);\n      const useHubFilter = originLocId === 'all-hubs' && (this.activeTab === 'stocks' || this.activeTab === 'other-branch' || this.activeTab === 'others-in-branch');\n      if (useHubFilter && !hubFilterId) {\n        const storedHubId = this.normalizeId(localStorage.getItem('hubId'));\n        const storedHubName = String(localStorage.getItem('hubName') || '').trim();\n        if (storedHubId) {\n          const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === storedHubId);\n          this.selectedHubFilterId = storedHubId;\n          this.selectedHubFilterName = String(hub?.hubName || storedHubName || '').trim();\n        } else {\n          const options = this.getAllHubsFilterOptions();\n          const firstHubId = this.normalizeId(options?.[0]?._id);\n          this.selectedHubFilterId = firstHubId || null;\n          this.selectedHubFilterName = String(options?.[0]?.hubName || '').trim();\n        }\n      }\n      const effectiveHubFilterId = this.normalizeId(this.selectedHubFilterId);\n      if (effectiveHubFilterId && !this.selectedHubFilterName) {\n        const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === effectiveHubFilterId);\n        this.selectedHubFilterName = String(hub?.hubName || '').trim();\n      }\n      const effectiveHubName = this.selectedHubFilterName;\n      this.filteredStocks = this.stocks.filter(s => (this.searchText ? s.consignmentNumber?.includes(this.searchText) || s.consignor?.includes(this.searchText) : true) && (this.filterDate ? new Date(s.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? s.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase()) : true) && (this.filterStatus ? String(s.shipmentStatus || '').trim() === this.filterStatus : true) && (!useHubFilter || effectiveHubFilterId && this.matchesHubFilter(s, effectiveHubFilterId, effectiveHubName)));\n    }\n    onHubFilterChange(value) {\n      this.selectedHubFilterId = value;\n      const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === this.normalizeId(value));\n      this.selectedHubFilterName = String(hub?.hubName || '').trim();\n      if (value) {\n        localStorage.setItem('hubId', String(value));\n        localStorage.setItem('hubName', this.selectedHubFilterName);\n      }\n      this.applyFilters();\n    }\n    getAllHubsFilterOptions() {\n      return this.hubs || [];\n    }\n    matchesHubFilter(stock, hubId, hubName) {\n      if (!hubId) return false;\n      const hasHubName = Boolean(hubName);\n      if (this.activeTab === 'stocks') {\n        const currentoriginLocId = this.normalizeId(stock?.currentLocationId || stock?.currentBranch);\n        const currentBranchLabel = String(stock?.currentBranch || '').trim();\n        return currentoriginLocId === hubId || hasHubName && currentBranchLabel.toLowerCase() === hubName.toLowerCase() || hasHubName && this.matchesBranchLabel(currentBranchLabel, hubName);\n      }\n      if (this.activeTab === 'other-branch') {\n        const originoriginLocId = this.getOriginId(stock);\n        const originBranchLabel = String(stock?.branch || '').trim();\n        return originoriginLocId === hubId || hasHubName && originBranchLabel.toLowerCase() === hubName.toLowerCase() || hasHubName && this.matchesBranchLabel(originBranchLabel, hubName);\n      }\n      if (this.activeTab === 'others-in-branch') {\n        const currentoriginLocId = this.normalizeId(stock?.currentLocationId || stock?.currentBranch);\n        const currentBranchLabel = String(stock?.currentBranch || '').trim();\n        return currentoriginLocId === hubId || hasHubName && currentBranchLabel.toLowerCase() === hubName.toLowerCase() || hasHubName && this.matchesBranchLabel(currentBranchLabel, hubName);\n      }\n      return this.getStockHubId(stock) === hubId;\n    }\n    getStockHubId(stock) {\n      return this.getOriginId(stock) || this.normalizeId(stock?.currentLocationId || stock?.currentBranch);\n    }\n    toggleAllSelection(event) {\n      const checked = event.target.checked;\n      this.filteredStocks.forEach(s => s.selected = checked);\n    }\n    clearSelection() {\n      this.filteredStocks.forEach(s => {\n        s.selected = false;\n      });\n      this.selectedForManifestation = [];\n    }\n    hasSelectedConsignment() {\n      return (this.filteredStocks || []).some(s => s.selected);\n    }\n    openCancelPopup() {\n      if (String(this.originLocId || '').trim().toLowerCase() === 'all') {\n        alert('Please select a specific branch for canceling');\n        return;\n      }\n      if (!this.hasSelectedConsignment()) return;\n      this.showCancelPopup = true;\n    }\n    closeCancelPopup() {\n      this.showCancelPopup = false;\n    }\n    getSelectedConsignments() {\n      return (this.filteredStocks || []).filter(s => s.selected);\n    }\n    removeSelection(consignment) {\n      if (consignment) {\n        consignment.selected = false;\n      }\n    }\n    confirmCancelSelection() {\n      const selected = this.getSelectedConsignments();\n      if (!selected.length) {\n        this.closeCancelPopup();\n        return;\n      }\n      const updates = selected.map(consignment => {\n        const shipmentId = consignment?._id ? encodeURIComponent(consignment._id) : '';\n        const shipmentParam = shipmentId ? `?shipmentId=${shipmentId}` : '';\n        const payload = {\n          ...consignment,\n          shipmentStatus: 'Deleted during Transportation',\n          currentVehicleNo: '',\n          currentVehicleOwnerType: '',\n          currentVehicleOwnerId: null\n        };\n        return this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}${shipmentParam}`, payload);\n      });\n      forkJoin(updates).subscribe({\n        next: () => {\n          this.closeCancelPopup();\n          this.clearSelection();\n          this.loadStocks();\n        },\n        error: err => {\n          console.error('Error deleting consignments:', err);\n          this.deleteErrorMessage = 'Failed to delete consignments. Please try again.';\n          this.showDeleteErrorPopup = true;\n        }\n      });\n    }\n    closeDeleteErrorPopup() {\n      this.showDeleteErrorPopup = false;\n    }\n    setActiveTab(tab) {\n      if (this.activeTab === tab) return;\n      this.activeTab = tab;\n      // Ensure the status filter does not hide delivery-status rows on delivery tabs.\n      if (tab === 'stocks') {\n        if (this.isAllowedDeliveryStatus(String(this.filterStatus || '').trim())) {\n          this.filterStatus = 'Manifestation';\n        }\n      } else {\n        if (!this.isAllowedDeliveryStatus(String(this.filterStatus || '').trim())) {\n          this.filterStatus = '';\n        }\n      }\n      this.loadStocks();\n    }\n    openStockDetails(stock) {\n      this.selectedStock = this.enrichShipmentDetails(stock);\n    }\n    closeStockDetails() {\n      this.selectedStock = null;\n    }\n    editStock(stock) {\n      console.log('?o??,? Edit stock:', stock);\n      const cloned = JSON.parse(JSON.stringify(stock));\n      cloned.invoices = this.flattenInvoices(cloned.ewaybills || cloned.invoices || []);\n      this.editingStock = cloned;\n      this.manifestEditsById = {};\n      this.pendingManifestAdjustment = null;\n      this.manifestAdjustmentLines = [];\n      this.showManifestAdjustmentPopup = false;\n      this.captureOriginalProductValues(this.editingStock);\n    }\n    saveStockEdit() {\n      if (!this.editingStock) return;\n      if (this.pendingManifestAdjustment || this.showManifestAdjustmentPopup) {\n        this.applyManifestAdjustments();\n        if (this.pendingManifestAdjustment || this.showManifestAdjustmentPopup) {\n          return;\n        }\n      }\n      this.syncEwaybillsFromInvoices();\n      console.log(\"kkkkkkkkkkklllllllllllllllll\" + this.editingStock.consignmentNumber);\n      const payload = this.buildShipmentPayload();\n      const manifestUpdates = Object.values(this.manifestEditsById || {});\n      const updateManifests$ = manifestUpdates.length ? forkJoin(manifestUpdates.map(m => this.http.put(`http://localhost:3000/api/manifest/${m._id}`, m))) : of([]);\n      updateManifests$.subscribe({\n        next: () => {\n          this.http.put(`http://localhost:3000/api/newshipments/${payload.consignmentNumber}`, payload).subscribe({\n            next: () => {\n              console.log('?o. Stock updated');\n              this.loadStocks(); // reload updated data\n              this.editingStock = null; // close modal\n            },\n            error: err => console.error('??O Error updating stock:', err)\n          });\n        },\n        error: err => {\n          console.error('??O Error updating manifests:', err);\n          alert('Failed to update manifests. Please try again.');\n        }\n      });\n    }\n    cancelEdit() {\n      this.editingStock = null;\n      this.pendingManifestAdjustment = null;\n      this.manifestAdjustmentLines = [];\n      this.showManifestAdjustmentPopup = false;\n    }\n    captureOriginalProductValues(stock) {\n      (stock?.invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          prod._originalAmount = Number(prod.amount) || 0;\n          prod._originalInstock = Number(prod.instock) || 0;\n          prod._originalIntransit = Number(prod.intransitstock) || 0;\n          prod._originalDelivered = Number(prod.deliveredstock) || 0;\n        });\n      });\n    }\n    resetProductToOriginal(product) {\n      product.amount = Number(product._originalAmount) || 0;\n      product.instock = Number(product._originalInstock) || 0;\n      product.intransitstock = Number(product._originalIntransit) || 0;\n      product.deliveredstock = Number(product._originalDelivered) || 0;\n    }\n    normalizeInvoiceNumber(invoice) {\n      return String(invoice?.number || invoice?.invoicenum || '').trim();\n    }\n    normalizeProductType(product) {\n      return String(product?.type || '').trim();\n    }\n    getManifestTotals() {\n      const lines = this.manifestAdjustmentLines || [];\n      const deliveredTotal = lines.filter(line => line?.isDelivered).reduce((sum, line) => sum + (Number(line.newManifestQty) || 0), 0);\n      const manifestTotal = lines.reduce((sum, line) => sum + (Number(line.newManifestQty) || 0), 0);\n      const intransitTotal = Math.max(0, manifestTotal - deliveredTotal);\n      return {\n        manifestTotal,\n        deliveredTotal,\n        intransitTotal\n      };\n    }\n    syncEwaybillsFromInvoices() {\n      if (!this.editingStock?.ewaybills?.length || !this.editingStock?.invoices?.length) return;\n      for (const flatInv of this.editingStock.invoices || []) {\n        const flatInvNumber = this.normalizeInvoiceNumber(flatInv);\n        for (const ewb of this.editingStock.ewaybills || []) {\n          for (const inv of ewb.invoices || []) {\n            if (this.normalizeInvoiceNumber(inv) !== flatInvNumber) continue;\n            for (const prod of inv.products || []) {\n              const flatProd = (flatInv.products || []).find(p => this.normalizeProductType(p) === this.normalizeProductType(prod));\n              if (!flatProd) continue;\n              prod.amount = flatProd.amount;\n              prod.instock = flatProd.instock;\n              prod.intransitstock = flatProd.intransitstock;\n              prod.deliveredstock = flatProd.deliveredstock;\n              if (flatProd.manifestQty !== undefined) {\n                prod.manifestQty = flatProd.manifestQty;\n              }\n            }\n          }\n        }\n      }\n    }\n    applyProductUpdate(invoices, invoiceNumber, productType, update) {\n      const normalizedInvoice = String(invoiceNumber || '').trim();\n      const normalizedProduct = String(productType || '').trim();\n      (invoices || []).forEach(inv => {\n        const invNumber = this.normalizeInvoiceNumber(inv);\n        if (normalizedInvoice && invNumber !== normalizedInvoice) return;\n        (inv.products || []).forEach(prod => {\n          if (this.normalizeProductType(prod) !== normalizedProduct) return;\n          update(prod);\n        });\n      });\n    }\n    isProductManifested(product) {\n      return Number(product?._originalIntransit ?? product?.intransitstock ?? 0) > 0;\n    }\n    onProductAmountFocus(invoice, product, invoiceIndex) {\n      if (!this.isProductManifested(product)) return;\n      this.openManifestAdjustmentPopup(invoice, product, product.amount, invoiceIndex);\n    }\n    onProductAmountChange(invoice, product, rawValue, invoiceIndex) {\n      if (!this.editingStock) return;\n      let newAmount = Number(rawValue);\n      if (!Number.isFinite(newAmount)) newAmount = 0;\n      if (newAmount < 0) newAmount = 0;\n      const originalAmount = Number(product._originalAmount) || 0;\n      const originalInstock = Number(product._originalInstock) || 0;\n      const originalIntransit = Number(product._originalIntransit) || 0;\n      const originalDelivered = Number(product._originalDelivered) || 0;\n      if (!this.isProductManifested(product)) {\n        if (newAmount >= originalAmount) {\n          const delta = newAmount - originalAmount;\n          product.amount = newAmount;\n          product.instock = originalInstock + delta;\n          product.intransitstock = originalIntransit;\n          product.deliveredstock = originalDelivered;\n          return;\n        }\n        const reduction = originalAmount - newAmount;\n        if (reduction <= originalInstock) {\n          product.amount = newAmount;\n          product.instock = originalInstock - reduction;\n          product.intransitstock = originalIntransit;\n          product.deliveredstock = originalDelivered;\n          return;\n        }\n        alert('Reduction exceeds available in-stock quantity.');\n        this.resetProductToOriginal(product);\n        return;\n      }\n      const reduction = originalAmount - newAmount;\n      if (reduction > originalInstock + originalIntransit) {\n        alert('Reduction exceeds available in-stock and manifested quantity.');\n        this.resetProductToOriginal(product);\n        return;\n      }\n      if (!this.pendingManifestAdjustment || this.pendingManifestAdjustment.productRef !== product) {\n        this.openManifestAdjustmentPopup(invoice, product, newAmount, invoiceIndex);\n        return;\n      }\n      this.pendingManifestAdjustment.targetAmount = newAmount;\n      product.amount = newAmount;\n    }\n    openManifestAdjustmentPopup(invoice, product, targetAmount, invoiceIndex) {\n      const consignmentNumber = this.editingStock?.consignmentNumber;\n      if (!consignmentNumber) return;\n      let invoiceNumber = this.normalizeInvoiceNumber(invoice);\n      if (!invoiceNumber && Number.isFinite(invoiceIndex)) {\n        invoiceNumber = `MAN-${String(consignmentNumber || '').trim()}-${Number(invoiceIndex) + 1}`;\n      }\n      this.pendingManifestAdjustment = {\n        consignmentNumber,\n        invoiceNumber,\n        productType: this.normalizeProductType(product),\n        targetAmount: Number(targetAmount) || 0,\n        popupInstock: Number(product._originalInstock) || 0,\n        originalAmount: Number(product._originalAmount) || 0,\n        originalInstock: Number(product._originalInstock) || 0,\n        originalIntransit: Number(product._originalIntransit) || 0,\n        originalDelivered: Number(product._originalDelivered) || 0,\n        productRef: product\n      };\n      this.http.get(`http://localhost:3000/api/manifest/by-consignment/${encodeURIComponent(consignmentNumber)}`).subscribe({\n        next: res => {\n          this.manifestAdjustments = res || [];\n          this.buildManifestAdjustmentLines();\n        },\n        error: err => {\n          console.error('Error loading manifests:', err);\n          alert('Failed to load manifests for adjustment.');\n          this.cancelManifestAdjustments();\n        }\n      });\n    }\n    buildManifestAdjustmentLines() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      const productType = pending.productType;\n      const consignmentNumber = pending.consignmentNumber;\n      const lines = [];\n      for (const manifest of this.manifestAdjustments || []) {\n        for (const cons of manifest.consignments || []) {\n          if (String(cons.consignmentNumber || '').trim() !== consignmentNumber) continue;\n          for (const inv of cons.invoices || []) {\n            const invNumber = this.normalizeInvoiceNumber(inv);\n            if (pending.invoiceNumber && invNumber !== pending.invoiceNumber) continue;\n            for (const prod of inv.products || []) {\n              if (this.normalizeProductType(prod) !== productType) continue;\n              const originalManifestQty = Number(prod.manifestQty) || 0;\n              lines.push({\n                manifestId: manifest._id,\n                manifestationNumber: manifest.manifestationNumber,\n                date: manifest.date,\n                manifestStatus: manifest.mshipmentStatus,\n                consignmentNumber,\n                invoiceNumber: invNumber,\n                productType,\n                originalManifestQty,\n                newManifestQty: originalManifestQty,\n                isDelivered: String(manifest.mshipmentStatus || '').toLowerCase() === 'delivered'\n              });\n            }\n          }\n        }\n      }\n      if (!lines.length) {\n        alert('No manifest lines found for this product.');\n        this.cancelManifestAdjustments();\n        return;\n      }\n      this.manifestAdjustmentLines = lines;\n      this.syncPopupInstockWithTarget();\n      this.showManifestAdjustmentPopup = true;\n    }\n    onManifestQtyChange(line) {\n      let value = Number(line.newManifestQty);\n      if (!Number.isFinite(value)) value = 0;\n      if (value < 0) value = 0;\n      line.newManifestQty = value;\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      const totals = this.getManifestTotals();\n      pending.targetAmount = (Number(pending.popupInstock) || 0) + totals.manifestTotal;\n      if (pending.productRef) {\n        pending.productRef.amount = Number(pending.targetAmount) || 0;\n      }\n    }\n    getManifestLineTotal() {\n      return this.getManifestTotals().manifestTotal;\n    }\n    getPopupTargetTotal() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return 0;\n      return Number(pending.targetAmount) || 0;\n    }\n    getPopupDeliveredTotal() {\n      return this.getManifestTotals().deliveredTotal;\n    }\n    getPopupInstockTotal() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return 0;\n      const totals = this.getManifestTotals();\n      return (Number(pending.targetAmount) || 0) - totals.manifestTotal;\n    }\n    syncPopupInstockWithTarget() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      const totals = this.getManifestTotals();\n      const targetAmount = Number(pending.targetAmount) || 0;\n      const computedInstock = targetAmount - totals.manifestTotal;\n      pending.popupInstock = Math.max(0, computedInstock);\n      pending.targetAmount = pending.popupInstock + totals.manifestTotal;\n    }\n    syncTargetFromInstock() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      const popupInstock = Math.max(0, Number(pending.popupInstock) || 0);\n      pending.popupInstock = popupInstock;\n      const totals = this.getManifestTotals();\n      pending.targetAmount = popupInstock + totals.manifestTotal;\n    }\n    onPopupTargetAmountChange(rawValue) {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      let newAmount = Number(rawValue);\n      if (!Number.isFinite(newAmount)) newAmount = 0;\n      if (newAmount < 0) newAmount = 0;\n      pending.targetAmount = newAmount;\n      this.syncPopupInstockWithTarget();\n      if (pending.productRef) {\n        pending.productRef.amount = newAmount;\n      }\n    }\n    onPopupInstockChange(rawValue) {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      let newInstock = Number(rawValue);\n      if (!Number.isFinite(newInstock)) newInstock = 0;\n      if (newInstock < 0) newInstock = 0;\n      pending.popupInstock = newInstock;\n      this.syncTargetFromInstock();\n      if (pending.productRef) {\n        pending.productRef.amount = Number(pending.targetAmount) || 0;\n      }\n    }\n    applyManifestAdjustments() {\n      const pending = this.pendingManifestAdjustment;\n      if (!pending) return;\n      const totals = this.getManifestTotals();\n      const instockTotal = Math.max(0, Number(pending.popupInstock) || 0);\n      const targetAmount = instockTotal + totals.manifestTotal;\n      if (instockTotal < 0) {\n        alert('New Total Qty must be at least manifest + delivered quantities.');\n        return;\n      }\n      for (const line of this.manifestAdjustmentLines || []) {\n        line.updatedAmount = targetAmount;\n        line.updatedInstock = instockTotal;\n        line.updatedIntransit = totals.intransitTotal;\n        line.updatedDelivered = totals.deliveredTotal;\n      }\n      for (const line of this.manifestAdjustmentLines || []) {\n        this.queueManifestUpdate(line);\n      }\n      const updateTotals = prod => {\n        prod.amount = targetAmount;\n        prod.instock = instockTotal;\n        prod.intransitstock = totals.intransitTotal;\n        prod.deliveredstock = totals.deliveredTotal;\n        prod.manifestQty = totals.manifestTotal;\n      };\n      if (pending.productRef) {\n        updateTotals(pending.productRef);\n      }\n      this.applyProductUpdate(this.editingStock?.invoices || [], pending.invoiceNumber, pending.productType, updateTotals);\n      (this.editingStock?.ewaybills || []).forEach(ewb => {\n        this.applyProductUpdate(ewb.invoices || [], pending.invoiceNumber, pending.productType, updateTotals);\n      });\n      this.pendingManifestAdjustment = null;\n      this.manifestAdjustmentLines = [];\n      this.showManifestAdjustmentPopup = false;\n    }\n    cancelManifestAdjustments() {\n      const pending = this.pendingManifestAdjustment;\n      if (pending?.productRef) this.resetProductToOriginal(pending.productRef);\n      this.pendingManifestAdjustment = null;\n      this.manifestAdjustmentLines = [];\n      this.showManifestAdjustmentPopup = false;\n    }\n    queueManifestUpdate(line) {\n      const manifest = (this.manifestAdjustments || []).find(m => m._id === line.manifestId);\n      if (!manifest) return;\n      for (const cons of manifest.consignments || []) {\n        if (String(cons.consignmentNumber || '').trim() !== line.consignmentNumber) continue;\n        for (const inv of cons.invoices || []) {\n          const invNumber = this.normalizeInvoiceNumber(inv);\n          if (invNumber !== line.invoiceNumber) continue;\n          for (const prod of inv.products || []) {\n            if (this.normalizeProductType(prod) !== line.productType) continue;\n            prod.manifestQty = Number(line.newManifestQty) || 0;\n            if (line.updatedAmount !== undefined) {\n              prod.amount = Number(line.updatedAmount) || 0;\n              prod.instock = Number(line.updatedInstock) || 0;\n              prod.intransitstock = Number(line.updatedIntransit) || 0;\n              prod.deliveredstock = Number(line.updatedDelivered) || 0;\n            }\n          }\n        }\n      }\n      this.manifestEditsById[manifest._id] = manifest;\n    }\n    buildShipmentPayload() {\n      const payload = JSON.parse(JSON.stringify(this.editingStock));\n      const cleanProduct = prod => {\n        delete prod._originalAmount;\n        delete prod._originalInstock;\n        delete prod._originalIntransit;\n        delete prod._originalDelivered;\n      };\n      (payload.ewaybills || []).forEach(ewb => {\n        (ewb.invoices || []).forEach(inv => {\n          (inv.products || []).forEach(prod => cleanProduct(prod));\n        });\n      });\n      (payload.invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => cleanProduct(prod));\n      });\n      return payload;\n    }\n    onConsignorSelect(name) {\n      const selectedconignor = this.clientList.find(c => c.clientName === name);\n      if (selectedconignor) {\n        this.editingStock.consignorGST = selectedconignor.GSTIN;\n        this.editingStock.consignorAddress = selectedconignor.address;\n        this.editingStock.consignorPhone = selectedconignor.phoneNum;\n      }\n    }\n    onConsigneeSelect(name) {\n      const selectedconignee = this.clientList.find(c => c.clientName === name);\n      if (selectedconignee) {\n        this.editingStock.consigneeGST = selectedconignee.GSTIN;\n        this.editingStock.consigneeAddress = selectedconignee.address;\n        this.editingStock.consigneePhone = selectedconignee.phoneNum;\n      }\n    }\n    onConsignorGuestSelect(name) {\n      const selectedguestconignor = this.guestList.find(c => c.guestName === name);\n      if (selectedguestconignor) {\n        this.editingStock.consignorGST = 'GUEST';\n        this.editingStock.consignorAddress = selectedguestconignor.address;\n        this.editingStock.consignorPhone = selectedguestconignor.phoneNum;\n      }\n    }\n    onConsigneeGuestSelect(name) {\n      const selectedguestconignee = this.guestList.find(c => c.guestName === name);\n      if (selectedguestconignee) {\n        this.editingStock.consigneeGST = 'GUEST';\n        this.editingStock.consigneeAddress = selectedguestconignee.address;\n        this.editingStock.consigneePhone = selectedguestconignee.phoneNum;\n      }\n    }\n    onPackageList(name) {\n      const selectedpackage = this.pkgList.find(c => c.pkgName === name);\n    }\n    onProductList(name) {\n      const selectedproduct = this.productList.find(c => c.productName === name);\n    }\n    addRoutePoint() {\n      if (!this.selectedRoutePoint) return;\n      const vehicleNo = this.selectedRouteVehicle || '';\n      this.shipmentRoute.push({\n        name: this.selectedRoutePoint.name,\n        type: this.selectedRoutePoint.type,\n        vehicleNo\n      });\n      this.selectedRoutePoint = null;\n      this.selectedRouteVehicle = '';\n    }\n    removeRoutePoint(index) {\n      this.shipmentRoute.splice(index, 1);\n    }\n    loadBranches() {\n      const email = localStorage.getItem('email');\n      this.http.get(`http://localhost:3000/api/branches?email=${email}`).subscribe({\n        next: data => {\n          console.log(\"Branches loaded:\", data);\n          this.branches = data;\n          this.updateAvailableRoutePoints(); // Refresh route options\n          this.loadStocks();\n          this.loadManifests();\n        },\n        error: err => console.error(\"Error loading branches:\", err)\n      });\n    }\n    loadHubs() {\n      const email = localStorage.getItem('email');\n      this.http.get(`http://localhost:3000/api/hubs?email=${email}`).subscribe({\n        next: data => {\n          console.log(\"Hubs loaded:\", data);\n          this.hubs = data;\n          this.updateAvailableRoutePoints(); // Refresh route options\n          const originLocId = this.originLocId || localStorage.getItem('originLocId') || 'all';\n          if (originLocId === 'all-hubs') {\n            const storedHubId = this.normalizeId(localStorage.getItem('hubId'));\n            const fallbackHubId = this.normalizeId((this.hubs || [])[0]?._id);\n            const hubId = storedHubId || fallbackHubId;\n            if (hubId) {\n              this.selectedHubFilterId = hubId;\n              const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === hubId);\n              this.selectedHubFilterName = String(hub?.hubName || '').trim();\n              localStorage.setItem('hubId', hubId);\n              localStorage.setItem('hubName', this.selectedHubFilterName);\n            }\n            this.loadStocks();\n            this.loadManifests();\n          }\n        },\n        error: err => console.error(\"Error loading hubs:\", err)\n      });\n    }\n    updateAvailableRoutePoints() {\n      const originLocId = String(this.originLocId || '').trim();\n      const branchName = String(this.branch || '').trim().toLowerCase();\n      const excludeSelected = branchName && branchName !== 'all branches';\n      this.availableRoutePoints = [...this.branches.filter(b => {\n        if (!excludeSelected) return true;\n        const idMatch = originLocId && originLocId !== 'all' && this.normalizeId(b?._id) === this.normalizeId(originLocId);\n        const nameMatch = String(b?.branchName || '').trim().toLowerCase() === branchName;\n        return !(idMatch || nameMatch);\n      }).map(b => ({\n        name: b.branchName,\n        type: \"Branch\",\n        vehicles: (b.vehicles || []).map(v => v.vehicleNo).filter(Boolean)\n      })), ...this.hubs.filter(h => {\n        if (!excludeSelected) return true;\n        const idMatch = originLocId && originLocId !== 'all' && this.normalizeId(h?.originLocId) === this.normalizeId(originLocId);\n        if (idMatch) return false;\n        const hubBranch = (this.branches || []).find(b => this.normalizeId(b?._id) === this.normalizeId(h?.originLocId));\n        const nameMatch = hubBranch?.branchName && String(hubBranch.branchName).trim().toLowerCase() === branchName;\n        return !nameMatch;\n      }).map(h => ({\n        name: h.hubName,\n        type: \"Hub\",\n        vehicles: (h.deliveryAddresses || []).flatMap(addr => (addr.vehicles || []).map(v => v.vehicleNo)).filter(Boolean)\n      }))];\n      console.log('[manifest] route points', {\n        originLocId,\n        branchName: this.branch,\n        points: this.availableRoutePoints.map(p => `${p.name} (${p.type})`)\n      });\n    }\n    onRoutePointChange() {\n      this.selectedRouteVehicle = this.selectedRoutePoint?.vehicles?.[0] || '';\n    }\n    ngOnInit() {\n      this.activeTab = 'stocks';\n      this.email = localStorage.getItem('email') || '';\n      this.username = localStorage.getItem('username') || '';\n      this.branch = this.branchService.currentBranch || localStorage.getItem('branch') || 'All Branches';\n      this.originLocId = localStorage.getItem('originLocId') || 'all';\n      if (this.originLocId === 'all') {\n        this.filterStatus = '';\n      }\n      this.branchSub = this.branchService.branch$.subscribe(branch => {\n        this.branch = branch;\n        this.originLocId = localStorage.getItem('originLocId') || 'all';\n        this.updateAvailableRoutePoints();\n        this.loadStocks();\n        this.loadManifests();\n      });\n      // react to branch changes (same tab)\n      this.branchCheck = setInterval(() => {\n        const current = localStorage.getItem('branch') || 'All Branches';\n        const currentId = localStorage.getItem('originLocId') || 'all';\n        if (current !== this.branch || currentId !== this.originLocId) {\n          this.branch = current;\n          this.originLocId = currentId;\n          this.updateAvailableRoutePoints();\n          this.loadStocks();\n          this.loadManifests();\n        }\n      }, 1000);\n      // react to branch changes (other tabs)\n      window.addEventListener('storage', this.onStorageChange);\n      // Clients list\n      this.http.get(`http://localhost:3000/api/clients/clientslist?emailId=${this.email}`).subscribe({\n        next: data => this.clientList = data,\n        error: err => console.error('Error fetching client list', err),\n        complete: () => console.log('Client list fetch complete')\n      });\n      // Guests list\n      this.http.get(`http://localhost:3000/api/guests/guestslist?emailId=${this.email}`).subscribe({\n        next: data => this.guestList = data,\n        error: err => console.error('Error fetching guest list', err),\n        complete: () => console.log('Guest list fetch complete')\n      });\n      // Packages list\n      this.http.get(`http://localhost:3000/api/pkgs/pkglist?emailId=${this.email}`).subscribe({\n        next: data => this.pkgList = data,\n        error: err => console.error('Error fetching package list', err),\n        complete: () => console.log('Package list fetch complete')\n      });\n      // Products list\n      const originFilter = this.getManifestOriginFilter();\n      const params = {\n        branch: this.branch || localStorage.getItem('branch') || ''\n      };\n      if (originFilter) {\n        params.originType = originFilter.originType;\n        params.originLocId = originFilter.originLocId;\n      } else {\n        const originLocIdParam = this.originLocId || localStorage.getItem('originLocId') || 'all';\n        params.originLocId = originLocIdParam === 'all-hubs' ? 'all' : originLocIdParam;\n      }\n      this.http.get('http://localhost:3000/api/products/productlist', {\n        params\n      }).subscribe({\n        next: data => this.productList = data,\n        error: err => console.error('Error fetching product list', err),\n        complete: () => console.log('Product list fetch complete')\n      });\n      this.loadBranches();\n      this.loadHubs();\n    }\n    ngOnDestroy() {\n      this.branchSub?.unsubscribe();\n      if (this.branchCheck) clearInterval(this.branchCheck);\n      window.removeEventListener('storage', this.onStorageChange);\n    }\n    getEwaybillNumberFromDB(consignmentNumber) {\n      const record = this.stocks.find(shipment => shipment.consignmentNumber === consignmentNumber);\n      return record?.ewaybillNumber || '';\n    }\n    openManifestationPopup() {\n      if (this.originLocId === 'all' || !this.originLocId) {\n        alert('Please select a specific branch before manifesting consignments.');\n        return;\n      }\n      // Filter selected consignments\n      this.selectedForManifestation = this.filteredStocks.filter(s => s.selected);\n      // Guard clause: ensure at least one consignment is selected\n      if (this.selectedForManifestation.length === 0) {\n        alert('G??n+? Please select at least one consignment to manifest.');\n        return;\n      }\n      // Initialize manifestQty and eway bill fields\n      this.selectedForManifestation = this.selectedForManifestation.map(consignment => {\n        // Set eway bill fields\n        const updatedConsignment = {\n          ...consignment,\n          ewayBillRequired: false,\n          ewaybillNumber: this.getEwaybillNumberFromDB(consignment.consignmentNumber)\n        };\n        // Set manifestQty = instock for each product\n        updatedConsignment.invoices?.forEach(invoice => {\n          invoice.products?.forEach(product => {\n            const amount = Number(product.amount) || 0;\n            const inTransit = Number(product.intransitstock) || 0;\n            const delivered = Number(product.deliveredstock) || 0;\n            const available = Math.max(0, amount - inTransit - delivered);\n            const currentInstock = Number(product.instock) || 0;\n            if (!currentInstock && available > 0) {\n              product.instock = available;\n            }\n            product.manifestQty = Number(product.instock) || available;\n            product.manifestQtyTouched = false;\n          });\n        });\n        return updatedConsignment;\n      });\n      // Show the popup\n      this.showManifestationPopup = true;\n    }\n    closeManifestationPopup() {\n      this.showManifestationPopup = false;\n    }\n    executeDelivery(consignments, onSuccess) {\n      if (!consignments.length) {\n        alert('No consignments selected.');\n        return;\n      }\n      const vehicleUpdates = [];\n      const completionTargets = new Map();\n      const updates = (consignments || []).map(consignment => {\n        const updatedEwaybills = (consignment.ewaybills || []).map(ewb => ({\n          ...ewb\n        }));\n        const status = String(consignment?.shipmentStatus || '').trim();\n        const isManifestation = status === 'Manifestation' || status === 'DManifestation';\n        const statusDetailsoriginLocId = this.getLastStatusDetailoriginLocId(consignment?.shipmentStatusDetails || '');\n        const resolvedCurrentoriginLocId = statusDetailsoriginLocId || consignment?.currentLocationId || consignment?.currentBranch || consignment?.currentBranch;\n        const vehicleNo = String(consignment?.currentVehicleNo || '').trim();\n        const payload = {\n          shipmentId: consignment?._id || '',\n          shipmentStatus: isManifestation ? 'DPending' : 'Delivered',\n          currentLocationId: resolvedCurrentoriginLocId,\n          currentVehicleNo: consignment?.currentVehicleNo || '',\n          currentVehicleOwnerType: consignment?.currentVehicleOwnerType || '',\n          currentVehicleOwnerId: consignment?.currentVehicleOwnerId || null,\n          clearAllVehicles: true,\n          ewaybills: updatedEwaybills\n        };\n        const shipmentId = consignment?._id ? encodeURIComponent(consignment._id) : '';\n        const shipmentParam = shipmentId ? `?shipmentId=${shipmentId}` : '';\n        console.log('[manifest:update] payload', {\n          consignmentNumber: consignment.consignmentNumber,\n          shipmentId: payload.shipmentId,\n          shipmentStatus: payload.shipmentStatus,\n          currentLocationId: payload.currentLocationId\n        });\n        if (!isManifestation && vehicleNo && resolvedCurrentoriginLocId) {\n          const currentStatus = this.findVehicleStatus(vehicleNo);\n          if (currentStatus === 'scheduled' || currentStatus === 'delivering') {\n            const owner = this.resolveVehicleOwner(vehicleNo, consignment?.currentVehicleOwnerType, consignment?.currentVehicleOwnerId);\n            if (owner.ownerType && owner.ownerId) {\n              const key = `${owner.ownerType}:${owner.ownerId}:${vehicleNo}`;\n              completionTargets.set(key, {\n                vehicleNo,\n                ownerType: owner.ownerType,\n                ownerId: owner.ownerId,\n                locationId: String(resolvedCurrentoriginLocId || '')\n              });\n            }\n          }\n        }\n        return this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}${shipmentParam}`, payload);\n      });\n      completionTargets.forEach(target => {\n        const endpoint = target.ownerType === 'Hub' ? `http://localhost:3000/api/hubs/${target.ownerId}/vehicle-status` : `http://localhost:3000/api/branches/${target.ownerId}/vehicle-status`;\n        vehicleUpdates.push(this.http.patch(endpoint, {\n          vehicleNo: target.vehicleNo,\n          vehicleStatus: 'online',\n          currentLocationId: target.locationId\n        }));\n      });\n      const calls = [...updates, ...vehicleUpdates];\n      if (!calls.length) return;\n      forkJoin(calls).subscribe({\n        next: responses => {\n          console.log('[manifest:update] response', responses);\n          if (onSuccess) {\n            onSuccess();\n            return;\n          }\n          this.showManifestationPopup = false;\n          this.selectedForManifestation = [];\n          this.filteredStocks.forEach(s => s.selected = false);\n          this.loadStocks();\n        },\n        error: err => {\n          console.error('Error updating consignment status:', err);\n          const serverMsg = String(err?.error?.message || '').trim();\n          alert(serverMsg || 'Failed to update consignment status.');\n        }\n      });\n    }\n    finalizeManifestation() {\n      this.executeDelivery(this.selectedForManifestation, () => {\n        this.showManifestationPopup = false;\n        this.selectedForManifestation = [];\n        this.filteredStocks.forEach(s => s.selected = false);\n        this.loadStocks();\n      });\n    }\n    validateManifestQty(product) {\n      product.manifestQtyTouched = true;\n      if (product.manifestQty > product.instock) {\n        alert(`G??n+? Manifest quantity cannot exceed available stock (${product.instock}).`);\n        product.manifestQty = product.instock;\n      }\n      if (product.manifestQty < 0) {\n        alert('G??n+? Manifest quantity cannot be negative.');\n        product.manifestQty = 0;\n      }\n    }\n    printSelectedManifests() {\n      const selected = this.getSelectedManifests();\n      if (!selected.length) {\n        alert('Select at least one manifest to print.');\n        return;\n      }\n      const html = this.buildManifestPrintHtml(selected);\n      const printWindow = window.open('', '_blank');\n      if (!printWindow) return;\n      printWindow.document.open();\n      printWindow.document.write(html);\n      printWindow.document.close();\n      printWindow.focus();\n      printWindow.print();\n    }\n    isManifestSelected(manifest) {\n      const id = this.normalizeId(manifest?._id);\n      return Boolean(id && this.selectedManifestIds.has(id));\n    }\n    toggleManifestSelection(manifest) {\n      const id = this.normalizeId(manifest?._id);\n      if (!id) return;\n      const updated = new Set(this.selectedManifestIds);\n      if (updated.has(id)) {\n        updated.delete(id);\n      } else {\n        updated.add(id);\n      }\n      this.selectedManifestIds = updated;\n    }\n    getSelectedManifests() {\n      if (!this.selectedManifestIds.size) return [];\n      return (this.manifests || []).filter(manifest => this.selectedManifestIds.has(this.normalizeId(manifest?._id)));\n    }\n    buildManifestPrintHtml(manifests) {\n      const sections = manifests.map((manifest, index) => {\n        const items = Array.isArray(manifest?.items) ? manifest.items : [];\n        const manifestStatusNormalized = String(manifest?.status || '').trim().toLowerCase();\n        const filteredForCancelled = manifestStatusNormalized === 'cancelled' ? items.filter(item => String(item?.status || '').trim().toLowerCase() === 'cancelled') : items;\n        const sectionItems = filteredForCancelled.length ? filteredForCancelled : items;\n        const rows = sectionItems.length ? sectionItems.map(item => {\n          const consignmentNumber = String(item?.consignmentNumber || '').trim() || '-';\n          const status = String(item?.status || item?.shipmentStatus || '-');\n          const shipmentId = String(item?.shipmentId || '').trim() || '-';\n          return `\n          <tr>\n            <td>${consignmentNumber}</td>\n            <td>${status}</td>\n            <td>${shipmentId}</td>\n          </tr>\n        `;\n        }).join('') : `<tr><td colspan=\"3\">No consignments recorded.</td></tr>`;\n        const entityName = this.getManifestEntityName(manifest);\n        const createdAt = manifest?.createdAt ? new Date(manifest.createdAt).toLocaleString() : '-';\n        const sectionStatusLabel = manifestStatusNormalized === 'cancelled' ? 'Cancelled consignments' : manifest?.status || '-';\n        return `\n      <section class=\"manifest-print-section\">\n        <h2>${manifest?.manifestNumber || 'Manifest'}</h2>\n        <p class=\"manifest-print-meta\">\n          <span><strong>Status:</strong> ${sectionStatusLabel}</span>\n          <span><strong>Vehicle:</strong> ${manifest?.vehicleNo || '-'}</span>\n          <span><strong>Entity:</strong> ${entityName}</span>\n          <span><strong>Created:</strong> ${createdAt}</span>\n        </p>\n        <table class=\"manifest-print-table\">\n          <thead>\n            <tr>\n              <th>Consignment</th>\n              <th>Manifest Status</th>\n              <th>Shipment ID</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${rows}\n          </tbody>\n        </table>\n      </section>\n      ${index < manifests.length - 1 ? '<div class=\"page-break\"></div>' : ''}\n    `;\n      });\n      return `\n    <html>\n      <head>\n        <meta charset=\"utf-8\" />\n        <title>Manifest Print</title>\n        <style>\n          body { font-family: Arial, sans-serif; padding: 20px; background: #fff; color: #0f172a; }\n          .manifest-print-section { border: 1px solid #d1d5db; border-radius: 12px; padding: 18px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); }\n          .manifest-print-section h2 { margin: 0 0 6px; font-size: 20px; }\n          .manifest-print-meta { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 14px; font-size: 14px; }\n          .manifest-print-table { width: 100%; border-collapse: collapse; margin-top: 4px; }\n          .manifest-print-table th, .manifest-print-table td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; font-size: 13px; }\n          .manifest-print-table th { background: #f8fafc; }\n          .page-break { page-break-after: always; }\n        </style>\n      </head>\n      <body>\n        ${sections.join('')}\n      </body>\n    </html>\n  `;\n    }\n    static {\n      this.ɵfac = function ManifestComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || ManifestComponent)(i0.ɵɵdirectiveInject(i1.HttpClient), i0.ɵɵdirectiveInject(i2.BranchService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: ManifestComponent,\n        selectors: [[\"app-manifest\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 41,\n        vars: 7,\n        consts: [[\"noConsignments\", \"\"], [1, \"stocks-container\"], [1, \"manifest-table-section\"], [1, \"manifest-filters\"], [\"type\", \"button\", 1, \"print-btn\", 3, \"click\", \"disabled\"], [\"type\", \"text\", \"placeholder\", \"Search manifest no.\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"text\", \"placeholder\", \"Filter vehicle no.\", 3, \"ngModelChange\", \"ngModel\"], [3, \"ngModelChange\", \"ngModel\"], [\"value\", \"\"], [\"value\", \"Scheduled\"], [\"value\", \"Completed\"], [\"value\", \"Cancelled\"], [1, \"stocks-table\"], [1, \"select-column\"], [3, \"click\", 4, \"ngFor\", \"ngForOf\"], [4, \"ngIf\"], [\"class\", \"modal\", 4, \"ngIf\"], [3, \"click\"], [1, \"checkbox-cell\"], [\"type\", \"checkbox\", 3, \"change\", \"click\", \"checked\"], [1, \"actions-cell\"], [3, \"click\", 4, \"ngIf\"], [\"colspan\", \"8\"], [1, \"modal\"], [1, \"modal-content\", \"manifest-details-content\"], [\"type\", \"button\", 1, \"details-close\", 3, \"click\"], [\"class\", \"consignment-edit-actions\", 4, \"ngIf\"], [\"class\", \"manifest-details-grid\", 4, \"ngIf\"], [\"class\", \"manifest-consignments\", 4, \"ngIf\", \"ngIfElse\"], [\"class\", \"consignment-edit-panel\", 4, \"ngIf\"], [1, \"consignment-edit-actions\"], [1, \"manifest-details-grid\"], [3, \"ngModel\", \"ngModelChange\", 4, \"ngIf\"], [3, \"ngModel\", \"disabled\", \"ngModelChange\", 4, \"ngIf\"], [3, \"ngModelChange\", \"ngModel\", \"disabled\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [3, \"value\"], [\"target\", \"_blank\", \"rel\", \"noopener noreferrer\", 3, \"href\"], [1, \"manifest-consignments\"], [\"class\", \"consignment-split\", 4, \"ngFor\", \"ngForOf\"], [1, \"consignment-split\"], [1, \"consignment-header\"], [1, \"consignment-pickup\"], [1, \"pickup-address\"], [4, \"ngFor\", \"ngForOf\"], [\"colspan\", \"5\"], [1, \"consignment-edit-panel\"], [\"class\", \"consignment-edit-status\", 4, \"ngIf\"], [\"class\", \"consignment-edit-status error\", 4, \"ngIf\"], [1, \"consignment-edit-grid\"], [1, \"consignment-edit-list\"], [\"class\", \"consignment-edit-item\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"consignment-edit-empty\", 4, \"ngIf\"], [1, \"consignment-edit-status\"], [1, \"consignment-edit-status\", \"error\"], [1, \"consignment-edit-item\"], [\"type\", \"checkbox\", 3, \"change\", \"checked\"], [1, \"consignment-edit-empty\"]],\n        template: function ManifestComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"h2\");\n            i0.ɵɵtext(2, \"Manifest List\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"div\", 2)(4, \"div\", 3)(5, \"button\", 4);\n            i0.ɵɵlistener(\"click\", function ManifestComponent_Template_button_click_5_listener() {\n              return ctx.printSelectedManifests();\n            });\n            i0.ɵɵtext(6, \" Print Selected \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(7, \"input\", 5);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_input_ngModelChange_7_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.manifestSearchText, $event) || (ctx.manifestSearchText = $event);\n              return $event;\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(8, \"input\", 6);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_input_ngModelChange_8_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.manifestVehicleFilter, $event) || (ctx.manifestVehicleFilter = $event);\n              return $event;\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(9, \"select\", 7);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function ManifestComponent_Template_select_ngModelChange_9_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.manifestStatusFilter, $event) || (ctx.manifestStatusFilter = $event);\n              return $event;\n            });\n            i0.ɵɵelementStart(10, \"option\", 8);\n            i0.ɵɵtext(11, \"All statuses\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(12, \"option\", 9);\n            i0.ɵɵtext(13, \"Scheduled\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(14, \"option\", 10);\n            i0.ɵɵtext(15, \"Completed\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(16, \"option\", 11);\n            i0.ɵɵtext(17, \"Cancelled\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(18, \"table\", 12)(19, \"thead\")(20, \"tr\")(21, \"th\", 13);\n            i0.ɵɵtext(22, \"Select\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(23, \"th\");\n            i0.ɵɵtext(24, \"Manifest No.\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(25, \"th\");\n            i0.ɵɵtext(26, \"Date\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(27, \"th\");\n            i0.ɵɵtext(28, \"Status\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(29, \"th\");\n            i0.ɵɵtext(30, \"Vehicle\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(31, \"th\");\n            i0.ɵɵtext(32, \"Entity\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(33, \"th\");\n            i0.ɵɵtext(34, \"Consignments\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(35, \"th\");\n            i0.ɵɵtext(36, \"Actions\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(37, \"tbody\");\n            i0.ɵɵtemplate(38, ManifestComponent_tr_38_Template, 19, 12, \"tr\", 14)(39, ManifestComponent_tr_39_Template, 3, 0, \"tr\", 15);\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵtemplate(40, ManifestComponent_div_40_Template, 14, 5, \"div\", 16);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(5);\n            i0.ɵɵproperty(\"disabled\", !ctx.isManifestPrintEnabled);\n            i0.ɵɵadvance(2);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.manifestSearchText);\n            i0.ɵɵadvance();\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.manifestVehicleFilter);\n            i0.ɵɵadvance();\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.manifestStatusFilter);\n            i0.ɵɵadvance(29);\n            i0.ɵɵproperty(\"ngForOf\", ctx.filterManifests(ctx.manifests));\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.filterManifests(ctx.manifests).length);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showManifestDetails);\n          }\n        },\n        dependencies: [CommonModule, i3.NgForOf, i3.NgIf, i3.DatePipe, FormsModule, i4.NgSelectOption, i4.ɵNgSelectMultipleOption, i4.DefaultValueAccessor, i4.SelectControlValueAccessor, i4.NgControlStatus, i4.NgModel],\n        styles: [\".stocks-container[_ngcontent-%COMP%]{padding:20px;color:var(--stock-text)}[_nghost-%COMP%]{--stock-bg: #f6f8fb;--stock-card: #ffffff;--stock-border: #e5e7eb;--stock-text: #0f172a;--stock-muted: #6b7280;--stock-primary: #2563eb;--stock-primary-strong: #1e3a8a;--stock-danger: #dc2626}.filters[_ngcontent-%COMP%]{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.stocks-tabs[_ngcontent-%COMP%]{display:flex;gap:10px;margin-bottom:12px}.stocks-tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 14px;border-radius:999px;border:1px solid var(--stock-border);background:#fff;color:var(--stock-muted);cursor:pointer}.stocks-tabs[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]{background:#eef2ff;border-color:#c7d2fe;color:var(--stock-primary-strong);font-weight:600}.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .filters[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:8px 10px;border:1px solid var(--stock-border);border-radius:10px;background:#fff;color:var(--stock-text);flex:1 1 190px;min-width:0}.filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 14px;border-radius:10px;border:1px solid var(--stock-border);background:#fff;color:var(--stock-text);cursor:pointer;flex:0 0 auto}.filters[_ngcontent-%COMP%]   button.cancel-btn[_ngcontent-%COMP%]{border-color:var(--stock-danger);color:var(--stock-danger);background:#fff5f5}.filters[_ngcontent-%COMP%]   button.cancel-btn[_ngcontent-%COMP%]:hover{border-color:#b91c1c;color:#b91c1c}.filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{border-color:var(--stock-primary);color:var(--stock-primary-strong)}@media (max-width: 1200px){.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .filters[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:7px 9px;font-size:13px}.filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .stocks-tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:7px 12px;font-size:13px}.stocks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .stocks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:7px;font-size:13px}}@media (max-width: 992px){.filters[_ngcontent-%COMP%]{gap:8px}.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .filters[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:6px 8px;font-size:12px}.filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .stocks-tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 10px;font-size:12px}.stocks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .stocks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:6px;font-size:12px}}@media (max-width: 768px){.filters[_ngcontent-%COMP%]{gap:6px}.filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .filters[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:5px 7px;font-size:11px}.filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .stocks-tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:5px 8px;font-size:11px}.stocks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .stocks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:5px;font-size:11px}}.stocks-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;background:var(--stock-card);border:1px solid var(--stock-border);border-radius:12px;overflow:hidden}.stocks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .stocks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid var(--stock-border);padding:8px;text-align:left}.stocks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc;font-weight:600}.stocks-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover{background-color:#f8fafc;cursor:pointer}.stocks-table[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 12px;border-radius:10px;border:1px solid var(--stock-primary);background:var(--stock-primary);color:#fff;cursor:pointer}.stocks-table[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:var(--stock-primary-strong);border-color:var(--stock-primary-strong)}.stocks-table[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled, .manifest-details-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{background:#e5e7eb;border-color:#e5e7eb;color:#fff;cursor:not-allowed;opacity:1}.actions[_ngcontent-%COMP%]{margin-top:15px}.manifest-table-section[_ngcontent-%COMP%]{margin:20px 0}.manifest-table-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 10px}.select-column[_ngcontent-%COMP%]{width:70px;text-align:center}.checkbox-cell[_ngcontent-%COMP%]{text-align:center}.actions-cell[_ngcontent-%COMP%]{display:flex;gap:6px;flex-wrap:wrap}.manifest-filters[_ngcontent-%COMP%]{display:flex;gap:10px;margin:8px 0 12px;flex-wrap:wrap}.manifest-filters[_ngcontent-%COMP%]   .print-btn[_ngcontent-%COMP%]{padding:8px 14px;border-radius:10px;border:1px solid var(--stock-primary);background:var(--stock-primary);color:#fff;cursor:pointer;flex:0 0 auto}.manifest-filters[_ngcontent-%COMP%]   .print-btn[_ngcontent-%COMP%]:disabled{background:#e5e7eb;border-color:#e5e7eb;cursor:not-allowed}.manifest-filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .manifest-filters[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:8px 10px;border:1px solid var(--stock-border);border-radius:10px;background:#fff;color:var(--stock-text);flex:1 1 180px;min-width:0}.manifest-details-content[_ngcontent-%COMP%]{background:var(--stock-bg);color:var(--stock-text);width:min(720px,92vw);max-height:85vh;border-radius:16px;border:1px solid var(--stock-border);box-shadow:0 18px 40px #0f172a33}.manifest-details-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 16px;background:var(--stock-card);border:1px solid var(--stock-border);border-radius:12px;padding:12px;margin-bottom:16px}.manifest-details-grid[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .manifest-details-grid[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:6px 8px;border:1px solid var(--stock-border);border-radius:8px;background:#fff;color:var(--stock-text);font-size:12px;margin-left:6px;min-width:160px}.manifest-consignments[_ngcontent-%COMP%]{margin-top:10px}.consignment-split[_ngcontent-%COMP%]{border:1px solid var(--stock-border);border-radius:12px;padding:10px;background:var(--stock-card);margin-bottom:12px}.consignment-header[_ngcontent-%COMP%]{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:8px;color:var(--stock-muted);font-size:13px}.consignment-pickup[_ngcontent-%COMP%]{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px;color:var(--stock-text);font-size:12px}.consignment-pickup[_ngcontent-%COMP%]   .pickup-address[_ngcontent-%COMP%]{flex:1 1 100%}.consignment-edit-panel[_ngcontent-%COMP%]{margin:12px 0 16px;padding:12px;border:1px solid var(--stock-border);border-radius:12px;background:var(--stock-card)}.consignment-edit-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px}.consignment-edit-list[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{margin:0 0 8px;font-size:13px;color:var(--stock-text)}.consignment-edit-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--stock-text);padding:6px 8px;border:1px solid var(--stock-border);border-radius:8px;background:#f8fafc;margin-bottom:6px}.consignment-edit-empty[_ngcontent-%COMP%]{font-size:12px;color:var(--stock-muted);padding:6px 0}.consignment-edit-actions[_ngcontent-%COMP%]{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}.consignment-edit-status[_ngcontent-%COMP%]{font-size:12px;color:var(--stock-muted)}.consignment-edit-status.error[_ngcontent-%COMP%]{color:var(--stock-danger)}@media (max-width: 700px){.manifest-details-grid[_ngcontent-%COMP%], .consignment-edit-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.modal[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:3000}.modal-content[_ngcontent-%COMP%]{background:#fff;padding:20px;width:500px;max-height:80vh;overflow-y:auto;border-radius:8px;position:relative}.details-modal[_ngcontent-%COMP%]{background:#0f172a8c}.details-content[_ngcontent-%COMP%]{background:var(--stock-bg);color:var(--stock-text);width:min(860px,92vw);max-height:85vh;border-radius:16px;border:1px solid var(--stock-border);box-shadow:0 18px 40px #0f172a33}.details-close[_ngcontent-%COMP%]{position:absolute;right:18px;top:12px;background:transparent;border:none;font-size:24px;cursor:pointer;color:var(--stock-muted)}.details-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;gap:12px}.details-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:22px}.details-sub[_ngcontent-%COMP%]{margin:6px 0 0;color:var(--stock-muted);font-size:13px}.details-status[_ngcontent-%COMP%]{background:#e0f2fe;color:#0ea5e9;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;white-space:nowrap}.details-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 16px;background:var(--stock-card);border:1px solid var(--stock-border);border-radius:12px;padding:12px;margin-bottom:16px}.details-products[_ngcontent-%COMP%]{display:grid;gap:12px}.details-invoice[_ngcontent-%COMP%]{background:var(--stock-card);border:1px solid var(--stock-border);border-radius:12px;padding:12px}.details-invoice-title[_ngcontent-%COMP%]{font-weight:600;margin-bottom:8px}.details-product-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0;display:grid;gap:8px}.details-product-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;border-bottom:1px solid var(--stock-border);padding-bottom:6px}.details-product-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]:last-child{border-bottom:none}.product-name[_ngcontent-%COMP%]{font-weight:600}.product-meta[_ngcontent-%COMP%]{color:var(--stock-muted);font-size:13px}@media (max-width: 700px){.details-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.details-product-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}}.edit-stock-modal[_ngcontent-%COMP%]{background:#0f172a8c}.edit-stock-content[_ngcontent-%COMP%]{background:var(--stock-bg);color:var(--stock-text);width:min(1100px,92vw);max-height:85vh;border-radius:16px;border:1px solid var(--stock-border);box-shadow:0 18px 40px #0f172a33}.edit-stock-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}.edit-stock-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:22px;color:var(--stock-text)}.edit-stock-meta[_ngcontent-%COMP%]{margin:6px 0 0;color:var(--stock-muted);font-size:13px}.edit-stock-section[_ngcontent-%COMP%]{background:var(--stock-card);border:1px solid var(--stock-border);border-radius:12px;padding:14px;margin-bottom:14px}.edit-stock-section[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 10px;font-size:15px}.edit-stock-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}.edit-stock-content[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px;font-weight:600;font-size:13px;color:var(--stock-text)}.edit-stock-content[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{border:1px solid var(--stock-border);border-radius:10px;padding:8px 10px;font-size:13px;background:#fff;color:var(--stock-text)}.edit-stock-content[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{min-height:80px;resize:vertical}.edit-stock-tabs[_ngcontent-%COMP%]{display:flex;gap:8px;margin-bottom:12px}.edit-stock-tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 12px;border-radius:999px;border:1px solid var(--stock-border);background:#fff;color:var(--stock-muted);cursor:pointer}.edit-stock-tabs[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]{background:#eef2ff;border-color:#c7d2fe;color:var(--stock-primary-strong);font-weight:600}.edit-stock-radio[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:12px;margin:10px 0 4px;color:var(--stock-muted);font-size:13px}.edit-stock-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}.edit-stock-content[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{border-radius:10px;border:1px solid var(--stock-border);padding:8px 14px;font-size:13px;cursor:pointer;background:#fff;color:var(--stock-text)}.edit-stock-content[_ngcontent-%COMP%]   button.primary[_ngcontent-%COMP%]{background:var(--stock-primary);border-color:var(--stock-primary);color:#fff}.edit-stock-content[_ngcontent-%COMP%]   button.ghost[_ngcontent-%COMP%]{background:#f8fafc;color:var(--stock-text)}.edit-stock-content[_ngcontent-%COMP%]   button.danger[_ngcontent-%COMP%]{border-color:#fecaca;background:#fef2f2;color:var(--stock-danger)}.edit-stock-content[_ngcontent-%COMP%]   .grid-3[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   .grid-4[_ngcontent-%COMP%]{gap:10px}.edit-stock-content[_ngcontent-%COMP%]   .grid-3[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   .grid-4[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,minmax(0,1fr))}@media (max-width: 900px){.edit-stock-grid[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   .grid-3[_ngcontent-%COMP%], .edit-stock-content[_ngcontent-%COMP%]   .grid-4[_ngcontent-%COMP%]{grid-template-columns:1fr}.edit-stock-actions[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}}.close[_ngcontent-%COMP%]{position:absolute;right:15px;top:10px;font-size:24px;cursor:pointer}.modal-content.terminal-style[_ngcontent-%COMP%]{background-color:#1e1e1e;color:#d4d4d4;font-family:Courier New,monospace;border-radius:10px;padding:20px;width:80%;max-height:80vh;overflow-y:auto}.consignment-block[_ngcontent-%COMP%]{background:#2a2a2a;padding:10px;border-radius:6px;margin-bottom:10px}.terminal-buttons[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:15px}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 20px;border:none;border-radius:6px;cursor:pointer}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{background-color:#007acc;color:#fff}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{background-color:#555;color:#fff}.cancel-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:12px 0 16px;display:flex;flex-direction:column;gap:8px}.cancel-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 10px;border:1px solid var(--stock-border);border-radius:10px;background:#f8fafc;color:var(--stock-text)}.cancel-list[_ngcontent-%COMP%]   .remove-btn[_ngcontent-%COMP%]{border:1px solid var(--stock-danger);color:var(--stock-danger);background:#fff5f5;border-radius:8px;padding:6px 10px;cursor:pointer}.cancel-list[_ngcontent-%COMP%]   .remove-btn[_ngcontent-%COMP%]:hover{border-color:#b91c1c;color:#b91c1c}.product-line[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:4px 0}.manifest-input[_ngcontent-%COMP%]{width:60px;padding:4px;margin-left:4px;background-color:#333;color:#fff;border:1px solid #555;border-radius:4px;text-align:right}.eway-toggle-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;position:relative;cursor:pointer;-webkit-user-select:none;user-select:none}.eway-toggle-input[_ngcontent-%COMP%]{opacity:0;width:0;height:0}.eway-toggle-slider[_ngcontent-%COMP%]{position:relative;width:40px;height:20px;background-color:#ccc;border-radius:20px;transition:background-color .3s}.eway-toggle-slider[_ngcontent-%COMP%]:before{content:\\\"\\\";position:absolute;height:16px;width:16px;left:2px;bottom:2px;background-color:#fff;border-radius:50%;transition:transform .3s}.eway-toggle-input[_ngcontent-%COMP%]:checked + .eway-toggle-slider[_ngcontent-%COMP%]{background-color:#4caf50}.eway-toggle-input[_ngcontent-%COMP%]:checked + .eway-toggle-slider[_ngcontent-%COMP%]:before{transform:translate(20px)}.eway-toggle-text[_ngcontent-%COMP%]{font-weight:500}.routing-section[_ngcontent-%COMP%]{margin-top:20px}.routing-controls[_ngcontent-%COMP%]{display:flex;gap:10px;margin-bottom:10px}.route-list[_ngcontent-%COMP%]{list-style:none;padding-left:0}.route-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.remove-btn[_ngcontent-%COMP%]{background:none;border:none;color:red;cursor:pointer}\"]\n      });\n    }\n  }\n  return ManifestComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}