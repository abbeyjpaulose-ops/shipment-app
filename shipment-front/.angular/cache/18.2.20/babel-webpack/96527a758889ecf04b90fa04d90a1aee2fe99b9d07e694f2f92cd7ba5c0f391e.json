{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { HttpClientModule } from '@angular/common/http';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet ProfileComponent = class ProfileComponent {\n  constructor(http) {\n    this.http = http;\n    this.profile = {\n      name: '',\n      photo: '',\n      address: '',\n      company: '',\n      mobile: '',\n      email: '',\n      role: '',\n      businessType: '',\n      pricePerNumber: 0,\n      pricePerKg: 0,\n      pricePerArea: 0\n    };\n    this.auditLogs = [];\n    this.auditLoading = false;\n    this.auditFilters = {\n      startDate: '',\n      endDate: '',\n      action: '',\n      user: '',\n      limit: '100'\n    };\n    this.auditPage = 1;\n    this.auditTotal = 0;\n  }\n  ngOnInit() {\n    this.loadProfile();\n  }\n  loadProfile() {\n    const email = localStorage.getItem('email'); // set during login\n    const username = localStorage.getItem('username'); // set during login\n    this.http.get(`http://localhost:3000/api/profile?user=${username}&email=${email}`).subscribe({\n      next: data => {\n        this.profile = data[0] || this.profile;\n        console.log(\"Profile loaded:\", this.profile);\n      },\n      error: err => console.error(\"Error loading products:\", err)\n    });\n  }\n  onFileSelected(event) {\n    const file = event.target.files[0];\n    if (file) {\n      const reader = new FileReader();\n      reader.onload = () => {\n        this.profile.photo = reader.result;\n      };\n      reader.readAsDataURL(file);\n    }\n  }\n  saveProfile() {\n    console.log('ðŸ“¤ Sending profile data:', this.profile);\n    this.http.post('http://localhost:3000/api/profile/save', this.profile, {\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }).subscribe({\n      next: res => {\n        console.log('âœ… Profile saved', res);\n        alert('Profile saved successfully!');\n      },\n      error: err => {\n        console.error('âŒ Error saving profile:', err);\n        alert('Error: ' + err.error.message);\n      }\n    });\n  }\n  backfillBusinessType() {\n    const ok = window.confirm('Backfill business type for all profiles?');\n    if (!ok) return;\n    this.http.post('http://localhost:3000/api/profile/migrateBusinessType', {}).subscribe({\n      next: res => {\n        console.log('Profile businessType backfilled', res);\n        alert('Business type backfilled for profiles.');\n        this.loadProfile();\n      },\n      error: err => {\n        console.error('Error backfilling businessType:', err);\n        alert('Error: ' + (err.error?.message || 'Backfill failed'));\n      }\n    });\n  }\n  loadAuditLogs() {\n    if (this.profile?.role !== 'admin') return;\n    this.auditLoading = true;\n    this.http.get('http://localhost:3000/api/audit-logs', {\n      params: {\n        startDate: this.auditFilters.startDate || '',\n        endDate: this.auditFilters.endDate || '',\n        action: this.auditFilters.action || '',\n        user: this.auditFilters.user || '',\n        limit: this.auditFilters.limit || '100',\n        page: String(this.auditPage || 1)\n      }\n    }).subscribe({\n      next: res => {\n        this.auditLogs = Array.isArray(res?.logs) ? res.logs : [];\n        this.auditTotal = Number(res?.total) || 0;\n        this.auditPage = Number(res?.page) || this.auditPage;\n        this.auditLoading = false;\n      },\n      error: err => {\n        console.error('Error loading audit logs:', err);\n        this.auditLogs = [];\n        this.auditLoading = false;\n      }\n    });\n  }\n  changeAuditPage(delta) {\n    const limitNum = Number(this.auditFilters.limit) || 100;\n    const totalPages = Math.max(1, Math.ceil(this.auditTotal / limitNum));\n    const next = Math.min(totalPages, Math.max(1, (this.auditPage || 1) + delta));\n    if (next === this.auditPage) return;\n    this.auditPage = next;\n    this.loadAuditLogs();\n  }\n  exportAuditLogsJson() {\n    const content = JSON.stringify(this.auditLogs || [], null, 2);\n    this.downloadBlob(content, 'audit-logs.json', 'application/json');\n  }\n  exportAuditLogsCsv() {\n    const rows = (this.auditLogs || []).map(log => ({\n      time: log.createdAt || '',\n      action: log.action || '',\n      user: log.actorUsername || log.actorEmail || '',\n      before: JSON.stringify(log.before || {}),\n      after: JSON.stringify(log.after || log.metadata || {})\n    }));\n    const header = ['time', 'action', 'user', 'before', 'after'];\n    const csv = [header.join(',')].concat(rows.map(r => header.map(h => this.escapeCsv(String(r[h] || ''))).join(','))).join('\\n');\n    this.downloadBlob(csv, 'audit-logs.csv', 'text/csv');\n  }\n  escapeCsv(value) {\n    const escaped = value.replace(/\\\"/g, '\"\"');\n    if (/[\\\",\\n]/.test(escaped)) return `\"${escaped}\"`;\n    return escaped;\n  }\n  downloadBlob(content, filename, type) {\n    const blob = new Blob([content], {\n      type\n    });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    link.click();\n    URL.revokeObjectURL(url);\n  }\n  clearProfile() {\n    this.profile = {\n      name: '',\n      address: '',\n      company: '',\n      mobile: '',\n      //email: localStorage.getItem('email')|| '', \n      role: '',\n      photo: '',\n      businessType: ''\n      //username: localStorage.getItem('username')\n    };\n    console.log('Profile cleared locally.');\n  }\n};\nProfileComponent = __decorate([Component({\n  selector: 'app-profile',\n  standalone: true,\n  imports: [CommonModule, FormsModule, HttpClientModule],\n  templateUrl: './profile.component.html',\n  styleUrls: ['./profile.component.css']\n})], ProfileComponent);\nexport { ProfileComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}