{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet BranchComponent = class BranchComponent {\n  constructor(http) {\n    this.http = http;\n    this.branches = [];\n    this.hubs = [];\n    this.showAddBranchPopup = false;\n    this.showEditBranchPopup = false;\n    this.lastHeadingBranchName = '';\n    this.newBranch = {\n      branchName: '',\n      prefix: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      vehicles: [{\n        vehicleNo: '',\n        driverPhone: '',\n        vehicleStatus: 'online',\n        currentLocationId: ''\n      }],\n      status: 'active'\n    };\n    this.editingBranch = null;\n  }\n  ngOnInit() {\n    localStorage.setItem('branch', 'All Branches');\n    this.loadBranches();\n    this.loadHubs();\n  }\n  // Load Branches\n  loadBranches() {\n    this.http.get(`http://localhost:3000/api/branches`).subscribe({\n      next: data => {\n        this.branches = data;\n      },\n      error: err => console.error('Error loading branches:', err)\n    });\n  }\n  loadHubs() {\n    this.http.get(`http://localhost:3000/api/hubs`).subscribe({\n      next: data => {\n        this.hubs = data;\n      },\n      error: err => console.error('Error loading hubs:', err)\n    });\n  }\n  openAddBranchPopup() {\n    this.showAddBranchPopup = true;\n  }\n  closeAddBranchPopup() {\n    this.showAddBranchPopup = false;\n  }\n  closeEditBranchPopup() {\n    this.showEditBranchPopup = false;\n    this.editingBranch = null;\n  }\n  // Add Vehicle in Add Form\n  addVehicle() {\n    this.newBranch.vehicles.push({\n      vehicleNo: '',\n      driverPhone: '',\n      vehicleStatus: 'online',\n      currentLocationId: ''\n    });\n  }\n  // Remove Vehicle in Add Form\n  removeVehicle(index) {\n    this.newBranch.vehicles.splice(index, 1);\n  }\n  // Add Vehicle while Editing\n  addVehicleEdit() {\n    this.editingBranch.vehicles.push({\n      vehicleNo: '',\n      driverPhone: '',\n      vehicleStatus: 'online',\n      currentLocationId: ''\n    });\n  }\n  // Remove Vehicle while Editing\n  removeVehicleEdit(index) {\n    this.editingBranch.vehicles.splice(index, 1);\n  }\n  toggleEditVehicleStatus(vehicle) {\n    if (!this.editingBranch?._id || !vehicle) return;\n    const vehicleNo = String(vehicle?.vehicleNo || '').trim();\n    if (!vehicleNo) return;\n    const current = String(vehicle?.vehicleStatus || 'online').trim().toLowerCase();\n    const nextStatus = current === 'offline' ? 'online' : 'offline';\n    this.http.patch(`http://localhost:3000/api/branches/${this.editingBranch._id}/vehicle-status`, {\n      vehicleNo,\n      vehicleStatus: nextStatus\n    }).subscribe({\n      next: () => {\n        vehicle.vehicleStatus = nextStatus;\n        this.loadBranches();\n      },\n      error: err => {\n        console.error('Error updating vehicle status:', err);\n        alert('Failed to update vehicle status.');\n      }\n    });\n  }\n  // Add Branch\n  addBranch() {\n    if (!this.newBranch.branchName || !this.newBranch.address || !this.newBranch.phoneNum) {\n      alert('Branch Name, Address, and Branch Phone are required.');\n      return;\n    }\n    const hasIncompleteVehicle = Array.isArray(this.newBranch.vehicles) && this.newBranch.vehicles.some(v => (v?.vehicleNo || v?.driverPhone) && !(v?.vehicleNo && v?.driverPhone));\n    if (hasIncompleteVehicle) {\n      alert('Each vehicle must have both Vehicle No. and Driver Phone (or leave the row empty).');\n      return;\n    }\n    const vehicles = Array.isArray(this.newBranch.vehicles) ? this.newBranch.vehicles.filter(v => v?.vehicleNo && v?.driverPhone).map(v => ({\n      ...v,\n      currentLocationId: this.normalizeLocationId(v?.currentLocationId)\n    })) : [];\n    const normalizedNewPrefix = this.normalizePrefix(this.newBranch.prefix);\n    const payload = {\n      branchName: this.newBranch.branchName,\n      ...(normalizedNewPrefix ? {\n        prefix: normalizedNewPrefix\n      } : {}),\n      address: this.newBranch.address,\n      city: this.newBranch.city,\n      state: this.newBranch.state,\n      pinCode: this.newBranch.pinCode,\n      phoneNum: this.newBranch.phoneNum,\n      vehicles\n    };\n    this.http.post('http://localhost:3000/api/branches/add', payload, {\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }).subscribe({\n      next: () => {\n        alert('Branch added successfully!');\n        this.loadBranches();\n        this.resetNewBranch();\n        this.closeAddBranchPopup();\n      },\n      error: err => {\n        console.error('Error saving branch:', err);\n        alert('Error: ' + (err?.error?.message || err?.message || 'Bad Request'));\n      }\n    });\n  }\n  handleHeadingBranchChange() {\n    const current = String(this.newBranch.branchName || '').trim();\n    const previous = String(this.lastHeadingBranchName || '').trim();\n    if (!Array.isArray(this.newBranch.vehicles)) {\n      this.lastHeadingBranchName = current;\n      return;\n    }\n    this.newBranch.vehicles.forEach(v => {\n      const currentLocationId = String(v?.currentLocationId || '').trim();\n      const matchesPrevious = previous && this.normalizeId(currentLocationId) === this.normalizeLocationId(previous);\n      if (!currentLocationId || matchesPrevious) {\n        v.currentLocationId = this.normalizeLocationId(current);\n      }\n    });\n    this.lastHeadingBranchName = current;\n  }\n  getAddBranchOptions() {\n    const options = [];\n    (this.branches || []).forEach(branch => {\n      const id = this.normalizeId(branch?._id);\n      const label = this.getBranchLabel(branch);\n      if (id && label) options.push({\n        id,\n        label\n      });\n    });\n    (this.hubs || []).forEach(hub => {\n      const id = this.normalizeId(hub?._id);\n      const label = String(hub?.hubName || '').trim();\n      if (id && label) options.push({\n        id,\n        label\n      });\n    });\n    return options;\n  }\n  getEditBranchOptions(currentValue) {\n    const options = [];\n    const currentId = this.normalizeLocationId(String(currentValue || '').trim());\n    const currentLabel = this.getCurrentLocationLabel(currentId);\n    if (currentId && currentLabel) {\n      options.push({\n        id: currentId,\n        label: currentLabel\n      });\n    }\n    const editingoriginLocId = this.normalizeId(this.editingBranch?._id);\n    (this.hubs || []).forEach(hub => {\n      if (!editingoriginLocId) return;\n      const huboriginLocId = this.normalizeId(hub?.originLocId);\n      if (!huboriginLocId || huboriginLocId !== editingoriginLocId) return;\n      const id = this.normalizeId(hub?._id);\n      const label = String(hub?.hubName || '').trim();\n      if (id && label && !options.some(o => o.id === id)) {\n        options.push({\n          id,\n          label\n        });\n      }\n    });\n    (this.branches || []).forEach(branch => {\n      const id = this.normalizeId(branch?._id);\n      const label = this.getBranchLabel(branch);\n      if (id && label && !options.some(o => o.id === id)) {\n        options.push({\n          id,\n          label\n        });\n      }\n    });\n    return options;\n  }\n  getCurrentLocationLabel(value) {\n    const raw = String(value || '').trim();\n    if (!raw) return '';\n    const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === raw);\n    const branchLabel = this.getBranchLabel(branch);\n    if (branchLabel) return branchLabel;\n    const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === raw);\n    if (hub?.hubName) return hub.hubName;\n    return raw;\n  }\n  getBranchLabel(branch) {\n    const prefix = String(branch?.prefix || '').trim();\n    if (prefix) return prefix;\n    const branchName = String(branch?.branchName || '').trim();\n    return branchName;\n  }\n  normalizeLocationId(value) {\n    const raw = String(value || '').trim();\n    if (!raw) return '';\n    if (/^[a-f\\d]{24}$/i.test(raw)) return raw;\n    const branch = (this.branches || []).find(b => String(b?.branchName || '').trim().toLowerCase() === raw.toLowerCase());\n    if (branch?._id) return this.normalizeId(branch._id);\n    const hub = (this.hubs || []).find(h => String(h?.hubName || '').trim().toLowerCase() === raw.toLowerCase());\n    if (hub?._id) return this.normalizeId(hub._id);\n    return '';\n  }\n  normalizePrefix(value) {\n    const raw = String(value || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n    if (!raw) return undefined;\n    return raw.slice(0, 3);\n  }\n  normalizeId(value) {\n    if (!value) return '';\n    if (typeof value === 'string') return value;\n    if (value?._id) return String(value._id);\n    if (value?.$oid) return String(value.$oid);\n    return String(value);\n  }\n  // Reset Form\n  resetNewBranch() {\n    this.newBranch = {\n      branchName: '',\n      prefix: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      vehicles: [{\n        vehicleNo: '',\n        driverPhone: '',\n        vehicleStatus: 'online',\n        currentLocationId: ''\n      }],\n      status: 'active'\n    };\n    this.lastHeadingBranchName = '';\n  }\n  // Edit Branch Mode\n  editBranch(branch) {\n    this.editingBranch = JSON.parse(JSON.stringify(branch)); // deep copy to avoid UI distortions\n    if (Array.isArray(this.editingBranch?.vehicles)) {\n      this.editingBranch.vehicles.forEach(vehicle => {\n        if (!vehicle.currentLocationId && vehicle.currentBranch) {\n          vehicle.currentLocationId = this.normalizeLocationId(vehicle.currentBranch);\n        }\n        delete vehicle.currentBranch;\n      });\n    }\n    this.showEditBranchPopup = true;\n  }\n  // Save Edited Branch\n  saveEdit() {\n    const payload = JSON.parse(JSON.stringify(this.editingBranch || {}));\n    const normalizedPrefix = this.normalizePrefix(payload?.prefix);\n    if (normalizedPrefix) {\n      payload.prefix = normalizedPrefix;\n    } else {\n      delete payload.prefix;\n    }\n    if (Array.isArray(payload?.vehicles)) {\n      payload.vehicles.forEach(vehicle => {\n        vehicle.currentLocationId = this.normalizeLocationId(vehicle.currentLocationId);\n        delete vehicle.currentBranch;\n      });\n    }\n    this.http.put(`http://localhost:3000/api/branches/${this.editingBranch._id}`, payload).subscribe({\n      next: () => {\n        alert('Branch updated successfully!');\n        this.closeEditBranchPopup();\n        this.loadBranches();\n      },\n      error: err => {\n        console.error('Error updating branch:', err);\n        alert('Error: ' + (err?.error?.message || err?.message || 'Bad Request'));\n      }\n    });\n  }\n  // Toggle Status Active / Inactive\n  toggleStatus(branch) {\n    this.http.patch(`http://localhost:3000/api/branches/${branch._id}/status`, {}).subscribe(() => {\n      this.loadBranches();\n    });\n  }\n  getBranchAddress(branch) {\n    const parts = [branch?.address, branch?.city, branch?.state, branch?.pinCode].filter(Boolean);\n    if (parts.length) {\n      return parts.join(', ');\n    }\n    const firstAddress = Array.isArray(branch?.addresses) ? branch.addresses[0] : null;\n    const fallback = [firstAddress?.address, firstAddress?.city, firstAddress?.state, firstAddress?.pinCode].filter(Boolean);\n    return fallback.join(', ');\n  }\n};\nBranchComponent = __decorate([Component({\n  selector: 'app-branch',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './branch.component.html',\n  styleUrls: ['./branch.component.css']\n})], BranchComponent);\nexport { BranchComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}