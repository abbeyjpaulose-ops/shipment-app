{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { HttpHeaders } from '@angular/common/http';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/common\";\nimport * as i3 from \"@angular/forms\";\nfunction LogsComponent_p_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 3);\n    i0.ɵɵtext(1, \"Only admins can view audit logs.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction LogsComponent_div_4_div_25_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 15);\n    i0.ɵɵtext(1, \"Loading audit logs...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction LogsComponent_div_4_div_26_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 16);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r1.auditError);\n  }\n}\nfunction LogsComponent_div_4_div_27_tr_24_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"td\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"td\");\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"td\")(9, \"pre\");\n    i0.ɵɵtext(10);\n    i0.ɵɵpipe(11, \"json\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(12, \"td\")(13, \"pre\");\n    i0.ɵɵtext(14);\n    i0.ɵɵpipe(15, \"json\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const log_r4 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind2(3, 5, log_r4.createdAt, \"yyyy-MM-dd HH:mm\"));\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(log_r4.action);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(log_r4.actorUsername || log_r4.actorEmail);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(11, 8, log_r4.before));\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(15, 10, log_r4.after || log_r4.metadata));\n  }\n}\nfunction LogsComponent_div_4_div_27_tr_25_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 21);\n    i0.ɵɵtext(2, \"No audit logs found.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction LogsComponent_div_4_div_27_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 17)(1, \"div\", 18)(2, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_div_27_Template_button_click_2_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r1 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r1.changeAuditPage(-1));\n    });\n    i0.ɵɵtext(3, \"Prev\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"span\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_div_27_Template_button_click_6_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r1 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r1.changeAuditPage(1));\n    });\n    i0.ɵɵtext(7, \"Next\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"span\");\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(10, \"table\")(11, \"thead\")(12, \"tr\")(13, \"th\");\n    i0.ɵɵtext(14, \"Time\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"th\");\n    i0.ɵɵtext(16, \"Action\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(17, \"th\");\n    i0.ɵɵtext(18, \"User\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"th\");\n    i0.ɵɵtext(20, \"Before\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(21, \"th\");\n    i0.ɵɵtext(22, \"After / Meta\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(23, \"tbody\");\n    i0.ɵɵtemplate(24, LogsComponent_div_4_div_27_tr_24_Template, 16, 12, \"tr\", 19)(25, LogsComponent_div_4_div_27_tr_25_Template, 3, 0, \"tr\", 20);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r1.auditPage <= 1);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate2(\"Page \", ctx_r1.auditPage, \" of \", ctx_r1.Math.max(1, ctx_r1.Math.ceil(ctx_r1.auditTotal / (ctx_r1.auditFilters.limit || 100))), \"\");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"disabled\", ctx_r1.auditPage >= ctx_r1.Math.ceil(ctx_r1.auditTotal / (ctx_r1.auditFilters.limit || 100)));\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\"Total: \", ctx_r1.auditTotal, \"\");\n    i0.ɵɵadvance(15);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r1.auditLogs);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r1.auditLogs.length);\n  }\n}\nfunction LogsComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 4)(1, \"div\", 5)(2, \"label\");\n    i0.ɵɵtext(3, \"From \");\n    i0.ɵɵelementStart(4, \"input\", 6);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function LogsComponent_div_4_Template_input_ngModelChange_4_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r1.auditFilters.startDate, $event) || (ctx_r1.auditFilters.startDate = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"label\");\n    i0.ɵɵtext(6, \"To \");\n    i0.ɵɵelementStart(7, \"input\", 6);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function LogsComponent_div_4_Template_input_ngModelChange_7_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r1.auditFilters.endDate, $event) || (ctx_r1.auditFilters.endDate = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(8, \"label\");\n    i0.ɵɵtext(9, \"Action \");\n    i0.ɵɵelementStart(10, \"input\", 7);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function LogsComponent_div_4_Template_input_ngModelChange_10_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r1.auditFilters.action, $event) || (ctx_r1.auditFilters.action = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(11, \"label\");\n    i0.ɵɵtext(12, \"User \");\n    i0.ɵɵelementStart(13, \"input\", 8);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function LogsComponent_div_4_Template_input_ngModelChange_13_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r1.auditFilters.user, $event) || (ctx_r1.auditFilters.user = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(14, \"label\");\n    i0.ɵɵtext(15, \"Limit \");\n    i0.ɵɵelementStart(16, \"input\", 9);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function LogsComponent_div_4_Template_input_ngModelChange_16_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r1.auditFilters.limit, $event) || (ctx_r1.auditFilters.limit = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(17, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      ctx_r1.auditPage = 1;\n      return i0.ɵɵresetView(ctx_r1.loadAuditLogs());\n    });\n    i0.ɵɵtext(18, \"Load Logs\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_Template_button_click_19_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.clearAuditFilters());\n    });\n    i0.ɵɵtext(20, \"Clear Filters\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(21, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_Template_button_click_21_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.exportAuditLogsJson());\n    });\n    i0.ɵɵtext(22, \"Export JSON\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(23, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function LogsComponent_div_4_Template_button_click_23_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.exportAuditLogsCsv());\n    });\n    i0.ɵɵtext(24, \"Export CSV\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(25, LogsComponent_div_4_div_25_Template, 2, 0, \"div\", 12)(26, LogsComponent_div_4_div_26_Template, 2, 1, \"div\", 13)(27, LogsComponent_div_4_div_27_Template, 26, 7, \"div\", 14);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r1.auditFilters.startDate);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r1.auditFilters.endDate);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r1.auditFilters.action);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r1.auditFilters.user);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r1.auditFilters.limit);\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"disabled\", !ctx_r1.auditLogs.length);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", !ctx_r1.auditLogs.length);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.auditLoading);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r1.auditLoading && ctx_r1.auditError);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r1.auditLoading);\n  }\n}\nexport let LogsComponent = /*#__PURE__*/(() => {\n  class LogsComponent {\n    constructor(http) {\n      this.http = http;\n      this.auditLogs = [];\n      this.auditLoading = false;\n      this.auditError = '';\n      this.auditFilters = {\n        startDate: '',\n        endDate: '',\n        action: '',\n        user: '',\n        limit: '100'\n      };\n      this.auditPage = 1;\n      this.auditTotal = 0;\n    }\n    ngOnInit() {\n      if (this.isAdmin()) {\n        this.loadAuditLogs();\n      }\n    }\n    isAdmin() {\n      const role = String(localStorage.getItem('role') || '').toLowerCase();\n      return role === 'admin';\n    }\n    loadAuditLogs() {\n      if (!this.isAdmin()) return;\n      this.auditError = '';\n      this.auditLoading = true;\n      const token = localStorage.getItem('token');\n      if (!token) {\n        this.auditError = 'Missing auth token. Please log in again.';\n        this.auditLoading = false;\n        return;\n      }\n      this.http.get('http://localhost:3000/api/audit-logs', {\n        headers: new HttpHeaders({\n          Authorization: `Bearer ${token}`\n        }),\n        params: {\n          startDate: this.auditFilters.startDate || '',\n          endDate: this.auditFilters.endDate || '',\n          action: this.auditFilters.action || '',\n          user: this.auditFilters.user || '',\n          limit: this.auditFilters.limit || '100',\n          page: String(this.auditPage || 1)\n        }\n      }).subscribe({\n        next: res => {\n          this.auditLogs = Array.isArray(res?.logs) ? res.logs : [];\n          this.auditTotal = Number(res?.total) || 0;\n          this.auditPage = Number(res?.page) || this.auditPage;\n          this.auditLoading = false;\n        },\n        error: err => {\n          console.error('Error loading audit logs:', err);\n          this.auditLogs = [];\n          this.auditError = err?.error?.message || 'Failed to load audit logs.';\n          this.auditLoading = false;\n        }\n      });\n    }\n    clearAuditFilters() {\n      this.auditFilters = {\n        startDate: '',\n        endDate: '',\n        action: '',\n        user: '',\n        limit: '100'\n      };\n      this.auditPage = 1;\n      this.loadAuditLogs();\n    }\n    changeAuditPage(delta) {\n      const limitNum = Number(this.auditFilters.limit) || 100;\n      const totalPages = Math.max(1, Math.ceil(this.auditTotal / limitNum));\n      const next = Math.min(totalPages, Math.max(1, (this.auditPage || 1) + delta));\n      if (next === this.auditPage) return;\n      this.auditPage = next;\n      this.loadAuditLogs();\n    }\n    exportAuditLogsJson() {\n      const content = JSON.stringify(this.auditLogs || [], null, 2);\n      this.downloadBlob(content, 'audit-logs.json', 'application/json');\n    }\n    exportAuditLogsCsv() {\n      const rows = (this.auditLogs || []).map(log => ({\n        time: log.createdAt || '',\n        action: log.action || '',\n        user: log.actorUsername || log.actorEmail || '',\n        before: JSON.stringify(log.before || {}),\n        after: JSON.stringify(log.after || log.metadata || {})\n      }));\n      const header = ['time', 'action', 'user', 'before', 'after'];\n      const csv = [header.join(',')].concat(rows.map(r => header.map(h => this.escapeCsv(String(r[h] || ''))).join(','))).join('\\n');\n      this.downloadBlob(csv, 'audit-logs.csv', 'text/csv');\n    }\n    escapeCsv(value) {\n      const escaped = value.replace(/\\\"/g, '\"\"');\n      if (/[\\\",\\n]/.test(escaped)) return `\"${escaped}\"`;\n      return escaped;\n    }\n    downloadBlob(content, filename, type) {\n      const blob = new Blob([content], {\n        type\n      });\n      const url = URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = filename;\n      link.click();\n      URL.revokeObjectURL(url);\n    }\n    static {\n      this.ɵfac = function LogsComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || LogsComponent)(i0.ɵɵdirectiveInject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: LogsComponent,\n        selectors: [[\"app-logs\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 5,\n        vars: 2,\n        consts: [[1, \"logs-page\"], [\"class\", \"subtitle\", 4, \"ngIf\"], [\"class\", \"audit-section\", 4, \"ngIf\"], [1, \"subtitle\"], [1, \"audit-section\"], [1, \"audit-filters\"], [\"type\", \"date\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"text\", \"placeholder\", \"auth.login or businessType\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"text\", \"placeholder\", \"username or email\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"number\", \"min\", \"1\", \"max\", \"500\", 3, \"ngModelChange\", \"ngModel\"], [\"type\", \"button\", 3, \"click\"], [\"type\", \"button\", 3, \"click\", \"disabled\"], [\"class\", \"audit-status\", 4, \"ngIf\"], [\"class\", \"audit-status error\", 4, \"ngIf\"], [\"class\", \"audit-table\", 4, \"ngIf\"], [1, \"audit-status\"], [1, \"audit-status\", \"error\"], [1, \"audit-table\"], [1, \"audit-pagination\"], [4, \"ngFor\", \"ngForOf\"], [4, \"ngIf\"], [\"colspan\", \"5\", 1, \"empty\"]],\n        template: function LogsComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ɵɵtext(2, \"Audit Logs\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(3, LogsComponent_p_3_Template, 2, 0, \"p\", 1)(4, LogsComponent_div_4_Template, 28, 10, \"div\", 2);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngIf\", !ctx.isAdmin());\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.isAdmin());\n          }\n        },\n        dependencies: [CommonModule, i2.NgForOf, i2.NgIf, i2.JsonPipe, i2.DatePipe, FormsModule, i3.DefaultValueAccessor, i3.NumberValueAccessor, i3.NgControlStatus, i3.MinValidator, i3.MaxValidator, i3.NgModel],\n        styles: [\".logs-page[_ngcontent-%COMP%]{padding:20px;color:#0f172a}.subtitle[_ngcontent-%COMP%]{margin:6px 0 0;color:#64748b;font-size:13px}.audit-section[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-top:12px}.audit-filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px 14px;align-items:flex-end;margin-bottom:12px}.audit-filters[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px;font-weight:600;font-size:13px}.audit-filters[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{padding:6px 8px;border-radius:6px;border:1px solid #cbd5f5;min-width:160px}.audit-filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 14px;border-radius:8px;border:1px solid #2c3e50;background:#2c3e50;color:#fff;cursor:pointer}.audit-filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#1b2836}.audit-filters[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.audit-pagination[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-bottom:10px;font-size:13px}.audit-pagination[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 10px;border-radius:6px;border:1px solid #2c3e50;background:#fff;cursor:pointer}.audit-pagination[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.audit-status[_ngcontent-%COMP%]{padding:10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}.audit-status.error[_ngcontent-%COMP%]{background:#fef2f2;border-color:#fecaca;color:#991b1b}.audit-table[_ngcontent-%COMP%]{overflow:auto}.audit-table[_ngcontent-%COMP%]   table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.audit-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border-bottom:1px solid #e2e8f0;padding:8px 10px;text-align:left;vertical-align:top}.audit-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc}.audit-table[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{margin:0;white-space:pre-wrap;font-size:12px}\"]\n      });\n    }\n  }\n  return LogsComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}