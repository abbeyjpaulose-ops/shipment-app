{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet NewShipmentComponent = class NewShipmentComponent {\n  // ======================================================\n  // E-WAYBILL FUNCTIONS\n  // ======================================================\n  addEwaybill() {\n    this.ewaybills.push({\n      number: '',\n      date: this.date,\n      invoices: []\n    });\n  }\n  deleteEwaybill(index) {\n    this.ewaybills.splice(index, 1);\n  }\n  // ======================================================\n  // INVOICE FUNCTIONS (NOW UNDER E-WAYBILL)\n  // ======================================================\n  addInvoice(ewaybillIndex) {\n    this.ewaybills[ewaybillIndex].invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices.splice(invoiceIndex, 1);\n  }\n  // ======================================================\n  // PACKAGE FUNCTIONS\n  // ======================================================\n  addPackage(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.push({\n      type: '',\n      amount: 0\n    });\n  }\n  deletePackage(ewaybillIndex, invoiceIndex, packageIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.splice(packageIndex, 1);\n  }\n  // ======================================================\n  // PRODUCT FUNCTIONS\n  // ======================================================\n  addProduct(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.push({\n      type: '',\n      amount: 1,\n      instock: 1,\n      intransitstock: 0,\n      deliveredstock: 0\n    });\n  }\n  deleteProduct(ewaybillIndex, invoiceIndex, productIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.splice(productIndex, 1);\n  }\n  // ======================================================\n  // FINAL AMOUNT CALCULATION\n  // ======================================================\n  calculateFinalAmount() {\n    let invoiceTotal = 0;\n    let packageTotal = 0;\n    this.ewaybills.forEach(ewb => {\n      invoiceTotal += ewb.invoices.reduce((sum, inv) => sum + (inv.value || 0), 0);\n      packageTotal += ewb.invoices.reduce((sum, inv) => sum + inv.packages.reduce((pSum, p) => pSum + (p.amount || 0), 0), 0);\n    });\n    const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n    this.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n  }\n  resetForm() {\n    // Reset all form fields to their initial defaults and fetch a fresh consignment number\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.branch = this.branchService.currentBranch;\n    this.consignmentNumber = '-999';\n    this.date = new Date().toISOString().split('T')[0];\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'To Pay';\n    this.externalRefId = '';\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n    this.getCurrentConsignmentNumber();\n  }\n  // ======================================================\n  // CONSIGNMENT NUMBER LOGIC\n  // ======================================================\n  getFiscalYear() {\n    const today = new Date();\n    return today.getMonth() >= 3 ? today.getFullYear() : today.getFullYear() - 1;\n  }\n  getCurrentConsignmentNumber() {\n    if (!this.branch || this.branch === 'All Branches') {\n      this.consignmentNumber = '-999';\n      return;\n    }\n    this.http.get(`http://localhost:3000/api/newshipments/nextConsignment?emailId=${this.email}&branch=${encodeURIComponent(this.branch)}`).subscribe({\n      next: res => {\n        this.consignmentNumber = res.nextNumber.toString();\n        localStorage.setItem('consignmentNumber', this.consignmentNumber);\n      },\n      error: err => {\n        console.error('Error fetching consignment number', err);\n        this.consignmentNumber = '-999';\n      }\n    });\n  }\n  // ======================================================\n  // SAVE SHIPMENT (NOW SAVES E-WAYBILLS)\n  // ======================================================\n  saveShipment() {\n    if (!this.ensureProductAmounts()) {\n      return;\n    }\n    const shipmentData = {\n      email: localStorage.getItem('email'),\n      username: localStorage.getItem('username'),\n      branch: localStorage.getItem('branch'),\n      shipmentStatus: this.shipmentStatus,\n      shipmentStatusDetails: `${localStorage.getItem('email')}$$${this.date}$$${this.shipmentStatus}`,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date,\n      paymentMode: this.paymentMode,\n      externalRefId: this.externalRefId,\n      consignorTab: this.consignorTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consigneeTab: this.consigneeTab,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingGSTIN: this.billingGSTIN,\n      billingAddress: this.billingAddress,\n      billingPhone: this.billingPhone,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      deliveryType: this.deliveryType,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      ewaybills: this.ewaybills,\n      // â˜… NEW STRUCTURE\n      charges: this.charges,\n      finalAmount: this.finalAmount\n    };\n    if (this.consignorTab === 'guest') shipmentData.consignorGST = 'GUEST';\n    if (this.consigneeTab === 'guest') shipmentData.consigneeGST = 'GUEST';\n    if (this.billingType === 'consignor') {\n      shipmentData.billingName = this.consignor;\n      shipmentData.billingAddress = this.consignorAddress;\n      shipmentData.billingGSTIN = this.consignorGST;\n      shipmentData.billingPhone = this.consignorPhone;\n    }\n    if (this.pickupType === 'consignor') {\n      shipmentData.pickupName = this.consignor;\n      shipmentData.pickupAddress = this.consignorAddress;\n      shipmentData.pickupPhone = this.consignorPhone;\n    }\n    if (this.deliveryType === 'consignee') {\n      shipmentData.deliveryName = this.consignee;\n      shipmentData.deliveryAddress = this.consigneeAddress;\n      shipmentData.deliveryPhone = this.consigneePhone;\n    }\n    if (shipmentData.branch !== 'All Branches') {\n      this.http.post('http://localhost:3000/api/newshipments/add', shipmentData, {\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }).subscribe({\n        next: () => {\n          alert(`Shipment ${this.consignmentNumber} saved successfully!`);\n          this.getCurrentConsignmentNumber();\n          this.resetForm();\n          window.location.reload();\n        },\n        error: err => alert('Error: ' + err.message)\n      });\n    } else {\n      alert('Please select a branch before saving.');\n    }\n  }\n  // Ensure every product has a positive quantity and sync instock with the entered amount\n  ensureProductAmounts() {\n    for (const ewb of this.ewaybills) {\n      for (const inv of ewb.invoices || []) {\n        for (const prod of inv.products || []) {\n          if (!prod.amount || prod.amount <= 0) {\n            alert('Please enter a quantity greater than 0 for all products.');\n            return false;\n          }\n          // Keep instock aligned with the entered amount if user did not manually change it\n          if (!prod.instock || prod.instock <= 0) {\n            prod.instock = prod.amount;\n          }\n        }\n      }\n    }\n    return true;\n  }\n  // ======================================================\n  // SELECT HANDLERS\n  // ======================================================\n  onConsignorSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consignorGST = c.GSTIN;\n      this.consignorAddress = c.address;\n      this.consignorPhone = c.phoneNum;\n      this.charges.consignorDiscount = c.perDis;\n    }\n  }\n  onConsigneeSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consigneeGST = c.GSTIN;\n      this.consigneeAddress = c.address;\n      this.consigneePhone = c.phoneNum;\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consignorGST = 'GUEST';\n      this.consignorAddress = g.address;\n      this.consignorPhone = g.phoneNum;\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consigneeGST = 'GUEST';\n      this.consigneeAddress = g.address;\n      this.consigneePhone = g.phoneNum;\n    }\n  }\n  onPackageList(name) {\n    this.pkgList.find(x => x.pkgName === name);\n  }\n  onProductList(name) {\n    this.productList.find(x => x.productName === name);\n  }\n  ngOnInit() {\n    if (typeof window !== 'undefined') {\n      this.email = localStorage.getItem('email') || '';\n      this.username = localStorage.getItem('username') || '';\n      this.branch = this.branchService.currentBranch;\n      this.branchSub = this.branchService.branch$.subscribe(branch => {\n        this.branch = branch;\n        this.getCurrentConsignmentNumber();\n      });\n      this.getCurrentConsignmentNumber();\n      // Client list\n      this.http.get(`http://localhost:3000/api/clients/clientslist?emailId=${this.email}`).subscribe(res => this.clientList = res);\n      // Guest list\n      this.http.get(`http://localhost:3000/api/guests/guestslist?emailId=${this.email}`).subscribe(res => this.guestList = res);\n      // Package list\n      this.http.get(`http://localhost:3000/api/pkgs/pkglist?emailId=${this.email}`).subscribe(res => this.pkgList = res);\n      // Product list\n      this.http.get(`http://localhost:3000/api/products/productlist?emailId=${this.email}`).subscribe(res => this.productList = res);\n    }\n  }\n  constructor(http, branchService) {\n    this.http = http;\n    this.branchService = branchService;\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    // Delivery\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.email = '';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.consignmentNumber = '-999';\n    this.date = new Date().toISOString().split('T')[0];\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'To Pay';\n    this.externalRefId = '';\n    // ===============================\n    // NEW STRUCTURE FOR MULTIPLE E-WAYBILLS\n    // ===============================\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n  }\n  ngOnDestroy() {\n    this.branchSub?.unsubscribe();\n  }\n};\nNewShipmentComponent = __decorate([Component({\n  selector: 'app-new-shipment',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './new-shipment.component.html',\n  styleUrls: ['./new-shipment.component.css']\n})], NewShipmentComponent);\nexport { NewShipmentComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}