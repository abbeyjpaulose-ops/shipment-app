{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet StocksComponent = class StocksComponent {\n  constructor(http) {\n    this.http = http;\n    this.stocks = [];\n    this.filteredStocks = [];\n    this.searchText = '';\n    this.filterDate = '';\n    this.filterConsignor = '';\n    this.selectedStock = null;\n    this.editingStock = null; // ‚úÖ track which stock is being edited\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'consignor';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    // Delivery\n    this.deliveryType = 'consignee';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.email = '';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.consignmentNumber = localStorage.getItem('consignmentNumber') || '-999'; // will be loaded asynchronously\n    this.date = new Date().toISOString().split('T')[0];\n    this.ewaybillNumber = '';\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'Account Credit';\n    this.externalRefId = '';\n    this.invoices = [{\n      number: '',\n      value: 0\n    }];\n    this.packages = [{\n      type: '',\n      amount: 1\n    }];\n    this.products = [{\n      type: '',\n      amount: 1\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0\n    };\n    this.finalAmount = 0;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n    this.branches = [];\n    this.hubs = [];\n    this.availableRoutePoints = [];\n    this.shipmentRoute = [];\n    this.selectedRoutePoint = null;\n    this.showManifestationPopup = false;\n    this.selectedForManifestation = [];\n    this.manifestationNumber = '';\n  }\n  // --- Methods ---\n  addInvoice() {\n    this.editingStock.invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(index) {\n    this.editingStock.invoices.splice(index, 1);\n  }\n  addPackage(invoiceIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (!invoice.packages) {\n      invoice.packages = [];\n    }\n    invoice.packages.push({\n      type: '',\n      amount: 1\n    });\n  }\n  deletePackage(invoiceIndex, packageIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (invoice.packages && invoice.packages.length > packageIndex) {\n      invoice.packages.splice(packageIndex, 1);\n    }\n  }\n  addProduct(invoiceIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (!invoice.products) {\n      invoice.products = [];\n    }\n    invoice.products.push({\n      type: '',\n      amount: 1,\n      instock: 0,\n      intransitstock: 0,\n      deliveredstock: 0\n    });\n  }\n  deleteProduct(invoiceIndex, productIndex) {\n    const invoice = this.editingStock.invoices[invoiceIndex];\n    if (invoice.products && invoice.products.length > productIndex) {\n      invoice.products.splice(productIndex, 1);\n    }\n  }\n  calculateFinalAmount() {\n    const invoiceTotal = this.editingStock.invoices.reduce((sum, i) => sum + (i.value || 0), 0);\n    const packageTotal = this.editingStock.packages.reduce((sum, p) => sum + (p.amount || 0), 0);\n    const chargeTotal = Object.values(this.charges).reduce((sum, c) => sum + (Number(c) || 0), 0);\n    this.editingStock.finalAmount = invoiceTotal + packageTotal + chargeTotal;\n  }\n  loadStocks() {\n    this.http.get('http://localhost:3000/api/newshipments', {\n      params: {\n        email: localStorage.getItem('email') || '',\n        branch: localStorage.getItem('branch') || ''\n      }\n    }).subscribe({\n      next: res => {\n        this.stocks = res.filter(stock => stock.shipmentStatus === 'Pending' || stock.shipmentStatus === 'In Transit/Pending').sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n        this.filteredStocks = [...this.stocks];\n      },\n      error: err => console.error('‚ùå Error loading shipments:', err)\n    });\n  }\n  getInvoiceAmountTotal(invoices = []) {\n    console.log(\"999999999999999999Invoices for amount total:\", invoices);\n    return invoices.reduce((total, invoice) => {\n      const productSum = (invoice.products || []).reduce((sum, prod) => sum + (Number(prod.amount) || 0), 0);\n      return total + productSum;\n    }, 0);\n  }\n  getInStockAmountTotal(invoices = []) {\n    return invoices.reduce((total, invoice) => {\n      const productSum = (invoice.products || []).reduce((sum, prod) => sum + (Number(prod.instock) || 0), 0);\n      return total + productSum;\n    }, 0);\n  }\n  applyFilters() {\n    this.filteredStocks = this.stocks.filter(s => (this.searchText ? s.consignmentNumber?.includes(this.searchText) || s.consignor?.includes(this.searchText) : true) && (this.filterDate ? new Date(s.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? s.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase()) : true));\n  }\n  toggleAllSelection(event) {\n    const checked = event.target.checked;\n    this.filteredStocks.forEach(s => s.selected = checked);\n  }\n  openStockDetails(stock) {\n    this.selectedStock = stock;\n  }\n  closeStockDetails() {\n    this.selectedStock = null;\n  }\n  editStock(stock) {\n    console.log('‚úèÔ∏è Edit stock:', stock);\n    this.editingStock = {\n      ...stock\n    }; // ‚úÖ copy so we don‚Äôt mutate directly\n  }\n  saveStockEdit() {\n    if (!this.editingStock) return;\n    console.log(\"kkkkkkkkkkklllllllllllllllll\" + this.editingStock.consignmentNumber);\n    this.http.put(`http://localhost:3000/api/newshipments/${this.editingStock.consignmentNumber}`, this.editingStock).subscribe({\n      next: () => {\n        console.log('‚úÖ Stock updated');\n        this.loadStocks(); // reload updated data\n        this.editingStock = null; // close modal\n      },\n      error: err => console.error('‚ùå Error updating stock:', err)\n    });\n  }\n  cancelEdit() {\n    this.editingStock = null;\n  }\n  onConsignorSelect(name) {\n    const selectedconignor = this.clientList.find(c => c.clientName === name);\n    if (selectedconignor) {\n      this.editingStock.consignorGST = selectedconignor.GSTIN;\n      this.editingStock.consignorAddress = selectedconignor.address;\n      this.editingStock.consignorPhone = selectedconignor.phoneNum;\n    }\n  }\n  onConsigneeSelect(name) {\n    const selectedconignee = this.clientList.find(c => c.clientName === name);\n    if (selectedconignee) {\n      this.editingStock.consigneeGST = selectedconignee.GSTIN;\n      this.editingStock.consigneeAddress = selectedconignee.address;\n      this.editingStock.consigneePhone = selectedconignee.phoneNum;\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const selectedguestconignor = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignor) {\n      this.editingStock.consignorGST = 'GUEST';\n      this.editingStock.consignorAddress = selectedguestconignor.address;\n      this.editingStock.consignorPhone = selectedguestconignor.phoneNum;\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const selectedguestconignee = this.guestList.find(c => c.guestName === name);\n    if (selectedguestconignee) {\n      this.editingStock.consigneeGST = 'GUEST';\n      this.editingStock.editingStock.consigneeAddress = selectedguestconignee.address;\n      this.editingStock.editingStock.consigneePhone = selectedguestconignee.phoneNum;\n    }\n  }\n  onPackageList(name) {\n    const selectedpackage = this.pkgList.find(c => c.pkgName === name);\n  }\n  onProductList(name) {\n    const selectedproduct = this.productList.find(c => c.productName === name);\n  }\n  addRoutePoint() {\n    if (!this.selectedRoutePoint) return;\n    this.shipmentRoute.push({\n      ...this.selectedRoutePoint\n    });\n    this.selectedRoutePoint = null;\n  }\n  removeRoutePoint(index) {\n    this.shipmentRoute.splice(index, 1);\n  }\n  loadBranches() {\n    const email = localStorage.getItem('email');\n    this.http.get(`http://localhost:3000/api/branches?email=${email}`).subscribe({\n      next: data => {\n        console.log(\"Branches loaded:\", data);\n        this.branches = data;\n        this.updateAvailableRoutePoints(); // ‚¨ÖÔ∏è Refresh route options\n      },\n      error: err => console.error(\"Error loading branches:\", err)\n    });\n  }\n  loadHubs() {\n    const email = localStorage.getItem('email');\n    this.http.get(`http://localhost:3000/api/hubs?email=${email}`).subscribe({\n      next: data => {\n        console.log(\"Hubs loaded:\", data);\n        this.hubs = data;\n        this.updateAvailableRoutePoints(); // ‚¨ÖÔ∏è Refresh route options\n      },\n      error: err => console.error(\"Error loading hubs:\", err)\n    });\n  }\n  updateAvailableRoutePoints() {\n    this.availableRoutePoints = [...this.branches.map(b => ({\n      name: b.branchName,\n      type: \"Branch\",\n      email: b.email\n    })), ...this.hubs.map(h => ({\n      name: h.hubName,\n      type: \"Hub\",\n      email: h.email\n    }))];\n  }\n  ngOnInit() {\n    this.loadStocks();\n    this.email = localStorage.getItem('email') || '';\n    this.username = localStorage.getItem('username') || '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    // Clients list\n    this.http.get(`http://localhost:3000/api/clients/clientslist?emailId=${this.email}`).subscribe({\n      next: data => this.clientList = data,\n      error: err => console.error('Error fetching client list', err),\n      complete: () => console.log('Client list fetch complete')\n    });\n    // Guests list\n    this.http.get(`http://localhost:3000/api/guests/guestslist?emailId=${this.email}`).subscribe({\n      next: data => this.guestList = data,\n      error: err => console.error('Error fetching guest list', err),\n      complete: () => console.log('Guest list fetch complete')\n    });\n    // Packages list\n    this.http.get(`http://localhost:3000/api/pkgs/pkglist?emailId=${this.email}`).subscribe({\n      next: data => this.pkgList = data,\n      error: err => console.error('Error fetching package list', err),\n      complete: () => console.log('Package list fetch complete')\n    });\n    // Products list\n    this.http.get(`http://localhost:3000/api/products/productlist?emailId=${this.email}`).subscribe({\n      next: data => this.productList = data,\n      error: err => console.error('Error fetching product list', err),\n      complete: () => console.log('Product list fetch complete')\n    });\n    this.loadBranches();\n    this.loadHubs();\n  }\n  getEwaybillNumberFromDB(consignmentNumber) {\n    const record = this.stocks.find(shipment => shipment.consignmentNumber === consignmentNumber);\n    return record?.ewaybillNumber || '';\n  }\n  openManifestationPopup() {\n    // Filter selected consignments\n    this.selectedForManifestation = this.filteredStocks.filter(s => s.selected);\n    // Guard clause: ensure at least one consignment is selected\n    if (this.selectedForManifestation.length === 0) {\n      alert('‚ö†Ô∏è Please select at least one consignment to manifest.');\n      return;\n    }\n    // Generate unique manifestation number\n    const now = new Date();\n    this.manifestationNumber = 'MF-' + now.getFullYear().toString().slice(2) + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + '-' + Math.floor(Math.random() * 10000);\n    // Initialize manifestQty and eway bill fields\n    this.selectedForManifestation = this.selectedForManifestation.map(consignment => {\n      // Set eway bill fields\n      const updatedConsignment = {\n        ...consignment,\n        ewayBillRequired: false,\n        ewaybillNumber: this.getEwaybillNumberFromDB(consignment.consignmentNumber)\n      };\n      // Set manifestQty = instock for each product\n      updatedConsignment.invoices?.forEach(invoice => {\n        invoice.products?.forEach(product => {\n          product.manifestQty = product.instock;\n        });\n      });\n      return updatedConsignment;\n    });\n    // Show the popup\n    this.showManifestationPopup = true;\n  }\n  closeManifestationPopup() {\n    this.showManifestationPopup = false;\n  }\n  finalizeManifestation() {\n    if (this.selectedForManifestation.length === 0) {\n      alert('No consignments selected.');\n      return;\n    }\n    // Convert route points to a travel pattern string\n    const routeString = this.shipmentRoute.map(p => `${p.name} (${p.type})`).join(' -> ');\n    console.log('üõ§Ô∏è TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTravel Pattern:', routeString);\n    const manifestationData = {\n      email: this.email,\n      username: this.username,\n      branch: this.branch,\n      manifestationNumber: this.manifestationNumber,\n      date: new Date(),\n      consignments: this.selectedForManifestation.map(c => ({\n        consignmentNumber: c.consignmentNumber,\n        consignor: c.consignor,\n        routes: routeString,\n        invoices: c.invoices.map(inv => ({\n          number: inv.number,\n          value: inv.value,\n          products: inv.products.map(p => ({\n            type: p.type,\n            instock: p.instock,\n            amount: p.amount,\n            manifestQty: p.manifestQty\n          }))\n        }))\n      }))\n    };\n    console.log('üì¶ Sending manifestation to backend:', manifestationData);\n    // ‚úÖ 1Ô∏è‚É£ POST manifestation details to backend DB\n    this.http.post('http://localhost:3000/api/manifest/add', manifestationData).subscribe({\n      next: res => {\n        console.log('‚úÖ Manifestation saved successfully:', res);\n        console.log('testttttt', manifestationData);\n        window.location.reload();\n      },\n      error: err => {\n        console.error('‚ùå Error saving manifestation:', err);\n        alert('Failed to save manifestation. Check server logs.');\n      }\n    });\n  }\n  validateManifestQty(product) {\n    if (product.manifestQty > product.instock) {\n      alert(`‚ö†Ô∏è Manifest quantity cannot exceed available stock (${product.instock}).`);\n      product.manifestQty = product.instock;\n    }\n    if (product.manifestQty < 0) {\n      alert('‚ö†Ô∏è Manifest quantity cannot be negative.');\n      product.manifestQty = 0;\n    }\n  }\n  printReceipts() {\n    const selected = this.filteredStocks?.filter(s => s.selected) || [];\n    if (selected.length === 0) {\n      alert('No consignments selected.');\n      return;\n    }\n    fetch('assets/receipt-template.html').then(res => res.text()).then(template => {\n      let fullHtml = `\n        <html>\n          <head>\n            <style>\n              body { font-family: Arial, sans-serif; padding: 20px; }\n              h2 { margin-bottom: 0; }\n              table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .page-break { page-break-after: always; }\n            </style>\n          </head>\n          <body>\n      `;\n      selected.forEach((consignment, index) => {\n        const rows = consignment.invoices.flatMap(inv => inv.products.map(p => `\n            <tr>\n              <td>${inv.number}</td>\n              <td>${p.type}</td>\n              <td>${p.instock}</td>\n              <td>${p.manifestQty}</td>\n              <td>${p.amount}</td>\n            </tr>\n          `)).join('');\n        const htmlContent = template.replace('{{consignmentNumber}}', consignment.consignmentNumber).replace('{{consignor}}', consignment.consignor).replace('{{rows}}', rows);\n        fullHtml += htmlContent;\n        // Add page break after each consignment except the last one\n        if (index < selected.length - 1) {\n          fullHtml += `<div class=\"page-break\"></div>`;\n        }\n      });\n      fullHtml += `</body></html>`;\n      const printWindow = window.open('', '_blank');\n      if (printWindow) {\n        printWindow.document.open();\n        printWindow.document.write(fullHtml); // use write instead of body.innerHTML\n        printWindow.document.close();\n        printWindow.print();\n      }\n    });\n  }\n};\nStocksComponent = __decorate([Component({\n  selector: 'app-stocks',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './stocks.component.html',\n  styleUrls: ['./stocks.component.css']\n})], StocksComponent);\nexport { StocksComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}