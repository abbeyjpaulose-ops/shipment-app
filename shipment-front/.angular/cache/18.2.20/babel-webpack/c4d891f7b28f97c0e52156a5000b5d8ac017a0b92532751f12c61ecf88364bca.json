{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"../../../services/branch.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction InvoiceComponent_tr_32_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\")(2, \"input\", 14);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_tr_32_Template_input_ngModelChange_2_listener($event) {\n      const inv_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      i0.ɵɵtwoWayBindingSet(inv_r2.selected, $event) || (inv_r2.selected = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(3, \"td\", 6);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_tr_32_Template_td_click_3_listener() {\n      const inv_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.openInvoiceDetails(inv_r2));\n    });\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"td\");\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"td\");\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"td\");\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"td\");\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"td\")(14, \"button\", 15);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_tr_32_Template_button_click_14_listener() {\n      const inv_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.editInvoice(inv_r2));\n    });\n    i0.ɵɵtext(15, \"\\u270F\\uFE0F Edit\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const inv_r2 = ctx.$implicit;\n    i0.ɵɵclassProp(\"selected\", inv_r2.selected);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtwoWayProperty(\"ngModel\", inv_r2.selected);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(inv_r2.consignmentNumber);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(inv_r2.shipmentStatus);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(inv_r2.consignor);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(inv_r2.deliveryAddress);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate((inv_r2.products == null ? null : inv_r2.products.length) || 0);\n  }\n}\nfunction InvoiceComponent_div_33_li_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"li\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const p_r5 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" \", p_r5.productName, \" \\u2014 Qty: \", p_r5.quantity, \" \");\n  }\n}\nfunction InvoiceComponent_div_33_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 16)(1, \"div\", 17)(2, \"h3\");\n    i0.ɵɵtext(3, \"Consignment Details\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"p\")(5, \"strong\");\n    i0.ɵɵtext(6, \"Consignment Number:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"p\")(9, \"strong\");\n    i0.ɵɵtext(10, \"Consignor:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"p\")(13, \"strong\");\n    i0.ɵɵtext(14, \"Delivery Address:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(15);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"p\")(17, \"strong\");\n    i0.ɵɵtext(18, \"Status:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(19);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(20, \"h4\");\n    i0.ɵɵtext(21, \"Products:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(22, \"ul\");\n    i0.ɵɵtemplate(23, InvoiceComponent_div_33_li_23_Template, 2, 2, \"li\", 18);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(24, \"button\", 6);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_div_33_Template_button_click_24_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeInvoiceDetails());\n    });\n    i0.ɵɵtext(25, \"Close\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedInvoice == null ? null : ctx_r2.selectedInvoice.consignmentNumber, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedInvoice == null ? null : ctx_r2.selectedInvoice.consignor, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedInvoice == null ? null : ctx_r2.selectedInvoice.deliveryAddress, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.selectedInvoice == null ? null : ctx_r2.selectedInvoice.shipmentStatus, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.selectedInvoice == null ? null : ctx_r2.selectedInvoice.products);\n  }\n}\nfunction InvoiceComponent_div_34_div_23_div_3_tr_13_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\")(4, \"input\", 38);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_div_34_div_23_div_3_tr_13_Template_input_ngModelChange_4_listener($event) {\n      const product_r8 = i0.ɵɵrestoreView(_r7).$implicit;\n      i0.ɵɵtwoWayBindingSet(product_r8.amount, $event) || (product_r8.amount = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"ngModelChange\", function InvoiceComponent_div_34_div_23_div_3_tr_13_Template_input_ngModelChange_4_listener($event) {\n      const product_r8 = i0.ɵɵrestoreView(_r7).$implicit;\n      const inv_r9 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.onTotalQtyChange(inv_r9, product_r8, $event));\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"td\")(6, \"input\", 39);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_div_34_div_23_div_3_tr_13_Template_input_ngModelChange_6_listener($event) {\n      const product_r8 = i0.ɵɵrestoreView(_r7).$implicit;\n      i0.ɵɵtwoWayBindingSet(product_r8.deliveredstock, $event) || (product_r8.deliveredstock = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"focus\", function InvoiceComponent_div_34_div_23_div_3_tr_13_Template_input_focus_6_listener() {\n      const product_r8 = i0.ɵɵrestoreView(_r7).$implicit;\n      const inv_r9 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.onDeliveredQtyFocus(inv_r9, product_r8));\n    })(\"ngModelChange\", function InvoiceComponent_div_34_div_23_div_3_tr_13_Template_input_ngModelChange_6_listener($event) {\n      const product_r8 = i0.ɵɵrestoreView(_r7).$implicit;\n      const inv_r9 = i0.ɵɵnextContext().$implicit;\n      const ctx_r2 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r2.onDeliveredQtyChange(inv_r9, product_r8, $event));\n    });\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const product_r8 = ctx.$implicit;\n    const p_r10 = ctx.index;\n    const i_r11 = i0.ɵɵnextContext().index;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(product_r8.type || product_r8.productName);\n    i0.ɵɵadvance(2);\n    i0.ɵɵpropertyInterpolate2(\"name\", \"total-\", i_r11, \"-\", p_r10, \"\");\n    i0.ɵɵproperty(\"min\", product_r8.deliveredstock || 0);\n    i0.ɵɵtwoWayProperty(\"ngModel\", product_r8.amount);\n    i0.ɵɵadvance(2);\n    i0.ɵɵpropertyInterpolate2(\"name\", \"delivered-\", i_r11, \"-\", p_r10, \"\");\n    i0.ɵɵproperty(\"max\", product_r8.amount);\n    i0.ɵɵtwoWayProperty(\"ngModel\", product_r8.deliveredstock);\n  }\n}\nfunction InvoiceComponent_div_34_div_23_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 35)(1, \"div\", 36);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"table\", 37)(4, \"thead\")(5, \"tr\")(6, \"th\");\n    i0.ɵɵtext(7, \"Product\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"th\");\n    i0.ɵɵtext(9, \"Total Qty\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"th\");\n    i0.ɵɵtext(11, \"Delivered Qty\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(12, \"tbody\");\n    i0.ɵɵtemplate(13, InvoiceComponent_div_34_div_23_div_3_tr_13_Template, 7, 11, \"tr\", 18);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const inv_r9 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Invoice #\", inv_r9.number, \"\");\n    i0.ɵɵadvance(11);\n    i0.ɵɵproperty(\"ngForOf\", inv_r9.products);\n  }\n}\nfunction InvoiceComponent_div_34_div_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 21)(1, \"h3\");\n    i0.ɵɵtext(2, \"Invoices & Products\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, InvoiceComponent_div_34_div_23_div_3_Template, 14, 2, \"div\", 34);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.editingInvoice.invoices);\n  }\n}\nfunction InvoiceComponent_div_34_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 19)(1, \"div\", 20)(2, \"h2\");\n    i0.ɵɵtext(3, \"Edit Details\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"form\")(5, \"div\", 21)(6, \"label\", 22);\n    i0.ɵɵtext(7, \"Consignor:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"input\", 23);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_div_34_Template_input_ngModelChange_8_listener($event) {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.editingInvoice.consignor, $event) || (ctx_r2.editingInvoice.consignor = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(9, \"div\", 21)(10, \"label\", 24);\n    i0.ɵɵtext(11, \"Delivery Address:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"textarea\", 25);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_div_34_Template_textarea_ngModelChange_12_listener($event) {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.editingInvoice.deliveryAddress, $event) || (ctx_r2.editingInvoice.deliveryAddress = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(13, \"div\", 21)(14, \"label\", 26);\n    i0.ɵɵtext(15, \"Status:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"select\", 27);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_div_34_Template_select_ngModelChange_16_listener($event) {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.editingInvoice.shipmentStatus, $event) || (ctx_r2.editingInvoice.shipmentStatus = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementStart(17, \"option\", 28);\n    i0.ɵɵtext(18, \"Pending\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"option\", 29);\n    i0.ɵɵtext(20, \"Delivered\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(21, \"option\", 30);\n    i0.ɵɵtext(22, \"Invoiced\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵtemplate(23, InvoiceComponent_div_34_div_23_Template, 4, 1, \"div\", 31);\n    i0.ɵɵelementStart(24, \"div\", 32)(25, \"button\", 33);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_div_34_Template_button_click_25_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.saveInvoiceEdit());\n    });\n    i0.ɵɵtext(26, \"Save\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(27, \"button\", 33);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_div_34_Template_button_click_27_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.cancelEdit());\n    });\n    i0.ɵɵtext(28, \"Cancel\");\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(8);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.editingInvoice.consignor);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.editingInvoice.deliveryAddress);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.editingInvoice.shipmentStatus);\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.editingInvoice == null ? null : ctx_r2.editingInvoice.invoices == null ? null : ctx_r2.editingInvoice.invoices.length);\n  }\n}\nfunction InvoiceComponent_div_35_p_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\")(1, \"strong\");\n    i0.ɵɵtext(2, \"Consignment:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(3);\n    i0.ɵɵelementStart(4, \"strong\");\n    i0.ɵɵtext(5, \"Invoice:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(6);\n    i0.ɵɵelementStart(7, \"strong\");\n    i0.ɵɵtext(8, \"Product:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.pendingManifestInfo.consignmentNumber, \" | \");\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.pendingManifestInfo.invoiceNumber, \" | \");\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.pendingManifestInfo.productType, \" \");\n  }\n}\nfunction InvoiceComponent_div_35_table_5_tr_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\");\n    i0.ɵɵtext(4);\n    i0.ɵɵpipe(5, \"date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"td\");\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const line_r13 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(line_r13.manifestationNumber);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind2(5, 3, line_r13.date, \"short\"));\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(line_r13.manifestQty);\n  }\n}\nfunction InvoiceComponent_div_35_table_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"table\", 37)(1, \"thead\")(2, \"tr\")(3, \"th\");\n    i0.ɵɵtext(4, \"Manifest No.\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"th\");\n    i0.ɵɵtext(6, \"Date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"th\");\n    i0.ɵɵtext(8, \"Manifest Qty\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(9, \"tbody\");\n    i0.ɵɵtemplate(10, InvoiceComponent_div_35_table_5_tr_10_Template, 8, 6, \"tr\", 18);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(10);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.manifestAdjustmentLines);\n  }\n}\nfunction InvoiceComponent_div_35_p_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"No manifestations found for this product.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction InvoiceComponent_div_35_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r12 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 19)(1, \"div\", 40)(2, \"h3\");\n    i0.ɵɵtext(3, \"Manifestations\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(4, InvoiceComponent_div_35_p_4_Template, 10, 3, \"p\", 41)(5, InvoiceComponent_div_35_table_5_Template, 11, 1, \"table\", 42)(6, InvoiceComponent_div_35_p_6_Template, 2, 0, \"p\", 41);\n    i0.ɵɵelementStart(7, \"div\", 32)(8, \"button\", 33);\n    i0.ɵɵlistener(\"click\", function InvoiceComponent_div_35_Template_button_click_8_listener() {\n      i0.ɵɵrestoreView(_r12);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeManifestPopup());\n    });\n    i0.ɵɵtext(9, \"Close\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.pendingManifestInfo);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.manifestAdjustmentLines.length);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.manifestAdjustmentLines.length);\n  }\n}\nexport let InvoiceComponent = /*#__PURE__*/(() => {\n  class InvoiceComponent {\n    constructor(http, branchService) {\n      this.http = http;\n      this.branchService = branchService;\n      this.invoices = [];\n      this.filteredInvoices = [];\n      this.searchText = '';\n      this.filterDate = '';\n      this.filterConsignor = '';\n      this.selectedInvoice = null;\n      this.showInvoiceModal = false;\n      this.branch = localStorage.getItem('branch') || 'All Branches';\n      this.editingInvoice = null; // âœ… Track the invoice being edited\n      this.showEditPopup = false; // âœ… Control popup visibility\n      this.onStorageChange = e => {\n        if (e.key === 'branch' && e.newValue && e.newValue !== this.branch) {\n          this.branch = e.newValue;\n          this.loadInvoices();\n        }\n      };\n    }\n    ngOnInit() {\n      this.branch = this.branchService.currentBranch || this.branch;\n      this.branchSub = this.branchService.branch$.subscribe(branch => {\n        if (branch !== this.branch) {\n          this.branch = branch;\n          this.loadInvoices();\n        }\n      });\n      window.addEventListener('storage', this.onStorageChange);\n      this.loadInvoices();\n    }\n    ngOnDestroy() {\n      this.branchSub?.unsubscribe();\n      window.removeEventListener('storage', this.onStorageChange);\n    }\n    loadInvoices() {\n      this.http.get('http://localhost:3000/api/newshipments', {\n        params: {\n          username: localStorage.getItem('username') || '',\n          branch: this.branch || localStorage.getItem('branch') || ''\n        }\n      }).subscribe({\n        next: res => {\n          // âœ… Only show shipments with status 'Delivered'\n          //onsole.log('ðŸ“¦ IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIInvoices loaded:', res);\n          this.invoices = res.filter(s => s.shipmentStatus === 'Delivered' || s.shipmentStatus === 'Invoiced');\n          this.filteredInvoices = [...this.invoices];\n          console.log('ðŸ“¦ Filtered Invoices for Delivered status:', this.filteredInvoices);\n          this.filteredInvoices.forEach(i => console.log('ðŸ“¦ Filtered Invoice:', i.consignmentNumber));\n        },\n        error: err => console.error('âŒ Error loading invoices:', err)\n      });\n    }\n    applyFilters() {\n      this.filteredInvoices = this.invoices.filter(s => (this.searchText ? s.consignmentNumber?.includes(this.searchText) || s.consignor?.includes(this.searchText) : true) && (this.filterDate ? new Date(s.date).toISOString().split('T')[0] === this.filterDate : true) && (this.filterConsignor ? s.consignor?.toLowerCase().includes(this.filterConsignor.toLowerCase()) : true));\n    }\n    toggleAllSelection(event) {\n      const checked = event.target.checked;\n      this.filteredInvoices.forEach(i => i.selected = checked);\n    }\n    openInvoiceDetails(invoice) {\n      this.selectedInvoice = invoice;\n      this.showInvoiceModal = true;\n    }\n    closeInvoiceDetails() {\n      this.showInvoiceModal = false;\n      this.selectedInvoice = null;\n    }\n    // âœ… Function to mark selected Delivered consignments as Invoiced\n    invoiceSelected() {\n      const selectedConsignments = this.filteredInvoices.filter(i => i.selected);\n      if (selectedConsignments.length === 0) {\n        console.warn('âš ï¸ No consignments selected for invoicing.');\n        return;\n      }\n      selectedConsignments.forEach(consignment => {\n        const updatedConsignment = {\n          ...consignment,\n          shipmentStatus: 'Invoiced'\n        };\n        this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, updatedConsignment).subscribe({\n          next: () => {\n            console.log(`âœ… Consignment ${consignment.consignmentNumber} updated to Invoiced`);\n            this.loadInvoices(); // Refresh data\n          },\n          error: err => {\n            console.error(`âŒ Error updating consignment ${consignment.consignmentNumber}:`, err);\n          }\n        });\n      });\n      // Clear selection\n      this.filteredInvoices.forEach(i => i.selected = false);\n    }\n    // âœ… Edit function (opens popup)\n    editInvoice(invoice) {\n      console.log('Edit invoice:', invoice);\n      const cloned = JSON.parse(JSON.stringify(invoice || {}));\n      if (Array.isArray(cloned.ewaybills) && cloned.ewaybills.length) {\n        cloned.invoices = this.flattenInvoices(cloned.ewaybills);\n      } else {\n        cloned.invoices = cloned.invoices || [];\n      }\n      this.editingInvoice = cloned;\n      this.captureOriginalDelivered(this.editingInvoice);\n      this.showEditPopup = true;\n    }\n    deleteInvoice() {\n      // Confirm before deleting\n      const selectedConsignments = this.filteredInvoices.filter(i => i.selected);\n      if (selectedConsignments.length === 0) {\n        console.warn('âš ï¸ No consignments selected for invoicing.');\n        return;\n      }\n      selectedConsignments.forEach(consignment => {\n        const updatedConsignment = {\n          ...consignment,\n          shipmentStatus: ' Cancelled-' + consignment.shipmentStatus\n        };\n        this.http.put(`http://localhost:3000/api/newshipments/${consignment.consignmentNumber}`, updatedConsignment).subscribe({\n          next: () => {\n            console.log(`âœ… Consignment ${consignment.consignmentNumber} updated to Invoiced`);\n            this.loadInvoices(); // Refresh data\n          },\n          error: err => {\n            console.error(`âŒ Error updating consignment ${consignment.consignmentNumber}:`, err);\n          }\n        });\n      });\n      // Clear selection\n      this.filteredInvoices.forEach(i => i.selected = false);\n    }\n    // âœ… Save changes from popup\n    saveInvoiceEdit() {\n      if (!this.editingInvoice) return;\n      const invoices = this.editingInvoice.invoices || [];\n      let anyDelivered = false;\n      let allDelivered = true;\n      invoices.forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          const amount = Number(prod.amount) || 0;\n          const delivered = Number(prod.deliveredstock) || 0;\n          if (delivered > 0) anyDelivered = true;\n          if (delivered < amount) allDelivered = false;\n        });\n      });\n      if (allDelivered) {\n        this.editingInvoice.shipmentStatus = 'Delivered';\n      } else if (anyDelivered) {\n        this.editingInvoice.shipmentStatus = 'In Transit/Pending';\n      } else {\n        this.editingInvoice.shipmentStatus = 'Pending';\n      }\n      invoices.forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          delete prod._originalDelivered;\n        });\n      });\n      this.syncDeliveredToEwaybills();\n      this.http.put(`http://localhost:3000/api/newshipments/${this.editingInvoice.consignmentNumber}`, this.editingInvoice).subscribe({\n        next: () => {\n          console.log('Invoice updated successfully');\n          this.loadInvoices();\n          this.editingInvoice = null;\n          this.showEditPopup = false; // Close popup\n        },\n        error: err => console.error('Error updating invoice:', err)\n      });\n    }\n    cancelEdit() {\n      this.editingInvoice = null;\n      this.showEditPopup = false;\n    }\n    flattenInvoices(ewaybills) {\n      return (ewaybills || []).flatMap(ewb => ewb.invoices || []);\n    }\n    captureOriginalDelivered(invoice) {\n      (invoice?.invoices || []).forEach(inv => {\n        (inv.products || []).forEach(prod => {\n          prod._originalDelivered = Number(prod.deliveredstock) || 0;\n        });\n      });\n    }\n    normalizeInvoiceNumber(invoice) {\n      return String(invoice?.number || invoice?.invoicenum || '').trim();\n    }\n    normalizeProductType(product) {\n      return String(product?.type || product?.productName || '').trim();\n    }\n    onDeliveredQtyChange(invoice, product, rawValue) {\n      let delivered = Number(rawValue);\n      if (!Number.isFinite(delivered)) delivered = 0;\n      if (delivered < 0) delivered = 0;\n      const amount = Number(product?.amount) || 0;\n      if (delivered > amount) delivered = amount;\n      product.deliveredstock = delivered;\n      product.amount = delivered;\n    }\n    onTotalQtyChange(invoice, product, rawValue) {\n      let total = Number(rawValue);\n      if (!Number.isFinite(total)) total = 0;\n      if (total < 0) total = 0;\n      const delivered = Number(product?.deliveredstock) || 0;\n      if (total < delivered) total = delivered;\n      product.amount = total;\n    }\n    syncDeliveredToEwaybills() {\n      const ewaybills = this.editingInvoice?.ewaybills || [];\n      if (!ewaybills.length) return;\n      const invoiceMap = new Map();\n      (this.editingInvoice?.invoices || []).forEach(inv => {\n        const key = this.normalizeInvoiceNumber(inv);\n        if (!key) return;\n        invoiceMap.set(key, inv);\n      });\n      (ewaybills || []).forEach(ewb => {\n        (ewb.invoices || []).forEach(inv => {\n          const key = this.normalizeInvoiceNumber(inv);\n          const sourceInv = invoiceMap.get(key);\n          if (!sourceInv) return;\n          (inv.products || []).forEach(prod => {\n            const pKey = this.normalizeProductType(prod);\n            const sourceProd = (sourceInv.products || []).find(p => this.normalizeProductType(p) === pKey);\n            if (!sourceProd) return;\n            prod.deliveredstock = Number(sourceProd.deliveredstock) || 0;\n          });\n        });\n      });\n    }\n    printInvoice() {\n      const selected = this.filteredInvoices?.filter(inv => inv.selected) || [];\n      if (selected.length === 0) {\n        alert('No invoices selected.');\n        return;\n      }\n      fetch('assets/invoice-template.html').then(res => res.text()).then(template => {\n        let fullHtml = `\n      <html>\n        <head>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h2 { margin-bottom: 0; }\n            table { width: 100%; border-collapse: collapse; margin-top: 10px; }\n            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n            th { background-color: #f2f2f2; }\n            .page-break { page-break-after: always; }\n            .totals { margin-top: 15px; font-weight: bold; }\n          </style>\n        </head>\n        <body>\n    `;\n        selected.forEach((inv, index) => {\n          // Build product rows + calculate subtotal\n          let subtotal = 0;\n          const rows = (inv.invoices || []).map(i => (i.products || []).map(p => {\n            const lineTotal = (p.price || 0) * (p.deliveredstock || 0);\n            subtotal += lineTotal;\n            return `\n          <tr>\n          <td>${inv.consignmentNumber}</td>\n          <td>${inv.shipmentStatus}</td>\n          <td>${inv.consignor}</td>\n          <td>${inv.deliveryAddress}</td>\n          <td>${p.type}</td>\n          <td>${p.deliveredstock}</td>\n          <td>${p.price || 0}</td>\n          <td>${lineTotal.toFixed(2)}</td>\n          </tr>\n          `;\n          }).join('')).join('');\n          const ctype = localStorage.getItem('companyType') || 'default';\n          const gst = inv.finalAmount * (parseInt(ctype, 10) / 100);\n          const grandTotal = inv.finalAmount + gst;\n          const htmlContent = template.replace('{{consignmentNumber}}', inv.consignmentNumber).replace('{{consignor}}', inv.consignor).replace('{{deliveryAddress}}', inv.deliveryAddress).replace('{{status}}', inv.shipmentStatus).replace('{{rows}}', rows).replace('{{subtotal}}', subtotal.toFixed(2)).replace('{{gst}}', gst.toFixed(2)).replace('{{grandTotal}}', grandTotal.toFixed(2));\n          fullHtml += htmlContent;\n          if (index < selected.length - 1) {\n            fullHtml += `<div class=\"page-break\"></div>`;\n          }\n        });\n        fullHtml += `</body></html>`;\n        const printWindow = window.open('', '_blank');\n        if (printWindow) {\n          printWindow.document.open();\n          printWindow.document.write(fullHtml);\n          printWindow.document.close();\n          printWindow.print();\n        }\n      }).catch(err => console.error('Error loading invoice template:', err));\n    }\n    static {\n      this.ɵfac = function InvoiceComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || InvoiceComponent)(i0.ɵɵdirectiveInject(i1.HttpClient), i0.ɵɵdirectiveInject(i2.BranchService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: InvoiceComponent,\n        selectors: [[\"app-invoice\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 36,\n        vars: 7,\n        consts: [[1, \"invoice-container\"], [1, \"filters\"], [\"type\", \"text\", \"placeholder\", \"Search by Consignment / Consignor\", 3, \"ngModelChange\", \"input\", \"ngModel\"], [\"type\", \"date\", 3, \"ngModelChange\", \"change\", \"ngModel\"], [\"type\", \"text\", \"placeholder\", \"Filter by Consignor\", 3, \"ngModelChange\", \"input\", \"ngModel\"], [1, \"action-bar\"], [3, \"click\"], [1, \"delete-btn\", 3, \"click\"], [1, \"print-btn\", 3, \"click\"], [1, \"invoice-table\"], [\"type\", \"checkbox\", 3, \"change\"], [3, \"selected\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"modal\", 4, \"ngIf\"], [\"class\", \"popup-overlay\", 4, \"ngIf\"], [\"type\", \"checkbox\", 3, \"ngModelChange\", \"ngModel\"], [1, \"edit-btn\", 3, \"click\"], [1, \"modal\"], [1, \"modal-content\"], [4, \"ngFor\", \"ngForOf\"], [1, \"popup-overlay\"], [1, \"popup-content\"], [1, \"form-row\"], [\"for\", \"consignor\"], [\"type\", \"text\", \"id\", \"consignor\", \"name\", \"consignor\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"deliveryAddress\"], [\"id\", \"deliveryAddress\", \"name\", \"deliveryAddress\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"status\"], [\"id\", \"status\", \"name\", \"status\", 3, \"ngModelChange\", \"ngModel\"], [\"value\", \"Pending\"], [\"value\", \"Delivered\"], [\"value\", \"Invoiced\"], [\"class\", \"form-row\", 4, \"ngIf\"], [1, \"button-section\"], [\"type\", \"button\", 3, \"click\"], [\"class\", \"invoice-block\", 4, \"ngFor\", \"ngForOf\"], [1, \"invoice-block\"], [1, \"invoice-title\"], [1, \"product-table\"], [\"type\", \"number\", \"min\", \"0\", 3, \"ngModelChange\", \"min\", \"ngModel\", \"name\"], [\"type\", \"number\", \"min\", \"0\", 3, \"ngModelChange\", \"focus\", \"max\", \"ngModel\", \"name\"], [1, \"popup-content\", \"manifest-popup\"], [4, \"ngIf\"], [\"class\", \"product-table\", 4, \"ngIf\"]],\n        template: function InvoiceComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ɵɵtext(2, \"\\uD83D\\uDCE6 Invoice Management\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"div\", 1)(4, \"input\", 2);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_Template_input_ngModelChange_4_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.searchText, $event) || (ctx.searchText = $event);\n              return $event;\n            });\n            i0.ɵɵlistener(\"input\", function InvoiceComponent_Template_input_input_4_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"input\", 3);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_Template_input_ngModelChange_5_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.filterDate, $event) || (ctx.filterDate = $event);\n              return $event;\n            });\n            i0.ɵɵlistener(\"change\", function InvoiceComponent_Template_input_change_5_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(6, \"input\", 4);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function InvoiceComponent_Template_input_ngModelChange_6_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.filterConsignor, $event) || (ctx.filterConsignor = $event);\n              return $event;\n            });\n            i0.ɵɵlistener(\"input\", function InvoiceComponent_Template_input_input_6_listener() {\n              return ctx.applyFilters();\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(7, \"div\", 5)(8, \"button\", 6);\n            i0.ɵɵlistener(\"click\", function InvoiceComponent_Template_button_click_8_listener() {\n              return ctx.invoiceSelected();\n            });\n            i0.ɵɵtext(9, \"\\uD83E\\uDDFE Generate Invoice\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(10, \"button\", 7);\n            i0.ɵɵlistener(\"click\", function InvoiceComponent_Template_button_click_10_listener() {\n              return ctx.deleteInvoice();\n            });\n            i0.ɵɵtext(11, \"\\uD83D\\uDDD1\\uFE0F Delete\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(12, \"button\", 8);\n            i0.ɵɵlistener(\"click\", function InvoiceComponent_Template_button_click_12_listener() {\n              return ctx.printInvoice();\n            });\n            i0.ɵɵtext(13, \"\\uD83D\\uDDA8\\uFE0F Print Manifest\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(14, \"table\", 9)(15, \"thead\")(16, \"tr\")(17, \"th\")(18, \"input\", 10);\n            i0.ɵɵlistener(\"change\", function InvoiceComponent_Template_input_change_18_listener($event) {\n              return ctx.toggleAllSelection($event);\n            });\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(19, \"th\");\n            i0.ɵɵtext(20, \"Consignment No.\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(21, \"th\");\n            i0.ɵɵtext(22, \"Status\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(23, \"th\");\n            i0.ɵɵtext(24, \"Consignor\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(25, \"th\");\n            i0.ɵɵtext(26, \"Delivery Address\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(27, \"th\");\n            i0.ɵɵtext(28, \"No. of Products\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(29, \"th\");\n            i0.ɵɵtext(30, \"Actions\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(31, \"tbody\");\n            i0.ɵɵtemplate(32, InvoiceComponent_tr_32_Template, 16, 8, \"tr\", 11);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(33, InvoiceComponent_div_33_Template, 26, 5, \"div\", 12)(34, InvoiceComponent_div_34_Template, 29, 4, \"div\", 13)(35, InvoiceComponent_div_35_Template, 10, 3, \"div\", 13);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(4);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.searchText);\n            i0.ɵɵadvance();\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.filterDate);\n            i0.ɵɵadvance();\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.filterConsignor);\n            i0.ɵɵadvance(26);\n            i0.ɵɵproperty(\"ngForOf\", ctx.filteredInvoices);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showInvoiceModal);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showEditPopup);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showManifestPopup);\n          }\n        },\n        dependencies: [CommonModule, i3.NgForOf, i3.NgIf, i3.DatePipe, FormsModule, i4.ɵNgNoValidate, i4.NgSelectOption, i4.ɵNgSelectMultipleOption, i4.DefaultValueAccessor, i4.NumberValueAccessor, i4.CheckboxControlValueAccessor, i4.SelectControlValueAccessor, i4.NgControlStatus, i4.NgControlStatusGroup, i4.MinValidator, i4.MaxValidator, i4.NgModel, i4.NgForm],\n        styles: [\".edit-btn[_ngcontent-%COMP%]{background:#ff9800;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer}.edit-btn[_ngcontent-%COMP%]:hover{background:#e68900}.modal-actions[_ngcontent-%COMP%]{margin-top:10px;display:flex;justify-content:space-between}.popup-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.popup-content[_ngcontent-%COMP%]{background:#fff;padding:20px;border-radius:6px;width:400px;max-width:90%}.form-row[_ngcontent-%COMP%]{margin-bottom:12px}.form-row[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:4px;font-weight:700}.form-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .form-row[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], .form-row[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{width:100%;padding:6px;box-sizing:border-box}.button-section[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px}.delete-btn[_ngcontent-%COMP%]{background-color:#e74c3c;color:#fff;border:none;padding:5px 10px;margin-left:5px;cursor:pointer;border-radius:4px}.delete-btn[_ngcontent-%COMP%]:hover{background-color:#c0392b}.invoice-block[_ngcontent-%COMP%]{margin-top:12px;padding:10px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb}.invoice-title[_ngcontent-%COMP%]{font-weight:600;margin-bottom:8px}.product-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.product-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .product-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}.product-table[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]{width:100%;padding:4px 6px;box-sizing:border-box}.manifest-popup[_ngcontent-%COMP%]{width:520px;max-width:95%}\"]\n      });\n    }\n  }\n  return InvoiceComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}