{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, HostListener } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { of } from 'rxjs';\nlet NewShipmentComponent = class NewShipmentComponent {\n  constructor(http) {\n    this.http = http;\n    this.DRAFT_PREFIX = 'newShipmentDraft';\n    this.showClientModal = false;\n    this.showGuestModal = false;\n    this.clientError = '';\n    this.guestError = '';\n    this.clientModalTab = 'add';\n    this.editClientError = '';\n    this.newClient = {\n      clientName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      GSTIN: '',\n      phoneNum: '',\n      perDis: 0,\n      creditType: 'no-credit',\n      products: [],\n      deliveryLocations: [{\n        address: '',\n        city: '',\n        state: '',\n        pinCode: ''\n      }],\n      status: 'active',\n      branch: ''\n    };\n    this.editableClientList = [];\n    this.selectedEditClientId = '';\n    this.editClient = {\n      _id: '',\n      clientName: '',\n      GSTIN: '',\n      phoneNum: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      branch: '',\n      deliveryLocations: []\n    };\n    this.newGuest = {\n      guestName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perDis: 0\n    };\n    // Billing\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.billingLocationIndex = '';\n    this.billingLocationId = null;\n    this.billingPreviousSender = '';\n    this.billingClientId = null;\n    this.clientList = [];\n    this.guestList = [];\n    this.pkgList = [];\n    this.productList = [];\n    // Pickup\n    this.pickupType = 'branch';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    this.pickupPincode = '';\n    this.pickupLocationIndex = '';\n    this.pickupLocationId = null;\n    this.pickupPreviousSender = '';\n    this.pickupSource = 'branch';\n    // Delivery\n    this.deliveryType = 'branch';\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.deliveryPincode = '';\n    this.deliveryLocationIndex = '';\n    this.deliveryLocationId = null;\n    this.deliveryPreviousReceiver = '';\n    this.deliveryClientId = null;\n    this.deliveryID = null;\n    this.deliveryBranch = '';\n    this.deliveryHub = '';\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.username = '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.selectedConsignorId = null;\n    this.consignorId = null;\n    this.consigneeId = null;\n    this.consignmentNumber = 'nil';\n    this.date = new Date().toISOString().split('T')[0];\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.paymentMode = 'To Pay';\n    this.rateUnit = 'box';\n    this.allowAccountCredit = false;\n    this.externalRefId = '';\n    this.suggestedRates = {};\n    this.showRateOverrideModal = false;\n    this.branchDetails = null;\n    this.branches = [];\n    this.hubs = [];\n    this.rateOverrides = [];\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          ratePer: 0,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.applyConsignorDiscount = true;\n    this.maxConsignorDiscount = 0;\n    this.finalAmount = 0;\n    this.showFinalAmountModal = false;\n    this.shipmentStatus = 'Pending';\n    this.shipmentStatusDetails = '';\n    this.isSaving = false;\n    this.onStorageChange = e => {\n      if (e.key === 'branch' && e.newValue) {\n        this.handleBranchChange(e.newValue, e.oldValue || this.branch);\n      }\n    };\n  }\n  ngOnInit() {\n    if (typeof window === 'undefined') return;\n    this.username = localStorage.getItem('username') || '';\n    this.branch = localStorage.getItem('branch') || 'All Branches';\n    this.newClient.branch = this.branch;\n    this.deliveryBranch = this.branch;\n    this.loadDraft(this.branch);\n    this.getCurrentConsignmentNumber();\n    this.loadLists();\n    this.loadBranchDetails();\n    this.loadHubDetails();\n    // React to branch change (same tab)\n    this.branchCheckInterval = setInterval(() => {\n      const current = localStorage.getItem('branch') || 'All Branches';\n      if (current !== this.branch) {\n        const oldBranch = this.branch;\n        this.handleBranchChange(current, oldBranch);\n      }\n    }, 1000);\n    // React to branch change (other tab)\n    window.addEventListener('storage', this.onStorageChange);\n  }\n  ngOnDestroy() {\n    if (this.branchCheckInterval) {\n      clearInterval(this.branchCheckInterval);\n    }\n    window.removeEventListener('storage', this.onStorageChange);\n  }\n  onBeforeUnload() {\n    this.saveDraft(this.branch);\n  }\n  handleBranchChange(newBranch, oldBranch) {\n    // Save draft for the previous branch\n    if (oldBranch) {\n      this.saveDraft(oldBranch);\n    }\n    this.branch = newBranch || 'All Branches';\n    this.newClient.branch = this.branch;\n    this.editClient.branch = this.branch;\n    if (this.deliveryType === 'branch') {\n      this.deliveryBranch = this.branch;\n    }\n    if (this.deliveryType === 'hub') {\n      this.deliveryHub = '';\n    }\n    this.loadDraft(this.branch);\n    this.getCurrentConsignmentNumber();\n    this.loadLists();\n    this.loadBranchDetails();\n    this.loadHubDetails();\n  }\n  draftKey(branch) {\n    return `${this.DRAFT_PREFIX}:${branch || 'All Branches'}`;\n  }\n  saveDraft(branch) {\n    if (typeof window === 'undefined') return;\n    const key = this.draftKey(branch);\n    const draft = {\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingAddress: this.billingAddress,\n      billingGSTIN: this.billingGSTIN,\n      billingPhone: this.billingPhone,\n      billingLocationId: this.billingLocationId,\n      billingPreviousSender: this.billingPreviousSender,\n      billingClientId: this.billingClientId,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      pickupPincode: this.pickupPincode,\n      pickupLocationId: this.pickupLocationId,\n      pickupPreviousSender: this.pickupPreviousSender,\n      pickupSource: this.pickupSource,\n      deliveryType: this.deliveryType,\n      deliveryBranch: this.deliveryBranch,\n      deliveryHub: this.deliveryHub,\n      deliveryID: this.deliveryID,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      deliveryPincode: this.deliveryPincode,\n      deliveryLocationId: this.deliveryLocationId,\n      deliveryPreviousReceiver: this.deliveryPreviousReceiver,\n      deliveryClientId: this.deliveryClientId,\n      consignorTab: this.consignorTab,\n      consigneeTab: this.consigneeTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consignorId: this.consignorId,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      consigneeId: this.consigneeId,\n      paymentMode: this.paymentMode,\n      rateUnit: this.rateUnit,\n      externalRefId: this.externalRefId,\n      ewaybills: this.ewaybills,\n      charges: this.charges,\n      applyConsignorDiscount: this.applyConsignorDiscount,\n      finalAmount: this.finalAmount,\n      selectedConsignorId: this.selectedConsignorId,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date\n    };\n    localStorage.setItem(key, JSON.stringify(draft));\n  }\n  loadDraft(branch) {\n    if (typeof window === 'undefined') return;\n    const raw = localStorage.getItem(this.draftKey(branch));\n    if (!raw) return;\n    try {\n      const draft = JSON.parse(raw);\n      Object.assign(this, {\n        billingType: draft.billingType ?? this.billingType,\n        billingName: draft.billingName ?? this.billingName,\n        billingAddress: draft.billingAddress ?? this.billingAddress,\n        billingGSTIN: draft.billingGSTIN ?? this.billingGSTIN,\n        billingPhone: draft.billingPhone ?? this.billingPhone,\n        billingLocationId: draft.billingLocationId ?? this.billingLocationId,\n        billingPreviousSender: draft.billingPreviousSender ?? this.billingPreviousSender,\n        billingClientId: draft.billingClientId ?? this.billingClientId,\n        pickupType: draft.pickupType ?? this.pickupType,\n        pickupName: draft.pickupName ?? this.pickupName,\n        pickupAddress: draft.pickupAddress ?? this.pickupAddress,\n        pickupPhone: draft.pickupPhone ?? this.pickupPhone,\n        pickupPincode: draft.pickupPincode ?? this.pickupPincode,\n        pickupLocationId: draft.pickupLocationId ?? this.pickupLocationId,\n        pickupPreviousSender: draft.pickupPreviousSender ?? this.pickupPreviousSender,\n        pickupSource: draft.pickupSource ?? this.pickupSource,\n        deliveryType: draft.deliveryType ?? this.deliveryType,\n        deliveryBranch: draft.deliveryBranch ?? this.deliveryBranch,\n        deliveryHub: draft.deliveryHub ?? this.deliveryHub,\n        deliveryID: draft.deliveryID ?? this.deliveryID,\n        deliveryName: draft.deliveryName ?? this.deliveryName,\n        deliveryAddress: draft.deliveryAddress ?? this.deliveryAddress,\n        deliveryPhone: draft.deliveryPhone ?? this.deliveryPhone,\n        deliveryPincode: draft.deliveryPincode ?? this.deliveryPincode,\n        deliveryLocationId: draft.deliveryLocationId ?? this.deliveryLocationId,\n        deliveryPreviousReceiver: draft.deliveryPreviousReceiver ?? this.deliveryPreviousReceiver,\n        deliveryClientId: draft.deliveryClientId ?? this.deliveryClientId,\n        consignorTab: draft.consignorTab ?? this.consignorTab,\n        consigneeTab: draft.consigneeTab ?? this.consigneeTab,\n        consignor: draft.consignor ?? this.consignor,\n        consignorGST: draft.consignorGST ?? this.consignorGST,\n        consignorAddress: draft.consignorAddress ?? this.consignorAddress,\n        consignorPhone: draft.consignorPhone ?? this.consignorPhone,\n        consignorId: draft.consignorId ?? this.consignorId,\n        consignee: draft.consignee ?? this.consignee,\n        consigneeGST: draft.consigneeGST ?? this.consigneeGST,\n        consigneeAddress: draft.consigneeAddress ?? this.consigneeAddress,\n        consigneePhone: draft.consigneePhone ?? this.consigneePhone,\n        consigneeId: draft.consigneeId ?? this.consigneeId,\n        paymentMode: draft.paymentMode ?? this.paymentMode,\n        rateUnit: draft.rateUnit ?? this.rateUnit,\n        externalRefId: draft.externalRefId ?? this.externalRefId,\n        ewaybills: draft.ewaybills ?? this.ewaybills,\n        charges: draft.charges ?? this.charges,\n        applyConsignorDiscount: draft.applyConsignorDiscount ?? this.applyConsignorDiscount,\n        finalAmount: draft.finalAmount ?? this.finalAmount,\n        selectedConsignorId: draft.selectedConsignorId ?? null,\n        consignmentNumber: draft.consignmentNumber ?? this.consignmentNumber,\n        date: draft.date ?? this.date\n      });\n      this.onPaymentModeChange();\n      this.updatePickupFromBranch();\n      if (this.deliveryType === 'branch') {\n        this.updateDeliveryFromBranch();\n      } else if (this.deliveryType === 'hub') {\n        this.updateDeliveryFromHub();\n      } else if (this.deliveryType === 'consignee') {\n        this.updateDeliveryFromConsignee();\n      }\n    } catch {\n      /* ignore bad draft */\n    }\n  }\n  clearDraft(branch) {\n    localStorage.removeItem(this.draftKey(branch));\n  }\n  loadLists() {\n    // Client list\n    this.http.get(`http://localhost:3000/api/clients/clientslist?branch=${encodeURIComponent(this.branch)}`).subscribe(res => {\n      this.clientList = res;\n      this.syncConsignorDiscount();\n      this.updatePaymentModeAvailability(this.consignor);\n    });\n    // Guest list\n    this.http.get(`http://localhost:3000/api/guests/guestslist`).subscribe(res => this.guestList = res);\n    // Package list\n    this.http.get(`http://localhost:3000/api/pkgs/pkglist`).subscribe(res => this.pkgList = res);\n    // Product list (defaults)\n    this.http.get(`http://localhost:3000/api/products/productlist`).subscribe(res => this.productList = res);\n  }\n  loadHubDetails() {\n    this.http.get('http://localhost:3000/api/hubs').subscribe({\n      next: hubs => {\n        this.hubs = hubs || [];\n        if (this.deliveryType === 'hub') {\n          this.updateDeliveryFromHub();\n        }\n      },\n      error: () => {\n        this.hubs = [];\n      }\n    });\n  }\n  // E-WAYBILL HELPERS\n  addEwaybill() {\n    this.ewaybills.push({\n      number: '',\n      date: this.date,\n      invoices: []\n    });\n  }\n  deleteEwaybill(index) {\n    this.ewaybills.splice(index, 1);\n  }\n  addInvoice(ewaybillIndex) {\n    this.ewaybills[ewaybillIndex].invoices.push({\n      number: '',\n      value: 0,\n      packages: [],\n      products: []\n    });\n  }\n  deleteInvoice(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices.splice(invoiceIndex, 1);\n  }\n  addPackage(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.push({\n      type: '',\n      amount: 0\n    });\n  }\n  deletePackage(ewaybillIndex, invoiceIndex, packageIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].packages.splice(packageIndex, 1);\n  }\n  addProduct(ewaybillIndex, invoiceIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.push({\n      type: '',\n      amount: 1,\n      ratePer: 0,\n      instock: 1,\n      intransitstock: 0,\n      deliveredstock: 0\n    });\n  }\n  deleteProduct(ewaybillIndex, invoiceIndex, productIndex) {\n    this.ewaybills[ewaybillIndex].invoices[invoiceIndex].products.splice(productIndex, 1);\n  }\n  // CALCULATIONS\n  calculateFinalAmount() {\n    let invoiceTotal = 0;\n    let packageTotal = 0;\n    this.ewaybills.forEach(ewb => {\n      invoiceTotal += ewb.invoices.reduce((sum, inv) => {\n        const productTotal = (inv.products || []).reduce((pSum, p) => {\n          const qty = Number(p?.amount) || 0;\n          const rate = Number(p?.ratePer) || 0;\n          return pSum + qty * rate;\n        }, 0);\n        const invoiceValue = Number(inv?.value) || 0;\n        return sum + (productTotal > 0 ? productTotal : invoiceValue);\n      }, 0);\n      packageTotal += ewb.invoices.reduce((sum, inv) => sum + (inv.packages || []).reduce((pSum, p) => pSum + (Number(p?.amount) || 0), 0), 0);\n    });\n    const chargeTotal = Object.entries(this.charges).filter(([key]) => key !== 'consignorDiscount').reduce((sum, [, c]) => sum + (Number(c) || 0), 0);\n    const subtotal = invoiceTotal + packageTotal + chargeTotal;\n    const discountPercent = Number(this.charges.consignorDiscount) || 0;\n    const discountAmount = this.applyConsignorDiscount ? subtotal * discountPercent / 100 : 0;\n    this.finalAmount = subtotal - discountAmount;\n  }\n  resetForm() {\n    this.billingType = 'consignor';\n    this.billingName = '';\n    this.billingAddress = '';\n    this.billingGSTIN = '';\n    this.billingPhone = '';\n    this.billingLocationIndex = '';\n    this.billingLocationId = null;\n    this.billingPreviousSender = '';\n    this.billingClientId = null;\n    this.pickupType = 'branch';\n    this.pickupName = '';\n    this.pickupAddress = '';\n    this.pickupPhone = '';\n    this.pickupPincode = '';\n    this.pickupLocationIndex = '';\n    this.pickupLocationId = null;\n    this.pickupPreviousSender = '';\n    this.pickupSource = 'branch';\n    this.deliveryType = 'branch';\n    this.deliveryBranch = this.branch;\n    this.deliveryName = '';\n    this.deliveryAddress = '';\n    this.deliveryPhone = '';\n    this.deliveryPincode = '';\n    this.deliveryLocationIndex = '';\n    this.deliveryLocationId = null;\n    this.deliveryPreviousReceiver = '';\n    this.deliveryClientId = null;\n    this.deliveryID = null;\n    this.consignorTab = 'consignor';\n    this.consigneeTab = 'consignee';\n    this.selectedConsignorId = null;\n    this.consignor = '';\n    this.consignorGST = '';\n    this.consignorAddress = '';\n    this.consignorPhone = '';\n    this.consignorId = null;\n    this.consignee = '';\n    this.consigneeGST = '';\n    this.consigneeAddress = '';\n    this.consigneePhone = '';\n    this.consigneeId = null;\n    this.paymentMode = 'To Pay';\n    this.rateUnit = 'box';\n    this.allowAccountCredit = false;\n    this.externalRefId = '';\n    this.ewaybills = [{\n      number: '',\n      date: this.date,\n      invoices: [{\n        number: '',\n        value: 0,\n        packages: [{\n          type: '',\n          amount: 0\n        }],\n        products: [{\n          type: '',\n          amount: 1,\n          ratePer: 0,\n          instock: 1,\n          intransitstock: 0,\n          deliveredstock: 0\n        }]\n      }]\n    }];\n    this.charges = {\n      odc: 0,\n      unloading: 0,\n      docket: 0,\n      other: 0,\n      ccc: 0,\n      consignorDiscount: 0\n    };\n    this.applyConsignorDiscount = true;\n    this.maxConsignorDiscount = 0;\n    this.finalAmount = 0;\n    this.suggestedRates = {};\n    this.saveDraft(this.branch);\n    this.updatePickupFromBranch();\n  }\n  // CONSIGNMENT NUMBER\n  getCurrentConsignmentNumber() {\n    if (!this.branch || this.branch === 'All Branches') {\n      this.consignmentNumber = 'nil';\n      return;\n    }\n    this.http.get(`http://localhost:3000/api/newshipments/nextConsignment?username=${encodeURIComponent(this.username)}&branch=${encodeURIComponent(this.branch)}`).subscribe({\n      next: res => {\n        this.consignmentNumber = res.nextNumber.toString();\n        localStorage.setItem('consignmentNumber', this.consignmentNumber);\n      },\n      error: err => console.error('Error fetching consignment number', err)\n    });\n  }\n  // SAVE SHIPMENT\n  saveShipment() {\n    if (this.isSaving) return;\n    if (!this.ensureProductAmounts()) return;\n    if (Number(this.finalAmount || 0) === 0) {\n      this.showFinalAmountModal = true;\n      return;\n    }\n    this.beginSaveFlow();\n  }\n  confirmFinalAmountSave() {\n    this.showFinalAmountModal = false;\n    this.beginSaveFlow();\n  }\n  cancelFinalAmountSave() {\n    this.showFinalAmountModal = false;\n  }\n  beginSaveFlow() {\n    const overrides = this.collectRateOverrides();\n    if (overrides.length) {\n      this.rateOverrides = overrides;\n      this.showRateOverrideModal = true;\n      return;\n    }\n    this.performSave();\n  }\n  performSave() {\n    this.isSaving = true;\n    if (this.paymentMode === 'To Pay') {\n      this.shipmentStatus = 'To Pay';\n    }\n    const branch = localStorage.getItem('branch') || '';\n    const shipmentData = {\n      username: localStorage.getItem('username'),\n      branch,\n      shipmentStatus: this.shipmentStatus,\n      shipmentStatusDetails: branch,\n      consignmentNumber: this.consignmentNumber,\n      date: this.date,\n      paymentMode: this.paymentMode,\n      externalRefId: this.externalRefId,\n      consignorTab: this.consignorTab,\n      consignor: this.consignor,\n      consignorGST: this.consignorGST,\n      consignorAddress: this.consignorAddress,\n      consignorPhone: this.consignorPhone,\n      consignorId: this.consignorId,\n      consigneeTab: this.consigneeTab,\n      consignee: this.consignee,\n      consigneeGST: this.consigneeGST,\n      consigneeAddress: this.consigneeAddress,\n      consigneePhone: this.consigneePhone,\n      consigneeId: this.consigneeId,\n      billingType: this.billingType,\n      billingName: this.billingName,\n      billingGSTIN: this.billingGSTIN,\n      billingAddress: this.billingAddress,\n      billingPhone: this.billingPhone,\n      billingLocationId: this.billingLocationId,\n      billingClientId: this.billingClientId,\n      pickupType: this.pickupType,\n      pickupName: this.pickupName,\n      pickupAddress: this.pickupAddress,\n      pickupPhone: this.pickupPhone,\n      pickupPincode: this.pickupPincode,\n      pickupLocationId: this.pickupLocationId,\n      deliveryType: this.deliveryType,\n      deliveryID: this.deliveryID,\n      deliveryName: this.deliveryName,\n      deliveryAddress: this.deliveryAddress,\n      deliveryPhone: this.deliveryPhone,\n      deliveryPincode: this.deliveryPincode,\n      deliveryLocationId: this.deliveryLocationId,\n      deliveryClientId: this.deliveryClientId,\n      ewaybills: this.ewaybills,\n      charges: this.charges,\n      finalAmount: this.finalAmount\n    };\n    if (this.consignorTab === 'guest') shipmentData.consignorGST = 'GUEST';\n    if (this.consigneeTab === 'guest') shipmentData.consigneeGST = 'GUEST';\n    if (this.billingType === 'consignor') {\n      shipmentData.billingName = this.consignor;\n      shipmentData.billingAddress = this.consignorAddress;\n      shipmentData.billingGSTIN = this.consignorGST;\n      shipmentData.billingPhone = this.consignorPhone;\n      shipmentData.billingClientId = this.consignorId;\n    }\n    if (this.pickupType === 'branch') {\n      shipmentData.pickupName = this.pickupName;\n      shipmentData.pickupAddress = this.pickupAddress;\n      shipmentData.pickupPhone = this.pickupPhone;\n    }\n    if (this.deliveryType === 'consignee') {\n      shipmentData.deliveryName = this.consignee;\n      shipmentData.deliveryAddress = this.consigneeAddress;\n      shipmentData.deliveryPhone = this.consigneePhone;\n    }\n    if (shipmentData.branch !== 'All Branches') {\n      shipmentData.ewaybills = this.sanitizeEwaybills(shipmentData.ewaybills);\n      this.http.post('http://localhost:3000/api/newshipments/add?summary=true', shipmentData, {\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }).subscribe({\n        next: () => {\n          alert(`Shipment ${this.consignmentNumber} saved successfully!`);\n          this.getCurrentConsignmentNumber();\n          this.resetForm();\n          this.clearDraft(this.branch);\n          this.isSaving = false;\n        },\n        error: err => {\n          const msg = err?.error?.message || err?.message || 'Bad Request';\n          if (msg.includes('E11000')) {\n            alert('Consignment number already used. Refreshing number and please try again.');\n            this.getCurrentConsignmentNumber();\n          } else {\n            alert('Error: ' + msg);\n          }\n          this.isSaving = false;\n        }\n      });\n    } else {\n      alert('Please select a branch before saving.');\n      this.isSaving = false;\n    }\n  }\n  collectRateOverrides() {\n    const overrides = [];\n    if (!this.selectedConsignorId) {\n      return overrides;\n    }\n    for (const ewb of this.ewaybills) {\n      for (const inv of ewb.invoices || []) {\n        for (const prod of inv.products || []) {\n          const name = String(prod.type || '').trim();\n          if (!name) continue;\n          const suggested = this.suggestedRates[name];\n          const entered = Number(prod.ratePer) || 0;\n          const hasValue = prod.ratePer !== null && prod.ratePer !== undefined && String(prod.ratePer).trim() !== '' && entered !== 0;\n          if (!hasValue) continue;\n          if (suggested === null || suggested === undefined || entered !== Number(suggested)) {\n            const match = this.productList.find(p => p.productName === name);\n            const suggestedValue = suggested === null || suggested === undefined ? null : Number(suggested);\n            overrides.push({\n              productName: name,\n              hsnNum: match?.hsnNum,\n              enteredRate: entered,\n              suggestedRate: suggestedValue,\n              action: 'override'\n            });\n          }\n        }\n      }\n    }\n    return overrides;\n  }\n  confirmRateOverride() {\n    this.showRateOverrideModal = false;\n    const updates = this.rateOverrides.filter(item => item.action === 'suggest');\n    if (!updates.length) {\n      this.performSave();\n      return;\n    }\n    this.ensureRoutePincodes();\n    const pickupPin = String(this.pickupPincode || '').trim();\n    const deliveryPin = String(this.deliveryPincode || '').trim();\n    if (!pickupPin || !deliveryPin) {\n      alert('Pickup and delivery pincode are required to save suggested rates.');\n      this.performSave();\n      return;\n    }\n    this.updateClientPricing(updates).subscribe({\n      next: () => this.performSave(),\n      error: () => {\n        alert('Failed to update client pricing. Saving shipment with entered rates.');\n        this.performSave();\n      }\n    });\n  }\n  updateClientPricing(overrides) {\n    if (!this.selectedConsignorId) {\n      return of(void 0);\n    }\n    this.ensureRoutePincodes();\n    const updates = new Map();\n    overrides.forEach(item => {\n      updates.set(item.productName, {\n        productName: item.productName,\n        hsnNum: item.hsnNum,\n        ratePer: item.enteredRate\n      });\n    });\n    const payload = {\n      pickupPincode: String(this.pickupPincode || '').trim(),\n      deliveryPincode: String(this.deliveryPincode || '').trim(),\n      rateUnit: this.rateUnit,\n      updates: Array.from(updates.values())\n    };\n    return this.http.post(`http://localhost:3000/api/clients/${this.selectedConsignorId}/pricing`, payload);\n  }\n  ensureRoutePincodes() {\n    if (!this.pickupPincode) {\n      const fallbackPin = String(this.branchDetails?.pinCode || '').trim();\n      if (fallbackPin) this.pickupPincode = fallbackPin;\n    }\n    if (!this.deliveryPincode) {\n      if (this.deliveryType === 'branch') {\n        const selected = (this.branches || []).find(b => b.branchName === this.deliveryBranch);\n        const source = selected || (this.branchDetails?.branchName === this.deliveryBranch ? this.branchDetails : null);\n        const fallbackPin = String(source?.pinCode || '').trim();\n        if (fallbackPin) this.deliveryPincode = fallbackPin;\n      } else if (this.deliveryType === 'different') {\n        const locations = this.getClientLocationsByName(this.deliveryPreviousReceiver);\n        const byId = this.getLocationById(locations, this.deliveryLocationId);\n        const fallbackPin = this.getLocationPin(byId) || this.getLocationPin(locations[0]);\n        if (fallbackPin) this.deliveryPincode = fallbackPin;\n      } else {\n        const locations = this.getConsigneeLocations();\n        const byId = this.getLocationById(locations, this.deliveryLocationId);\n        const byIndex = locations[Number(this.deliveryLocationIndex)];\n        const deliveryPin = this.consigneeTab === 'guest' ? this.getGuestPinByName(this.consignee) : this.getClientPinByName(this.consignee);\n        const fallbackPin = this.getLocationPin(byId) || this.getLocationPin(byIndex) || deliveryPin || this.getLocationPin(locations[0]);\n        if (fallbackPin) this.deliveryPincode = fallbackPin;\n      }\n    }\n  }\n  sanitizeEwaybills(ewaybills) {\n    return (ewaybills || []).map(ewb => ({\n      ...ewb,\n      invoices: (ewb.invoices || []).map(inv => ({\n        ...inv,\n        packages: (inv.packages || []).filter(p => p?.type && Number(p?.amount) > 0),\n        products: (inv.products || []).filter(p => p?.type && Number(p?.amount) > 0)\n      }))\n    }));\n  }\n  ensureProductAmounts() {\n    let hasAnyProduct = false;\n    for (const ewb of this.ewaybills) {\n      let ewbHasProduct = false;\n      for (const inv of ewb.invoices || []) {\n        const validProducts = (inv.products || []).filter(prod => String(prod?.type || '').trim() && Number(prod?.amount) > 0);\n        if (!validProducts.length) {\n          alert('Please add at least one product to each invoice.');\n          return false;\n        }\n        for (const prod of inv.products || []) {\n          const type = String(prod?.type || '').trim();\n          const amount = Number(prod?.amount || 0);\n          if (!type && !amount) continue;\n          if (!type) {\n            alert('Please select a product type for all products.');\n            return false;\n          }\n          if (amount <= 0) {\n            alert('Please enter a quantity greater than 0 for all products.');\n            return false;\n          }\n          ewbHasProduct = true;\n          hasAnyProduct = true;\n          if (!prod.instock || prod.instock <= 0) {\n            prod.instock = amount;\n          }\n        }\n      }\n      if (!ewbHasProduct) {\n        alert('Please add at least one product to each e-waybill.');\n        return false;\n      }\n    }\n    if (!hasAnyProduct) {\n      alert('Please add at least one product before saving.');\n      return false;\n    }\n    return true;\n  }\n  hasValidProduct() {\n    for (const ewb of this.ewaybills) {\n      for (const inv of ewb.invoices || []) {\n        for (const prod of inv.products || []) {\n          const type = String(prod?.type || '').trim();\n          const amount = Number(prod?.amount || 0);\n          if (type && amount > 0) {\n            return true;\n          }\n        }\n      }\n    }\n    return false;\n  }\n  setPincodeIfEmpty(target, value) {\n    const pin = String(value || '').trim();\n    if (!pin) return;\n    if (target === 'pickup') {\n      if (this.pickupPincode) return;\n      this.pickupPincode = pin;\n    } else {\n      if (this.deliveryPincode) return;\n      this.deliveryPincode = pin;\n    }\n    this.onRouteChange();\n  }\n  getClientLocationsByName(name) {\n    const client = this.clientList.find(x => x.clientName === name);\n    return Array.isArray(client?.deliveryLocations) ? client.deliveryLocations : [];\n  }\n  getConsignorLocations() {\n    return this.getClientLocationsByName(this.consignor);\n  }\n  getConsigneeLocations() {\n    return this.getClientLocationsByName(this.consignee);\n  }\n  formatLocation(loc) {\n    const address = loc?.address || loc?.location;\n    const parts = [address, loc?.city, loc?.state, this.getLocationPin(loc)].filter(Boolean);\n    return parts.join(', ');\n  }\n  getLocationPin(loc) {\n    return String(loc?.pinCode ?? loc?.pincode ?? loc?.pin ?? '').trim();\n  }\n  getLocationId(loc) {\n    const id = loc?.delivery_id || loc?._id || loc?.id;\n    return id ? String(id) : null;\n  }\n  getPrimaryLocationId(locations) {\n    if (!Array.isArray(locations) || !locations.length) return null;\n    return this.getLocationId(locations[0]);\n  }\n  getLocationById(locations, id) {\n    if (!id || !Array.isArray(locations)) return null;\n    return locations.find(loc => this.getLocationId(loc) === id) || null;\n  }\n  getClientPinByName(name) {\n    const client = this.clientList.find(x => x.clientName === name);\n    const pin = String(client?.pinCode ?? client?.pincode ?? client?.pin ?? '').trim();\n    if (pin) return pin;\n    const locations = Array.isArray(client?.deliveryLocations) ? client.deliveryLocations : [];\n    return this.getLocationPin(locations[0]);\n  }\n  getGuestPinByName(name) {\n    const guest = this.guestList.find(x => x.guestName === name);\n    return String(guest?.pinCode ?? guest?.pincode ?? '').trim();\n  }\n  updatePickupFromConsignor() {\n    if (this.consignorTab === 'guest') {\n      const guest = this.guestList.find(x => x.guestName === this.consignor);\n      if (!guest) return;\n      this.pickupName = guest.guestName || '';\n      this.pickupPhone = guest.phoneNum || '';\n      this.pickupAddress = guest.address || '';\n      this.pickupPincode = String(guest?.pinCode ?? guest?.pincode ?? '').trim();\n      this.pickupLocationId = null;\n      this.pickupLocationIndex = '';\n      this.pickupSource = 'consignor-guest';\n      this.onRouteChange();\n      return;\n    }\n    const client = this.clientList.find(x => x.clientName === this.consignor);\n    if (!client) return;\n    this.pickupName = client.clientName || '';\n    this.pickupPhone = client.phoneNum || '';\n    const locations = Array.isArray(client?.deliveryLocations) ? client.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.pickupAddress = primaryLocation ? this.formatLocation(primaryLocation) : client.address || '';\n    const pin = primaryLocation ? this.getLocationPin(primaryLocation) : this.getClientPinByName(client.clientName);\n    if (pin) {\n      this.pickupPincode = pin;\n      this.onRouteChange();\n    }\n    this.pickupLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.pickupLocationIndex = '';\n    if (!this.pickupSource || this.pickupSource === 'branch' || this.pickupSource === 'consignor-guest') {\n      this.pickupSource = 'consignor-primary';\n    }\n  }\n  updateBillingFromConsignor() {\n    if (this.consignorTab === 'guest') {\n      const guest = this.guestList.find(x => x.guestName === this.consignor);\n      if (!guest) return;\n      this.billingName = guest.guestName || '';\n      this.billingGSTIN = 'GUEST';\n      this.billingPhone = guest.phoneNum || '';\n      this.billingAddress = guest.address || '';\n      this.billingLocationId = null;\n      this.billingLocationIndex = '';\n      this.billingClientId = null;\n      return;\n    }\n    const client = this.clientList.find(x => x.clientName === this.consignor);\n    if (!client) return;\n    this.billingName = client.clientName || '';\n    this.billingGSTIN = client.GSTIN || '';\n    this.billingPhone = client.phoneNum || '';\n    const locations = Array.isArray(client?.deliveryLocations) ? client.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.billingAddress = primaryLocation ? this.formatLocation(primaryLocation) : client.address || '';\n    this.billingLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.billingLocationIndex = '';\n    this.billingClientId = client._id || null;\n    this.refreshPricingSuggestions();\n  }\n  updateDeliveryFromConsignee() {\n    if (this.consigneeTab === 'guest') {\n      const guest = this.guestList.find(x => x.guestName === this.consignee);\n      if (!guest) return;\n      this.deliveryAddress = guest.address || '';\n      this.deliveryPincode = String(guest?.pinCode ?? guest?.pincode ?? '').trim();\n      this.deliveryLocationId = null;\n      this.deliveryLocationIndex = '';\n      this.deliveryID = guest._id || null;\n      this.onRouteChange();\n      return;\n    }\n    const client = this.clientList.find(x => x.clientName === this.consignee);\n    if (!client) return;\n    const locations = Array.isArray(client?.deliveryLocations) ? client.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.deliveryAddress = primaryLocation ? this.formatLocation(primaryLocation) : client.address || '';\n    const pin = primaryLocation ? this.getLocationPin(primaryLocation) : this.getClientPinByName(client.clientName);\n    if (pin) {\n      this.deliveryPincode = pin;\n      this.onRouteChange();\n    }\n    this.deliveryLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.deliveryLocationIndex = '';\n    this.deliveryID = client._id || null;\n  }\n  setPickupType(type) {\n    this.pickupType = type;\n    if (type === 'branch') {\n      this.updatePickupFromBranch();\n      return;\n    }\n    if (type === 'consignor') {\n      this.updatePickupFromConsignor();\n      return;\n    }\n    if (this.pickupPreviousSender) {\n      this.onPickupPreviousSenderSelect(this.pickupPreviousSender);\n    }\n  }\n  activatePickupPrimary() {\n    this.pickupSource = 'branch';\n    this.setPickupType('branch');\n  }\n  onPickupSourceSelect(value) {\n    this.pickupSource = value;\n    if (value === 'branch') {\n      this.setPickupType('branch');\n      return;\n    }\n    if (value === 'consignor-guest') {\n      this.setPickupType('consignor');\n      this.updatePickupFromConsignor();\n      return;\n    }\n    if (value === 'consignor-primary') {\n      this.setPickupType('consignor');\n      this.updatePickupFromConsignor();\n      return;\n    }\n    if (value.startsWith('consignor:')) {\n      const index = value.split(':')[1] || '';\n      this.setPickupType('consignor');\n      this.pickupLocationIndex = index;\n      this.onPickupLocationSelect(index);\n    }\n  }\n  setBillingType(type) {\n    this.billingType = type;\n    if (type === 'consignor') {\n      this.updateBillingFromConsignor();\n      return;\n    }\n    if (this.billingLocationIndex !== '') {\n      this.onBillingLocationSelect(this.billingLocationIndex);\n    }\n  }\n  setDeliveryType(type) {\n    this.deliveryType = type;\n    if (type === 'branch') {\n      if (!this.deliveryBranch) this.deliveryBranch = this.branch;\n      this.updateDeliveryFromBranch();\n      return;\n    }\n    if (type === 'hub') {\n      if (!this.deliveryHub) {\n        const hubs = this.getAvailableHubs();\n        if (hubs.length === 1) {\n          this.deliveryHub = hubs[0].hubName;\n        }\n      }\n      this.updateDeliveryFromHub();\n      return;\n    }\n    if (type === 'consignee') {\n      this.updateDeliveryFromConsignee();\n      return;\n    }\n    if (this.deliveryPreviousReceiver) {\n      this.onDeliveryPreviousReceiverSelect(this.deliveryPreviousReceiver);\n    }\n  }\n  onDeliveryBranchSelect(name) {\n    this.deliveryBranch = name;\n    this.updateDeliveryFromBranch();\n  }\n  onDeliveryHubSelect(name) {\n    this.deliveryHub = name;\n    this.updateDeliveryFromHub();\n  }\n  onBillingLocationSelect(index) {\n    this.billingLocationIndex = index;\n    const locations = this.getConsignorLocations();\n    const loc = locations[Number(index)];\n    if (!loc) return;\n    this.billingAddress = this.formatLocation(loc);\n    this.billingLocationId = this.getLocationId(loc);\n    this.refreshPricingSuggestions();\n  }\n  onBillingPreviousSenderSelect(name) {\n    const selected = this.clientList.find(c => c.clientName === name);\n    if (!selected) return;\n    this.billingName = selected.clientName || '';\n    this.billingGSTIN = selected.GSTIN || '';\n    this.billingPhone = selected.phoneNum || '';\n    const locations = Array.isArray(selected.deliveryLocations) ? selected.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.billingAddress = primaryLocation ? this.formatLocation(primaryLocation) : selected.address || '';\n    this.billingLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.billingClientId = selected._id || null;\n    this.billingLocationIndex = '';\n    this.refreshPricingSuggestions();\n  }\n  onPickupLocationSelect(index) {\n    this.pickupLocationIndex = index;\n    const locations = this.getConsignorLocations();\n    const loc = locations[Number(index)];\n    if (!loc) return;\n    this.pickupAddress = this.formatLocation(loc);\n    this.pickupPincode = this.getLocationPin(loc);\n    this.pickupLocationId = this.getLocationId(loc);\n    this.pickupSource = `consignor:${index}`;\n    this.onRouteChange();\n  }\n  onPickupPreviousSenderSelect(name) {\n    const selected = this.clientList.find(c => c.clientName === name);\n    if (!selected) return;\n    this.pickupName = selected.clientName || '';\n    this.pickupPhone = selected.phoneNum || '';\n    const locations = Array.isArray(selected.deliveryLocations) ? selected.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.pickupAddress = primaryLocation ? this.formatLocation(primaryLocation) : selected.address || '';\n    this.pickupPincode = primaryLocation ? this.getLocationPin(primaryLocation) : '';\n    this.pickupLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.pickupLocationIndex = '';\n    this.onRouteChange();\n  }\n  onDeliveryLocationSelect(index) {\n    this.deliveryLocationIndex = index;\n    const locations = this.getConsigneeLocations();\n    const loc = locations[Number(index)];\n    if (!loc) return;\n    this.deliveryAddress = this.formatLocation(loc);\n    this.deliveryPincode = this.getLocationPin(loc);\n    this.deliveryLocationId = this.getLocationId(loc);\n    this.onRouteChange();\n  }\n  onDeliveryPreviousReceiverSelect(name) {\n    const selected = this.clientList.find(c => c.clientName === name);\n    if (!selected) return;\n    this.deliveryName = selected.clientName || '';\n    this.deliveryPhone = selected.phoneNum || '';\n    const locations = Array.isArray(selected.deliveryLocations) ? selected.deliveryLocations : [];\n    const primaryLocation = locations[0];\n    this.deliveryAddress = primaryLocation ? this.formatLocation(primaryLocation) : selected.address || '';\n    this.deliveryPincode = primaryLocation ? this.getLocationPin(primaryLocation) : '';\n    this.deliveryLocationId = primaryLocation ? this.getLocationId(primaryLocation) : null;\n    this.deliveryClientId = selected._id || null;\n    this.deliveryLocationIndex = '';\n    this.deliveryID = selected._id || null;\n    this.onRouteChange();\n  }\n  // SELECT HANDLERS\n  onConsignorSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consignorGST = c.GSTIN;\n      this.consignorAddress = c.address;\n      this.consignorPhone = c.phoneNum;\n      this.maxConsignorDiscount = Number(c.perDis) || 0;\n      this.charges.consignorDiscount = this.maxConsignorDiscount;\n      this.selectedConsignorId = c._id;\n      this.consignorId = c._id;\n      if (this.pickupType === 'consignor') {\n        this.updatePickupFromConsignor();\n      }\n      if (this.billingType === 'consignor') {\n        this.updateBillingFromConsignor();\n      } else {\n        this.billingLocationId = null;\n      }\n      this.billingLocationIndex = '';\n      this.pickupLocationIndex = '';\n      this.refreshPricingSuggestions();\n    }\n    this.updatePaymentModeAvailability(name);\n  }\n  onConsigneeSelect(name) {\n    const c = this.clientList.find(x => x.clientName === name);\n    if (c) {\n      this.consigneeGST = c.GSTIN;\n      this.consigneeAddress = c.address;\n      this.consigneePhone = c.phoneNum;\n      this.consigneeId = c._id;\n      if (this.deliveryType === 'consignee') {\n        this.updateDeliveryFromConsignee();\n      }\n      this.deliveryLocationIndex = '';\n    }\n  }\n  onConsignorGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consignorGST = 'GUEST';\n      this.consignorAddress = g.address;\n      this.consignorPhone = g.phoneNum;\n      this.charges.consignorDiscount = 0;\n      this.maxConsignorDiscount = 0;\n      this.selectedConsignorId = null;\n      this.consignorId = g._id || null;\n      if (this.pickupType === 'consignor') {\n        this.updatePickupFromConsignor();\n      }\n      if (this.billingType === 'consignor') {\n        this.updateBillingFromConsignor();\n      } else {\n        this.billingLocationId = null;\n        this.billingLocationIndex = '';\n      }\n      this.pickupLocationIndex = '';\n      this.suggestedRates = {};\n    }\n    this.updatePaymentModeAvailability('');\n  }\n  syncConsignorDiscount() {\n    const name = (this.consignor || '').trim();\n    if (!name || this.consignorTab !== 'consignor') return;\n    const client = this.clientList.find(x => x.clientName === name);\n    this.maxConsignorDiscount = Number(client?.perDis) || 0;\n    this.charges.consignorDiscount = this.maxConsignorDiscount;\n  }\n  onConsignorDiscountChange(value) {\n    const raw = Number(value);\n    const clamped = Math.max(0, Math.min(Number.isFinite(raw) ? raw : 0, this.maxConsignorDiscount));\n    this.charges.consignorDiscount = clamped;\n    this.calculateFinalAmount();\n  }\n  onRateUnitChange() {\n    this.refreshPricingSuggestions();\n  }\n  onPaymentModeChange() {\n    if (this.paymentMode === 'To Pay') {\n      this.shipmentStatus = 'To Pay';\n      return;\n    }\n    if (this.shipmentStatus === 'To Pay') {\n      this.shipmentStatus = 'Pending';\n    }\n  }\n  onRouteChange() {\n    this.refreshPricingSuggestions();\n  }\n  onProductTypeChange(product) {\n    const suggested = this.getSuggestedRate(product);\n    if (suggested === null) return;\n    const hasValue = product.ratePer !== null && product.ratePer !== undefined && String(product.ratePer).trim() !== '' && Number(product.ratePer) !== 0;\n    if (!hasValue) {\n      product.ratePer = suggested;\n    }\n  }\n  onConsigneeGuestSelect(name) {\n    const g = this.guestList.find(x => x.guestName === name);\n    if (g) {\n      this.consigneeGST = 'GUEST';\n      this.consigneeAddress = g.address;\n      this.consigneePhone = g.phoneNum;\n      this.consigneeId = g._id || null;\n      if (this.deliveryType === 'consignee') {\n        this.updateDeliveryFromConsignee();\n      }\n      this.deliveryLocationIndex = '';\n    }\n  }\n  onPackageList(name) {\n    this.pkgList.find(x => x.pkgName === name);\n  }\n  onProductList(name) {\n    this.productList.find(x => x.productName === name);\n  }\n  formatClientOption(client) {\n    const gstin = client?.GSTIN || '-';\n    const name = client?.clientName || '-';\n    const address = client?.address || '-';\n    return `${gstin} | ${name} | ${address}`;\n  }\n  formatGuestOption(guest) {\n    const name = guest?.guestName || '-';\n    const address = guest?.address || '-';\n    return `- | ${name} | ${address}`;\n  }\n  formatBranchAddress(branch) {\n    if (!branch) return '';\n    const parts = [branch.address, branch.city, branch.state, branch.pinCode].filter(Boolean);\n    return parts.join(', ');\n  }\n  updatePickupFromBranch() {\n    if (!this.branchDetails || this.branch === 'All Branches') {\n      this.pickupType = 'branch';\n      this.pickupName = '';\n      this.pickupAddress = '';\n      this.pickupPhone = '';\n      this.pickupPincode = '';\n      this.pickupLocationIndex = '';\n      this.pickupLocationId = null;\n      this.pickupSource = 'branch';\n      return;\n    }\n    this.pickupType = 'branch';\n    this.pickupName = this.branchDetails.branchName || this.branch;\n    this.pickupAddress = this.formatBranchAddress(this.branchDetails);\n    this.pickupPhone = this.branchDetails.phoneNum || '';\n    this.pickupPincode = String(this.branchDetails.pinCode || '').trim();\n    this.pickupLocationIndex = '';\n    this.pickupLocationId = null;\n    this.pickupSource = 'branch';\n    this.onRouteChange();\n  }\n  updateDeliveryFromBranch() {\n    const target = String(this.deliveryBranch || this.branch || '').trim();\n    if (!target) {\n      this.deliveryName = '';\n      this.deliveryAddress = '';\n      this.deliveryPhone = '';\n      this.deliveryPincode = '';\n      this.deliveryLocationIndex = '';\n      this.deliveryLocationId = null;\n      this.deliveryClientId = null;\n      return;\n    }\n    const selected = (this.branches || []).find(b => b.branchName === target);\n    const source = selected || (this.branchDetails?.branchName === target ? this.branchDetails : null);\n    if (!source) {\n      return;\n    }\n    this.deliveryID = source._id || null;\n    this.deliveryBranch = source.branchName || target;\n    this.deliveryName = source.branchName || target;\n    this.deliveryAddress = this.formatBranchAddress(source);\n    this.deliveryPhone = source.phoneNum || '';\n    this.deliveryPincode = String(source.pinCode || '').trim();\n    this.deliveryLocationIndex = '';\n    this.deliveryLocationId = null;\n    this.deliveryClientId = null;\n    this.onRouteChange();\n  }\n  updateDeliveryFromHub() {\n    const target = String(this.deliveryHub || '').trim();\n    if (!target) {\n      this.deliveryID = null;\n      this.deliveryName = '';\n      this.deliveryAddress = '';\n      this.deliveryPhone = '';\n      this.deliveryPincode = '';\n      this.deliveryLocationIndex = '';\n      this.deliveryLocationId = null;\n      this.deliveryClientId = null;\n      return;\n    }\n    const hub = (this.hubs || []).find(h => h.hubName === target) || null;\n    if (!hub) {\n      return;\n    }\n    this.deliveryID = hub._id || null;\n    this.deliveryName = hub.hubName || target;\n    this.deliveryAddress = hub.address || '';\n    this.deliveryPhone = hub.phoneNum || '';\n    this.deliveryPincode = String(hub.pinCode || '').trim();\n    this.deliveryLocationIndex = '';\n    this.deliveryLocationId = null;\n    this.deliveryClientId = null;\n    this.onRouteChange();\n  }\n  getAvailableHubs() {\n    if (this.branch && this.branch !== 'All Branches') {\n      return (this.hubs || []).filter(h => String(h?.branch || '') === this.branch);\n    }\n    return this.hubs || [];\n  }\n  loadBranchDetails() {\n    this.http.get('http://localhost:3000/api/branches').subscribe({\n      next: branches => {\n        this.branches = branches || [];\n        this.branchDetails = this.branches.find(b => b.branchName === this.branch) || null;\n        this.updatePickupFromBranch();\n        if (this.deliveryType === 'branch') {\n          this.updateDeliveryFromBranch();\n        }\n      },\n      error: () => {\n        this.branches = [];\n        this.branchDetails = null;\n        this.updatePickupFromBranch();\n      }\n    });\n  }\n  updatePaymentModeAvailability(consignorName) {\n    const name = (consignorName ?? this.consignor ?? '').trim();\n    const client = this.clientList.find(x => x.clientName === name);\n    const creditType = String(client?.creditType || '').toLowerCase();\n    this.allowAccountCredit = creditType === 'credit' || creditType === 'credit allowed';\n    this.paymentMode = this.allowAccountCredit ? 'Account Credit' : 'To Pay';\n    this.onPaymentModeChange();\n  }\n  isPaymentModeEnabled() {\n    return Boolean((this.consignor || '').trim());\n  }\n  getSuggestedRate(product) {\n    const name = String(product?.type || '').trim();\n    if (!name) return null;\n    const value = this.suggestedRates[name];\n    if (value === null || value === undefined) return null;\n    return Number(value) || 0;\n  }\n  loadPricingSuggestions(clientId) {\n    if (!this.branch || this.branch === 'All Branches') return;\n    const params = clientId ? `branch=${encodeURIComponent(this.branch)}&clientId=${clientId}` : `branch=${encodeURIComponent(this.branch)}`;\n    const routeParams = [`pickupPincode=${encodeURIComponent(this.pickupPincode)}`, `deliveryPincode=${encodeURIComponent(this.deliveryPincode)}`, `rateUnit=${encodeURIComponent(this.rateUnit)}`].join('&');\n    this.http.get(`http://localhost:3000/api/pricing/suggestions?${params}&${routeParams}`).subscribe({\n      next: res => {\n        if (res?.pricing) {\n          this.productList = res.pricing;\n          this.suggestedRates = {};\n          res.pricing.forEach(p => {\n            if (p?.suggestedRate !== null && p?.suggestedRate !== undefined) {\n              this.suggestedRates[p.productName] = Number(p.suggestedRate) || 0;\n            }\n          });\n        }\n      },\n      error: () => {}\n    });\n  }\n  getClientIdByLocationId(id) {\n    if (!id) return null;\n    const client = this.clientList.find(c => Array.isArray(c?.deliveryLocations) && c.deliveryLocations.some(loc => this.getLocationId(loc) === id));\n    return client?._id || null;\n  }\n  getClientIdForPricing() {\n    const billingClientId = this.getClientIdByLocationId(this.billingLocationId);\n    if (billingClientId) return billingClientId;\n    if (this.billingClientId) return this.billingClientId;\n    return this.selectedConsignorId;\n  }\n  getPricingGstinId() {\n    const clientId = this.getClientIdForPricing();\n    const client = this.clientList.find(c => c?._id === clientId);\n    const gstin = (client?.GSTIN || '').trim();\n    if (gstin) return gstin;\n    const billingGstin = String(this.billingGSTIN || '').trim();\n    if (billingGstin) return billingGstin;\n    return '-';\n  }\n  refreshPricingSuggestions() {\n    const clientId = this.getClientIdForPricing();\n    if (!clientId) {\n      this.suggestedRates = {};\n      return;\n    }\n    this.loadPricingSuggestions(clientId);\n  }\n  // QUICK ADD CLIENT/GUEST\n  openClientModal() {\n    if (!this.branch || this.branch === 'All Branches') {\n      alert('Select a branch before adding a client.');\n      return;\n    }\n    this.clientModalTab = 'add';\n    this.newClient = {\n      clientName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      GSTIN: '',\n      phoneNum: '',\n      perDis: 0,\n      creditType: 'no-credit',\n      products: [],\n      deliveryLocations: [{\n        address: '',\n        city: '',\n        state: '',\n        pinCode: ''\n      }],\n      status: 'active',\n      branch: this.branch\n    };\n    this.clientError = '';\n    this.editClientError = '';\n    this.selectedEditClientId = '';\n    this.showClientModal = true;\n  }\n  setClientModalTab(tab) {\n    this.clientModalTab = tab;\n    if (tab === 'edit') {\n      this.loadEditableClients();\n    }\n  }\n  loadEditableClients() {\n    if (!this.branch || this.branch === 'All Branches') return;\n    this.http.get(`http://localhost:3000/api/clients?branch=${encodeURIComponent(this.branch)}`).subscribe({\n      next: res => this.editableClientList = res || [],\n      error: () => {\n        this.editableClientList = [];\n      }\n    });\n  }\n  onEditClientSelect(id) {\n    const c = this.editableClientList.find(x => x._id === id);\n    if (!c) return;\n    this.editClient = {\n      _id: c._id,\n      clientName: c.clientName || '',\n      GSTIN: c.GSTIN || '',\n      phoneNum: c.phoneNum || '',\n      address: c.address || '',\n      city: c.city || '',\n      state: c.state || '',\n      pinCode: c.pinCode || '',\n      branch: c.branch || '',\n      deliveryLocations: Array.isArray(c.deliveryLocations) ? c.deliveryLocations.map(d => ({\n        address: d.address || '',\n        city: d.city || '',\n        state: d.state || '',\n        pinCode: d.pinCode || ''\n      })) : []\n    };\n    if (!this.editClient.deliveryLocations.length) {\n      this.editClient.deliveryLocations = [{\n        address: '',\n        city: '',\n        state: '',\n        pinCode: ''\n      }];\n    }\n    this.editClientError = '';\n  }\n  addEditDeliveryLocation() {\n    if (!Array.isArray(this.editClient.deliveryLocations)) {\n      this.editClient.deliveryLocations = [];\n    }\n    this.editClient.deliveryLocations.push({\n      address: '',\n      city: '',\n      state: '',\n      pinCode: ''\n    });\n  }\n  removeEditDeliveryLocation(index) {\n    this.editClient.deliveryLocations.splice(index, 1);\n  }\n  openGuestModal() {\n    this.newGuest = {\n      guestName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perDis: 0\n    };\n    this.guestError = '';\n    this.showGuestModal = true;\n  }\n  saveNewClient() {\n    this.clientError = '';\n    if (!this.newClient.clientName || !this.newClient.address || !this.newClient.GSTIN || !this.newClient.phoneNum || !this.newClient.branch) {\n      this.clientError = 'Please fill required fields (name, address, GSTIN, phone, branch).';\n      return;\n    }\n    if (this.newClient.branch === 'All Branches') {\n      this.clientError = 'Select a specific branch before adding a client.';\n      return;\n    }\n    this.http.post('http://localhost:3000/api/clients/add', this.newClient).subscribe({\n      next: client => {\n        this.clientList = [client, ...this.clientList];\n        this.consignor = client.clientName;\n        this.onConsignorSelect(this.consignor);\n        this.showClientModal = false;\n      },\n      error: err => {\n        this.clientError = err?.error?.message || 'Failed to save client.';\n      }\n    });\n  }\n  saveEditedClient() {\n    this.editClientError = '';\n    if (!this.selectedEditClientId) {\n      this.editClientError = 'Select a client to edit.';\n      return;\n    }\n    const payload = {\n      deliveryLocations: (this.editClient.deliveryLocations || []).filter(d => d?.address)\n    };\n    this.http.put(`http://localhost:3000/api/clients/${this.selectedEditClientId}`, payload).subscribe({\n      next: () => {\n        this.showClientModal = false;\n      },\n      error: err => {\n        this.editClientError = err?.error?.message || 'Failed to update client.';\n      }\n    });\n  }\n  saveNewGuest() {\n    this.guestError = '';\n    if (!this.newGuest.guestName || !this.newGuest.address || !this.newGuest.phoneNum) {\n      this.guestError = 'Please fill required fields (name, address, phone).';\n      return;\n    }\n    this.http.post('http://localhost:3000/api/guests/add', this.newGuest).subscribe({\n      next: guest => {\n        this.guestList = [guest, ...this.guestList];\n        if (this.consignorTab === 'guest') {\n          this.consignor = guest.guestName;\n          this.onConsignorGuestSelect(this.consignor);\n        }\n        this.showGuestModal = false;\n      },\n      error: err => {\n        this.guestError = err?.error?.message || 'Failed to save guest.';\n      }\n    });\n  }\n  closeModals() {\n    this.showClientModal = false;\n    this.showGuestModal = false;\n  }\n  addClientProduct() {\n    this.newClient.products.push({\n      hsnNum: '',\n      productName: '',\n      ratePerNum: 0,\n      ratePerVolume: 0,\n      ratePerKg: 0\n    });\n  }\n  removeClientProduct(index) {\n    this.newClient.products.splice(index, 1);\n  }\n  addDeliveryLocation() {\n    this.newClient.deliveryLocations.push({\n      address: '',\n      city: '',\n      state: '',\n      pinCode: ''\n    });\n  }\n  removeDeliveryLocation(index) {\n    this.newClient.deliveryLocations.splice(index, 1);\n  }\n};\n__decorate([HostListener('window:beforeunload')], NewShipmentComponent.prototype, \"onBeforeUnload\", null);\nNewShipmentComponent = __decorate([Component({\n  selector: 'app-new-shipment',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './new-shipment.component.html',\n  styleUrls: ['./new-shipment.component.css']\n})], NewShipmentComponent);\nexport { NewShipmentComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}