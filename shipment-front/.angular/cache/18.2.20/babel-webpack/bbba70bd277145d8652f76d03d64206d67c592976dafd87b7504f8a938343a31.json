{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { RouterModule } from '@angular/router';\nimport { forkJoin } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/common\";\nimport * as i3 from \"@angular/forms\";\nfunction BranchVehiclesComponent_tr_20_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\", 6);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_tr_20_Template_tr_click_0_listener() {\n      const v_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.openVehicleManifests(v_r2));\n    });\n    i0.ɵɵelementStart(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"td\");\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"td\");\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"td\");\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"td\")(12, \"button\", 7);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_tr_20_Template_button_click_12_listener($event) {\n      const v_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.openEditLocation(v_r2, $event));\n    });\n    i0.ɵɵtext(13, \"Edit\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const v_r2 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.branchName);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.vehicleNo);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(v_r2.driverPhone);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.formatVehicleStatus(v_r2.vehicleStatus));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.getVehicleCurrentBranchLabel(v_r2));\n  }\n}\nfunction BranchVehiclesComponent_tr_21_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 8);\n    i0.ɵɵtext(2, \"No vehicles found.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction BranchVehiclesComponent_div_22_option_13_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 19);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const opt_r5 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", opt_r5.value);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", opt_r5.label, \" \");\n  }\n}\nfunction BranchVehiclesComponent_div_22_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 9)(1, \"div\", 10)(2, \"span\", 11);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_span_click_2_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeEditLocationPopup());\n    });\n    i0.ɵɵtext(3, \"\\u00D7\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"h3\");\n    i0.ɵɵtext(5, \"Edit Vehicle Activity\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"p\", 12);\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"label\");\n    i0.ɵɵtext(9, \" Current Branch \");\n    i0.ɵɵelementStart(10, \"select\", 13);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function BranchVehiclesComponent_div_22_Template_select_ngModelChange_10_listener($event) {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.editLocationValue, $event) || (ctx_r2.editLocationValue = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementStart(11, \"option\", 14);\n    i0.ɵɵtext(12, \"Select a location\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(13, BranchVehiclesComponent_div_22_option_13_Template, 2, 2, \"option\", 15);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(14, \"div\", 16)(15, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_button_click_15_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.saveEditLocation());\n    });\n    i0.ɵɵtext(16, \"Save\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(17, \"button\", 18);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_22_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeEditLocationPopup());\n    });\n    i0.ɵɵtext(18, \"Cancel\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵtextInterpolate1(\"Vehicle: \", (ctx_r2.editLocationVehicle == null ? null : ctx_r2.editLocationVehicle.vehicleNo) || \"-\", \"\");\n    i0.ɵɵadvance(3);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.editLocationValue);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.getLocationOptions());\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", !ctx_r2.editLocationValue);\n  }\n}\nfunction BranchVehiclesComponent_div_23_p_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"Loading manifests...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_23_p_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"No manifests found.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_23_div_8_div_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 29);\n    i0.ɵɵtext(1, \"No consignments.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_23_div_8_div_17_span_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \"No products.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BranchVehiclesComponent_div_23_div_8_div_17_span_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 35);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const p_r7 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" \", p_r7.name, \" (\", p_r7.qty, \") \");\n  }\n}\nfunction BranchVehiclesComponent_div_23_div_8_div_17_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 30)(1, \"div\", 31)(2, \"span\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"span\", 32);\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"div\", 33);\n    i0.ɵɵtemplate(7, BranchVehiclesComponent_div_23_div_8_div_17_span_7_Template, 2, 0, \"span\", 4)(8, BranchVehiclesComponent_div_23_div_8_div_17_span_8_Template, 2, 2, \"span\", 34);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const c_r8 = ctx.$implicit;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(c_r8.consignmentNumber);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(c_r8.shipmentStatus || \"-\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", !c_r8.products.length);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", c_r8.products);\n  }\n}\nfunction BranchVehiclesComponent_div_23_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22)(1, \"div\", 23)(2, \"div\")(3, \"strong\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"span\", 24);\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(7, \"div\", 25);\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(9, \"div\", 25);\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"div\", 25);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"div\", 26)(14, \"h4\");\n    i0.ɵɵtext(15, \"Consignments\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(16, BranchVehiclesComponent_div_23_div_8_div_16_Template, 2, 0, \"div\", 27)(17, BranchVehiclesComponent_div_23_div_8_div_17_Template, 9, 4, \"div\", 28);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const m_r9 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(m_r9.manifestNumber || \"-\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.formatVehicleStatus(m_r9.status));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Vehicle: \", m_r9.vehicleNo || \"-\", \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Pickup: \", m_r9.pickup || \"-\", \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Drop: \", m_r9.drop || \"-\", \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", !m_r9.consignments.length);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", m_r9.consignments);\n  }\n}\nfunction BranchVehiclesComponent_div_23_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 9)(1, \"div\", 20)(2, \"span\", 11);\n    i0.ɵɵlistener(\"click\", function BranchVehiclesComponent_div_23_Template_span_click_2_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.closeVehicleManifests());\n    });\n    i0.ɵɵtext(3, \"\\u00D7\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"h3\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, BranchVehiclesComponent_div_23_p_6_Template, 2, 0, \"p\", 4)(7, BranchVehiclesComponent_div_23_p_7_Template, 2, 0, \"p\", 4)(8, BranchVehiclesComponent_div_23_div_8_Template, 18, 7, \"div\", 21);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\"Vehicle Manifests: \", ctx_r2.selectedVehicleNo, \"\");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.manifestsLoading);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.manifestsLoading && ctx_r2.selectedVehicleManifests.length === 0);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.selectedVehicleManifests);\n  }\n}\nexport let BranchVehiclesComponent = /*#__PURE__*/(() => {\n  class BranchVehiclesComponent {\n    constructor(http) {\n      this.http = http;\n      this.branches = [];\n      this.hubs = [];\n      this.manifests = [];\n      this.scheduledVehicleSet = new Set();\n      this.latestManifestStatusByVehicle = new Map();\n      this.showVehicleManifestPopup = false;\n      this.manifestsLoading = false;\n      this.selectedVehicleNo = '';\n      this.selectedVehicleManifests = [];\n      this.isAdmin = String(localStorage.getItem('role') || '').toLowerCase() === 'admin';\n      this.vehicles = [];\n      this.branchId = localStorage.getItem('branchId') || 'all';\n      this.branchName = localStorage.getItem('branch') || 'All Branches';\n      this.showEditLocationPopup = false;\n      this.editLocationVehicle = null;\n      this.editLocationValue = '';\n      this.onStorage = e => {\n        if (e.key === 'branch' || e.key === 'branchId') {\n          this.branchName = localStorage.getItem('branch') || 'All Branches';\n          this.branchId = localStorage.getItem('branchId') || 'all';\n          this.loadBranches();\n          this.loadHubs();\n          this.loadManifests();\n        }\n      };\n    }\n    ngOnInit() {\n      this.loadBranches();\n      this.loadHubs();\n      this.loadManifests();\n      this.branchCheck = setInterval(() => {\n        const current = localStorage.getItem('branch') || 'All Branches';\n        const currentId = localStorage.getItem('branchId') || 'all';\n        if (current !== this.branchName || currentId !== this.branchId) {\n          this.branchName = current;\n          this.branchId = currentId;\n          this.loadManifests();\n          this.buildVehicles();\n        }\n      }, 1000);\n      this.refreshTimer = setInterval(() => {\n        this.loadBranches();\n        this.loadHubs();\n        this.loadManifests();\n      }, 5000);\n      window.addEventListener('storage', this.onStorage);\n    }\n    ngOnDestroy() {\n      if (this.branchCheck) clearInterval(this.branchCheck);\n      if (this.refreshTimer) clearInterval(this.refreshTimer);\n      window.removeEventListener('storage', this.onStorage);\n    }\n    loadHubs() {\n      const ts = Date.now();\n      this.http.get(`http://localhost:3000/api/hubs?ts=${ts}`).subscribe({\n        next: data => {\n          this.hubs = data || [];\n          this.buildVehicles();\n        },\n        error: err => console.error('Error loading hubs:', err)\n      });\n    }\n    loadBranches() {\n      const ts = Date.now();\n      this.http.get(`http://localhost:3000/api/branches?ts=${ts}`).subscribe({\n        next: data => {\n          this.branches = data || [];\n          this.buildVehicles();\n        },\n        error: err => console.error('Error loading branches:', err)\n      });\n    }\n    loadManifests() {\n      const params = {};\n      if (this.branchId && this.branchId !== 'all' && this.branchId !== 'all-hubs') {\n        params.entityType = 'branch';\n        params.entityId = this.branchId;\n      }\n      this.http.get(`http://localhost:3000/api/manifests`, {\n        params\n      }).subscribe({\n        next: data => {\n          this.manifests = Array.isArray(data) ? data : [];\n          this.buildScheduledVehicleSet();\n          this.buildVehicles();\n        },\n        error: err => console.error('Error loading manifests:', err)\n      });\n    }\n    buildVehicles() {\n      const branchId = this.branchId || 'all';\n      const branchName = String(this.branchName || '').trim().toLowerCase();\n      const isAllHubs = branchId === 'all-hubs';\n      const isAllBranches = branchId === 'all';\n      const assignedBranchIds = this.isAdmin ? [] : this.getAssignedBranchIds();\n      const filtered = this.isAdmin ? this.branches || [] : assignedBranchIds.length ? (this.branches || []).filter(b => assignedBranchIds.includes(String(b?._id || '').trim())) : [];\n      const rows = [];\n      if (!isAllHubs) {\n        (filtered || []).forEach(b => {\n          const list = Array.isArray(b?.vehicles) ? b.vehicles : [];\n          list.forEach(v => {\n            const vehicleNo = String(v?.vehicleNo || '').trim();\n            const driverPhone = String(v?.driverPhone || '').trim();\n            const currentLocationId = this.normalizeId(b?._id);\n            const vehicleCurrentLocationId = this.normalizeId(v?.currentLocationId || v?.currentBranch);\n            const vehicleCurrentLocationType = String(v?.currentLocationType || '').trim().toLowerCase();\n            if (!vehicleNo && !driverPhone) return;\n            if (!isAllBranches && !this.matchesBranchFilter(currentLocationId, branchId, branchName)) return;\n            rows.push({\n              branchId: String(b?._id || ''),\n              branchName: b?.branchName || '',\n              branchStatus: b?.status || '',\n              vehicleNo,\n              vehicleStatus: this.resolveVehicleStatus(vehicleNo, v?.vehicleStatus),\n              driverPhone,\n              currentLocationId,\n              vehicleCurrentLocationId,\n              vehicleCurrentLocationType,\n              sourceType: 'branch',\n              sourceId: String(b?._id || '')\n            });\n          });\n        });\n      }\n      const hubs = this.isAdmin ? this.hubs || [] : assignedBranchIds.length ? (this.hubs || []).filter(h => assignedBranchIds.includes(String(h?.branchId || '').trim())) : [];\n      (hubs || []).forEach(h => {\n        const deliveryAddresses = Array.isArray(h?.deliveryAddresses) ? h.deliveryAddresses : [];\n        deliveryAddresses.forEach(addr => {\n          const list = Array.isArray(addr?.vehicles) ? addr.vehicles : [];\n          list.forEach(v => {\n            const vehicleNo = String(v?.vehicleNo || '').trim();\n            const driverPhone = String(v?.driverPhone || '').trim();\n            const currentLocationId = this.normalizeId(h?._id);\n            const vehicleCurrentLocationId = this.normalizeId(v?.currentLocationId || v?.currentBranch);\n            const vehicleCurrentLocationType = String(v?.currentLocationType || '').trim().toLowerCase();\n            if (!vehicleNo && !driverPhone) return;\n            if (!isAllBranches && !isAllHubs && !this.matchesBranchFilter(currentLocationId, branchId, branchName)) return;\n            rows.push({\n              branchId: String(h?._id || ''),\n              branchName: h?.hubName || '',\n              branchStatus: h?.status || '',\n              vehicleNo,\n              vehicleStatus: this.resolveVehicleStatus(vehicleNo, v?.vehicleStatus),\n              driverPhone,\n              currentLocationId,\n              vehicleCurrentLocationId,\n              vehicleCurrentLocationType,\n              sourceType: 'hub',\n              sourceId: String(h?._id || '')\n            });\n          });\n        });\n      });\n      this.vehicles = rows;\n    }\n    matchesBranchFilter(currentLocationId, branchId, branchName) {\n      const raw = String(currentLocationId || '').trim();\n      if (!raw) return false;\n      const targetName = String(branchName || '').trim().toLowerCase();\n      const rawLower = raw.toLowerCase();\n      if (rawLower === targetName) return true;\n      if (String(raw) === String(branchId)) return true;\n      const branch = (this.branches || []).find(b => String(b?._id || '') === raw);\n      if (branch?.branchName && String(branch.branchName).trim().toLowerCase() === targetName) return true;\n      const hub = (this.hubs || []).find(h => String(h?._id || '') === raw);\n      if (hub?.hubName && String(hub.hubName).trim().toLowerCase() === targetName) return true;\n      return this.matchesBranchLabel(raw, String(branchName || ''));\n    }\n    matchesBranchLabel(currentBranch, branchLabel) {\n      const current = String(currentBranch || '').trim().toLowerCase();\n      const label = String(branchLabel || '').trim().toLowerCase();\n      if (!current || !label) return false;\n      if (label === current) return true;\n      if (label.startsWith(`${current}-`)) return true;\n      const labelPrefix = label.split('-')[0].trim();\n      return Boolean(labelPrefix) && labelPrefix === current;\n    }\n    normalizeId(value) {\n      if (!value) return '';\n      if (typeof value === 'string') return value;\n      if (value?._id) return String(value._id);\n      if (value?.$oid) return String(value.$oid);\n      return String(value);\n    }\n    getAssignedBranchIds() {\n      try {\n        const storedIds = JSON.parse(localStorage.getItem('branchIds') || '[]');\n        if (!Array.isArray(storedIds)) return [];\n        return storedIds.map(id => String(id || '').trim()).filter(id => id);\n      } catch {\n        return [];\n      }\n    }\n    toggleBranchStatus(branchId) {\n      if (!branchId) return;\n      this.http.patch(`http://localhost:3000/api/branches/${branchId}/status`, {}).subscribe({\n        next: () => this.loadBranches(),\n        error: err => console.error('Error updating branch status:', err)\n      });\n    }\n    openEditLocation(vehicle, event) {\n      if (event) event.stopPropagation();\n      if (!vehicle?.vehicleNo) return;\n      this.editLocationVehicle = vehicle;\n      const currentId = this.normalizeId(vehicle?.vehicleCurrentLocationId);\n      const currentType = String(vehicle?.vehicleCurrentLocationType || '').trim().toLowerCase();\n      if (currentId && currentType) {\n        this.editLocationValue = `${currentType}:${currentId}`;\n      } else if (vehicle?.currentLocationId && vehicle?.sourceType) {\n        this.editLocationValue = `${vehicle.sourceType}:${vehicle.currentLocationId}`;\n      } else {\n        this.editLocationValue = '';\n      }\n      this.showEditLocationPopup = true;\n    }\n    closeEditLocationPopup() {\n      this.showEditLocationPopup = false;\n      this.editLocationVehicle = null;\n      this.editLocationValue = '';\n    }\n    saveEditLocation() {\n      if (!this.editLocationVehicle || !this.editLocationValue) return;\n      const [type, id] = String(this.editLocationValue).split(':');\n      if (!type || !id) return;\n      const endpoint = this.editLocationVehicle.sourceType === 'hub' ? `http://localhost:3000/api/hubs/${this.editLocationVehicle.sourceId}/vehicle-status` : `http://localhost:3000/api/branches/${this.editLocationVehicle.sourceId}/vehicle-status`;\n      this.http.patch(endpoint, {\n        vehicleNo: this.editLocationVehicle.vehicleNo,\n        vehicleStatus: this.editLocationVehicle.vehicleStatus || 'online',\n        currentLocationId: id,\n        currentLocationType: type\n      }).subscribe({\n        next: () => {\n          this.closeEditLocationPopup();\n          this.loadBranches();\n          this.loadHubs();\n          this.loadManifests();\n        },\n        error: err => console.error('Error updating vehicle location:', err)\n      });\n    }\n    openVehicleManifests(vehicle) {\n      const vehicleNo = String(vehicle?.vehicleNo || '').trim();\n      if (!vehicleNo) return;\n      const target = vehicleNo.toLowerCase();\n      const manifestMatches = (this.manifests || []).filter(m => String(m?.vehicleNo || '').trim().toLowerCase() === target).filter(m => String(m?.status || '').trim().toLowerCase() !== 'completed');\n      this.selectedVehicleNo = vehicleNo;\n      this.showVehicleManifestPopup = true;\n      this.manifestsLoading = true;\n      if (!manifestMatches.length) {\n        this.selectedVehicleManifests = [];\n        this.manifestsLoading = false;\n        return;\n      }\n      const consignmentNumbers = Array.from(new Set(manifestMatches.flatMap(m => Array.isArray(m?.items) ? m.items : []).map(i => String(i?.consignmentNumber || '').trim()).filter(Boolean)));\n      if (!consignmentNumbers.length) {\n        this.selectedVehicleManifests = manifestMatches.map(m => ({\n          manifestNumber: String(m?.manifestNumber || ''),\n          status: String(m?.status || ''),\n          vehicleNo: String(m?.vehicleNo || ''),\n          pickup: this.resolveManifestPickup(m),\n          drop: this.resolveManifestDrop(m),\n          consignments: []\n        }));\n        this.manifestsLoading = false;\n        return;\n      }\n      const calls = consignmentNumbers.map(consignmentNumber => this.http.get(`http://localhost:3000/api/newshipments/getConsignment`, {\n        params: {\n          consignmentNumber\n        }\n      }));\n      forkJoin(calls).subscribe({\n        next: responses => {\n          const consignments = responses.flatMap(r => Array.isArray(r) ? r : []);\n          const byNumber = new Map(consignments.map(c => [String(c?.consignmentNumber || ''), c]));\n          this.selectedVehicleManifests = manifestMatches.map(m => {\n            const items = Array.isArray(m?.items) ? m.items : [];\n            const manifestConsignments = items.map(item => {\n              const consignmentNumber = String(item?.consignmentNumber || '').trim();\n              const shipment = byNumber.get(consignmentNumber);\n              const products = this.buildShipmentProductSummary(shipment);\n              return {\n                consignmentNumber,\n                shipmentStatus: String(shipment?.shipmentStatus || ''),\n                products\n              };\n            }).filter(c => c.consignmentNumber);\n            return {\n              manifestNumber: String(m?.manifestNumber || ''),\n              status: String(m?.status || ''),\n              vehicleNo: String(m?.vehicleNo || ''),\n              pickup: this.resolveManifestPickup(m),\n              drop: this.resolveManifestDrop(m),\n              consignments: manifestConsignments\n            };\n          });\n          this.manifestsLoading = false;\n        },\n        error: err => {\n          console.error('Error loading vehicle manifests', err);\n          this.selectedVehicleManifests = [];\n          this.manifestsLoading = false;\n        }\n      });\n    }\n    closeVehicleManifests() {\n      this.showVehicleManifestPopup = false;\n      this.selectedVehicleNo = '';\n      this.selectedVehicleManifests = [];\n      this.manifestsLoading = false;\n    }\n    getCurrentBranchLabel(value) {\n      const raw = this.normalizeId(value);\n      if (!raw) return '-';\n      const branch = (this.branches || []).find(b => String(b?._id || '') === raw);\n      if (branch?.branchName) return branch.branchName;\n      const byName = (this.branches || []).find(b => String(b?.branchName || '').trim().toLowerCase() === raw.toLowerCase());\n      if (byName?.branchName) return byName.branchName;\n      const byPrefix = (this.branches || []).find(b => this.matchesBranchLabel(raw, String(b?.branchName || '')));\n      if (byPrefix?.branchName) return byPrefix.branchName;\n      const hub = (this.hubs || []).find(h => String(h?._id || '') === raw);\n      if (hub?.hubName) return hub.hubName;\n      return raw;\n    }\n    getVehicleCurrentBranchLabel(vehicle) {\n      const id = this.normalizeId(vehicle?.vehicleCurrentLocationId || '');\n      if (!id) return '-';\n      return this.getCurrentBranchLabel(id);\n    }\n    getLocationOptions() {\n      const options = [];\n      (this.branches || []).forEach(b => {\n        const id = this.normalizeId(b?._id);\n        if (!id) return;\n        const name = String(b?.branchName || '').trim();\n        options.push({\n          value: `branch:${id}`,\n          label: `Branch: ${name || id}`\n        });\n      });\n      (this.hubs || []).forEach(h => {\n        const id = this.normalizeId(h?._id);\n        if (!id) return;\n        const name = String(h?.hubName || '').trim();\n        options.push({\n          value: `hub:${id}`,\n          label: `Hub: ${name || id}`\n        });\n      });\n      return options;\n    }\n    formatVehicleStatus(status) {\n      const value = String(status || '').trim().toLowerCase();\n      if (!value) return '';\n      return value.charAt(0).toUpperCase() + value.slice(1);\n    }\n    buildScheduledVehicleSet() {\n      const latestByVehicle = new Map();\n      (this.manifests || []).forEach(m => {\n        const vehicleNo = String(m?.vehicleNo || '').trim().toLowerCase();\n        if (!vehicleNo) return;\n        const status = String(m?.status || '').trim().toLowerCase();\n        const tsSource = m?.deliveredAt || m?.updatedAt || m?.createdAt;\n        const ts = tsSource ? new Date(tsSource).getTime() : 0;\n        const existing = latestByVehicle.get(vehicleNo);\n        if (!existing || ts >= existing.ts) {\n          latestByVehicle.set(vehicleNo, {\n            status,\n            ts\n          });\n        }\n      });\n      const scheduled = new Set();\n      const latestStatus = new Map();\n      latestByVehicle.forEach((info, vehicleNo) => {\n        if (info.status === 'scheduled') scheduled.add(vehicleNo);\n        latestStatus.set(vehicleNo, info.status);\n      });\n      this.scheduledVehicleSet = scheduled;\n      this.latestManifestStatusByVehicle = latestStatus;\n    }\n    resolveVehicleStatus(vehicleNo, fallback) {\n      const key = String(vehicleNo || '').trim().toLowerCase();\n      if (!key) return String(fallback || 'online');\n      if (this.scheduledVehicleSet.has(key)) return 'scheduled';\n      const latest = this.latestManifestStatusByVehicle.get(key);\n      if (!latest) return 'completed';\n      if (latest === 'completed') return 'completed';\n      return String(fallback || 'online');\n    }\n    resolveManifestPickup(manifest) {\n      const entityType = String(manifest?.entityType || '').trim().toLowerCase();\n      const entityId = this.normalizeId(manifest?.entityId);\n      return this.resolveLocationName(entityType, entityId);\n    }\n    resolveManifestDrop(manifest) {\n      const deliveryType = String(manifest?.deliveryType || '').trim().toLowerCase();\n      const deliveryId = this.normalizeId(manifest?.deliveryId);\n      if (deliveryType && deliveryId) {\n        return this.resolveLocationName(deliveryType, deliveryId);\n      }\n      return this.resolveManifestPickup(manifest);\n    }\n    resolveLocationName(entityType, entityId) {\n      if (!entityType || !entityId) return '-';\n      if (entityType === 'hub') {\n        const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === entityId);\n        return hub?.hubName ? String(hub.hubName).trim() : entityId;\n      }\n      const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === entityId);\n      return branch?.branchName ? String(branch.branchName).trim() : entityId;\n    }\n    buildShipmentProductSummary(shipment) {\n      if (!shipment) return [];\n      const invoices = Array.isArray(shipment?.ewaybills) ? shipment.ewaybills.flatMap(ewb => ewb?.invoices || []) : shipment?.invoices || [];\n      const products = invoices.flatMap(inv => inv?.products || []);\n      const summary = new Map();\n      products.forEach(p => {\n        const name = String(p?.type || p?.productName || '').trim();\n        if (!name) return;\n        const qty = Number(p?.amount) || 0;\n        summary.set(name, (summary.get(name) || 0) + qty);\n      });\n      return Array.from(summary.entries()).map(([name, qty]) => ({\n        name,\n        qty\n      }));\n    }\n    static {\n      this.ɵfac = function BranchVehiclesComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || BranchVehiclesComponent)(i0.ɵɵdirectiveInject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: BranchVehiclesComponent,\n        selectors: [[\"app-branch-vehicles\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 24,\n        vars: 5,\n        consts: [[1, \"branch-vehicles-container\"], [1, \"branch-subtitle\"], [1, \"vehicles-table-wrapper\"], [\"class\", \"clickable-row\", 3, \"click\", 4, \"ngFor\", \"ngForOf\"], [4, \"ngIf\"], [\"class\", \"modal\", 4, \"ngIf\"], [1, \"clickable-row\", 3, \"click\"], [\"type\", \"button\", 1, \"link-button\", 3, \"click\"], [\"colspan\", \"6\"], [1, \"modal\"], [1, \"modal-content\"], [1, \"close\", 3, \"click\"], [1, \"modal-subtitle\"], [3, \"ngModelChange\", \"ngModel\"], [\"value\", \"\", \"disabled\", \"\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [1, \"terminal-buttons\"], [\"type\", \"button\", 3, \"click\", \"disabled\"], [\"type\", \"button\", 3, \"click\"], [3, \"value\"], [1, \"modal-content\", \"vehicle-manifest-modal\"], [\"class\", \"manifest-card\", 4, \"ngFor\", \"ngForOf\"], [1, \"manifest-card\"], [1, \"manifest-header\"], [1, \"manifest-status\"], [1, \"manifest-meta\"], [1, \"manifest-consignments\"], [\"class\", \"manifest-empty\", 4, \"ngIf\"], [\"class\", \"consignment-row\", 4, \"ngFor\", \"ngForOf\"], [1, \"manifest-empty\"], [1, \"consignment-row\"], [1, \"consignment-header\"], [1, \"consignment-status\"], [1, \"consignment-products\"], [\"class\", \"product-pill\", 4, \"ngFor\", \"ngForOf\"], [1, \"product-pill\"]],\n        template: function BranchVehiclesComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ɵɵtext(2, \"Branch Vehicles\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"p\", 1);\n            i0.ɵɵtext(4);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"div\", 2)(6, \"table\")(7, \"tr\")(8, \"th\");\n            i0.ɵɵtext(9, \"Branch\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(10, \"th\");\n            i0.ɵɵtext(11, \"Vehicles num\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(12, \"th\");\n            i0.ɵɵtext(13, \"Phone\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(14, \"th\");\n            i0.ɵɵtext(15, \"Vehicle Status\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(16, \"th\");\n            i0.ɵɵtext(17, \"Current Branch\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(18, \"th\");\n            i0.ɵɵtext(19, \"Actions\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(20, BranchVehiclesComponent_tr_20_Template, 14, 5, \"tr\", 3)(21, BranchVehiclesComponent_tr_21_Template, 3, 0, \"tr\", 4);\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵtemplate(22, BranchVehiclesComponent_div_22_Template, 19, 4, \"div\", 5)(23, BranchVehiclesComponent_div_23_Template, 9, 4, \"div\", 5);\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(4);\n            i0.ɵɵtextInterpolate(ctx.branchId === \"all\" ? \"All Branches\" : ctx.branchId === \"all-hubs\" ? \"All Hubs\" : ctx.branchName);\n            i0.ɵɵadvance(16);\n            i0.ɵɵproperty(\"ngForOf\", ctx.vehicles);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.vehicles.length === 0);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showEditLocationPopup);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.showVehicleManifestPopup);\n          }\n        },\n        dependencies: [CommonModule, i2.NgForOf, i2.NgIf, FormsModule, i3.NgSelectOption, i3.ɵNgSelectMultipleOption, i3.SelectControlValueAccessor, i3.NgControlStatus, i3.NgModel, RouterModule],\n        styles: [\".branch-vehicles-container[_ngcontent-%COMP%]{padding:20px}.branch-subtitle[_ngcontent-%COMP%]{color:#6b7280;margin-top:4px}.vehicles-table-wrapper[_ngcontent-%COMP%]   table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin-top:12px}.vehicles-table-wrapper[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .vehicles-table-wrapper[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #e5e7eb;padding:8px;text-align:left}.vehicles-table-wrapper[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc}.clickable-row[_ngcontent-%COMP%]{cursor:pointer}.clickable-row[_ngcontent-%COMP%]:hover{background:#f9fafb}.modal[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:#fff;padding:20px;width:480px;max-width:90%;max-height:80vh;overflow-y:auto;border-radius:8px;position:relative}.vehicle-manifest-modal[_ngcontent-%COMP%]{width:720px}.close[_ngcontent-%COMP%]{position:absolute;right:15px;top:10px;font-size:24px;cursor:pointer}.terminal-buttons[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:12px;margin-top:12px}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 16px;border:none;border-radius:6px;cursor:pointer}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{background-color:#007acc;color:#fff}.terminal-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{background-color:#555;color:#fff}.link-button[_ngcontent-%COMP%]{background:none;border:none;padding:0;color:#2563eb;cursor:pointer;text-decoration:underline;font-size:14px}.modal-subtitle[_ngcontent-%COMP%]{color:#6b7280;margin:6px 0 12px}.manifest-card[_ngcontent-%COMP%]{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-top:12px;background:#f9fafb}.manifest-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}.manifest-status[_ngcontent-%COMP%]{margin-left:8px;font-size:12px;color:#6b7280}.manifest-meta[_ngcontent-%COMP%]{font-size:13px;color:#4b5563;margin-top:4px}.manifest-consignments[_ngcontent-%COMP%]{margin-top:10px}.consignment-row[_ngcontent-%COMP%]{border-top:1px dashed #d1d5db;padding-top:8px;margin-top:8px}.consignment-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-weight:600}.consignment-status[_ngcontent-%COMP%]{font-size:12px;color:#6b7280}.consignment-products[_ngcontent-%COMP%]{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;font-size:12px}.product-pill[_ngcontent-%COMP%]{background:#e0f2fe;color:#0f172a;padding:2px 6px;border-radius:999px}.manifest-empty[_ngcontent-%COMP%]{font-size:12px;color:#6b7280}\"]\n      });\n    }\n  }\n  return BranchVehiclesComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}