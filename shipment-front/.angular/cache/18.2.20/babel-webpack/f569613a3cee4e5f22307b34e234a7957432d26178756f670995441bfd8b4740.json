{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nlet HubComponent = class HubComponent {\n  constructor(http) {\n    this.http = http;\n    this.hubs = [];\n    this.branches = [];\n    this.showAddHubPopup = false;\n    this.showEditHubPopup = false;\n    this.showHubDetailsPopup = false;\n    this.lastHubName = '';\n    this.currentoriginLocId = localStorage.getItem('originLocId') || 'all';\n    this.newHub = {\n      hubName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perRev: '',\n      originLocId: localStorage.getItem('originLocId') || 'all',\n      deliveryAddresses: [{\n        location: '',\n        vehicles: [{\n          vehicleNo: '',\n          driverPhone: '',\n          vehicleStatus: 'online',\n          currentLocationId: ''\n        }]\n      }],\n      status: 'active'\n    };\n    this.editingHub = null;\n    this.selectedHub = null;\n    this.onStorage = e => {\n      if (e.key === 'originLocId') {\n        const currentId = localStorage.getItem('originLocId') || 'all';\n        if (currentId !== this.currentoriginLocId) {\n          this.currentoriginLocId = currentId;\n        }\n        this.loadHubs();\n      }\n    };\n  }\n  ngOnInit() {\n    localStorage.setItem('branch', 'All Branches');\n    this.newHub.originLocId = localStorage.getItem('originLocId') || 'all';\n    this.loadHubs();\n    this.loadBranches();\n    this.branchCheck = setInterval(() => {\n      const currentId = localStorage.getItem('originLocId') || 'all';\n      if (currentId !== this.currentoriginLocId) {\n        this.currentoriginLocId = currentId;\n        this.loadHubs();\n      }\n    }, 1000);\n    window.addEventListener('storage', this.onStorage);\n  }\n  ngOnDestroy() {\n    if (this.branchCheck) clearInterval(this.branchCheck);\n    window.removeEventListener('storage', this.onStorage);\n  }\n  loadHubs() {\n    this.http.get(`http://localhost:3000/api/hubs`).subscribe({\n      next: data => {\n        console.log(\"Hubs loaded:\", data);\n        this.hubs = data || [];\n      },\n      error: err => console.error(\"Error loading hubs:\", err)\n    });\n  }\n  loadBranches() {\n    this.http.get(`http://localhost:3000/api/branches`).subscribe({\n      next: data => {\n        this.branches = data;\n      },\n      error: err => console.error(\"Error loading branches:\", err)\n    });\n  }\n  openAddHubPopup() {\n    this.showAddHubPopup = true;\n    this.syncNewHubCurrentBranchDefaults();\n  }\n  closeAddHubPopup() {\n    this.showAddHubPopup = false;\n  }\n  closeEditHubPopup() {\n    this.showEditHubPopup = false;\n    this.editingHub = null;\n  }\n  openHubDetailsPopup(hub) {\n    this.selectedHub = hub;\n    this.showHubDetailsPopup = true;\n  }\n  closeHubDetailsPopup() {\n    this.showHubDetailsPopup = false;\n    this.selectedHub = null;\n  }\n  editHubFromDetails() {\n    if (!this.selectedHub) return;\n    const hub = this.selectedHub;\n    this.closeHubDetailsPopup();\n    this.editHub(hub);\n  }\n  addHub() {\n    const originLocId = localStorage.getItem('originLocId') || 'all';\n    if (!originLocId || originLocId === 'all' || originLocId === 'all-hubs') {\n      alert('Please select a specific branch before adding a hub.');\n      return;\n    }\n    this.syncNewHubCurrentBranchDefaults();\n    const payload = JSON.parse(JSON.stringify(this.newHub || {}));\n    payload.originLocId = originLocId;\n    (payload.deliveryAddresses || []).forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        v.currentLocationId = this.normalizeLocationId(v?.currentLocationId);\n        delete v.currentBranch;\n      });\n    });\n    this.http.post('http://localhost:3000/api/hubs/add', payload).subscribe({\n      next: () => {\n        alert('Hub added successfully!');\n        this.loadHubs();\n        this.resetForm();\n        this.closeAddHubPopup();\n      },\n      error: err => {\n        console.error('Error saving hub:', err);\n        alert('Error: ' + err.error?.message);\n      }\n    });\n  }\n  resetForm() {\n    this.newHub = {\n      hubName: '',\n      address: '',\n      city: '',\n      state: '',\n      pinCode: '',\n      phoneNum: '',\n      perRev: '',\n      originLocId: localStorage.getItem('originLocId') || 'all',\n      deliveryAddresses: [{\n        location: '',\n        vehicles: [{\n          vehicleNo: '',\n          driverPhone: '',\n          vehicleStatus: 'online',\n          currentLocationId: ''\n        }]\n      }],\n      status: 'active'\n    };\n    this.lastHubName = '';\n  }\n  /** ðŸ”¹ Add / Remove Address in Add Mode */\n  addAddress() {\n    this.newHub.deliveryAddresses.push({\n      location: '',\n      vehicles: [{\n        vehicleNo: '',\n        driverPhone: '',\n        vehicleStatus: 'online',\n        currentLocationId: ''\n      }]\n    });\n  }\n  removeAddress(i) {\n    this.newHub.deliveryAddresses.splice(i, 1);\n  }\n  /** ðŸ”¹ Add / Remove Vehicles in Add Mode */\n  addVehicle(addrIndex) {\n    this.newHub.deliveryAddresses[addrIndex].vehicles.push({\n      vehicleNo: '',\n      driverPhone: '',\n      vehicleStatus: 'online',\n      currentLocationId: ''\n    });\n  }\n  removeVehicle(addrIndex, vIndex) {\n    this.newHub.deliveryAddresses[addrIndex].vehicles.splice(vIndex, 1);\n  }\n  /** ðŸ”¹ Edit Mode */\n  editHub(hub) {\n    this.editingHub = JSON.parse(JSON.stringify(hub)); // Deep clone\n    this.ensureVehicleStatuses(this.editingHub);\n    (this.editingHub?.deliveryAddresses || []).forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        if (!v.currentLocationId && v.currentBranch) {\n          v.currentLocationId = this.normalizeLocationId(v.currentBranch);\n        }\n        delete v.currentBranch;\n      });\n    });\n    this.showEditHubPopup = true;\n  }\n  addAddressEdit() {\n    this.editingHub.deliveryAddresses.push({\n      location: '',\n      vehicles: [{\n        vehicleNo: '',\n        driverPhone: '',\n        vehicleStatus: 'online',\n        currentLocationId: ''\n      }]\n    });\n  }\n  removeAddressEdit(i) {\n    this.editingHub.deliveryAddresses.splice(i, 1);\n  }\n  addVehicleEdit(addrIndex) {\n    this.editingHub.deliveryAddresses[addrIndex].vehicles.push({\n      vehicleNo: '',\n      driverPhone: '',\n      vehicleStatus: 'online',\n      currentLocationId: ''\n    });\n  }\n  removeVehicleEdit(addrIndex, vIndex) {\n    this.editingHub.deliveryAddresses[addrIndex].vehicles.splice(vIndex, 1);\n  }\n  toggleEditVehicleStatus(vehicle) {\n    if (!this.editingHub?._id || !vehicle) return;\n    const vehicleNo = String(vehicle?.vehicleNo || '').trim();\n    if (!vehicleNo) return;\n    const current = String(vehicle?.vehicleStatus || 'online').trim().toLowerCase();\n    const nextStatus = current === 'offline' ? 'online' : 'offline';\n    this.http.patch(`http://localhost:3000/api/hubs/${this.editingHub._id}/vehicle-status`, {\n      vehicleNo,\n      vehicleStatus: nextStatus\n    }).subscribe({\n      next: () => {\n        vehicle.vehicleStatus = nextStatus;\n        this.loadHubs();\n      },\n      error: err => {\n        console.error('Error updating vehicle status:', err);\n        alert('Failed to update vehicle status.');\n      }\n    });\n  }\n  saveEdit() {\n    const payload = JSON.parse(JSON.stringify(this.editingHub || {}));\n    (payload?.deliveryAddresses || []).forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        v.currentLocationId = this.normalizeLocationId(v.currentLocationId);\n        delete v.currentBranch;\n      });\n    });\n    this.http.put(`http://localhost:3000/api/hubs/${this.editingHub._id}`, payload).subscribe({\n      next: () => {\n        this.loadHubs();\n        this.closeEditHubPopup();\n      },\n      error: err => alert(\"Update failed!\")\n    });\n  }\n  /** ðŸ”¹ Toggle Active/Inactive */\n  toggleStatus(hub) {\n    this.http.patch(`http://localhost:3000/api/hubs/${hub._id}/status`, {\n      status: hub.status === 'active' ? 'inactive' : 'active'\n    }).subscribe(() => this.loadHubs());\n  }\n  handleHubNameChange() {\n    const current = String(this.newHub.hubName || '').trim();\n    const previous = String(this.lastHubName || '').trim();\n    (this.newHub.deliveryAddresses || []).forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        const currentLocationId = String(v?.currentLocationId || '').trim();\n        const matchesPrevious = previous && this.normalizeLocationId(currentLocationId) === this.normalizeLocationId(previous);\n        if (!currentLocationId || matchesPrevious) {\n          v.currentLocationId = this.normalizeLocationId(current);\n        }\n      });\n    });\n    this.lastHubName = current;\n  }\n  syncNewHubCurrentBranchDefaults() {\n    const current = String(this.newHub.hubName || '').trim();\n    if (!current) return;\n    (this.newHub.deliveryAddresses || []).forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        if (!String(v?.currentLocationId || '').trim()) {\n          v.currentLocationId = this.normalizeLocationId(current);\n        }\n      });\n    });\n  }\n  getHubBranchOptions() {\n    const options = [];\n    (this.hubs || []).forEach(hub => {\n      const id = this.normalizeId(hub?._id);\n      const label = String(hub?.hubName || '').trim();\n      if (id && label) options.push({\n        id,\n        label\n      });\n    });\n    (this.branches || []).forEach(branch => {\n      const id = this.normalizeId(branch?._id);\n      const label = String(branch?.branchName || '').trim();\n      if (id && label && !options.some(o => o.id === id)) {\n        options.push({\n          id,\n          label\n        });\n      }\n    });\n    return options;\n  }\n  getEditHubBranchOptions(currentValue) {\n    const options = [];\n    const currentId = this.normalizeLocationId(String(currentValue || '').trim());\n    const currentLabel = this.getLocationLabel(currentId);\n    if (currentId && currentLabel) {\n      options.push({\n        id: currentId,\n        label: currentLabel\n      });\n    }\n    (this.hubs || []).forEach(hub => {\n      const id = this.normalizeId(hub?._id);\n      const label = String(hub?.hubName || '').trim();\n      if (id && label && !options.some(o => o.id === id)) {\n        options.push({\n          id,\n          label\n        });\n      }\n    });\n    (this.branches || []).forEach(branch => {\n      const id = this.normalizeId(branch?._id);\n      const label = String(branch?.branchName || '').trim();\n      if (id && label && !options.some(o => o.id === id)) {\n        options.push({\n          id,\n          label\n        });\n      }\n    });\n    return options;\n  }\n  ensureVehicleStatuses(targetHub) {\n    if (!targetHub?.deliveryAddresses) return;\n    targetHub.deliveryAddresses.forEach(addr => {\n      (addr?.vehicles || []).forEach(v => {\n        if (!v.vehicleStatus) {\n          v.vehicleStatus = 'online';\n        }\n      });\n    });\n  }\n  getFilteredVehicles(vehicles) {\n    const originLocId = String(localStorage.getItem('originLocId') || '').trim();\n    if (!originLocId || originLocId === 'all' || originLocId === 'all-hubs') {\n      return vehicles || [];\n    }\n    return (vehicles || []).filter(v => {\n      const currentLocationId = this.normalizeLocationId(v?.currentLocationId || v?.currentBranch);\n      return currentLocationId && currentLocationId === originLocId;\n    });\n  }\n  getLocationLabel(value) {\n    const raw = String(value || '').trim();\n    if (!raw) return '';\n    const hub = (this.hubs || []).find(h => this.normalizeId(h?._id) === raw);\n    if (hub?.hubName) return hub.hubName;\n    const branch = (this.branches || []).find(b => this.normalizeId(b?._id) === raw);\n    if (branch?.branchName) return branch.branchName;\n    return raw;\n  }\n  getHubAddress(hub) {\n    const parts = [hub?.address, hub?.city, hub?.state, hub?.pinCode].filter(Boolean);\n    if (parts.length) return parts.join(', ');\n    const firstAddress = Array.isArray(hub?.addresses) ? hub.addresses[0] : null;\n    const fallback = [firstAddress?.address, firstAddress?.city, firstAddress?.state, firstAddress?.pinCode].filter(Boolean);\n    return fallback.join(', ');\n  }\n  getOriginLabel(hub) {\n    const raw = String(hub?.originLocId || '').trim();\n    if (!raw) return '-';\n    const label = this.getLocationLabel(raw);\n    return label || raw;\n  }\n  getVehicleLocationLabel(vehicle) {\n    const raw = String(vehicle?.currentLocationId || vehicle?.currentBranch || '').trim();\n    if (!raw) {\n      return this.selectedHub?.hubName ? this.selectedHub.hubName : 'This hub';\n    }\n    const normalized = this.normalizeLocationId(raw);\n    return this.getLocationLabel(normalized || raw) || 'This hub';\n  }\n  normalizeLocationId(value) {\n    const raw = String(value || '').trim();\n    if (!raw) return '';\n    if (/^[a-f\\d]{24}$/i.test(raw)) return raw;\n    const hub = (this.hubs || []).find(h => String(h?.hubName || '').trim().toLowerCase() === raw.toLowerCase());\n    if (hub?._id) return this.normalizeId(hub._id);\n    const branch = (this.branches || []).find(b => String(b?.branchName || '').trim().toLowerCase() === raw.toLowerCase());\n    if (branch?._id) return this.normalizeId(branch._id);\n    return '';\n  }\n  normalizeId(value) {\n    if (!value) return '';\n    if (typeof value === 'string') return value;\n    if (value?._id) return String(value._id);\n    if (value?.$oid) return String(value.$oid);\n    return String(value);\n  }\n};\nHubComponent = __decorate([Component({\n  selector: 'app-hub',\n  standalone: true,\n  imports: [CommonModule, FormsModule],\n  templateUrl: './hub.component.html',\n  styleUrls: ['./hub.component.css']\n})], HubComponent);\nexport { HubComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}